<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.257">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend">

<title>meteo_imp - Kalman Filter</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="meteo_imp - Kalman Filter">
<meta property="og:description" content="Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend">
<meta property="og:site-name" content="meteo_imp">
<meta name="twitter:title" content="meteo_imp - Kalman Filter">
<meta name="twitter:description" content="Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">meteo_imp</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./kalman_filter.html">Kalman Filter</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GPFA Imputation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gaussian.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gaussian Distributions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./kalman_filter.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Kalman Filter</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./training.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Implement Kalman model using FastAI</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./filter_performance_stability.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Filter Perfomance and Stability</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./results.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Results</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Utils</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Fluxnet</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Fluxnet/gap_finder.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Find Gaps in Fluxnet data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Fluxnet/hainich.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fluxnet Hainich</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#equations" id="toc-equations" class="nav-link" data-scroll-target="#equations">Equations</a></li>
  </ul></li>
  <li><a href="#kalman-filter-base" id="toc-kalman-filter-base" class="nav-link" data-scroll-target="#kalman-filter-base">Kalman Filter Base</a>
  <ul class="collapse">
  <li><a href="#utils" id="toc-utils" class="nav-link" data-scroll-target="#utils">Utils</a></li>
  <li><a href="#kalman-filter-base-1" id="toc-kalman-filter-base-1" class="nav-link" data-scroll-target="#kalman-filter-base-1">Kalman Filter Base</a>
  <ul class="collapse">
  <li><a href="#kalmanfilterbase" id="toc-kalmanfilterbase" class="nav-link" data-scroll-target="#kalmanfilterbase">KalmanFilterBase</a></li>
  <li><a href="#constructors" id="toc-constructors" class="nav-link" data-scroll-target="#constructors">Constructors</a></li>
  <li><a href="#kalmanfilter" id="toc-kalmanfilter" class="nav-link" data-scroll-target="#kalmanfilter">KalmanFilter</a></li>
  <li><a href="#kalmanfiltersr" id="toc-kalmanfiltersr" class="nav-link" data-scroll-target="#kalmanfiltersr">KalmanFilterSR</a></li>
  <li><a href="#init_from" id="toc-init_from" class="nav-link" data-scroll-target="#init_from">init_from’]</a></li>
  <li><a href="#get-info" id="toc-get-info" class="nav-link" data-scroll-target="#get-info">Get Info</a></li>
  <li><a href="#kalmanfilterbase.get_info" id="toc-kalmanfilterbase.get_info" class="nav-link" data-scroll-target="#kalmanfilterbase.get_info">KalmanFilterBase.get_info</a></li>
  <li><a href="#test-data" id="toc-test-data" class="nav-link" data-scroll-target="#test-data">Test data</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#standard-kalman-filter" id="toc-standard-kalman-filter" class="nav-link" data-scroll-target="#standard-kalman-filter">Standard Kalman Filter</a>
  <ul class="collapse">
  <li><a href="#filter" id="toc-filter" class="nav-link" data-scroll-target="#filter">Filter</a>
  <ul class="collapse">
  <li><a href="#filter-predict" id="toc-filter-predict" class="nav-link" data-scroll-target="#filter-predict">Filter predict</a></li>
  <li><a href="#filter-update" id="toc-filter-update" class="nav-link" data-scroll-target="#filter-update">Filter update</a></li>
  <li><a href="#filter-all" id="toc-filter-all" class="nav-link" data-scroll-target="#filter-all">Filter All</a></li>
  <li><a href="#filter-1" id="toc-filter-1" class="nav-link" data-scroll-target="#filter-1">Filter</a></li>
  <li><a href="#kalmanfilter.filter" id="toc-kalmanfilter.filter" class="nav-link" data-scroll-target="#kalmanfilter.filter">KalmanFilter.filter</a></li>
  </ul></li>
  <li><a href="#smooth" id="toc-smooth" class="nav-link" data-scroll-target="#smooth">Smooth</a>
  <ul class="collapse">
  <li><a href="#smooth-update-step" id="toc-smooth-update-step" class="nav-link" data-scroll-target="#smooth-update-step">Smooth update step</a></li>
  <li><a href="#smooth-1" id="toc-smooth-1" class="nav-link" data-scroll-target="#smooth-1">Smooth</a></li>
  <li><a href="#kalmanfilter-method" id="toc-kalmanfilter-method" class="nav-link" data-scroll-target="#kalmanfilter-method">KalmanFilter method</a></li>
  <li><a href="#kalmanfilter.smooth" id="toc-kalmanfilter.smooth" class="nav-link" data-scroll-target="#kalmanfilter.smooth">KalmanFilter.smooth</a></li>
  </ul></li>
  <li><a href="#predict-1" id="toc-predict-1" class="nav-link" data-scroll-target="#predict-1">Predict</a>
  <ul class="collapse">
  <li><a href="#kalmanfilter.predict" id="toc-kalmanfilter.predict" class="nav-link" data-scroll-target="#kalmanfilter.predict">KalmanFilter.predict</a></li>
  <li><a href="#kalmanfilter.predict-1" id="toc-kalmanfilter.predict-1" class="nav-link" data-scroll-target="#kalmanfilter.predict-1">KalmanFilter.predict</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#numerical-stable-kalman-filter-square-root-filter" id="toc-numerical-stable-kalman-filter-square-root-filter" class="nav-link" data-scroll-target="#numerical-stable-kalman-filter-square-root-filter">Numerical Stable Kalman Filter (Square Root Filter)</a>
  <ul class="collapse">
  <li><a href="#filter-2" id="toc-filter-2" class="nav-link" data-scroll-target="#filter-2">Filter</a>
  <ul class="collapse">
  <li><a href="#filter-predict-1" id="toc-filter-predict-1" class="nav-link" data-scroll-target="#filter-predict-1">Filter predict</a></li>
  <li><a href="#filter-update-1" id="toc-filter-update-1" class="nav-link" data-scroll-target="#filter-update-1">Filter Update</a></li>
  <li><a href="#cat_2d" id="toc-cat_2d" class="nav-link" data-scroll-target="#cat_2d">cat_2d</a></li>
  <li><a href="#tensor_info" id="toc-tensor_info" class="nav-link" data-scroll-target="#tensor_info">tensor_info</a></li>
  <li><a href="#filter-all-1" id="toc-filter-all-1" class="nav-link" data-scroll-target="#filter-all-1">Filter All</a></li>
  <li><a href="#filter-3" id="toc-filter-3" class="nav-link" data-scroll-target="#filter-3">Filter</a></li>
  <li><a href="#kalmanfiltersr.filter" id="toc-kalmanfiltersr.filter" class="nav-link" data-scroll-target="#kalmanfiltersr.filter">KalmanFilterSR.filter</a></li>
  </ul></li>
  <li><a href="#smooth-2" id="toc-smooth-2" class="nav-link" data-scroll-target="#smooth-2">Smooth</a>
  <ul class="collapse">
  <li><a href="#smooth-update-step-1" id="toc-smooth-update-step-1" class="nav-link" data-scroll-target="#smooth-update-step-1">Smooth update step</a></li>
  <li><a href="#smooth-3" id="toc-smooth-3" class="nav-link" data-scroll-target="#smooth-3">Smooth</a></li>
  <li><a href="#kalmanfilter-method-1" id="toc-kalmanfilter-method-1" class="nav-link" data-scroll-target="#kalmanfilter-method-1">KalmanFilter method</a></li>
  <li><a href="#kalmanfiltersr.smooth" id="toc-kalmanfiltersr.smooth" class="nav-link" data-scroll-target="#kalmanfiltersr.smooth">KalmanFilterSR.smooth</a></li>
  </ul></li>
  <li><a href="#predict-3" id="toc-predict-3" class="nav-link" data-scroll-target="#predict-3">Predict</a>
  <ul class="collapse">
  <li><a href="#obs-from-state" id="toc-obs-from-state" class="nav-link" data-scroll-target="#obs-from-state">Obs from State</a></li>
  <li><a href="#masked-batch" id="toc-masked-batch" class="nav-link" data-scroll-target="#masked-batch">Masked Batch</a></li>
  <li><a href="#predict-4" id="toc-predict-4" class="nav-link" data-scroll-target="#predict-4">Predict</a></li>
  <li><a href="#kalmanfiltersr.predict" id="toc-kalmanfiltersr.predict" class="nav-link" data-scroll-target="#kalmanfiltersr.predict">KalmanFilterSR.predict</a></li>
  <li><a href="#exploration" id="toc-exploration" class="nav-link" data-scroll-target="#exploration">Exploration</a></li>
  <li><a href="#with_settings" id="toc-with_settings" class="nav-link" data-scroll-target="#with_settings">with_settings</a></li>
  <li><a href="#replacing_ctx" id="toc-replacing_ctx" class="nav-link" data-scroll-target="#replacing_ctx">replacing_ctx</a></li>
  <li><a href="#buffer_pred_single" id="toc-buffer_pred_single" class="nav-link" data-scroll-target="#buffer_pred_single">buffer_pred_single</a></li>
  <li><a href="#buffer_pred" id="toc-buffer_pred" class="nav-link" data-scroll-target="#buffer_pred">buffer_pred</a></li>
  </ul></li>
  <li><a href="#debug-nan" id="toc-debug-nan" class="nav-link" data-scroll-target="#debug-nan">Debug nan</a>
  <ul class="collapse">
  <li><a href="#sr-filter" id="toc-sr-filter" class="nav-link" data-scroll-target="#sr-filter">SR Filter</a></li>
  <li><a href="#standard-filter" id="toc-standard-filter" class="nav-link" data-scroll-target="#standard-filter">Standard Filter</a></li>
  </ul></li>
  <li><a href="#additional" id="toc-additional" class="nav-link" data-scroll-target="#additional">Additional</a>
  <ul class="collapse">
  <li><a href="#constructors-1" id="toc-constructors-1" class="nav-link" data-scroll-target="#constructors-1">Constructors</a></li>
  <li><a href="#init_simple" id="toc-init_simple" class="nav-link" data-scroll-target="#init_simple">init_simple’]</a></li>
  <li><a href="#init_local_slope_pca" id="toc-init_local_slope_pca" class="nav-link" data-scroll-target="#init_local_slope_pca">init_local_slope_pca’]</a></li>
  </ul></li>
  <li><a href="#export" id="toc-export" class="nav-link" data-scroll-target="#export">Export</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/mone27/meteo_imp/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Kalman Filter</h1>
</div>

<div>
  <div class="description">
    Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The models uses a latent state variable <span class="math inline">\(x\)</span> that is modelled over time, to impute gaps in <span class="math inline">\(y\)</span></p>
<p>The assumption of the model is that the state variable at time <span class="math inline">\(x_t\)</span> depends only on the last state <span class="math inline">\(x_{t-1}\)</span> and not on the previous states.</p>
<section id="equations" class="level3">
<h3 class="anchored" data-anchor-id="equations">Equations</h3>
<p>The equations of the model are:</p>
<p><span class="math display">\[\begin{align} p(x_t | x_{t-1}) &amp; = \mathcal{N}(Ax_{t-1} + b, Q) \\
p(y_t | x_t) &amp; = \mathcal{N}(Hx_t + d, R) \end{align}\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(A\)</span> is the <code>A</code></li>
<li><span class="math inline">\(b\)</span> is the <code>bset</code></li>
<li><span class="math inline">\(Q\)</span> is the <code>Q</code></li>
<li><span class="math inline">\(H\)</span> is the <code>obs_trans</code></li>
<li><span class="math inline">\(d\)</span> is the <code>d</code></li>
<li><span class="math inline">\(R\)</span> is the <code>R</code></li>
</ul>
<p>in addition the model has also the parameters of the initial state that are used to initialize the filter:</p>
<ul>
<li><code>m0</code></li>
<li><code>P0</code></li>
</ul>
<p>The Kalman filter has 3 steps:</p>
<ul>
<li>filter (updating the state at time t with observations till time t-1)</li>
<li>update (update the state at time t using the observation at time t)</li>
<li>smooth (update the state using the observations at time t+1)</li>
</ul>
<p>In case of missing data the update step is skipped.</p>
<p>After smoothing the missing data at time t (<span class="math inline">\(y_t\)</span>) can be imputed from the state (<span class="math inline">\(x_t\)</span>) using this formula: <span class="math display">\[p(y_t|x_t) = \mathcal{N}(Hx_t + d, R + HP^s_tH^T)\]</span></p>
<p>The Kalman Filter is an algorithm designed to estimate <span class="math inline">\(P(x_t | y_{0:t})\)</span>. As all state transitions and obss are linear with Gaussian distributed noise, these distributions can be represented exactly as Gaussian distributions with mean <code>ms[t]</code> and covs <code>Ps[t]</code>. Similarly, the Kalman Smoother is an algorithm designed to estimate <span class="math inline">\(P(x_t | y_{0:t-1})\)</span></p>
</section>
</section>
<section id="kalman-filter-base" class="level1">
<h1>Kalman Filter Base</h1>
<section id="utils" class="level3">
<h3 class="anchored" data-anchor-id="utils">Utils</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>show_as_row(_add_batch_dim(torch.ones(<span class="dv">2</span>)), _add_batch_dim(torch.ones(<span class="dv">2</span>,<span class="dv">2</span>)), _add_batch_dim(torch.ones(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[[1.],
         [1.]]])
</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[[1., 1.],
         [1., 1.]]])
</pre> </div><div><p style="font-size: 1.2rem;">#2</p> <pre>tensor([[[1., 1.],
         [1., 1.]],

        [[1., 1.],
         [1., 1.]]])
</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>show_as_row(_add_batch_dim(torch.ones(<span class="dv">2</span>)).shape, _add_batch_dim(torch.ones(<span class="dv">2</span>,<span class="dv">2</span>)).shape, _add_batch_dim(torch.ones(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>)).shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([1, 2, 1])
</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([1, 2, 2])
</pre> </div><div><p style="font-size: 1.2rem;">#2</p> <pre>torch.Size([2, 2, 2])
</pre> </div></div>
</div>
</div>
</section>
<section id="kalman-filter-base-1" class="level2">
<h2 class="anchored" data-anchor-id="kalman-filter-base-1">Kalman Filter Base</h2>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L45" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="kalmanfilterbase" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilterbase">KalmanFilterBase</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilterBase (A:torch.Tensor, H:torch.Tensor, B:torch.Tensor,
                   Q:torch.Tensor, R:torch.Tensor, b:torch.Tensor,
                   d:torch.Tensor, m0:torch.Tensor, P0:torch.Tensor,
                   n_dim_state:int=None, n_dim_obs:int=None,
                   n_dim_contr:int=None,
                   var_names:Optional[Iterable[str]]=None,
                   contr_names:Optional[Iterable[str]]=None,
                   cov_checker:meteo_imp.gaussian.CheckPosDef|None=None,
                   use_conditional:bool=False, use_control:bool=True,
                   use_smooth:bool=True, pred_only_gap:bool=False,
                   pred_std:bool=False)</code></pre>
</blockquote>
<p>Base class for handling Kalman Filter implementation in PyTorch</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state,n_dim_state] <span class="math inline">\(A\)</span>, state transition matrix</td>
</tr>
<tr class="even">
<td>H</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_state] <span class="math inline">\(H\)</span>, observation matrix</td>
</tr>
<tr class="odd">
<td>B</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_contr] <span class="math inline">\(B\)</span> control matrix</td>
</tr>
<tr class="even">
<td>Q</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(Q\)</span>, state trans covariance matrix</td>
</tr>
<tr class="odd">
<td>R</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_obs] <span class="math inline">\(R\)</span>, observations covariance matrix</td>
</tr>
<tr class="even">
<td>b</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(b\)</span>, state transition offset</td>
</tr>
<tr class="odd">
<td>d</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs] <span class="math inline">\(d\)</span>, observations offset</td>
</tr>
<tr class="even">
<td>m0</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(m_0\)</span></td>
</tr>
<tr class="odd">
<td>P0</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(P_0\)</span></td>
</tr>
<tr class="even">
<td>n_dim_state</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for state - default infered from parameters</td>
</tr>
<tr class="odd">
<td>n_dim_obs</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for observations - default infered from parameters</td>
</tr>
<tr class="even">
<td>n_dim_contr</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for control - default infered from parameters</td>
</tr>
<tr class="odd">
<td>var_names</td>
<td>Optional</td>
<td>None</td>
<td>Names of variables for printing</td>
</tr>
<tr class="even">
<td>contr_names</td>
<td>Optional</td>
<td>None</td>
<td>Names of control variables for printing</td>
</tr>
<tr class="odd">
<td>cov_checker</td>
<td>meteo_imp.gaussian.CheckPosDef | None</td>
<td>None</td>
<td>Check covariance at every step</td>
</tr>
<tr class="even">
<td>use_conditional</td>
<td>bool</td>
<td>False</td>
<td>Use conditional distribution for gaps that don’t have all variables missing</td>
</tr>
<tr class="odd">
<td>use_control</td>
<td>bool</td>
<td>True</td>
<td>Use the control in the filter</td>
</tr>
<tr class="even">
<td>use_smooth</td>
<td>bool</td>
<td>True</td>
<td>Use smoother for predictions (otherwise is filter only)</td>
</tr>
<tr class="odd">
<td>pred_only_gap</td>
<td>bool</td>
<td>False</td>
<td>it True predictions are only for the gap</td>
</tr>
<tr class="even">
<td>pred_std</td>
<td>bool</td>
<td>False</td>
<td>return only stds and not covariances</td>
</tr>
</tbody>
</table>
</section>
<section id="constructors" class="level3">
<h3 class="anchored" data-anchor-id="constructors">Constructors</h3>
<p>Giving all the parameters manually to the <a href="https://mone27.github.io/meteo_imp/lib/kalman_filter.html#kalmanfilterbase"><code>KalmanFilterBase</code></a> init method is not convenient, hence we are having some methods that help initize the class</p>
<p>due to a bug in fastcore cannot subclass after creating class methods</p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L186" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter">KalmanFilter</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter (A:torch.Tensor, H:torch.Tensor, B:torch.Tensor,
               Q:torch.Tensor, R:torch.Tensor, b:torch.Tensor,
               d:torch.Tensor, m0:torch.Tensor, P0:torch.Tensor,
               n_dim_state:int=None, n_dim_obs:int=None,
               n_dim_contr:int=None,
               var_names:Optional[Iterable[str]]=None,
               contr_names:Optional[Iterable[str]]=None,
               cov_checker:meteo_imp.gaussian.CheckPosDef|None=None,
               use_conditional:bool=False, use_control:bool=True,
               use_smooth:bool=True, pred_only_gap:bool=False,
               pred_std:bool=False)</code></pre>
</blockquote>
<p>Base class for handling Kalman Filter implementation in PyTorch</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state,n_dim_state] <span class="math inline">\(A\)</span>, state transition matrix</td>
</tr>
<tr class="even">
<td>H</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_state] <span class="math inline">\(H\)</span>, observation matrix</td>
</tr>
<tr class="odd">
<td>B</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_contr] <span class="math inline">\(B\)</span> control matrix</td>
</tr>
<tr class="even">
<td>Q</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(Q\)</span>, state trans covariance matrix</td>
</tr>
<tr class="odd">
<td>R</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_obs] <span class="math inline">\(R\)</span>, observations covariance matrix</td>
</tr>
<tr class="even">
<td>b</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(b\)</span>, state transition offset</td>
</tr>
<tr class="odd">
<td>d</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs] <span class="math inline">\(d\)</span>, observations offset</td>
</tr>
<tr class="even">
<td>m0</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(m_0\)</span></td>
</tr>
<tr class="odd">
<td>P0</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(P_0\)</span></td>
</tr>
<tr class="even">
<td>n_dim_state</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for state - default infered from parameters</td>
</tr>
<tr class="odd">
<td>n_dim_obs</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for observations - default infered from parameters</td>
</tr>
<tr class="even">
<td>n_dim_contr</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for control - default infered from parameters</td>
</tr>
<tr class="odd">
<td>var_names</td>
<td>Optional</td>
<td>None</td>
<td>Names of variables for printing</td>
</tr>
<tr class="even">
<td>contr_names</td>
<td>Optional</td>
<td>None</td>
<td>Names of control variables for printing</td>
</tr>
<tr class="odd">
<td>cov_checker</td>
<td>meteo_imp.gaussian.CheckPosDef | None</td>
<td>None</td>
<td>Check covariance at every step</td>
</tr>
<tr class="even">
<td>use_conditional</td>
<td>bool</td>
<td>False</td>
<td>Use conditional distribution for gaps that don’t have all variables missing</td>
</tr>
<tr class="odd">
<td>use_control</td>
<td>bool</td>
<td>True</td>
<td>Use the control in the filter</td>
</tr>
<tr class="even">
<td>use_smooth</td>
<td>bool</td>
<td>True</td>
<td>Use smoother for predictions (otherwise is filter only)</td>
</tr>
<tr class="odd">
<td>pred_only_gap</td>
<td>bool</td>
<td>False</td>
<td>it True predictions are only for the gap</td>
</tr>
<tr class="even">
<td>pred_std</td>
<td>bool</td>
<td>False</td>
<td>return only stds and not covariances</td>
</tr>
</tbody>
</table>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L190" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfiltersr" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfiltersr">KalmanFilterSR</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilterSR (A:torch.Tensor, H:torch.Tensor, B:torch.Tensor,
                 Q:torch.Tensor, R:torch.Tensor, b:torch.Tensor,
                 d:torch.Tensor, m0:torch.Tensor, P0:torch.Tensor,
                 n_dim_state:int=None, n_dim_obs:int=None,
                 n_dim_contr:int=None,
                 var_names:Optional[Iterable[str]]=None,
                 contr_names:Optional[Iterable[str]]=None,
                 cov_checker:meteo_imp.gaussian.CheckPosDef|None=None,
                 use_conditional:bool=False, use_control:bool=True,
                 use_smooth:bool=True, pred_only_gap:bool=False,
                 pred_std:bool=False)</code></pre>
</blockquote>
<p>Base class for handling Kalman Filter implementation in PyTorch</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state,n_dim_state] <span class="math inline">\(A\)</span>, state transition matrix</td>
</tr>
<tr class="even">
<td>H</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_state] <span class="math inline">\(H\)</span>, observation matrix</td>
</tr>
<tr class="odd">
<td>B</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_contr] <span class="math inline">\(B\)</span> control matrix</td>
</tr>
<tr class="even">
<td>Q</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(Q\)</span>, state trans covariance matrix</td>
</tr>
<tr class="odd">
<td>R</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_obs] <span class="math inline">\(R\)</span>, observations covariance matrix</td>
</tr>
<tr class="even">
<td>b</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(b\)</span>, state transition offset</td>
</tr>
<tr class="odd">
<td>d</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs] <span class="math inline">\(d\)</span>, observations offset</td>
</tr>
<tr class="even">
<td>m0</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(m_0\)</span></td>
</tr>
<tr class="odd">
<td>P0</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(P_0\)</span></td>
</tr>
<tr class="even">
<td>n_dim_state</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for state - default infered from parameters</td>
</tr>
<tr class="odd">
<td>n_dim_obs</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for observations - default infered from parameters</td>
</tr>
<tr class="even">
<td>n_dim_contr</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for control - default infered from parameters</td>
</tr>
<tr class="odd">
<td>var_names</td>
<td>Optional</td>
<td>None</td>
<td>Names of variables for printing</td>
</tr>
<tr class="even">
<td>contr_names</td>
<td>Optional</td>
<td>None</td>
<td>Names of control variables for printing</td>
</tr>
<tr class="odd">
<td>cov_checker</td>
<td>meteo_imp.gaussian.CheckPosDef | None</td>
<td>None</td>
<td>Check covariance at every step</td>
</tr>
<tr class="even">
<td>use_conditional</td>
<td>bool</td>
<td>False</td>
<td>Use conditional distribution for gaps that don’t have all variables missing</td>
</tr>
<tr class="odd">
<td>use_control</td>
<td>bool</td>
<td>True</td>
<td>Use the control in the filter</td>
</tr>
<tr class="even">
<td>use_smooth</td>
<td>bool</td>
<td>True</td>
<td>Use smoother for predictions (otherwise is filter only)</td>
</tr>
<tr class="odd">
<td>pred_only_gap</td>
<td>bool</td>
<td>False</td>
<td>it True predictions are only for the gap</td>
</tr>
<tr class="even">
<td>pred_std</td>
<td>bool</td>
<td>False</td>
<td>return only stds and not covariances</td>
</tr>
</tbody>
</table>
<section id="random-parameters" class="level4">
<h4 class="anchored" data-anchor-id="random-parameters">Random parameters</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>kB <span class="op">=</span> KalmanFilterBase.init_random(<span class="dv">3</span>,<span class="dv">4</span>, <span class="dv">3</span>, dtype<span class="op">=</span>torch.float64)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>kB</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Kalman Filter
        N dim obs: 3,
        N dim state: 4,
        N dim contr: 3</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>kB.Q</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[1.5725, 0.3829, 0.0843, 0.3637],
         [0.3829, 1.4430, 0.3358, 1.1988],
         [0.0843, 0.3358, 1.7816, 0.7411],
         [0.3637, 1.1988, 0.7411, 1.6773]]], dtype=torch.float64,
       grad_fn=&lt;UnsafeViewBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>kB.Q_C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[1.2540, 0.0000, 0.0000, 0.0000],
         [0.3053, 1.1618, 0.0000, 0.0000],
         [0.0672, 0.2714, 1.3052, 0.0000],
         [0.2901, 0.9556, 0.3542, 0.7446]]], dtype=torch.float64,
       grad_fn=&lt;DiagonalScatterBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>test_close(kB.Q_C <span class="op">@</span> kB.Q_C.mT, kB.Q, eps<span class="op">=</span><span class="fl">2e-5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>kB.P0 <span class="op">=</span> to_posdef(torch.rand(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>check that assigment works :)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>kB.P0 <span class="op">=</span> to_posdef(torch.rand(<span class="dv">4</span>, <span class="dv">4</span>, dtype<span class="op">=</span>torch.float64))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>kB.P0_C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[0.9349, 0.0000, 0.0000, 0.0000],
        [0.3928, 1.0748, 0.0000, 0.0000],
        [0.7406, 0.7533, 0.8326, 0.0000],
        [0.5903, 0.0391, 0.8217, 0.9638]], dtype=torch.float64,
       grad_fn=&lt;DiagonalScatterBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>kB <span class="op">=</span> KalmanFilterBase.init_random(<span class="dv">3</span>,<span class="dv">4</span>, <span class="dv">3</span>, dtype<span class="op">=</span>torch.float64)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>kB</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Kalman Filter
        N dim obs: 3,
        N dim state: 4,
        N dim contr: 3</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(kB.named_parameters())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[('A',
  Parameter containing:
  tensor([[[0.1751, 0.5375, 0.7676, 0.7450],
           [0.1204, 0.4777, 0.5823, 0.3786],
           [0.8484, 0.2317, 0.3969, 0.7088],
           [0.0270, 0.6178, 0.6097, 0.9128]]], dtype=torch.float64,
         requires_grad=True)),
 ('H',
  Parameter containing:
  tensor([[[0.4984, 0.1597, 0.4458, 0.7349],
           [0.1070, 0.9531, 0.1942, 0.6683],
           [0.9186, 0.7123, 0.1806, 0.5045]]], dtype=torch.float64,
         requires_grad=True)),
 ('B',
  Parameter containing:
  tensor([[[0.2827, 0.1138, 0.9378],
           [0.5594, 0.9364, 0.5136],
           [0.8592, 0.7647, 0.5183],
           [0.2376, 0.5618, 0.5096]]], dtype=torch.float64, requires_grad=True)),
 ('Q_raw',
  Parameter containing:
  tensor([[[0.4590, 0.0000, 0.0000, 0.0000],
           [0.5348, 0.5296, 0.0000, 0.0000],
           [0.0025, 0.0749, 0.4603, 0.0000],
           [0.0588, 0.5416, 0.9309, 0.5859]]], dtype=torch.float64,
         requires_grad=True)),
 ('R_raw',
  Parameter containing:
  tensor([[[0.1393, 0.0000, 0.0000],
           [0.0249, 0.7613, 0.0000],
           [0.7829, 0.4311, 0.9199]]], dtype=torch.float64, requires_grad=True)),
 ('b',
  Parameter containing:
  tensor([[[0.4661],
           [0.3918],
           [0.0571],
           [0.9529]]], dtype=torch.float64, requires_grad=True)),
 ('d',
  Parameter containing:
  tensor([[[0.9334],
           [0.5645],
           [0.0695]]], dtype=torch.float64, requires_grad=True)),
 ('m0',
  Parameter containing:
  tensor([[[0.8234],
           [0.3850],
           [0.3380],
           [0.4376]]], dtype=torch.float64, requires_grad=True)),
 ('P0_raw',
  Parameter containing:
  tensor([[[0.4467, 0.0000, 0.0000, 0.0000],
           [0.4818, 0.9502, 0.0000, 0.0000],
           [0.4770, 0.3478, 0.9812, 0.0000],
           [0.2460, 0.9602, 0.6476, 0.2647]]], dtype=torch.float64,
         requires_grad=True))]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>kB.state_dict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>OrderedDict([('A',
              tensor([[[0.1751, 0.5375, 0.7676, 0.7450],
                       [0.1204, 0.4777, 0.5823, 0.3786],
                       [0.8484, 0.2317, 0.3969, 0.7088],
                       [0.0270, 0.6178, 0.6097, 0.9128]]], dtype=torch.float64)),
             ('H',
              tensor([[[0.4984, 0.1597, 0.4458, 0.7349],
                       [0.1070, 0.9531, 0.1942, 0.6683],
                       [0.9186, 0.7123, 0.1806, 0.5045]]], dtype=torch.float64)),
             ('B',
              tensor([[[0.2827, 0.1138, 0.9378],
                       [0.5594, 0.9364, 0.5136],
                       [0.8592, 0.7647, 0.5183],
                       [0.2376, 0.5618, 0.5096]]], dtype=torch.float64)),
             ('Q_raw',
              tensor([[[0.4590, 0.0000, 0.0000, 0.0000],
                       [0.5348, 0.5296, 0.0000, 0.0000],
                       [0.0025, 0.0749, 0.4603, 0.0000],
                       [0.0588, 0.5416, 0.9309, 0.5859]]], dtype=torch.float64)),
             ('R_raw',
              tensor([[[0.1393, 0.0000, 0.0000],
                       [0.0249, 0.7613, 0.0000],
                       [0.7829, 0.4311, 0.9199]]], dtype=torch.float64)),
             ('b',
              tensor([[[0.4661],
                       [0.3918],
                       [0.0571],
                       [0.9529]]], dtype=torch.float64)),
             ('d',
              tensor([[[0.9334],
                       [0.5645],
                       [0.0695]]], dtype=torch.float64)),
             ('m0',
              tensor([[[0.8234],
                       [0.3850],
                       [0.3380],
                       [0.4376]]], dtype=torch.float64)),
             ('P0_raw',
              tensor([[[0.4467, 0.0000, 0.0000, 0.0000],
                       [0.4818, 0.9502, 0.0000, 0.0000],
                       [0.4770, 0.3478, 0.9812, 0.0000],
                       [0.2460, 0.9602, 0.6476, 0.2647]]], dtype=torch.float64))])</code></pre>
</div>
</div>
</section>
<section id="from-filter" class="level4">
<h4 class="anchored" data-anchor-id="from-filter">From filter</h4>
<hr>
</section>
</section>
<section id="init_from" class="level3">
<h3 class="anchored" data-anchor-id="init_from">init_from’]</h3>
<p>Built-in mutable sequence.</p>
<p>If no argument is given, the constructor creates a new empty list. The argument must be an iterable if specified.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>k1 <span class="op">=</span> KalmanFilter.init_random(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">3</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>k2 <span class="op">=</span> KalmanFilterSR.init_from(k1)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p1, p2 <span class="kw">in</span> <span class="bu">zip</span>(k1.parameters(), k2.parameters()):</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    test_close(p1,p2, eps<span class="op">=</span><span class="fl">1e-3</span>) <span class="co">#noise added by contraints</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-info" class="level3">
<h3 class="anchored" data-anchor-id="get-info">Get Info</h3>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L233" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilterbase.get_info" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilterbase.get_info">KalmanFilterBase.get_info</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilterBase.get_info ()</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>kB</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<p style="font-size: 1.5rem; font-decoration: bold">Kalman Filter (3 obs, 4 state, 3 contr)</p><p></p><div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div> <p style="font-size: 1.3rem;">$A$</p> <style type="text/css">
</style>

<table id="T_26020" data-quarto-postprocess="true" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_26020_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">state</th>
<th id="T_26020_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">x_0</th>
<th id="T_26020_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">x_1</th>
<th id="T_26020_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">x_2</th>
<th id="T_26020_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">x_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_26020_row0_col0" class="data row0 col0">x_0</td>
<td id="T_26020_row0_col1" class="data row0 col1">0.1751</td>
<td id="T_26020_row0_col2" class="data row0 col2">0.5375</td>
<td id="T_26020_row0_col3" class="data row0 col3">0.7676</td>
<td id="T_26020_row0_col4" class="data row0 col4">0.7450</td>
</tr>
<tr class="even">
<td id="T_26020_row1_col0" class="data row1 col0">x_1</td>
<td id="T_26020_row1_col1" class="data row1 col1">0.1204</td>
<td id="T_26020_row1_col2" class="data row1 col2">0.4777</td>
<td id="T_26020_row1_col3" class="data row1 col3">0.5823</td>
<td id="T_26020_row1_col4" class="data row1 col4">0.3786</td>
</tr>
<tr class="odd">
<td id="T_26020_row2_col0" class="data row2 col0">x_2</td>
<td id="T_26020_row2_col1" class="data row2 col1">0.8484</td>
<td id="T_26020_row2_col2" class="data row2 col2">0.2317</td>
<td id="T_26020_row2_col3" class="data row2 col3">0.3969</td>
<td id="T_26020_row2_col4" class="data row2 col4">0.7088</td>
</tr>
<tr class="even">
<td id="T_26020_row3_col0" class="data row3 col0">x_3</td>
<td id="T_26020_row3_col1" class="data row3 col1">0.0270</td>
<td id="T_26020_row3_col2" class="data row3 col2">0.6178</td>
<td id="T_26020_row3_col3" class="data row3 col3">0.6097</td>
<td id="T_26020_row3_col4" class="data row3 col4">0.9128</td>
</tr>
</tbody>
</table>
<div>
<p>$Q$</p>
<table id="T_db001" data-quarto-postprocess="true" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_db001_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">state</th>
<th id="T_db001_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">x_0</th>
<th id="T_db001_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">x_1</th>
<th id="T_db001_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">x_2</th>
<th id="T_db001_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">x_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_db001_row0_col0" class="data row0 col0">x_0</td>
<td id="T_db001_row0_col1" class="data row0 col1">0.9002</td>
<td id="T_db001_row0_col2" class="data row0 col2">0.5074</td>
<td id="T_db001_row0_col3" class="data row0 col3">0.0024</td>
<td id="T_db001_row0_col4" class="data row0 col4">0.0558</td>
</tr>
<tr class="even">
<td id="T_db001_row1_col0" class="data row1 col0">x_1</td>
<td id="T_db001_row1_col1" class="data row1 col1">0.5074</td>
<td id="T_db001_row1_col2" class="data row1 col2">1.2712</td>
<td id="T_db001_row1_col3" class="data row1 col3">0.0756</td>
<td id="T_db001_row1_col4" class="data row1 col4">0.5690</td>
</tr>
<tr class="odd">
<td id="T_db001_row2_col0" class="data row2 col0">x_2</td>
<td id="T_db001_row2_col1" class="data row2 col1">0.0024</td>
<td id="T_db001_row2_col2" class="data row2 col2">0.0756</td>
<td id="T_db001_row2_col3" class="data row2 col3">0.9072</td>
<td id="T_db001_row2_col4" class="data row2 col4">0.9246</td>
</tr>
<tr class="even">
<td id="T_db001_row3_col0" class="data row3 col0">x_3</td>
<td id="T_db001_row3_col1" class="data row3 col1">0.0558</td>
<td id="T_db001_row3_col2" class="data row3 col2">0.5690</td>
<td id="T_db001_row3_col3" class="data row3 col3">0.9246</td>
<td id="T_db001_row3_col4" class="data row3 col4">2.2208</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>$b$</p>
<table id="T_1d151" data-quarto-postprocess="true" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_1d151_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">state</th>
<th id="T_1d151_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">offset</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_1d151_row0_col0" class="data row0 col0">x_0</td>
<td id="T_1d151_row0_col1" class="data row0 col1">0.4661</td>
</tr>
<tr class="even">
<td id="T_1d151_row1_col0" class="data row1 col0">x_1</td>
<td id="T_1d151_row1_col1" class="data row1 col1">0.3918</td>
</tr>
<tr class="odd">
<td id="T_1d151_row2_col0" class="data row2 col0">x_2</td>
<td id="T_1d151_row2_col1" class="data row2 col1">0.0571</td>
</tr>
<tr class="even">
<td id="T_1d151_row3_col0" class="data row3 col0">x_3</td>
<td id="T_1d151_row3_col1" class="data row3 col1">0.9529</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>$H$</p>
<table id="T_ddc60" data-quarto-postprocess="true" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_ddc60_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">variable</th>
<th id="T_ddc60_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">x_0</th>
<th id="T_ddc60_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">x_1</th>
<th id="T_ddc60_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">x_2</th>
<th id="T_ddc60_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">x_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_ddc60_row0_col0" class="data row0 col0">y_0</td>
<td id="T_ddc60_row0_col1" class="data row0 col1">0.4984</td>
<td id="T_ddc60_row0_col2" class="data row0 col2">0.1597</td>
<td id="T_ddc60_row0_col3" class="data row0 col3">0.4458</td>
<td id="T_ddc60_row0_col4" class="data row0 col4">0.7349</td>
</tr>
<tr class="even">
<td id="T_ddc60_row1_col0" class="data row1 col0">y_1</td>
<td id="T_ddc60_row1_col1" class="data row1 col1">0.1070</td>
<td id="T_ddc60_row1_col2" class="data row1 col2">0.9531</td>
<td id="T_ddc60_row1_col3" class="data row1 col3">0.1942</td>
<td id="T_ddc60_row1_col4" class="data row1 col4">0.6683</td>
</tr>
<tr class="odd">
<td id="T_ddc60_row2_col0" class="data row2 col0">y_2</td>
<td id="T_ddc60_row2_col1" class="data row2 col1">0.9186</td>
<td id="T_ddc60_row2_col2" class="data row2 col2">0.7123</td>
<td id="T_ddc60_row2_col3" class="data row2 col3">0.1806</td>
<td id="T_ddc60_row2_col4" class="data row2 col4">0.5045</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>$R$</p>
<table id="T_47653" data-quarto-postprocess="true" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_47653_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">variable</th>
<th id="T_47653_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">y_0</th>
<th id="T_47653_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">y_1</th>
<th id="T_47653_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">y_2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_47653_row0_col0" class="data row0 col0">y_0</td>
<td id="T_47653_row0_col1" class="data row0 col1">0.5856</td>
<td id="T_47653_row0_col2" class="data row0 col2">0.0190</td>
<td id="T_47653_row0_col3" class="data row0 col3">0.5991</td>
</tr>
<tr class="even">
<td id="T_47653_row1_col0" class="data row1 col0">y_1</td>
<td id="T_47653_row1_col1" class="data row1 col1">0.0190</td>
<td id="T_47653_row1_col2" class="data row1 col2">1.3107</td>
<td id="T_47653_row1_col3" class="data row1 col3">0.5130</td>
</tr>
<tr class="odd">
<td id="T_47653_row2_col0" class="data row2 col0">y_2</td>
<td id="T_47653_row2_col1" class="data row2 col1">0.5991</td>
<td id="T_47653_row2_col2" class="data row2 col2">0.5130</td>
<td id="T_47653_row2_col3" class="data row2 col3">2.3748</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>$d$</p>
<table id="T_31d59" data-quarto-postprocess="true" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_31d59_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">variable</th>
<th id="T_31d59_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">offset</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_31d59_row0_col0" class="data row0 col0">y_0</td>
<td id="T_31d59_row0_col1" class="data row0 col1">0.9334</td>
</tr>
<tr class="even">
<td id="T_31d59_row1_col0" class="data row1 col0">y_1</td>
<td id="T_31d59_row1_col1" class="data row1 col1">0.5645</td>
</tr>
<tr class="odd">
<td id="T_31d59_row2_col0" class="data row2 col0">y_2</td>
<td id="T_31d59_row2_col1" class="data row2 col1">0.0695</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>$B$</p>
<table id="T_62060" data-quarto-postprocess="true" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_62060_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">state</th>
<th id="T_62060_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">c_0</th>
<th id="T_62060_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">c_1</th>
<th id="T_62060_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">c_2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_62060_row0_col0" class="data row0 col0">x_0</td>
<td id="T_62060_row0_col1" class="data row0 col1">0.2827</td>
<td id="T_62060_row0_col2" class="data row0 col2">0.1138</td>
<td id="T_62060_row0_col3" class="data row0 col3">0.9378</td>
</tr>
<tr class="even">
<td id="T_62060_row1_col0" class="data row1 col0">x_1</td>
<td id="T_62060_row1_col1" class="data row1 col1">0.5594</td>
<td id="T_62060_row1_col2" class="data row1 col2">0.9364</td>
<td id="T_62060_row1_col3" class="data row1 col3">0.5136</td>
</tr>
<tr class="odd">
<td id="T_62060_row2_col0" class="data row2 col0">x_2</td>
<td id="T_62060_row2_col1" class="data row2 col1">0.8592</td>
<td id="T_62060_row2_col2" class="data row2 col2">0.7647</td>
<td id="T_62060_row2_col3" class="data row2 col3">0.5183</td>
</tr>
<tr class="even">
<td id="T_62060_row3_col0" class="data row3 col0">x_3</td>
<td id="T_62060_row3_col1" class="data row3 col1">0.2376</td>
<td id="T_62060_row3_col2" class="data row3 col2">0.5618</td>
<td id="T_62060_row3_col3" class="data row3 col3">0.5096</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>$m_0$</p>
<table id="T_9c8d4" data-quarto-postprocess="true" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_9c8d4_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">state</th>
<th id="T_9c8d4_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">mean</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_9c8d4_row0_col0" class="data row0 col0">x_0</td>
<td id="T_9c8d4_row0_col1" class="data row0 col1">0.8234</td>
</tr>
<tr class="even">
<td id="T_9c8d4_row1_col0" class="data row1 col0">x_1</td>
<td id="T_9c8d4_row1_col1" class="data row1 col1">0.3850</td>
</tr>
<tr class="odd">
<td id="T_9c8d4_row2_col0" class="data row2 col0">x_2</td>
<td id="T_9c8d4_row2_col1" class="data row2 col1">0.3380</td>
</tr>
<tr class="even">
<td id="T_9c8d4_row3_col0" class="data row3 col0">x_3</td>
<td id="T_9c8d4_row3_col1" class="data row3 col1">0.4376</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>$P_0$</p>
<table id="T_adee1" data-quarto-postprocess="true" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_adee1_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">state</th>
<th id="T_adee1_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">x_0</th>
<th id="T_adee1_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">x_1</th>
<th id="T_adee1_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">x_2</th>
<th id="T_adee1_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">x_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_adee1_row0_col0" class="data row0 col0">x_0</td>
<td id="T_adee1_row0_col1" class="data row0 col1">0.8860</td>
<td id="T_adee1_row0_col2" class="data row0 col2">0.4535</td>
<td id="T_adee1_row0_col3" class="data row0 col3">0.4490</td>
<td id="T_adee1_row0_col4" class="data row0 col4">0.2316</td>
</tr>
<tr class="even">
<td id="T_adee1_row1_col0" class="data row1 col0">x_1</td>
<td id="T_adee1_row1_col1" class="data row1 col1">0.4535</td>
<td id="T_adee1_row1_col2" class="data row1 col2">1.8632</td>
<td id="T_adee1_row1_col3" class="data row1 col3">0.6740</td>
<td id="T_adee1_row1_col4" class="data row1 col4">1.3448</td>
</tr>
<tr class="odd">
<td id="T_adee1_row2_col0" class="data row2 col0">x_2</td>
<td id="T_adee1_row2_col1" class="data row2 col1">0.4490</td>
<td id="T_adee1_row2_col2" class="data row2 col2">0.6740</td>
<td id="T_adee1_row2_col3" class="data row2 col3">2.0374</td>
<td id="T_adee1_row2_col4" class="data row2 col4">1.2929</td>
</tr>
<tr class="even">
<td id="T_adee1_row3_col0" class="data row3 col0">x_3</td>
<td id="T_adee1_row3_col1" class="data row3 col1">0.2316</td>
<td id="T_adee1_row3_col2" class="data row3 col2">1.3448</td>
<td id="T_adee1_row3_col3" class="data row3 col3">1.2929</td>
<td id="T_adee1_row3_col4" class="data row3 col4">2.0978</td>
</tr>
</tbody>
</table>
</div>

 </div></div>
</div>
</div>
</section>
<section id="test-data" class="level3">
<h3 class="anchored" data-anchor-id="test-data">Test data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>reset_seed()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>data, mask, control <span class="op">=</span> get_test_data()</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>show_as_row(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">data</p> <pre>tensor([[[0.8775,    nan,    nan],
         [0.6706,    nan, 0.9272],
         [   nan, 0.4967,    nan],
         [   nan,    nan,    nan],
         [   nan,    nan, 0.4760],
         [0.7606, 0.7759, 0.5243],
         [0.3714, 0.0426, 0.2343],
         [0.9991, 0.1775,    nan],
         [0.6734,    nan, 0.6468],
         [0.5825, 0.4599, 0.7960]],

        [[0.9038, 0.9735, 0.6428],
         [0.3725, 0.2052,    nan],
         [0.4448, 0.5775, 0.7237],
         [0.5927,    nan, 0.6441],
         [   nan, 0.9132, 0.0329],
         [0.4856, 0.9927, 0.5895],
         [0.2611, 0.9413, 0.1371],
         [0.8726, 0.5590, 0.8451],
         [0.1253, 0.9434, 0.0462],
         [0.2360, 0.0239, 0.8950]]], dtype=torch.float64)
</pre> </div><div><p style="font-size: 1.2rem;">mask</p> <pre>tensor([[[ True, False, False],
         [ True, False,  True],
         [False,  True, False],
         [False, False, False],
         [False, False,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True, False],
         [ True, False,  True],
         [ True,  True,  True]],

        [[ True,  True,  True],
         [ True,  True, False],
         [ True,  True,  True],
         [ True, False,  True],
         [False,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True]]])
</pre> </div><div><p style="font-size: 1.2rem;">control</p> <pre>tensor([[[0.9201, 0.6883, 0.5342],
         [0.7847, 0.3137, 0.1778],
         [0.5838, 0.9799, 0.3611],
         [0.3155, 0.7475, 0.5450],
         [0.5641, 0.2493, 0.8323],
         [0.9723, 0.1883, 0.3605],
         [0.5344, 0.3443, 0.7696],
         [0.3410, 0.7553, 0.3177],
         [0.0315, 0.5209, 0.6514],
         [0.3131, 0.4510, 0.3550]],

        [[0.4790, 0.0676, 0.3606],
         [0.7299, 0.6713, 0.3134],
         [0.7460, 0.1291, 0.4653],
         [0.5693, 0.9906, 0.8288],
         [0.9039, 0.5240, 0.6277],
         [0.3574, 0.0076, 0.6530],
         [0.8667, 0.9368, 0.8667],
         [0.6749, 0.3526, 0.6618],
         [0.0837, 0.7188, 0.7247],
         [0.3211, 0.4898, 0.9030]]], dtype=torch.float64)
</pre> </div></div>
</div>
</div>
</section>
</section>
</section>
<section id="standard-kalman-filter" class="level1">
<h1>Standard Kalman Filter</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> KalmanFilter.init_random(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="filter" class="level2">
<h2 class="anchored" data-anchor-id="filter">Filter</h2>
<section id="filter-predict" class="level3">
<h3 class="anchored" data-anchor-id="filter-predict">Filter predict</h3>
<p>Probability of state at time <code>t</code> given state a time <code>t-1</code></p>
<p><span class="math inline">\(p(x_t) = \mathcal{N}(x_t; m_t^-, P_t^-)\)</span> where:</p>
<ul>
<li><p>predicted state mean: <span class="math inline">\(m_t^- = Am_{t-1} + B c_t + b\)</span></p></li>
<li><p>predicted state covariance: <span class="math inline">\(P_t^- = AP_{t-1}A^T + Q\)</span></p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>A, Q, b, B, m_pr,P_pr<span class="op">=</span> (k.A, k.Q, k.b, k.B,torch.concat([k.m0]<span class="op">*</span><span class="dv">2</span>), torch.concat([k.P0]<span class="op">*</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>m_pr.shape, P_pr.shape, A.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]), torch.Size([1, 4, 4]))</code></pre>
</div>
</div>
<section id="covariance" class="level4">
<h4 class="anchored" data-anchor-id="covariance">Covariance</h4>
<p>implement <span class="math inline">\(P_t^- = AP_{t-1}A^T + Q\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>P_m <span class="op">=</span> _filter_predict_cov_stand(A, Q, P_pr)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>P_m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[6.2873, 3.7655, 4.8718, 5.8589],
         [3.7655, 4.8551, 4.7314, 5.1009],
         [4.8718, 4.7314, 5.9373, 6.0160],
         [5.8589, 5.1009, 6.0160, 8.5954]],

        [[6.2873, 3.7655, 4.8718, 5.8589],
         [3.7655, 4.8551, 4.7314, 5.1009],
         [4.8718, 4.7314, 5.9373, 6.0160],
         [5.8589, 5.1009, 6.0160, 8.5954]]], dtype=torch.float64,
       grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
</section>
<section id="mean" class="level4">
<h4 class="anchored" data-anchor-id="mean">Mean</h4>
</section>
<section id="predict" class="level4">
<h4 class="anchored" data-anchor-id="predict">Predict</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>B.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([1, 4, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>control.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>B[<span class="dv">0</span>].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([4, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>B[<span class="dv">0</span>] <span class="op">@</span> control[<span class="dv">0</span>, <span class="dv">0</span>].unsqueeze(<span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[0.7217],
        [0.9572],
        [0.5742],
        [1.2138]], dtype=torch.float64, grad_fn=&lt;MmBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>m_m, P_m <span class="op">=</span> _filter_predict(</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    A, Q, b, B,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    m_pr,P_pr, control[:, <span class="dv">0</span>, :].unsqueeze(<span class="op">-</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>show_as_row(m_m, P_m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">m_m</p> <pre>tensor([[[2.4986],
         [2.2429],
         [1.8833],
         [3.6164]],

        [[2.1377],
         [1.5964],
         [1.5371],
         [2.8315]]], dtype=torch.float64, grad_fn=<addbackward0>)
</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">P_m</p> <pre>tensor([[[6.2873, 3.7655, 4.8718, 5.8589],
         [3.7655, 4.8551, 4.7314, 5.1009],
         [4.8718, 4.7314, 5.9373, 6.0160],
         [5.8589, 5.1009, 6.0160, 8.5954]],

        [[6.2873, 3.7655, 4.8718, 5.8589],
         [3.7655, 4.8551, 4.7314, 5.1009],
         [4.8718, 4.7314, 5.9373, 6.0160],
         [5.8589, 5.1009, 6.0160, 8.5954]]], dtype=torch.float64,
       grad_fn=<addbackward0>)
</addbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>(m_m.shape, P_m.shape,)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]))</code></pre>
</div>
</div>
</section>
</section>
<section id="filter-update" class="level3">
<h3 class="anchored" data-anchor-id="filter-update">Filter update</h3>
<p>Probability of state at time <code>t</code> given the observations at time <code>t</code></p>
<p><span class="math inline">\(p(x_t|y_t) = \mathcal{N}(x_t; m_t, P_t)\)</span> where:</p>
<ul>
<li><p>predicted obs mean: <span class="math inline">\(z_t = Hm_t^- + d\)</span></p></li>
<li><p>prediced obs covariance: <span class="math inline">\(S_t = HP_t^-H^T + R\)</span></p></li>
<li><p>kalman gain<span class="math inline">\(K_t = P_t^-H^TS_t^{-1}\)</span></p></li>
<li><p>corrected state mean: <span class="math inline">\(m_t = m_t^- + K_t(y_t - z_t)\)</span></p></li>
<li><p>corrected state covariance: <span class="math inline">\(P_t = (I-K_tH)P_t^-\)</span></p></li>
</ul>
<p>if the observation are missing this step is skipped and the corrected state is equal to the predicted state</p>
<p>Need to figure out the Nans for the gradients …</p>
<section id="kalman-gain" class="level4">
<h4 class="anchored" data-anchor-id="kalman-gain">Kalman Gain</h4>
<p>Don’t compute the inverse of the matrix, but use <code>cholesky_solve</code> to invert the matrix</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>H, d, R, obs <span class="op">=</span> k.H, k.d, k.R, data[:,<span class="dv">0</span>,:].unsqueeze(<span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> _filter_update_k_gain(H, R, P_m)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>K</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 0.1177,  0.2313,  0.0612],
         [-0.5573,  0.6582,  0.0288],
         [-0.3189,  0.5919, -0.0174],
         [ 0.3269,  0.3056, -0.0378]],

        [[ 0.1177,  0.2313,  0.0612],
         [-0.5573,  0.6582,  0.0288],
         [-0.3189,  0.5919, -0.0174],
         [ 0.3269,  0.3056, -0.0378]]], dtype=torch.float64,
       grad_fn=&lt;TransposeBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>test_close(_filter_update_k_gain(H, R, P_m), P_m <span class="op">@</span> H.mT <span class="op">@</span> torch.inverse(H <span class="op">@</span> P_m <span class="op">@</span> H.mT <span class="op">+</span> R))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="covariance-1" class="level4">
<h4 class="anchored" data-anchor-id="covariance-1">Covariance</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>P <span class="op">=</span> _filter_update_cov(H, K, P_m)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>P</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 2.1074, -0.2158,  0.3602,  0.1911],
         [-0.2158,  0.4808,  0.0472, -0.1503],
         [ 0.3602,  0.0472,  0.8035, -0.0177],
         [ 0.1911, -0.1503, -0.0177,  0.8448]],

        [[ 2.1074, -0.2158,  0.3602,  0.1911],
         [-0.2158,  0.4808,  0.0472, -0.1503],
         [ 0.3602,  0.0472,  0.8035, -0.0177],
         [ 0.1911, -0.1503, -0.0177,  0.8448]]], dtype=torch.float64,
       grad_fn=&lt;UnsafeViewBackward0&gt;)</code></pre>
</div>
</div>
</section>
<section id="mean-1" class="level4">
<h4 class="anchored" data-anchor-id="mean-1">Mean</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> H <span class="op">@</span> m_m <span class="op">+</span> d<span class="op">;</span> z</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>(obs <span class="op">-</span> z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[-3.3343],
         [    nan],
         [    nan]],

        [[-2.4181],
         [-5.0754],
         [-3.9145]]], dtype=torch.float64, grad_fn=&lt;SubBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> _filter_update_mean(H, d, K, m_m, obs)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[    nan],
         [    nan],
         [    nan],
         [    nan]],

        [[ 0.4396],
         [-0.5094],
         [-0.6276],
         [ 0.6379]]], dtype=torch.float64, grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>m, P <span class="op">=</span> _filter_update(H, d, R, m_m, P_m, obs)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>show_as_row(m, P)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>m.shape, P.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">m</p> <pre>tensor([[[    nan],
         [    nan],
         [    nan],
         [    nan]],

        [[ 0.4396],
         [-0.5094],
         [-0.6276],
         [ 0.6379]]], dtype=torch.float64, grad_fn=<addbackward0>)
</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">P</p> <pre>tensor([[[ 2.1074, -0.2158,  0.3602,  0.1911],
         [-0.2158,  0.4808,  0.0472, -0.1503],
         [ 0.3602,  0.0472,  0.8035, -0.0177],
         [ 0.1911, -0.1503, -0.0177,  0.8448]],

        [[ 2.1074, -0.2158,  0.3602,  0.1911],
         [-0.2158,  0.4808,  0.0472, -0.1503],
         [ 0.3602,  0.0472,  0.8035, -0.0177],
         [ 0.1911, -0.1503, -0.0177,  0.8448]]], dtype=torch.float64,
       grad_fn=<unsafeviewbackward0>)
</unsafeviewbackward0></pre> </div></div>
</div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]))</code></pre>
</div>
</div>
<p>there are <code>nan</code> in the output because there are <code>nan</code> in the observations</p>
<p>The next functions adds the support for missing obsevations by also using a mask</p>
</section>
<section id="missing-observations" class="level4">
<h4 class="anchored" data-anchor-id="missing-observations">Missing observations</h4>
<p>If all the observations at time <span class="math inline">\(t\)</span> are missing the correct step is skipped and the filtered state at time <span class="math inline">\(t\)</span> () is the same of the filtered state.</p>
<p>If only some observations are missing a variation of equation can be used.</p>
<p><span class="math inline">\(y^{ng}_t\)</span> is a vector containing the observations that are not missing at time <span class="math inline">\(t\)</span>.</p>
<p>It can be expressed as a linear transformation of <span class="math inline">\(y_t\)</span></p>
<p><span class="math display">\[ y^{ng}_t = My_t\]</span></p>
<p>where <span class="math inline">\(M\)</span> is a mask matrix that is used to select the subset of <span class="math inline">\(y_t\)</span> that is observed. <span class="math inline">\(M \in \mathbb{R}^{n_{ng} \times n}\)</span> and is made of columns which are made of all zeros but for an entry 1 at row corresponding to the non-missing observation. hence:</p>
<p><span class="math display">\[ p(y^{ng}_t) = \mathcal{N}(M\mu_{y_t},  M\Sigma_{y_t}M^T)\]</span></p>
<p>from which you can derive</p>
<p><span id="eq-filter-correct"><span class="math display">\[ p(y^{ng}_t|x_t) = p(MHx_t + Mb, MRM^T)  \tag{1}\]</span></span></p>
<p>Then the posterior <span class="math inline">\(p(x_t|y_t^{ng})\)</span> can be computed similarly of equation <span class="citation" data-cites="filter_correct">@filter_correct</span> as:</p>
<p><span id="eq-filter_correct_missing"><span class="math display">\[ p(x_t|y^{ng}_t) = \mathcal{N}(x_t; m_t, P_t)  \tag{2}\]</span></span></p>
<p>where:</p>
<ul>
<li>predicted obs mean: <span class="math inline">\(z_t = MHm_t^- + Md\)</span></li>
<li>predicted obs covariance: <span class="math inline">\(S_t = MHP_t^-(MH)^T + MRM^T\)</span></li>
<li>Kalman gain <span class="math inline">\(K_t = P_t^-(MH)^TS_t^{-1}\)</span></li>
<li>corrected state mean: <span class="math inline">\(m_t = m_t^- + K_t(My_t - z_t)\)</span></li>
<li>corrected state covariance: <span class="math inline">\(P_t = (I-K_tMH)P_t^-\)</span></li>
</ul>
<section id="details-implementation" class="level5">
<h5 class="anchored" data-anchor-id="details-implementation">Details implementation</h5>
<p>For the implementation the matrix multiplication <span class="math inline">\(MH\)</span> can be replaced with <code>H[m]</code> where <code>m</code> is the mask for the rows for <code>H</code> and <span class="math inline">\(MRM^T\)</span> with <code>R[m][:,m]</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>H, R, d,obs, mm <span class="op">=</span> k.H, k.R, k.d, data[:,<span class="dv">0</span>,:].unsqueeze(<span class="op">-</span><span class="dv">1</span>), mask[:,<span class="dv">0</span>,:].unsqueeze(<span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> torch.tensor([<span class="va">False</span>,<span class="va">True</span>,<span class="va">True</span>]) <span class="co"># mask batch</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> torch.tensor([[[<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>], <span class="co"># mask matrix</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>                  [<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>]]], dtype<span class="op">=</span>torch.float64)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>show_as_row(m, M, H, R)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">m</p> <pre>tensor([False,  True,  True])
</pre> </div><div><p style="font-size: 1.2rem;">M</p> <pre>tensor([[[0., 1., 0.],
         [0., 0., 1.]]], dtype=torch.float64)
</pre> </div><div><p style="font-size: 1.2rem;">H</p> <pre>Parameter containing:
tensor([[[0.1349, 0.0519, 0.1180, 0.9767],
         [0.1679, 0.8635, 0.3753, 0.9760],
         [0.2125, 0.8049, 0.2124, 0.6794]]], dtype=torch.float64,
       requires_grad=True)
</pre> </div><div><p style="font-size: 1.2rem;">R</p> <pre>tensor([[[1.6259, 1.1183, 0.8535],
         [1.1183, 1.2831, 0.9935],
         [0.8535, 0.9935, 2.4550]]], dtype=torch.float64,
       grad_fn=<unsafeviewbackward0>)
</unsafeviewbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>M <span class="op">@</span> M.mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[1., 0.],
         [0., 1.]]], dtype=torch.float64)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>M <span class="op">@</span> H, H[:, m]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[[0.1679, 0.8635, 0.3753, 0.9760],
          [0.2125, 0.8049, 0.2124, 0.6794]]], dtype=torch.float64,
        grad_fn=&lt;UnsafeViewBackward0&gt;),
 tensor([[[0.1679, 0.8635, 0.3753, 0.9760],
          [0.2125, 0.8049, 0.2124, 0.6794]]], dtype=torch.float64,
        grad_fn=&lt;IndexBackward0&gt;))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>M <span class="op">@</span> R <span class="op">@</span> M.mT, R[:,m][:,:,m]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[[1.2831, 0.9935],
          [0.9935, 2.4550]]], dtype=torch.float64,
        grad_fn=&lt;UnsafeViewBackward0&gt;),
 tensor([[[1.2831, 0.9935],
          [0.9935, 2.4550]]], dtype=torch.float64, grad_fn=&lt;IndexBackward0&gt;))</code></pre>
</div>
</div>
<p>By using partially missing observations <a href="https://mone27.github.io/meteo_imp/lib/kalman_filter.html#_filter_update"><code>_filter_update</code></a> cannot be easily batched as the shape of the intermediate variables depends on the number of observed variables. So the idea is to divide the batch in blocks that share the same number of variables missing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>mask_values, indices <span class="op">=</span> torch.unique(mask[:,<span class="dv">1</span>,:], dim<span class="op">=</span><span class="dv">0</span>, return_inverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>mask_values, indices</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[ True, False,  True],
         [ True,  True, False]]),
 tensor([0, 1]))</code></pre>
</div>
</div>
</section>
<section id="update-mask" class="level5">
<h5 class="anchored" data-anchor-id="update-mask">Update mask</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>mm <span class="op">=</span> mask[<span class="dv">0</span>,<span class="dv">0</span>,:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>H[:, mm].shape, d[:, mm].shape, R[:, mm][:, :,mm].shape, obs[:, mm].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([1, 1, 4]),
 torch.Size([1, 1, 1]),
 torch.Size([1, 1, 1]),
 torch.Size([2, 1, 1]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span>_filter_update_mask(H, d, R, m_m, P_m, obs, mask[<span class="dv">0</span>, <span class="dv">0</span>, :] ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[[0.7184],
         [0.7151],
         [0.0696],
         [1.1526]],

        [[0.8467],
         [0.4883],
         [0.2217],
         [1.0446]]], dtype=torch.float64, grad_fn=<addbackward0>)
</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[[2.3679, 0.4016, 0.8785, 0.4342],
         [0.4016, 1.9680, 1.3041, 0.4451],
         [0.8785, 1.3041, 1.8687, 0.4890],
         [0.4342, 0.4451, 0.4890, 1.0874]],

        [[2.3679, 0.4016, 0.8785, 0.4342],
         [0.4016, 1.9680, 1.3041, 0.4451],
         [0.8785, 1.3041, 1.8687, 0.4890],
         [0.4342, 0.4451, 0.4890, 1.0874]]], dtype=torch.float64,
       grad_fn=<unsafeviewbackward0>)
</unsafeviewbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>m, P <span class="op">=</span> _filter_update_mask(H, d, R, m_m, P_m, obs, mask[<span class="dv">0</span>, <span class="dv">0</span>, :] )</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>m.shape, P.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]))</code></pre>
</div>
</div>
</section>
<section id="update-mask-batch" class="level5">
<h5 class="anchored" data-anchor-id="update-mask-batch">Update mask batch</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>m, P <span class="op">=</span> _filter_update_mask_batch(H, d, R, m_m, P_m, obs, mask[:,<span class="dv">0</span>,:] )</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>show_as_row(m, P)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>m.shape, P.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">m</p> <pre>tensor([[[ 0.7184],
         [ 0.7151],
         [ 0.0696],
         [ 1.1526]],

        [[ 0.4396],
         [-0.5094],
         [-0.6276],
         [ 0.6379]]], dtype=torch.float64, grad_fn=<indexputbackward0>)
</indexputbackward0></pre> </div><div><p style="font-size: 1.2rem;">P</p> <pre>tensor([[[ 2.3679,  0.4016,  0.8785,  0.4342],
         [ 0.4016,  1.9680,  1.3041,  0.4451],
         [ 0.8785,  1.3041,  1.8687,  0.4890],
         [ 0.4342,  0.4451,  0.4890,  1.0874]],

        [[ 2.1074, -0.2158,  0.3602,  0.1911],
         [-0.2158,  0.4808,  0.0472, -0.1503],
         [ 0.3602,  0.0472,  0.8035, -0.0177],
         [ 0.1911, -0.1503, -0.0177,  0.8448]]], dtype=torch.float64,
       grad_fn=<indexputbackward0>)
</indexputbackward0></pre> </div></div>
</div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>m.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>) <span class="co"># check that pytorch can compute gradients with the whole batch and gradients aren't nan</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>H.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[-1.1769, -2.7620, -0.9158, -2.4954],
         [-2.0431,  0.8269,  0.5074, -1.5867],
         [ 0.1472,  0.0285,  0.1012,  0.0356]]], dtype=torch.float64)</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="filter-all" class="level3">
<h3 class="anchored" data-anchor-id="filter-all">Filter All</h3>
<p>The resursive version of the kalman filter is apperently breaking pytorch gradients calculations so a workaround is needed. During the loop the states are saved in a python list and then at the end they are combined back into a tensor. The last line of the function does:</p>
<ul>
<li>convert lists to tensors</li>
<li>correct order dimensions</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>filt_state, pred_state  <span class="op">=</span> k._filter_all(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>(ms, Ps), (m_ms, P_ms) <span class="op">=</span> filt_state, pred_state</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Predictions at time <code>0</code> for both batches</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(Self.shape(), (m_ms, P_ms, ms, Ps,)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([2, 10, 4, 1])
</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([2, 10, 4, 4])
</pre> </div><div><p style="font-size: 1.2rem;">#2</p> <pre>torch.Size([2, 10, 4, 1])
</pre> </div><div><p style="font-size: 1.2rem;">#3</p> <pre>torch.Size([2, 10, 4, 4])
</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(<span class="kw">lambda</span> x:x[<span class="dv">0</span>][<span class="dv">0</span>], (m_ms, P_ms, ms, Ps,)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[0.6498],
        [0.3257],
        [0.8462],
        [0.7727]], dtype=torch.float64, grad_fn=<selectbackward0>)
</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[0.7511, 0.6229, 0.6414, 0.4561],
        [0.6229, 1.2138, 0.6974, 0.9224],
        [0.6414, 0.6974, 1.4388, 1.4051],
        [0.4561, 0.9224, 1.4051, 3.1638]], dtype=torch.float64,
       grad_fn=<selectbackward0>)
</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;">#2</p> <pre>tensor([[0.6392],
        [0.3073],
        [0.8191],
        [0.7180]], dtype=torch.float64, grad_fn=<selectbackward0>)
</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;">#3</p> <pre>tensor([[0.6695, 0.4821, 0.4340, 0.0368],
        [0.4821, 0.9707, 0.3394, 0.1987],
        [0.4340, 0.3394, 0.9115, 0.3391],
        [0.0368, 0.1987, 0.3391, 1.0092]], dtype=torch.float64,
       grad_fn=<selectbackward0>)
</selectbackward0></pre> </div></div>
</div>
</div>
</section>
<section id="filter-1" class="level3">
<h3 class="anchored" data-anchor-id="filter-1">Filter</h3>
<p>The filter methods wraps <code>_filter_all</code> but in addition:</p>
<ul>
<li>returns only filtered state</li>
<li>remove last dimensions from mean</li>
</ul>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L422" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter.filter" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.filter">KalmanFilter.filter</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.filter (obs:torch.Tensor, mask:torch.Tensor,
                      control:torch.Tensor)</code></pre>
</blockquote>
<p>Filter observation</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>obs</td>
<td>Tensor</td>
<td><code>([n_batches], n_obs, [self.n_dim_obs])</code> where <code>n_batches</code> and <code>n_dim_obs</code> dimensions can be omitted if 1</td>
</tr>
<tr class="even">
<td>mask</td>
<td>Tensor</td>
<td><code>([n_batches], n_obs, [self.n_dim_obs])</code> where <code>n_batches</code> and <code>n_dim_obs</code> dimensions can be omitted if 1</td>
</tr>
<tr class="odd">
<td>control</td>
<td>Tensor</td>
<td>([n_batches], n_obs, [self.n_dim_contr])</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ListMultiNormal</strong></td>
<td><strong>Filtered state (n_batches, n_obs, self.n_dim_state)</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>filt <span class="op">=</span> k.<span class="bu">filter</span>(data, mask, control)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>filt.mean.shape, filt.cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 10, 4, 1]), torch.Size([2, 10, 4, 4]))</code></pre>
</div>
</div>
</section>
</section>
<section id="smooth" class="level2">
<h2 class="anchored" data-anchor-id="smooth">Smooth</h2>
<section id="smooth-update-step" class="level3">
<h3 class="anchored" data-anchor-id="smooth-update-step">Smooth update step</h3>
<p>compute the probability of the state at time <code>t</code> given all the observations</p>
<p><span class="math inline">\(p(x_t|Y) = \mathcal{N}(x_t; m_t^s, P_t^s)\)</span> where:</p>
<ul>
<li>Kalman smoothing gain: <span class="math inline">\(G_t = P_tA^T(P_{t+1}^-)^{-1}\)</span></li>
<li>smoothed mean: <span class="math inline">\(m_t^s = m_t + G_t(m_{t+1}^s - m_{t+1}^-)\)</span></li>
<li>smoothed covariance: <span class="math inline">\(P_t^s = P_t + G_t(P_{t+1}^s - P_{t+1}^-)G_t^T\)</span></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>test_close(_smooth_gain(A, filt_state.cov, pred_state.cov), filt_state.cov <span class="op">@</span> A.mT <span class="op">@</span> torch.inverse(pred_state.cov))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>K_p <span class="op">=</span> _smooth_gain(A, filt_state[:,<span class="dv">0</span>].cov, pred_state[:,<span class="dv">0</span>].cov)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>K_p.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 4, 4])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>_smooth_mean(K_p, filt_state[:,<span class="dv">0</span>].mean, pred_state[:,<span class="dv">0</span>].mean, filt_state[:,<span class="dv">0</span>].mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 0.6254],
         [ 0.2922],
         [ 0.7965],
         [ 0.6964]],

        [[-0.1829],
         [-0.7088],
         [-0.0211],
         [ 0.2570]]], dtype=torch.float64, grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>_smooth_cov(K_p, filt_state[:,<span class="dv">0</span>].cov, pred_state[:,<span class="dv">0</span>].cov, filt_state[:,<span class="dv">0</span>].cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 0.5327,  0.3321,  0.2094, -0.1773],
         [ 0.3321,  0.8061,  0.0930, -0.0363],
         [ 0.2094,  0.0930,  0.5427, -0.0125],
         [-0.1773, -0.0363, -0.0125,  0.6738]],

        [[ 0.3342,  0.0671,  0.0652, -0.2001],
         [ 0.0671,  0.3478, -0.1115, -0.1245],
         [ 0.0652, -0.1115,  0.4549, -0.0025],
         [-0.2001, -0.1245, -0.0025,  0.6981]]], dtype=torch.float64,
       grad_fn=&lt;DivBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span>_smooth_update(A, filt_state[:, <span class="dv">0</span>], pred_state[:, <span class="dv">0</span>], filt_state[:, <span class="dv">0</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[[ 0.6254],
         [ 0.2922],
         [ 0.7965],
         [ 0.6964]],

        [[-0.1829],
         [-0.7088],
         [-0.0211],
         [ 0.2570]]], dtype=torch.float64, grad_fn=<addbackward0>)
</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[[ 0.5327,  0.3321,  0.2094, -0.1773],
         [ 0.3321,  0.8061,  0.0930, -0.0363],
         [ 0.2094,  0.0930,  0.5427, -0.0125],
         [-0.1773, -0.0363, -0.0125,  0.6738]],

        [[ 0.3342,  0.0671,  0.0652, -0.2001],
         [ 0.0671,  0.3478, -0.1115, -0.1245],
         [ 0.0652, -0.1115,  0.4549, -0.0025],
         [-0.2001, -0.1245, -0.0025,  0.6981]]], dtype=torch.float64,
       grad_fn=<divbackward0>)
</divbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(Self.shape(), _smooth_update(A, MNormal(m_m, P_m), MNormal(m_m, P_m), MNormal(m_m, P_m))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([2, 4, 1])
</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([2, 4, 4])
</pre> </div></div>
</div>
</div>
</section>
<section id="smooth-1" class="level3">
<h3 class="anchored" data-anchor-id="smooth-1">Smooth</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>smooth_state <span class="op">=</span> _smooth(k.A,  filt_state, pred_state)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smooth_state.mean[<span class="dv">0</span>][<span class="dv">0</span>], smooth_state.cov[<span class="dv">0</span>][<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[-0.0785],
        [-0.5839],
        [-0.0959],
        [ 0.0031]], dtype=torch.float64, grad_fn=<selectbackward0>)
</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[ 0.4578,  0.2300,  0.1755, -0.1481],
        [ 0.2300,  0.6676,  0.0346, -0.0171],
        [ 0.1755,  0.0346,  0.5665,  0.0642],
        [-0.1481, -0.0171,  0.0642,  0.7652]], dtype=torch.float64,
       grad_fn=<selectbackward0>)
</selectbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smooth_state.mean.shape, smooth_state.cov.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([2, 10, 4, 1])
</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([2, 10, 4, 4])
</pre> </div></div>
</div>
</div>
</section>
<section id="kalmanfilter-method" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter-method">KalmanFilter method</h3>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L493" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter.smooth" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.smooth">KalmanFilter.smooth</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.smooth (obs:torch.Tensor, mask:torch.Tensor,
                      control:torch.Tensor)</code></pre>
</blockquote>
<p>Kalman Filter Smoothing</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>obs</td>
<td>Tensor</td>
<td></td>
</tr>
<tr class="even">
<td>mask</td>
<td>Tensor</td>
<td></td>
</tr>
<tr class="odd">
<td>control</td>
<td>Tensor</td>
<td></td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ListMultiNormal</strong></td>
<td><strong><code>[n_timesteps, n_dim_state]</code> smoothed state</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>smoothed_state <span class="op">=</span> k.smooth(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smoothed_state.mean.shape, smoothed_state.cov.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([2, 10, 4, 1])
</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([2, 10, 4, 4])
</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>smoothed_state.mean.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>A.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[-4.9495, -5.2939, -7.8642,  0.2546],
         [ 0.2445,  8.3747, 13.5693, -7.4543],
         [-5.4811, -5.2497, -6.6092, -1.5187],
         [-1.5874,  2.1945,  3.6410, -2.3143]]], dtype=torch.float64)</code></pre>
</div>
</div>
</section>
</section>
<section id="predict-1" class="level2">
<h2 class="anchored" data-anchor-id="predict-1">Predict</h2>
<p>The prediction at time t (<span class="math inline">\(y_t\)</span>) are computed rom the state (<span class="math inline">\(x_t\)</span>) using this formula: <span class="math display">\[p(y_t|x_t) = \mathcal{N}(Hx_t + d, R + HP^s_tH^T)\]</span></p>
<p>this works both if the state was filtered or smoother</p>
<p>This add the supports for conditional predictions, which means that at the time (t) when we are making the predictions some of the variables have been actually observed. Since the model prediction is a normal distribution we can condition on the observed values and thus improve the predictions. See <code>conditional_gaussian</code></p>
<p>In order to have conditional predictions that make sense it’s not possible to return the full covariance matrix for the predictions but only the standard deviations</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>test_m <span class="op">=</span> torch.tensor(</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>    [[<span class="va">True</span>, <span class="va">True</span>, <span class="va">True</span>,],</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>    [<span class="va">False</span>, <span class="va">True</span>, <span class="va">True</span>],</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    [<span class="va">False</span>, <span class="va">False</span>, <span class="va">False</span>]]</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>torch.logical_xor(test_m.<span class="bu">all</span>(<span class="op">-</span><span class="dv">1</span>), test_m.<span class="bu">any</span>(<span class="op">-</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([False,  True, False])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> torch.rand(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>(A <span class="op">@</span> A).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 2, 3, 3])</code></pre>
</div>
</div>
<p>predict can be vectorized across both the batch and the timesteps, except for timesteps that require conditional predictions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>smoothed_state.mean.shape, smoothed_state.cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 10, 4, 1]), torch.Size([2, 10, 4, 4]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>(k.H <span class="op">@</span> smoothed_state.mean).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10, 3, 1])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>pred_obs0 <span class="op">=</span> k._obs_from_state(smoothed_state)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>pred_obs0.mean.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>pred_obs0.cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10, 3, 3])</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L552" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="kalmanfilter.predict" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.predict">KalmanFilter.predict</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.predict (obs, mask, control, smooth=True)</code></pre>
</blockquote>
<p>Predicted observations at all times</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> k.predict(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>pred.mean.shape, pred.std.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 10, 3]), torch.Size([2, 10, 3]))</code></pre>
</div>
</div>
<p>Gradients …</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_grad_mask(x):</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"filter gradient after sub the masks value with x"</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> data.clone()</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    d[<span class="op">~</span>mask] <span class="op">=</span> x</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>    k.predict(data, mask, control).mean.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    grad <span class="op">=</span> k.R_raw.grad.clone()</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>    k.zero_grad() </span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>get_grad_mask(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ -2.5082,   0.0000,   0.0000],
         [-11.7667,  -0.1206,   0.0000],
         [ -7.6345,  -8.3390,  -4.0905]]], dtype=torch.float64)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>test_close(get_grad_mask(<span class="dv">1</span>), get_grad_mask(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L552" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter.predict-1" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.predict-1">KalmanFilter.predict</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.predict (obs, mask, control, smooth=True)</code></pre>
</blockquote>
<p>Predicted observations at all times</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_times(<span class="va">self</span>: KalmanFilter, times, obs, mask<span class="op">=</span><span class="va">None</span>, smooth<span class="op">=</span><span class="va">True</span>, check_args<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Predicted observations at specific times """</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    state <span class="op">=</span> <span class="va">self</span>.smooth(obs, mask, check_args) <span class="cf">if</span> smooth <span class="cf">else</span> <span class="va">self</span>.<span class="bu">filter</span>(obs, mask, check_args)</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    obs, mask <span class="op">=</span> <span class="va">self</span>._parse_obs(obs, mask)</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    times <span class="op">=</span> array1d(times)</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>    n_timesteps <span class="op">=</span> obs.shape[<span class="dv">0</span>]</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>    n_features <span class="op">=</span> obs.shape[<span class="dv">1</span>] <span class="cf">if</span> <span class="bu">len</span>(obs.shape) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> times.<span class="bu">max</span>() <span class="op">&gt;</span> n_timesteps <span class="kw">or</span> times.<span class="bu">min</span>() <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"provided times range from </span><span class="sc">{</span>times<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>times<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">, which is outside allowed range : 0 to </span><span class="sc">{</span>n_timesteps<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>    means <span class="op">=</span> torch.empty((times.shape[<span class="dv">0</span>], n_features), dtype<span class="op">=</span>obs.dtype, device<span class="op">=</span>obs.device)</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>    stds <span class="op">=</span> torch.empty((times.shape[<span class="dv">0</span>], n_features), dtype<span class="op">=</span>obs.dtype, device<span class="op">=</span>obs.device) </span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, t <span class="kw">in</span> <span class="bu">enumerate</span>(times):</span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>        mean, std <span class="op">=</span> <span class="va">self</span>._obs_from_state(</span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>            state.mean[t],</span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>            state.cov[t],</span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'t'</span>: t, <span class="op">**</span>check_args} <span class="cf">if</span> check_args <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a>        means[i], stds[i] <span class="op">=</span> _get_cond_pred(ListNormal(mean, std), obs[t], mask[t])</span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ListNormal(means, stds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="numerical-stable-kalman-filter-square-root-filter" class="level1">
<h1>Numerical Stable Kalman Filter (Square Root Filter)</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>kSR <span class="op">=</span> KalmanFilterSR.init_random(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="filter-2" class="level2">
<h2 class="anchored" data-anchor-id="filter-2">Filter</h2>
<section id="filter-predict-1" class="level3">
<h3 class="anchored" data-anchor-id="filter-predict-1">Filter predict</h3>
<section id="covariance-2" class="level4">
<h4 class="anchored" data-anchor-id="covariance-2">Covariance</h4>
<p>Implement the numerical stable version of the covariance update</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>A, Q, b, B, m_pr,P_pr<span class="op">=</span> (k.A, k.Q, k.b, k.B,torch.concat([k.m0]<span class="op">*</span><span class="dv">2</span>), torch.concat([k.P0]<span class="op">*</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>Q_C <span class="op">=</span> kSR.Q_C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>_filter_predict_cov_stand(kSR.A, kSR.Q_C <span class="op">@</span> kSR.Q_C.mT, P_pr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[1.9504, 2.3535, 2.1727, 2.2936],
         [2.3535, 5.8436, 5.0464, 6.0831],
         [2.1727, 5.0464, 6.2940, 6.0969],
         [2.2936, 6.0831, 6.0969, 8.1538]],

        [[1.9504, 2.3535, 2.1727, 2.2936],
         [2.3535, 5.8436, 5.0464, 6.0831],
         [2.1727, 5.0464, 6.2940, 6.0969],
         [2.2936, 6.0831, 6.0969, 8.1538]]], dtype=torch.float64,
       grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>P_pr_C <span class="op">=</span> torch.linalg.cholesky(P_pr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><span class="math display">\[W = \begin{bmatrix}AC_{t-1}&amp;C_Q\end{bmatrix}\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> torch.concat([A <span class="op">@</span> P_pr_C, Q_C.expand_as(P_pr_C)], dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>W.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 4, 8])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>P_m_C <span class="op">=</span> torch.linalg.qr(W.mT).R.mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>P_m_C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[-2.5709,  0.0000,  0.0000,  0.0000],
         [-1.7904,  1.1590,  0.0000,  0.0000],
         [-1.9907,  1.3402,  1.2995,  0.0000],
         [-2.2985,  0.5614,  0.8125, -1.0728]],

        [[-2.5709,  0.0000,  0.0000,  0.0000],
         [-1.7904,  1.1590,  0.0000,  0.0000],
         [-1.9907,  1.3402,  1.2995,  0.0000],
         [-2.2985,  0.5614,  0.8125, -1.0728]]], dtype=torch.float64,
       grad_fn=&lt;TransposeBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>P_m_C <span class="op">@</span> P_m_C.mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[6.6096, 4.6031, 5.1178, 5.9093],
         [4.6031, 4.5489, 5.1174, 4.7660],
         [5.1178, 5.1174, 7.4476, 6.3838],
         [5.9093, 4.7660, 6.3838, 7.4094]],

        [[6.6096, 4.6031, 5.1178, 5.9093],
         [4.6031, 4.5489, 5.1174, 4.7660],
         [5.1178, 5.1174, 7.4476, 6.3838],
         [5.9093, 4.7660, 6.3838, 7.4094]]], dtype=torch.float64,
       grad_fn=&lt;UnsafeViewBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>P_m <span class="op">=</span> _filter_predict_cov_stand(A, Q_C <span class="op">@</span> Q_C.mT, P_pr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>test_close(P_m, P_m_C <span class="op">@</span> P_m_C.mT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>(P_m <span class="op">-</span> P_m_C <span class="op">@</span> P_m_C.mT).<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(8.8818e-16, dtype=torch.float64, grad_fn=&lt;MaxBackward1&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>test_P_m_C <span class="op">=</span> torch.linalg.cholesky(P_m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>(test_P_m_C <span class="op">@</span> test_P_m_C.mT <span class="op">-</span> P_m_C <span class="op">@</span> P_m_C.mT).<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(8.8818e-16, dtype=torch.float64, grad_fn=&lt;MaxBackward1&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>(test_P_m_C <span class="op">-</span> P_m_C).<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(5.1418, dtype=torch.float64, grad_fn=&lt;MaxBackward1&gt;)</code></pre>
</div>
</div>
<p>Cholesky decomposition is not unique! but the solution is correct</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>P_m_C <span class="op">=</span> _filter_predict_cov_SR(A, Q_C, P_pr_C)</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>test_close(P_m_C <span class="op">@</span> P_m_C.mT, _filter_predict_cov_stand(A, Q_C <span class="op">@</span> Q_C.mT, P_pr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzz_filter_predict_cov_SR(n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>        kSR <span class="op">=</span> KalmanFilterSR.init_random(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">4</span>)</span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>        A, Q_C, b, B, m_pr,P_pr <span class="op">=</span> (kSR.A.unsqueeze(<span class="dv">0</span>), kSR.Q_C.unsqueeze(<span class="dv">0</span>), kSR.b.unsqueeze(<span class="op">-</span><span class="dv">1</span>),</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>                                                  kSR.B.unsqueeze(<span class="dv">0</span>),</span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>                                                  torch.stack([kSR.m0]<span class="op">*</span><span class="dv">2</span>).unsqueeze(<span class="op">-</span><span class="dv">1</span>),</span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>                                                  torch.stack([kSR.P0]<span class="op">*</span><span class="dv">2</span>))</span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>        P_pr_C <span class="op">=</span> torch.linalg.cholesky(P_pr)</span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>        P_m_C <span class="op">=</span> _filter_predict_cov_SR(A, Q_C, P_pr_C)</span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a>        test_close(P_m_C <span class="op">@</span> P_m_C.mT, _filter_predict_cov_stand(A, Q_C <span class="op">@</span> Q_C.mT, P_pr), eps<span class="op">=</span><span class="fl">5e-13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>fuzz_filter_predict_cov_SR()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="predict-2" class="level4">
<h4 class="anchored" data-anchor-id="predict-2">Predict</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>m_m, P_m_C <span class="op">=</span> _filter_predict_SR(kSR.A, kSR.Q_C, kSR.b, kSR.B, m_pr, P_pr_C, control[:,<span class="dv">0</span>].unsqueeze(<span class="op">-</span><span class="dv">1</span>)) </span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>show_as_row(m_m, P_m_C)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">m_m</p> <pre>tensor([[[1.9549],
         [2.4811],
         [3.3275],
         [3.5545]],

        [[1.1647],
         [2.3109],
         [2.4892],
         [2.8133]]], dtype=torch.float64, grad_fn=<addbackward0>)
</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">P_m_C</p> <pre>tensor([[[-1.3966,  0.0000,  0.0000,  0.0000],
         [-1.6852, -1.7331,  0.0000,  0.0000],
         [-1.5557, -1.3991,  1.3843,  0.0000],
         [-1.6423, -1.9130,  0.6253, -1.1858]],

        [[-1.3966,  0.0000,  0.0000,  0.0000],
         [-1.6852, -1.7331,  0.0000,  0.0000],
         [-1.5557, -1.3991,  1.3843,  0.0000],
         [-1.6423, -1.9130,  0.6253, -1.1858]]], dtype=torch.float64,
       grad_fn=<transposebackward0>)
</transposebackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>is_posdef(P_m_C <span class="op">@</span> P_m_C.mT).<span class="bu">all</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(True)</code></pre>
</div>
</div>
</section>
</section>
<section id="filter-update-1" class="level3">
<h3 class="anchored" data-anchor-id="filter-update-1">Filter Update</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_sr(x_C, x): <span class="cf">return</span> torch.allclose(x_C <span class="op">@</span> x_C.mT, x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L592" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="cat_2d" class="level3">
<h3 class="anchored" data-anchor-id="cat_2d">cat_2d</h3>
<blockquote class="blockquote">
<pre><code> cat_2d (x)</code></pre>
</blockquote>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>x</td>
<td>matrix as list of list of Tensor</td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> [[]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="example-calculations" class="level4">
<h4 class="anchored" data-anchor-id="example-calculations">Example calculations</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>H, R, R_C, obs <span class="op">=</span> kSR.H, kSR.R, kSR.R_C, data[:,<span class="dv">0</span>,:].unsqueeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>P_m <span class="op">=</span> P_m_C <span class="op">@</span> P_m_C.mT</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a><span class="co"># use standard filter to compute expected result</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>S <span class="op">=</span> H <span class="op">@</span> P_m <span class="op">@</span> H.mT <span class="op">+</span> R</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>S_C <span class="op">=</span> torch.linalg.cholesky(S)</span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> _filter_update_k_gain(H, R, P_m)</span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>K_bar <span class="op">=</span> K <span class="op">@</span> S_C</span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>P_stand <span class="op">=</span> _filter_update_cov(H, K, P_m)</span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>P_C_stand <span class="op">=</span> torch.linalg.cholesky(P_stand)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">all</span>([is_sr(R_C, R), is_sr(S_C, S)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><span class="math display">\[M = \begin{bmatrix} R^{1/2} &amp; H(P^-)^{1/2} \\ 0 &amp; (P^-)^{1/2} \end{bmatrix}\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> cat_2d([[R_C.expand(<span class="dv">2</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>)              , H <span class="op">@</span> P_m_C], </span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>            [torch.zeros_like((H <span class="op">@</span> P_m_C).mT),  P_m_C]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>M[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[ 1.2478,  0.0000,  0.0000, -1.2662, -1.1753,  0.7242, -0.3448],
        [ 0.3190,  1.2801,  0.0000, -2.1349, -1.5926,  1.0952, -0.3843],
        [ 0.0341,  0.9601,  0.7766, -3.2461, -2.1290,  0.8250, -0.5179],
        [ 0.0000,  0.0000,  0.0000, -1.3966,  0.0000,  0.0000,  0.0000],
        [ 0.0000,  0.0000,  0.0000, -1.6852, -1.7331,  0.0000,  0.0000],
        [ 0.0000,  0.0000,  0.0000, -1.5557, -1.3991,  1.3843,  0.0000],
        [ 0.0000,  0.0000,  0.0000, -1.6423, -1.9130,  0.6253, -1.1858]],
       dtype=torch.float64, grad_fn=&lt;SelectBackward0&gt;)</code></pre>
</div>
</div>
<p><span class="math display">\[V = \begin{bmatrix} S^{1/2} &amp; 0 \\ \bar{K} &amp; P^{1/2} \end{bmatrix}\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co"># V from standard filter</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>V_stand <span class="op">=</span> cat_2d([[S_C,   torch.zeros_like(K_bar.mT)],</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>                  [K_bar, P_C_stand]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>V_stand[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[ 2.2770,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
        [ 2.5904,  1.8631,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
        [ 3.2634,  2.2593,  1.3379,  0.0000,  0.0000,  0.0000,  0.0000],
        [ 0.7766,  0.5205,  0.6151,  0.8355,  0.0000,  0.0000,  0.0000],
        [ 1.8316,  0.8659,  0.9168, -0.1000,  0.9427,  0.0000,  0.0000],
        [ 2.0275,  0.9734,  0.2654, -0.0859,  0.2527,  1.0461,  0.0000],
        [ 2.2790,  0.9606,  0.6923, -0.4813,  0.4183,  0.2013,  1.0540]],
       dtype=torch.float64, grad_fn=&lt;SelectBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>test_close(M <span class="op">@</span> M.mT, V_stand <span class="op">@</span> V_stand.mT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>V_sr <span class="op">=</span> torch.linalg.qr(M.mT).R.mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>V_sr[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[-2.2770,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
        [-2.5904, -1.8631,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
        [-3.2634, -2.2593, -1.3379,  0.0000,  0.0000,  0.0000,  0.0000],
        [-0.7766, -0.5205, -0.6151,  0.8355,  0.0000,  0.0000,  0.0000],
        [-1.8316, -0.8659, -0.9168, -0.1000,  0.9427,  0.0000,  0.0000],
        [-2.0275, -0.9734, -0.2654, -0.0859,  0.2527, -1.0461,  0.0000],
        [-2.2790, -0.9606, -0.6923, -0.4813,  0.4183, -0.2013, -1.0540]],
       dtype=torch.float64, grad_fn=&lt;SelectBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>test_close(V_sr <span class="op">@</span> V_sr.mT, V_stand <span class="op">@</span> V_stand.mT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>n_dim_obs <span class="op">=</span> R_C.shape[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>P_C <span class="op">=</span> V_sr[:, n_dim_obs:, n_dim_obs:]</span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>P_C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 0.8355,  0.0000,  0.0000,  0.0000],
         [-0.1000,  0.9427,  0.0000,  0.0000],
         [-0.0859,  0.2527, -1.0461,  0.0000],
         [-0.4813,  0.4183, -0.2013, -1.0540]],

        [[ 0.8355,  0.0000,  0.0000,  0.0000],
         [-0.1000,  0.9427,  0.0000,  0.0000],
         [-0.0859,  0.2527, -1.0461,  0.0000],
         [-0.4813,  0.4183, -0.2013, -1.0540]]], dtype=torch.float64,
       grad_fn=&lt;SliceBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>is_sr(P_C, P_stand)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>True</code></pre>
</div>
</div>
<p><span class="math inline">\(P_C\)</span> computed with the QR decomposition is not the same from the cholesky decomposition, but that’s okay! They are all valid square roots of the posterior covariance</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>(P_C <span class="op">==</span> P_C_stand).<span class="bu">all</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(False)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>(H <span class="op">@</span> P_m_C).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 3, 4])</code></pre>
</div>
</div>
</section>
<section id="covariance-3" class="level4">
<h4 class="anchored" data-anchor-id="covariance-3">Covariance</h4>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L596" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="tensor_info" class="level3">
<h3 class="anchored" data-anchor-id="tensor_info">tensor_info</h3>
<blockquote class="blockquote">
<pre><code> tensor_info (x)</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>P_C, S_C <span class="op">=</span> _filter_update_cov_SR(kSR.H, kSR.R_C, P_m_C)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzz_filter_update_cov_SR(n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>    errs <span class="op">=</span> []</span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>        kSR <span class="op">=</span> KalmanFilterSR.init_random(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">4</span>)</span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>        H, R_C, P_m <span class="op">=</span> (kSR.H, kSR.R_C, torch.cat([kSR.P0]<span class="op">*</span><span class="dv">5</span>))</span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>        R <span class="op">=</span> R_C <span class="op">@</span> R_C.mT</span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a>        P_m_C <span class="op">=</span> torch.linalg.cholesky(P_m)</span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a>        P_C, _ <span class="op">=</span> _filter_update_cov_SR(H, R_C, P_m_C)</span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a>        K <span class="op">=</span> _filter_update_k_gain(H, R, P_m)</span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a>        P_stand <span class="op">=</span> _filter_update_cov(H, K, P_m)</span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a>        errs.append((P_C <span class="op">@</span> P_C.mT <span class="op">-</span>  P_stand).<span class="bu">abs</span>().<span class="bu">max</span>().item())</span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.tensor(errs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>err <span class="op">=</span> fuzz_filter_update_cov_SR(<span class="dv">100</span>)</span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> err.<span class="bu">max</span>() <span class="op">&lt;</span> torch.tensor(<span class="fl">1e-10</span>)</span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>err.median(), err.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor(2.8588e-15), tensor(1.0214e-14))</code></pre>
</div>
</div>
<section id="kalman-gain-1" class="level4">
<h4 class="anchored" data-anchor-id="kalman-gain-1">Kalman Gain</h4>
<p>Don’t compute the inverse of the matrix, but use <code>cholesky_solve</code> to invert the matrix</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>S <span class="op">=</span> kSR.H <span class="op">@</span> P_m_C <span class="op">@</span> P_m_C.mT <span class="op">@</span> kSR.H.mT <span class="op">+</span> kSR.R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>test_close(kSR.R, kSR.R_C <span class="op">@</span> kSR.R_C.mT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>test_close(S_C <span class="op">@</span> S_C.mT, S)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>_filter_update_k_gain_SR(H, P_m_C, S_C)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[-0.0014, -0.2782,  0.4598],
         [ 0.2389, -0.3662,  0.6852],
         [ 0.2854,  0.2819,  0.1984],
         [ 0.3866, -0.1119,  0.5174]],

        [[-0.0014, -0.2782,  0.4598],
         [ 0.2389, -0.3662,  0.6852],
         [ 0.2854,  0.2819,  0.1984],
         [ 0.3866, -0.1119,  0.5174]]], dtype=torch.float64,
       grad_fn=&lt;TransposeBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>test_close(_filter_update_k_gain(H, R, P_m), _filter_update_k_gain_SR(H, P_m_C, S_C))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzz_kalman_gain_SR(n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>    errs <span class="op">=</span> []</span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>        kSR <span class="op">=</span> KalmanFilterSR.init_random(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">4</span>)</span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>        H, R_C, P_m <span class="op">=</span> (kSR.H, kSR.R_C, torch.cat([kSR.P0]<span class="op">*</span><span class="dv">5</span>))</span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>        R <span class="op">=</span> R_C <span class="op">@</span> R_C.mT</span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a>        P_m_C <span class="op">=</span> torch.linalg.cholesky(P_m)</span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a>        P_C, S_C <span class="op">=</span> _filter_update_cov_SR(H, R_C, P_m_C)</span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>        K_stand <span class="op">=</span> _filter_update_k_gain(H, R, P_m)</span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a>        K <span class="op">=</span> _filter_update_k_gain_SR(H, P_m_C, S_C)</span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>        errs.append((K_stand <span class="op">-</span> K).<span class="bu">abs</span>().<span class="bu">max</span>().item())</span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.tensor(errs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>err <span class="op">=</span> fuzz_kalman_gain_SR(<span class="dv">100</span>)</span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> err.<span class="bu">max</span>() <span class="op">&lt;</span> torch.tensor(<span class="fl">1e-10</span>)</span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>err.median(), err.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor(4.5797e-15), tensor(2.5202e-14))</code></pre>
</div>
</div>
</section>
<section id="measurement-update" class="level4">
<h4 class="anchored" data-anchor-id="measurement-update">Measurement update</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>m, P_C <span class="op">=</span> _filter_update_SR(H, d, R_C, m_m, P_m_C, obs)</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>show_as_row(m, P_C)</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>m.shape, P_C.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">m</p> <pre>tensor([[[   nan],
         [   nan],
         [   nan],
         [   nan]],

        [[0.1197],
         [0.3457],
         [0.5033],
         [0.6044]]], dtype=torch.float64, grad_fn=<addbackward0>)
</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">P_C</p> <pre>tensor([[[ 0.8355,  0.0000,  0.0000,  0.0000],
         [-0.1000,  0.9427,  0.0000,  0.0000],
         [-0.0859,  0.2527, -1.0461,  0.0000],
         [-0.4813,  0.4183, -0.2013, -1.0540]],

        [[ 0.8355,  0.0000,  0.0000,  0.0000],
         [-0.1000,  0.9427,  0.0000,  0.0000],
         [-0.0859,  0.2527, -1.0461,  0.0000],
         [-0.4813,  0.4183, -0.2013, -1.0540]]], dtype=torch.float64,
       grad_fn=<slicebackward0>)
</slicebackward0></pre> </div></div>
</div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>get_test_data(<span class="dv">1</span>, <span class="dv">5</span>,<span class="dv">4</span>, bs<span class="op">=</span><span class="dv">1</span>)[<span class="dv">1</span>].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([1, 1, 5])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzz_filter_update_SR(n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>    errs <span class="op">=</span> {<span class="st">'mean'</span>: [], <span class="st">'cov'</span>: []}</span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>        kSR <span class="op">=</span> KalmanFilterSR.init_random(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">4</span>)</span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>        H, d, R, R_C, m_m, P_m <span class="op">=</span> (kSR.H, kSR.d, kSR.R, kSR.R_C, torch.cat([kSR.m0]<span class="op">*</span><span class="dv">5</span>), torch.cat([kSR.P0]<span class="op">*</span><span class="dv">5</span>))</span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>        obs <span class="op">=</span> torch.randn_like(H <span class="op">@</span> m_m)</span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>        P_m_C <span class="op">=</span> torch.linalg.cholesky(P_m)</span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>        mSR, P_m_C <span class="op">=</span> _filter_update_SR(H, d, R_C, m_m, P_m_C, obs)</span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>        m, P_C <span class="op">=</span> _filter_update(H, d, R, m_m, P_m, obs)</span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a>        errs[<span class="st">'mean'</span>].append((mSR <span class="op">-</span> m).<span class="bu">abs</span>().<span class="bu">max</span>().item())</span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a>        errs[<span class="st">'cov'</span>].append((P_C <span class="op">-</span> P_m_C <span class="op">@</span> P_m_C.mT).<span class="bu">abs</span>().<span class="bu">max</span>().item())</span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(errs)</span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a>err <span class="op">=</span> fuzz_filter_update_SR(<span class="dv">100</span>)</span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-16"><a href="#cb195-16" aria-hidden="true" tabindex="-1"></a>err.median(), err.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(mean    1.049161e-14
 cov     2.740863e-15
 dtype: float64,
 mean    5.573320e-14
 cov     1.099121e-14
 dtype: float64)</code></pre>
</div>
</div>
</section>
<section id="missing-observations-1" class="level4">
<h4 class="anchored" data-anchor-id="missing-observations-1">Missing observations</h4>
<section id="update-mask-1" class="level5">
<h5 class="anchored" data-anchor-id="update-mask-1">Update mask</h5>
<p>Here need to compute the square root of <span class="math inline">\(R\)</span>, because cannot apply the mask to <span class="math inline">\(R^{1/2}\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[1.5571, 0.3980, 0.0426],
         [0.3980, 1.7403, 1.2398],
         [0.0426, 1.2398, 1.5260]]], dtype=torch.float64,
       grad_fn=&lt;UnsafeViewBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>is_posdef(R)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([True])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>R_m <span class="op">=</span> torch.tensor([[<span class="fl">1.5571</span>,  <span class="fl">0.0426</span>], [<span class="fl">0.0426</span>, <span class="fl">1.5259</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>R_m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[1.5571, 0.0426],
        [0.0426, 1.5259]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a>is_posdef(R_m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(True)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> [<span class="va">True</span>, <span class="va">False</span>, <span class="va">True</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>is_posdef(R[:, m,:][:, :, m])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([True])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>H_m, d_m, R_m, R_C_m, obs_m, <span class="op">=</span> H[:, m,:], d[:, m,:], R[:, m,:][:, :,m], R_C[:, m,:][:, :,m], obs[:, m]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>R2 <span class="op">=</span> R_m</span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>R2_C_m <span class="op">=</span> torch.linalg.cholesky(R_m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>is_sr(R_C_m, R_m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>False</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>_filter_update_SR(H_m, d_m, R_C_m, m_m, P_m_C, obs_m)[<span class="dv">0</span>] <span class="op">-</span> _filter_update(H_m, d_m, R_m, m_m, P_m_C <span class="op">@</span> P_m_C.mT, obs_m)[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[    nan],
         [    nan],
         [    nan],
         [    nan]],

        [[-0.1152],
         [-0.1834],
         [-0.1472],
         [-0.1785]]], dtype=torch.float64, grad_fn=&lt;SubBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>_filter_update_SR(H_m, d_m, R2_C_m, m_m, P_m_C, obs_m)[<span class="dv">0</span>] <span class="op">-</span> _filter_update(H_m, d_m, R_m, m_m, P_m_C <span class="op">@</span> P_m_C.mT, obs_m)[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[        nan],
         [        nan],
         [        nan],
         [        nan]],

        [[-4.4409e-16],
         [-4.4409e-16],
         [ 0.0000e+00],
         [-8.8818e-16]]], dtype=torch.float64, grad_fn=&lt;SubBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span>_filter_update_mask_SR(H, d, R_C, m_m, P_m_C, obs, mask[<span class="dv">0</span>, <span class="dv">0</span>, :] ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[[1.3313],
         [1.0104],
         [1.6996],
         [1.7246]],

        [[0.7732],
         [1.3875],
         [1.4670],
         [1.6642]]], dtype=torch.float64, grad_fn=<addbackward0>)
</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[[ 1.1441,  0.0000,  0.0000,  0.0000],
         [ 0.7349,  1.3175,  0.0000,  0.0000],
         [ 0.4355,  0.5900, -1.1768,  0.0000],
         [ 0.3596,  1.0472, -0.3473, -1.1330]],

        [[ 1.1441,  0.0000,  0.0000,  0.0000],
         [ 0.7349,  1.3175,  0.0000,  0.0000],
         [ 0.4355,  0.5900, -1.1768,  0.0000],
         [ 0.3596,  1.0472, -0.3473, -1.1330]]], dtype=torch.float64,
       grad_fn=<slicebackward0>)
</slicebackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a>m, P_C <span class="op">=</span> _filter_update_mask_SR(H, d, R_C, m_m, P_m_C, obs, mask[<span class="dv">0</span>, <span class="dv">0</span>, :] )</span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>m.shape, P_C.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a>mask[<span class="dv">0</span>,<span class="dv">0</span>].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb222"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzz_filter_update_SR(n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a>    errs <span class="op">=</span> {<span class="st">'mean'</span>: [], <span class="st">'cov'</span>: []}</span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a>        kSR <span class="op">=</span> KalmanFilterSR.init_random(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">4</span>)</span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a>        H, d, R, R_C, m_m, P_m <span class="op">=</span> (kSR.H, kSR.d, kSR.R, kSR.R_C, torch.cat([kSR.m0]<span class="op">*</span><span class="dv">5</span>), torch.cat([kSR.P0]<span class="op">*</span><span class="dv">5</span>))</span>
<span id="cb222-6"><a href="#cb222-6" aria-hidden="true" tabindex="-1"></a>        obs, mask, _  <span class="op">=</span> get_test_data(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">4</span>, bs<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb222-7"><a href="#cb222-7" aria-hidden="true" tabindex="-1"></a>        obs, mask <span class="op">=</span> obs[:,<span class="dv">0</span>].unsqueeze(<span class="op">-</span><span class="dv">1</span>), mask[<span class="dv">0</span>,<span class="dv">0</span>]</span>
<span id="cb222-8"><a href="#cb222-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb222-9"><a href="#cb222-9" aria-hidden="true" tabindex="-1"></a>        P_m_C <span class="op">=</span> torch.linalg.cholesky(P_m)</span>
<span id="cb222-10"><a href="#cb222-10" aria-hidden="true" tabindex="-1"></a>        mSR, P_m_C <span class="op">=</span> _filter_update_mask_SR(H, d, R, m_m, P_m_C, obs, mask)</span>
<span id="cb222-11"><a href="#cb222-11" aria-hidden="true" tabindex="-1"></a>        m, P_C <span class="op">=</span> _filter_update_mask(H, d, R, m_m, P_m, obs, mask)</span>
<span id="cb222-12"><a href="#cb222-12" aria-hidden="true" tabindex="-1"></a>        errs[<span class="st">'mean'</span>].append((mSR <span class="op">-</span> m).<span class="bu">abs</span>().<span class="bu">max</span>().item())</span>
<span id="cb222-13"><a href="#cb222-13" aria-hidden="true" tabindex="-1"></a>        errs[<span class="st">'cov'</span>].append((P_C <span class="op">-</span> P_m_C <span class="op">@</span> P_m_C.mT).<span class="bu">abs</span>().<span class="bu">max</span>().item())</span>
<span id="cb222-14"><a href="#cb222-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(errs)</span>
<span id="cb222-15"><a href="#cb222-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-16"><a href="#cb222-16" aria-hidden="true" tabindex="-1"></a>err <span class="op">=</span> fuzz_filter_update_SR(<span class="dv">100</span>)</span>
<span id="cb222-17"><a href="#cb222-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-18"><a href="#cb222-18" aria-hidden="true" tabindex="-1"></a>err.median(), err.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(mean    3.996803e-15
 cov     1.970646e-15
 dtype: float64,
 mean    3.996803e-15
 cov     7.827072e-15
 dtype: float64)</code></pre>
</div>
</div>
</section>
<section id="update-mask-batch-1" class="level5">
<h5 class="anchored" data-anchor-id="update-mask-batch-1">Update mask batch</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a>m, P_C <span class="op">=</span> _filter_update_mask_batch_SR(H, d, R, m_m, P_m_C, obs, mask[:,<span class="dv">0</span>,:] )</span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a>show_as_row(m, P_C)</span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a>m.shape, P_C.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">m</p> <pre>tensor([[[1.3685],
         [1.0982],
         [1.7967],
         [1.8337]],

        [[0.1197],
         [0.3457],
         [0.5033],
         [0.6044]]], dtype=torch.float64, grad_fn=<indexputbackward0>)
</indexputbackward0></pre> </div><div><p style="font-size: 1.2rem;">P_C</p> <pre>tensor([[[ 1.1607,  0.0000,  0.0000,  0.0000],
         [ 0.8022,  1.3585,  0.0000,  0.0000],
         [ 0.5153,  0.6769, -1.2081,  0.0000],
         [ 0.4512,  1.1387, -0.3915, -1.1430]],

        [[ 0.8355,  0.0000,  0.0000,  0.0000],
         [-0.1000,  0.9427,  0.0000,  0.0000],
         [-0.0859,  0.2527, -1.0461,  0.0000],
         [-0.4813,  0.4183, -0.2013, -1.0540]]], dtype=torch.float64,
       grad_fn=<indexputbackward0>)
</indexputbackward0></pre> </div></div>
</div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a>m.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>) <span class="co"># check that pytorch can compute gradients with the whole batch and gradients aren't nan</span></span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>H.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[-5.3359, -5.2561, -7.0879, -7.6131],
         [ 0.0176, -0.2548, -0.2340, -0.2578],
         [-0.2513, -0.9494, -1.2821, -1.5227]]], dtype=torch.float64)</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="filter-all-1" class="level3">
<h3 class="anchored" data-anchor-id="filter-all-1">Filter All</h3>
<p>The resursive version of the kalman filter is apperently breaking pytorch gradients calculations so a workaround is needed. During the loop the states are saved in a python list and then at the end they are combined back into a tensor. The last line of the function does:</p>
<ul>
<li>convert lists to tensors</li>
<li>correct order dimensions</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb228"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a>filt_stateSR, pred_stateSR  <span class="op">=</span> kSR._filter_all(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb229"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a>(ms, P_Cs), (m_ms, P_m_Cs) <span class="op">=</span> filt_stateSR, pred_stateSR</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Predictions at time <code>0</code> for both batches</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb230"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(Self.shape(), (m_ms, P_m_Cs, ms, P_Cs,)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([2, 10, 4, 1])
</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([2, 10, 4, 4])
</pre> </div><div><p style="font-size: 1.2rem;">#2</p> <pre>torch.Size([2, 10, 4, 1])
</pre> </div><div><p style="font-size: 1.2rem;">#3</p> <pre>torch.Size([2, 10, 4, 4])
</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb231"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(<span class="kw">lambda</span> x:x[<span class="dv">0</span>][<span class="dv">0</span>], (m_ms, P_m_Cs, ms, P_Cs,)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[0.4499],
        [0.8575],
        [0.2647],
        [0.4293]], dtype=torch.float64, grad_fn=<selectbackward0>)
</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[1.2562, 0.0000, 0.0000, 0.0000],
        [0.3804, 0.9666, 0.0000, 0.0000],
        [0.9536, 0.7909, 1.2431, 0.0000],
        [0.4487, 0.4993, 0.4600, 1.2599]], dtype=torch.float64,
       grad_fn=<selectbackward0>)
</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;">#2</p> <pre>tensor([[0.5189],
        [0.9208],
        [0.4203],
        [0.5421]], dtype=torch.float64, grad_fn=<selectbackward0>)
</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;">#3</p> <pre>tensor([[-1.1638,  0.0000,  0.0000,  0.0000],
        [-0.2344, -0.9142,  0.0000,  0.0000],
        [-0.5963, -0.5742, -1.1218,  0.0000],
        [-0.1702, -0.3039, -0.2622,  1.2088]], dtype=torch.float64,
       grad_fn=<selectbackward0>)
</selectbackward0></pre> </div></div>
</div>
</div>
</section>
<section id="filter-3" class="level3">
<h3 class="anchored" data-anchor-id="filter-3">Filter</h3>
<p>The filter methods wraps <code>_filter_all</code> but in addition:</p>
<ul>
<li>returns only filtered state</li>
<li>remove last dimensions from mean</li>
</ul>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L720" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfiltersr.filter" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfiltersr.filter">KalmanFilterSR.filter</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilterSR.filter (obs:torch.Tensor, mask:torch.Tensor,
                        control:torch.Tensor)</code></pre>
</blockquote>
<p>Filter observation</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>obs</td>
<td>Tensor</td>
<td><code>([n_batches], n_obs, [self.n_dim_obs])</code> where <code>n_batches</code> and <code>n_dim_obs</code> dimensions can be omitted if 1</td>
</tr>
<tr class="even">
<td>mask</td>
<td>Tensor</td>
<td><code>([n_batches], n_obs, [self.n_dim_obs])</code> where <code>n_batches</code> and <code>n_dim_obs</code> dimensions can be omitted if 1</td>
</tr>
<tr class="odd">
<td>control</td>
<td>Tensor</td>
<td>([n_batches], n_obs, [self.n_dim_contr])</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ListMultiNormal</strong></td>
<td><strong>Filtered state (n_batches, n_obs, self.n_dim_state)</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb233"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a>filtSR <span class="op">=</span> kSR.<span class="bu">filter</span>(data, mask, control)</span>
<span id="cb233-2"><a href="#cb233-2" aria-hidden="true" tabindex="-1"></a>filtSR.mean.shape, filtSR.cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 10, 4, 1]), torch.Size([2, 10, 4, 4]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb235"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzz_filter_SR(n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a>    errs <span class="op">=</span> {<span class="st">'mean'</span>: [], <span class="st">'cov'</span>: []}</span>
<span id="cb235-3"><a href="#cb235-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb235-4"><a href="#cb235-4" aria-hidden="true" tabindex="-1"></a>        kSR <span class="op">=</span> KalmanFilterSR.init_random(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">4</span>)</span>
<span id="cb235-5"><a href="#cb235-5" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> KalmanFilter.init_from(kSR)</span>
<span id="cb235-6"><a href="#cb235-6" aria-hidden="true" tabindex="-1"></a>        dat <span class="op">=</span> get_test_data(<span class="dv">20</span>, <span class="dv">5</span>, <span class="dv">4</span>)</span>
<span id="cb235-7"><a href="#cb235-7" aria-hidden="true" tabindex="-1"></a>        mean, cov <span class="op">=</span> k.<span class="bu">filter</span>(<span class="op">*</span>dat)</span>
<span id="cb235-8"><a href="#cb235-8" aria-hidden="true" tabindex="-1"></a>        meanSR, covSR <span class="op">=</span> kSR.<span class="bu">filter</span>(<span class="op">*</span>dat)</span>
<span id="cb235-9"><a href="#cb235-9" aria-hidden="true" tabindex="-1"></a>        covSR <span class="op">=</span> covSR <span class="op">@</span> covSR.mT</span>
<span id="cb235-10"><a href="#cb235-10" aria-hidden="true" tabindex="-1"></a>        errs[<span class="st">'mean'</span>].append((meanSR <span class="op">-</span> mean).<span class="bu">abs</span>().<span class="bu">max</span>().item())</span>
<span id="cb235-11"><a href="#cb235-11" aria-hidden="true" tabindex="-1"></a>        errs[<span class="st">'cov'</span>].append((covSR <span class="op">-</span> cov).<span class="bu">abs</span>().<span class="bu">max</span>().item())</span>
<span id="cb235-12"><a href="#cb235-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(errs)</span>
<span id="cb235-13"><a href="#cb235-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-14"><a href="#cb235-14" aria-hidden="true" tabindex="-1"></a>err <span class="op">=</span> fuzz_filter_SR(<span class="dv">10</span>)</span>
<span id="cb235-15"><a href="#cb235-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb235-16"><a href="#cb235-16" aria-hidden="true" tabindex="-1"></a>err.median(), err.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(mean    8.108847e-12
 cov     8.149592e-12
 dtype: float64,
 mean    4.446576e-11
 cov     1.261309e-10
 dtype: float64)</code></pre>
</div>
</div>
</section>
</section>
<section id="smooth-2" class="level2">
<h2 class="anchored" data-anchor-id="smooth-2">Smooth</h2>
<section id="smooth-update-step-1" class="level3">
<h3 class="anchored" data-anchor-id="smooth-update-step-1">Smooth update step</h3>
<p>compute the probability of the state at time <code>t</code> given all the observations</p>
<p><span class="math inline">\(p(x_t|Y) = \mathcal{N}(x_t; m_t^s, P_t^s)\)</span> where:</p>
<ul>
<li>Kalman smoothing gain: <span class="math inline">\(G_t = P_tA^T(P_{t+1}^-)^{-1}\)</span></li>
<li>smoothed mean: <span class="math inline">\(m_t^s = m_t + G_t(m_{t+1}^s - m_{t+1}^-)\)</span></li>
<li>smoothed covariance: <span class="math inline">\(P_t^s = P_t + G_t(P_{t+1}^s - P_{t+1}^-)G_t^T\)</span></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a>filt_state <span class="op">=</span> ListMNormal(filt_stateSR.mean, filt_stateSR.cov <span class="op">@</span> filt_stateSR.cov.mT)</span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a>pred_state <span class="op">=</span> ListMNormal(pred_stateSR.mean, pred_stateSR.cov <span class="op">@</span> pred_stateSR.cov.mT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb238"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>K_p <span class="op">=</span> _smooth_gain_SR(kSR.A, filt_stateSR[:, <span class="dv">0</span>].cov, pred_stateSR[:, <span class="dv">0</span>].cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>test_close(</span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a>    _smooth_gain_SR(kSR.A, filt_stateSR[:, <span class="dv">0</span>].cov, pred_stateSR[:, <span class="dv">0</span>].cov),</span>
<span id="cb239-3"><a href="#cb239-3" aria-hidden="true" tabindex="-1"></a>    _smooth_gain(kSR.A, filt_state[:, <span class="dv">0</span>].cov, pred_state[:, <span class="dv">0</span>].cov)</span>
<span id="cb239-4"><a href="#cb239-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb240"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a>test_close(filt_state[<span class="dv">0</span>,<span class="dv">0</span>].cov, filt_stateSR[<span class="dv">0</span>,<span class="dv">0</span>].cov <span class="op">@</span> filt_stateSR[<span class="dv">0</span>,<span class="dv">0</span>].cov.mT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a>test_close(pred_state[<span class="dv">0</span>,<span class="dv">0</span>].cov, pred_stateSR[<span class="dv">0</span>,<span class="dv">0</span>].cov <span class="op">@</span> pred_stateSR[<span class="dv">0</span>,<span class="dv">0</span>].cov.mT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb242"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzz_gain_SR(n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>    errs <span class="op">=</span> {<span class="st">'K'</span>: []}</span>
<span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb242-4"><a href="#cb242-4" aria-hidden="true" tabindex="-1"></a>        kSR <span class="op">=</span> KalmanFilterSR.init_random(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">4</span>)</span>
<span id="cb242-5"><a href="#cb242-5" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> KalmanFilter.init_from(kSR)</span>
<span id="cb242-6"><a href="#cb242-6" aria-hidden="true" tabindex="-1"></a>        dat <span class="op">=</span> get_test_data(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">4</span>)</span>
<span id="cb242-7"><a href="#cb242-7" aria-hidden="true" tabindex="-1"></a>        (_, f_cov), (_, p_cov) <span class="op">=</span> k._filter_all(<span class="op">*</span>dat)</span>
<span id="cb242-8"><a href="#cb242-8" aria-hidden="true" tabindex="-1"></a>        (_, f_covSR), (_, p_covSR) <span class="op">=</span> kSR._filter_all(<span class="op">*</span>dat)</span>
<span id="cb242-9"><a href="#cb242-9" aria-hidden="true" tabindex="-1"></a>        K <span class="op">=</span> _smooth_gain(k.A, f_cov[:, <span class="dv">0</span>], p_cov[:, <span class="dv">0</span>])</span>
<span id="cb242-10"><a href="#cb242-10" aria-hidden="true" tabindex="-1"></a>        K_SR <span class="op">=</span> _smooth_gain_SR(k.A, f_covSR[:, <span class="dv">0</span>], p_covSR[:, <span class="dv">0</span>])</span>
<span id="cb242-11"><a href="#cb242-11" aria-hidden="true" tabindex="-1"></a>        errs[<span class="st">'K'</span>].append((K <span class="op">-</span> K_SR).<span class="bu">abs</span>().<span class="bu">max</span>().item())</span>
<span id="cb242-12"><a href="#cb242-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(errs)</span>
<span id="cb242-13"><a href="#cb242-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-14"><a href="#cb242-14" aria-hidden="true" tabindex="-1"></a>err <span class="op">=</span> fuzz_gain_SR(<span class="dv">10</span>)</span>
<span id="cb242-15"><a href="#cb242-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb242-16"><a href="#cb242-16" aria-hidden="true" tabindex="-1"></a>err.median(), err.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(K    1.920686e-14
 dtype: float64,
 K    4.352074e-14
 dtype: float64)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>m_p, P_p <span class="op">=</span> _smooth_update_SR(kSR.A, filt_stateSR[:, <span class="dv">0</span>, :], pred_stateSR[:, <span class="dv">0</span>, :], filt_stateSR[:, <span class="dv">0</span>, :])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a>test_close(filt_state[:, <span class="dv">0</span>, :].mean, filt_stateSR[:, <span class="dv">0</span>, :].mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>_smooth_update(kSR.A, filt_state[<span class="dv">0</span>,<span class="dv">0</span>],  pred_state[<span class="dv">0</span>,<span class="dv">0</span>] , filt_state[<span class="dv">0</span>,<span class="dv">0</span>] )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>MultiNormal(mean=tensor([[[0.6325],
         [0.9899],
         [0.5680],
         [0.6284]]], dtype=torch.float64, grad_fn=&lt;AddBackward0&gt;), cov=tensor([[[ 0.7480, -0.0959, -0.0944, -0.2622],
         [-0.0959,  0.6667,  0.1856,  0.0380],
         [-0.0944,  0.1856,  0.9192, -0.0280],
         [-0.2622,  0.0380, -0.0280,  1.3021]]], dtype=torch.float64,
       grad_fn=&lt;DivBackward0&gt;))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a>_smooth_update_SR(kSR.A, filt_stateSR[<span class="dv">0</span>,<span class="dv">0</span>],  pred_stateSR[<span class="dv">0</span>,<span class="dv">0</span>], filt_stateSR[<span class="dv">0</span>,<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>MultiNormal(mean=tensor([[[0.6325],
         [0.9899],
         [0.5680],
         [0.6284]]], dtype=torch.float64, grad_fn=&lt;AddBackward0&gt;), cov=tensor([[[-1.8502, -2.4971, -5.2813, -3.0804],
         [-2.4971, -1.6908, -4.8194, -2.8887],
         [-5.2813, -4.8194, -9.7933, -6.0797],
         [-3.0804, -2.8887, -6.0797, -2.6434]]], dtype=torch.float64,
       grad_fn=&lt;DivBackward0&gt;))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a>test_close((filt_stateSR.mean, pred_stateSR.mean), (filt_state.mean, pred_state.mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a>test_close(</span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a>    _smooth_update_SR(kSR.A, filt_stateSR[:, <span class="dv">0</span>], pred_stateSR[:, <span class="dv">0</span>], filt_state[:, <span class="dv">0</span>]),</span>
<span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a>    _smooth_update(kSR.A, filt_state[:, <span class="dv">0</span>], pred_state[:, <span class="dv">0</span>], filt_state[:, <span class="dv">0</span>])</span>
<span id="cb251-4"><a href="#cb251-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzz_update_SR(n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a>    errs <span class="op">=</span> {<span class="st">'mean'</span>: [], <span class="st">'cov'</span>: []}</span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a>        kSR <span class="op">=</span> KalmanFilterSR.init_random(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">4</span>)</span>
<span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> KalmanFilter.init_from(kSR)</span>
<span id="cb252-6"><a href="#cb252-6" aria-hidden="true" tabindex="-1"></a>        dat <span class="op">=</span> get_test_data(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">4</span>)</span>
<span id="cb252-7"><a href="#cb252-7" aria-hidden="true" tabindex="-1"></a>        f_state, p_state <span class="op">=</span> k._filter_all(<span class="op">*</span>dat)</span>
<span id="cb252-8"><a href="#cb252-8" aria-hidden="true" tabindex="-1"></a>        f_stateSR, p_stateSR <span class="op">=</span> kSR._filter_all(<span class="op">*</span>dat)</span>
<span id="cb252-9"><a href="#cb252-9" aria-hidden="true" tabindex="-1"></a>        mean, cov <span class="op">=</span> _smooth_update(k.A, f_state[:, <span class="dv">0</span>], p_state[:, <span class="dv">0</span>], f_state[:, <span class="dv">1</span>])</span>
<span id="cb252-10"><a href="#cb252-10" aria-hidden="true" tabindex="-1"></a>        meanSR, covSR <span class="op">=</span> _smooth_update_SR(k.A, f_stateSR[:, <span class="dv">0</span>], p_stateSR[:, <span class="dv">0</span>], f_state[:, <span class="dv">1</span>])</span>
<span id="cb252-11"><a href="#cb252-11" aria-hidden="true" tabindex="-1"></a>        errs[<span class="st">'mean'</span>].append((meanSR <span class="op">-</span> mean).<span class="bu">abs</span>().<span class="bu">max</span>().item())</span>
<span id="cb252-12"><a href="#cb252-12" aria-hidden="true" tabindex="-1"></a>        errs[<span class="st">'cov'</span>].append((covSR <span class="op">-</span> cov).<span class="bu">abs</span>().<span class="bu">max</span>().item())</span>
<span id="cb252-13"><a href="#cb252-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(errs)</span>
<span id="cb252-14"><a href="#cb252-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-15"><a href="#cb252-15" aria-hidden="true" tabindex="-1"></a>err <span class="op">=</span> fuzz_update_SR(<span class="dv">10</span>)</span>
<span id="cb252-16"><a href="#cb252-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-17"><a href="#cb252-17" aria-hidden="true" tabindex="-1"></a>err.median(), err.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(mean    1.154632e-14
 cov     2.771117e-13
 dtype: float64,
 mean    3.375078e-14
 cov     8.242296e-13
 dtype: float64)</code></pre>
</div>
</div>
</section>
<section id="smooth-3" class="level3">
<h3 class="anchored" data-anchor-id="smooth-3">Smooth</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>smooth_state <span class="op">=</span> _smooth_SR(kSR.A,  filt_stateSR, pred_stateSR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a>is_sr(filt_stateSR.cov, filt_state.cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>True</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb257"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a>s_mean, s_cov <span class="op">=</span>  _smooth(kSR.A,  filt_state, pred_state)</span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a>s_meanSR, s_covSR <span class="op">=</span>  _smooth_SR(kSR.A,  filt_stateSR, pred_stateSR)</span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a>test_close(s_cov, s_covSR)</span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a>(s_cov <span class="op">-</span> s_covSR).median(), (s_cov <span class="op">-</span> s_covSR).<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor(0., dtype=torch.float64, grad_fn=&lt;MedianBackward0&gt;),
 tensor(3.5527e-15, dtype=torch.float64, grad_fn=&lt;MaxBackward1&gt;))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb259"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smooth_state.mean[<span class="dv">0</span>][<span class="dv">0</span>], smooth_state.cov[<span class="dv">0</span>][<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[-0.3279],
        [ 0.4029],
        [-0.7501],
        [-0.0098]], dtype=torch.float64, grad_fn=<selectbackward0>)
</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[ 0.9163, -0.0046,  0.0978, -0.1494],
        [-0.0046,  0.7132,  0.2841,  0.0932],
        [ 0.0978,  0.2841,  1.1262,  0.0916],
        [-0.1494,  0.0932,  0.0916,  1.3623]], dtype=torch.float64,
       grad_fn=<selectbackward0>)
</selectbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smooth_state.mean.shape, smooth_state.cov.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([2, 10, 4, 1])
</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([2, 10, 4, 4])
</pre> </div></div>
</div>
</div>
</section>
<section id="kalmanfilter-method-1" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter-method-1">KalmanFilter method</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ True, False, False],
         [ True, False,  True],
         [False,  True, False],
         [False, False, False],
         [False, False,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True, False],
         [ True, False,  True],
         [ True,  True,  True]],

        [[ True,  True,  True],
         [ True,  True, False],
         [ True,  True,  True],
         [ True, False,  True],
         [False,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True]]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb263"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a>torch.argwhere((<span class="op">~</span>mask).<span class="bu">any</span>(<span class="op">-</span><span class="dv">1</span>).<span class="bu">any</span>(<span class="dv">0</span>)).<span class="bu">min</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(0)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a>torch.ones(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([], size=(1, 2, 0))</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L784" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfiltersr.smooth" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfiltersr.smooth">KalmanFilterSR.smooth</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilterSR.smooth (obs:torch.Tensor, mask:torch.Tensor,
                        control:torch.Tensor)</code></pre>
</blockquote>
<p>Kalman Filter Smoothing</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>obs</td>
<td>Tensor</td>
<td></td>
</tr>
<tr class="even">
<td>mask</td>
<td>Tensor</td>
<td></td>
</tr>
<tr class="odd">
<td>control</td>
<td>Tensor</td>
<td></td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ListMultiNormal</strong></td>
<td><strong><code>[n_timesteps, n_dim_state]</code> smoothed state</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb268"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a>smoothed_state <span class="op">=</span> kSR.smooth(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb269"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smoothed_state.mean.shape, smoothed_state.cov.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([2, 10, 4, 1])
</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([2, 10, 4, 4])
</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb270"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a>smoothed_state.cov.isnan().<span class="bu">any</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(False)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb272"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a>smoothed_state.mean.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a>A.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[0., 0., 0., 0.],
         [0., 0., 0., 0.],
         [0., 0., 0., 0.],
         [0., 0., 0., 0.]]], dtype=torch.float64)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb274"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a>smoothed_state_stand <span class="op">=</span> k.smooth(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb275"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a>(smoothed_state.mean <span class="op">-</span> smoothed_state_stand.mean).<span class="bu">max</span>()</span>
<span id="cb275-2"><a href="#cb275-2" aria-hidden="true" tabindex="-1"></a>(smoothed_state.cov <span class="op">-</span> smoothed_state_stand.cov).<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(0.6755, dtype=torch.float64, grad_fn=&lt;MaxBackward1&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb277"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzz_smooth_SR(n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a>    errs <span class="op">=</span> {<span class="st">'mean'</span>: [], <span class="st">'cov'</span>: []}</span>
<span id="cb277-3"><a href="#cb277-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb277-4"><a href="#cb277-4" aria-hidden="true" tabindex="-1"></a>        kSR <span class="op">=</span> KalmanFilterSR.init_random(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">4</span>)</span>
<span id="cb277-5"><a href="#cb277-5" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> KalmanFilter.init_from(kSR)</span>
<span id="cb277-6"><a href="#cb277-6" aria-hidden="true" tabindex="-1"></a>        dat <span class="op">=</span> get_test_data(<span class="dv">20</span>, <span class="dv">5</span>, <span class="dv">4</span>)</span>
<span id="cb277-7"><a href="#cb277-7" aria-hidden="true" tabindex="-1"></a>        mean, cov <span class="op">=</span> k.smooth(<span class="op">*</span>dat)</span>
<span id="cb277-8"><a href="#cb277-8" aria-hidden="true" tabindex="-1"></a>        meanSR, covSR <span class="op">=</span> kSR.smooth(<span class="op">*</span>dat)</span>
<span id="cb277-9"><a href="#cb277-9" aria-hidden="true" tabindex="-1"></a>        errs[<span class="st">'mean'</span>].append((meanSR <span class="op">-</span> mean).<span class="bu">abs</span>().<span class="bu">max</span>().item())</span>
<span id="cb277-10"><a href="#cb277-10" aria-hidden="true" tabindex="-1"></a>        errs[<span class="st">'cov'</span>].append((covSR <span class="op">-</span> cov).<span class="bu">abs</span>().<span class="bu">max</span>().item())</span>
<span id="cb277-11"><a href="#cb277-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(errs)</span>
<span id="cb277-12"><a href="#cb277-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-13"><a href="#cb277-13" aria-hidden="true" tabindex="-1"></a>err <span class="op">=</span> fuzz_smooth_SR(<span class="dv">10</span>)</span>
<span id="cb277-14"><a href="#cb277-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-15"><a href="#cb277-15" aria-hidden="true" tabindex="-1"></a>err.median(), err.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(mean    9.733464e-12
 cov     8.838374e-12
 dtype: float64,
 mean    4.984400e-09
 cov     4.896766e-09
 dtype: float64)</code></pre>
</div>
</div>
</section>
</section>
<section id="predict-3" class="level2">
<h2 class="anchored" data-anchor-id="predict-3">Predict</h2>
<p>predict can be vectorized across both the batch and the timesteps, except for timesteps that require conditional predictions</p>
<section id="obs-from-state" class="level3">
<h3 class="anchored" data-anchor-id="obs-from-state">Obs from State</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb279"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a>smoothed_state.mean.shape, smoothed_state.cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 10, 4, 1]), torch.Size([2, 10, 4, 4]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb281"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a>pred_obs0 <span class="op">=</span> kSR._obs_from_state(smoothed_state)</span>
<span id="cb281-2"><a href="#cb281-2" aria-hidden="true" tabindex="-1"></a>pred_obs0.mean.shape, pred_obs0.cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 10, 3, 1]), torch.Size([2, 10, 3, 3]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb283"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a>pred_obs0.cov.isnan().<span class="bu">any</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(False)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb285"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a>gap_mask <span class="op">=</span> <span class="op">~</span>mask.<span class="bu">all</span>(<span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb286"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a>gap_mask.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10])</code></pre>
</div>
</div>
<p>Predict has various modes:</p>
<ul>
<li><code>pred_only_gap</code> is True, returns predictions only where the mask is False
<ul>
<li><code>use_conditional</code> returns a list (for each batch) of list (for each time stamp) of Tensors of shape [1, gap_len]</li>
<li><code>use_conditional</code> is False, returns a list (for each batch) of Tensor of shape [n_times_gap, n_dim_obs]</li>
</ul></li>
</ul>
</section>
<section id="masked-batch" class="level3">
<h3 class="anchored" data-anchor-id="masked-batch">Masked Batch</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb288"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a>gap_mask <span class="op">=</span> <span class="op">~</span>mask.<span class="bu">all</span>(<span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb289"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pprint <span class="im">import</span> pp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb290"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a>pp(_masked2batch(mask[gap_mask], mask)[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[tensor([False, False]),
 tensor([False]),
 tensor([False, False]),
 tensor([False, False, False]),
 tensor([False, False]),
 tensor([False]),
 tensor([False])]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb292"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="bu">str</span>(_masked2batch(mask[gap_mask], mask)[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'[tensor([False, False]), tensor([False]), tensor([False, False]), tensor([False, False, False]), tensor([False, False]), tensor([False]), tensor([False])]'</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb294"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a>show_as_row(all_mask <span class="op">=</span> mask[<span class="dv">0</span>] , only_gap<span class="op">=</span>_masked2batch(mask[gap_mask], mask)[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">all_mask</p> <pre>tensor([[ True, False, False],
        [ True, False,  True],
        [False,  True, False],
        [False, False, False],
        [False, False,  True],
        [ True,  True,  True],
        [ True,  True,  True],
        [ True,  True, False],
        [ True, False,  True],
        [ True,  True,  True]])
</pre> </div><div><p style="font-size: 1.2rem;">only_gap</p> <pre>[tensor([False, False]),
 tensor([False]),
 tensor([False, False]),
 tensor([False, False, False]),
 tensor([False, False]),
 tensor([False]),
 tensor([False])]
</pre> </div></div>
</div>
</div>
</section>
<section id="predict-4" class="level3">
<h3 class="anchored" data-anchor-id="predict-4">Predict</h3>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L849" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfiltersr.predict" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfiltersr.predict">KalmanFilterSR.predict</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilterSR.predict (obs, mask, control, smooth=True)</code></pre>
</blockquote>
<p>Predicted observations at all times</p>
</section>
<section id="exploration" class="level3">
<h3 class="anchored" data-anchor-id="exploration">Exploration</h3>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L899" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="with_settings" class="level3">
<h3 class="anchored" data-anchor-id="with_settings">with_settings</h3>
<blockquote class="blockquote">
<pre><code> with_settings (k, **kwargs)</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L897" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="replacing_ctx" class="level3">
<h3 class="anchored" data-anchor-id="replacing_ctx">replacing_ctx</h3>
<blockquote class="blockquote">
<pre><code> replacing_ctx (*args)</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb298"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> with_settings(kSR, use_conditional<span class="op">=</span><span class="va">False</span>, pred_only_gap<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb298-2"><a href="#cb298-2" aria-hidden="true" tabindex="-1"></a>    pred_mean, pred_cov <span class="op">=</span> kSR.predict(data, mask, control)</span>
<span id="cb298-3"><a href="#cb298-3" aria-hidden="true" tabindex="-1"></a>show_as_row(mean<span class="op">=</span> pred_mean.shape, cov <span class="op">=</span> pred_cov.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">mean</p> <pre>torch.Size([2, 10, 3])
</pre> </div><div><p style="font-size: 1.2rem;">cov</p> <pre>torch.Size([2, 10, 3, 3])
</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb299"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> with_settings(kSR, use_conditional<span class="op">=</span><span class="va">False</span>, pred_only_gap<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a>    pred_mean, pred_cov <span class="op">=</span> kSR.predict(data, mask, control)</span>
<span id="cb299-3"><a href="#cb299-3" aria-hidden="true" tabindex="-1"></a>show_as_row(mean<span class="op">=</span> pred_mean[<span class="dv">0</span>], cov <span class="op">=</span> pred_cov[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">mean</p> <pre>[tensor([-0.3666,  0.3765], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([-0.0844], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([0.1625, 0.3119], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([-0.1102, -0.5474, -0.1901], dtype=torch.float64,
       grad_fn=<indexbackward0>),
 tensor([-0.1439, -0.4996], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([0.4966], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([0.0202], dtype=torch.float64, grad_fn=<indexbackward0>)]
</indexbackward0></indexbackward0></indexbackward0></indexbackward0></indexbackward0></indexbackward0></indexbackward0></pre> </div><div><p style="font-size: 1.2rem;">cov</p> <pre>[tensor([[2.5518, 2.1682],
        [2.1682, 2.8766]], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([[2.3344]], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([[1.9095, 0.5371],
        [0.5371, 3.0221]], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([[2.0929, 1.1465, 0.8395],
        [1.1465, 2.8696, 2.5367],
        [0.8395, 2.5367, 3.5092]], dtype=torch.float64,
       grad_fn=<indexbackward0>),
 tensor([[1.9076, 0.8393],
        [0.8393, 2.3729]], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([[2.7991]], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([[2.2841]], dtype=torch.float64, grad_fn=<indexbackward0>)]
</indexbackward0></indexbackward0></indexbackward0></indexbackward0></indexbackward0></indexbackward0></indexbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb300"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> with_settings(kSR, use_conditional<span class="op">=</span><span class="va">True</span>, pred_only_gap<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb300-2"><a href="#cb300-2" aria-hidden="true" tabindex="-1"></a>    pred_mean, pred_cov <span class="op">=</span> kSR.predict(data, mask, control)</span>
<span id="cb300-3"><a href="#cb300-3" aria-hidden="true" tabindex="-1"></a>show_as_row(mean<span class="op">=</span> pred_mean[<span class="dv">0</span>], cov <span class="op">=</span> pred_cov[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">mean</p> <pre>[tensor([0.0292, 0.6235], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([0.4156], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([0.3672, 0.7999], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([-0.1102, -0.5474, -0.1901], dtype=torch.float64,
       grad_fn=<indexbackward0>),
 tensor([-0.0686, -0.1575], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([0.4823], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([0.1720], dtype=torch.float64, grad_fn=<indexbackward0>)]
</indexbackward0></indexbackward0></indexbackward0></indexbackward0></indexbackward0></indexbackward0></indexbackward0></pre> </div><div><p style="font-size: 1.2rem;">cov</p> <pre>[tensor([[2.5518, 2.1682],
        [2.1682, 2.8766]], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([[2.3344]], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([[1.9095, 0.5371],
        [0.5371, 3.0221]], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([[2.0929, 1.1465, 0.8395],
        [1.1465, 2.8696, 2.5367],
        [0.8395, 2.5367, 3.5092]], dtype=torch.float64,
       grad_fn=<indexbackward0>),
 tensor([[1.9076, 0.8393],
        [0.8393, 2.3729]], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([[2.7991]], dtype=torch.float64, grad_fn=<indexbackward0>),
 tensor([[2.2841]], dtype=torch.float64, grad_fn=<indexbackward0>)]
</indexbackward0></indexbackward0></indexbackward0></indexbackward0></indexbackward0></indexbackward0></indexbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb301"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> with_settings(kSR, use_conditional <span class="op">=</span> <span class="va">True</span>, pred_only_gap <span class="op">=</span> <span class="va">False</span>):</span>
<span id="cb301-2"><a href="#cb301-2" aria-hidden="true" tabindex="-1"></a>    test_fail(kSR.predict, [data, mask, control]) <span class="co"># this params combination is invalid</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="gap-only-prediction" class="level4">
<h4 class="anchored" data-anchor-id="gap-only-prediction">Gap only prediction</h4>
<p>copy paste from other notebook to make visualization easier</p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/training.py#L777" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="buffer_pred_single" class="level3">
<h3 class="anchored" data-anchor-id="buffer_pred_single">buffer_pred_single</h3>
<blockquote class="blockquote">
<pre><code> buffer_pred_single (preds:list[torch.Tensor], masks:torch.Tensor)</code></pre>
</blockquote>
<p>For predictions are for gaps only add buffer of <code>Nan</code> so they have same shape of targets</p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/training.py#L790" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="buffer_pred" class="level3">
<h3 class="anchored" data-anchor-id="buffer_pred">buffer_pred</h3>
<blockquote class="blockquote">
<pre><code> buffer_pred (preds:list[list[torch.Tensor]], masks:torch.Tensor)</code></pre>
</blockquote>
<p>For predictions are for gaps only add buffer of <code>Nan</code> so they have same shape of targets</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb304"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> with_settings(kSR, use_conditional<span class="op">=</span><span class="va">False</span>, pred_only_gap<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a>    pred_m_gap, _ <span class="op">=</span> kSR.predict(data, mask, control)</span>
<span id="cb304-3"><a href="#cb304-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb304-4"><a href="#cb304-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> with_settings(kSR, use_conditional<span class="op">=</span><span class="va">False</span>, pred_only_gap<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb304-5"><a href="#cb304-5" aria-hidden="true" tabindex="-1"></a>    pred_m, _ <span class="op">=</span> kSR.predict(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>soooooooo this is a problem!!! those should be the same</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb305"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a>show_as_row(gap <span class="op">=</span> buffer_pred(pred_m_gap, mask), no_gap <span class="op">=</span> pred_m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">gap</p> <pre>tensor([[[    nan, -0.3666,  0.3765],
         [    nan, -0.0844,     nan],
         [ 0.1625,     nan,  0.3119],
         [-0.1102, -0.5474, -0.1901],
         [-0.1439, -0.4996,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,  0.4966],
         [    nan,  0.0202,     nan],
         [    nan,     nan,     nan]],

        [[    nan,     nan,     nan],
         [    nan,     nan,  0.2059],
         [    nan,     nan,     nan],
         [    nan, -0.3611,     nan],
         [ 0.1032,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan]]], dtype=torch.float64)
</pre> </div><div><p style="font-size: 1.2rem;">no_gap</p> <pre>tensor([[[ 0.0322, -0.3666,  0.3765],
         [ 0.1475, -0.0844,  0.4320],
         [ 0.1625, -0.0796,  0.3119],
         [-0.1102, -0.5474, -0.1901],
         [-0.1439, -0.4996,  0.0158],
         [ 0.1736, -0.0500,  0.1638],
         [ 0.0998, -0.2115,  0.2026],
         [ 0.2642,  0.0727,  0.4966],
         [ 0.2667,  0.0202,  0.5999],
         [ 0.5621,  0.4854,  1.0911]],

        [[ 0.0523, -0.3558,  0.1773],
         [ 0.0572, -0.2074,  0.2059],
         [ 0.0361, -0.2809,  0.0575],
         [-0.0671, -0.3611,  0.1202],
         [ 0.1032, -0.2193, -0.1928],
         [-0.1298, -0.5874, -0.3787],
         [ 0.0450, -0.2554, -0.2029],
         [ 0.0938, -0.0932,  0.3782],
         [ 0.2229, -0.1440, -0.1133],
         [ 0.3722,  0.3017,  1.1004]]], dtype=torch.float64,
       grad_fn=<squeezebackward3>)
</squeezebackward3></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb306"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a>state <span class="op">=</span> kSR.smooth(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb307"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a>state.mean.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10, 4, 1])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb309"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a>gap_mask <span class="op">=</span> <span class="op">~</span>mask.<span class="bu">all</span>(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a><span class="co"># this destroy batches! so need to do some magic after</span></span>
<span id="cb309-3"><a href="#cb309-3" aria-hidden="true" tabindex="-1"></a>state_gap <span class="op">=</span> state[gap_mask]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb310"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a>state_gap.mean.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([10, 4, 1])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb312"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a>pred_obs <span class="op">=</span> kSR._obs_from_state(state)</span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a>pred_obs.mean.squeeze_(<span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 0.0322, -0.3666,  0.3765],
         [ 0.1475, -0.0844,  0.4320],
         [ 0.1625, -0.0796,  0.3119],
         [-0.1102, -0.5474, -0.1901],
         [-0.1439, -0.4996,  0.0158],
         [ 0.1736, -0.0500,  0.1638],
         [ 0.0998, -0.2115,  0.2026],
         [ 0.2642,  0.0727,  0.4966],
         [ 0.2667,  0.0202,  0.5999],
         [ 0.5621,  0.4854,  1.0911]],

        [[ 0.0523, -0.3558,  0.1773],
         [ 0.0572, -0.2074,  0.2059],
         [ 0.0361, -0.2809,  0.0575],
         [-0.0671, -0.3611,  0.1202],
         [ 0.1032, -0.2193, -0.1928],
         [-0.1298, -0.5874, -0.3787],
         [ 0.0450, -0.2554, -0.2029],
         [ 0.0938, -0.0932,  0.3782],
         [ 0.2229, -0.1440, -0.1133],
         [ 0.3722,  0.3017,  1.1004]]], dtype=torch.float64,
       grad_fn=&lt;SqueezeBackward3&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb314"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a>pred_obs_gap <span class="op">=</span> kSR._obs_from_state(state_gap)</span>
<span id="cb314-2"><a href="#cb314-2" aria-hidden="true" tabindex="-1"></a>pred_obs_gap.mean.squeeze_(<span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[ 0.0322, -0.3666,  0.3765],
        [ 0.1475, -0.0844,  0.4320],
        [ 0.1625, -0.0796,  0.3119],
        [-0.1102, -0.5474, -0.1901],
        [-0.1439, -0.4996,  0.0158],
        [ 0.2642,  0.0727,  0.4966],
        [ 0.2667,  0.0202,  0.5999],
        [ 0.0572, -0.2074,  0.2059],
        [-0.0671, -0.3611,  0.1202],
        [ 0.1032, -0.2193, -0.1928]], dtype=torch.float64,
       grad_fn=&lt;SqueezeBackward3&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb316"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a>(pred_obs[gap_mask].mean <span class="op">==</span> pred_obs_gap.mean).<span class="bu">all</span>() <span class="co"># so far good</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(True)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb318"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb318-1"><a href="#cb318-1" aria-hidden="true" tabindex="-1"></a>pred_obs.mean.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb320"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb320-1"><a href="#cb320-1" aria-hidden="true" tabindex="-1"></a>mask.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb322"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb322-1"><a href="#cb322-1" aria-hidden="true" tabindex="-1"></a>show_as_row(pred <span class="op">=</span> buffer_pred(_masked2batch(pred_obs_gap.mean, mask), mask), mask <span class="op">=</span> mask, <span class="bu">all</span> <span class="op">=</span> pred_obs.mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">pred</p> <pre>tensor([[[    nan, -0.3666,  0.3765],
         [    nan, -0.0844,     nan],
         [ 0.1625,     nan,  0.3119],
         [-0.1102, -0.5474, -0.1901],
         [-0.1439, -0.4996,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,  0.4966],
         [    nan,  0.0202,     nan],
         [    nan,     nan,     nan]],

        [[    nan,     nan,     nan],
         [    nan,     nan,  0.2059],
         [    nan,     nan,     nan],
         [    nan, -0.3611,     nan],
         [ 0.1032,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan]]], dtype=torch.float64)
</pre> </div><div><p style="font-size: 1.2rem;">mask</p> <pre>tensor([[[ True, False, False],
         [ True, False,  True],
         [False,  True, False],
         [False, False, False],
         [False, False,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True, False],
         [ True, False,  True],
         [ True,  True,  True]],

        [[ True,  True,  True],
         [ True,  True, False],
         [ True,  True,  True],
         [ True, False,  True],
         [False,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True]]])
</pre> </div><div><p style="font-size: 1.2rem;">all</p> <pre>tensor([[[ 0.0322, -0.3666,  0.3765],
         [ 0.1475, -0.0844,  0.4320],
         [ 0.1625, -0.0796,  0.3119],
         [-0.1102, -0.5474, -0.1901],
         [-0.1439, -0.4996,  0.0158],
         [ 0.1736, -0.0500,  0.1638],
         [ 0.0998, -0.2115,  0.2026],
         [ 0.2642,  0.0727,  0.4966],
         [ 0.2667,  0.0202,  0.5999],
         [ 0.5621,  0.4854,  1.0911]],

        [[ 0.0523, -0.3558,  0.1773],
         [ 0.0572, -0.2074,  0.2059],
         [ 0.0361, -0.2809,  0.0575],
         [-0.0671, -0.3611,  0.1202],
         [ 0.1032, -0.2193, -0.1928],
         [-0.1298, -0.5874, -0.3787],
         [ 0.0450, -0.2554, -0.2029],
         [ 0.0938, -0.0932,  0.3782],
         [ 0.2229, -0.1440, -0.1133],
         [ 0.3722,  0.3017,  1.1004]]], dtype=torch.float64,
       grad_fn=<squeezebackward3>)
</squeezebackward3></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb323"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a>pred_gap_buff <span class="op">=</span> buffer_pred(_masked2batch(pred_obs_gap.mean, mask), mask)</span>
<span id="cb323-2"><a href="#cb323-2" aria-hidden="true" tabindex="-1"></a>mask_na <span class="op">=</span> <span class="op">~</span>pred_gap_buff.isnan()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb324"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb324-1"><a href="#cb324-1" aria-hidden="true" tabindex="-1"></a>test_close(pred_gap_buff[mask_na], pred_obs.mean[mask_na])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb325"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> with_settings(kSR, use_conditional<span class="op">=</span><span class="va">False</span>, pred_only_gap<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb325-2"><a href="#cb325-2" aria-hidden="true" tabindex="-1"></a>    pred_gap_buff <span class="op">=</span> buffer_pred(kSR.predict(data, mask, control).mean, mask)</span>
<span id="cb325-3"><a href="#cb325-3" aria-hidden="true" tabindex="-1"></a>mask_na <span class="op">=</span> <span class="op">~</span>pred_gap_buff.isnan()</span>
<span id="cb325-4"><a href="#cb325-4" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> with_settings(kSR, use_conditional<span class="op">=</span><span class="va">False</span>, pred_only_gap<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb325-5"><a href="#cb325-5" aria-hidden="true" tabindex="-1"></a>    pred_ng <span class="op">=</span> kSR.predict(data, mask, control).mean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb326"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a>test_close(pred_gap_buff[mask_na], pred_ng[mask_na])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb327"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb327-1"><a href="#cb327-1" aria-hidden="true" tabindex="-1"></a>show_as_row(pred <span class="op">=</span> pred_gap_buff, mask <span class="op">=</span> mask, <span class="bu">all</span> <span class="op">=</span> pred_ng)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">pred</p> <pre>tensor([[[    nan, -0.3666,  0.3765],
         [    nan, -0.0844,     nan],
         [ 0.1625,     nan,  0.3119],
         [-0.1102, -0.5474, -0.1901],
         [-0.1439, -0.4996,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,  0.4966],
         [    nan,  0.0202,     nan],
         [    nan,     nan,     nan]],

        [[    nan,     nan,     nan],
         [    nan,     nan,  0.2059],
         [    nan,     nan,     nan],
         [    nan, -0.3611,     nan],
         [ 0.1032,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan]]], dtype=torch.float64)
</pre> </div><div><p style="font-size: 1.2rem;">mask</p> <pre>tensor([[[ True, False, False],
         [ True, False,  True],
         [False,  True, False],
         [False, False, False],
         [False, False,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True, False],
         [ True, False,  True],
         [ True,  True,  True]],

        [[ True,  True,  True],
         [ True,  True, False],
         [ True,  True,  True],
         [ True, False,  True],
         [False,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True]]])
</pre> </div><div><p style="font-size: 1.2rem;">all</p> <pre>tensor([[[ 0.0322, -0.3666,  0.3765],
         [ 0.1475, -0.0844,  0.4320],
         [ 0.1625, -0.0796,  0.3119],
         [-0.1102, -0.5474, -0.1901],
         [-0.1439, -0.4996,  0.0158],
         [ 0.1736, -0.0500,  0.1638],
         [ 0.0998, -0.2115,  0.2026],
         [ 0.2642,  0.0727,  0.4966],
         [ 0.2667,  0.0202,  0.5999],
         [ 0.5621,  0.4854,  1.0911]],

        [[ 0.0523, -0.3558,  0.1773],
         [ 0.0572, -0.2074,  0.2059],
         [ 0.0361, -0.2809,  0.0575],
         [-0.0671, -0.3611,  0.1202],
         [ 0.1032, -0.2193, -0.1928],
         [-0.1298, -0.5874, -0.3787],
         [ 0.0450, -0.2554, -0.2029],
         [ 0.0938, -0.0932,  0.3782],
         [ 0.2229, -0.1440, -0.1133],
         [ 0.3722,  0.3017,  1.1004]]], dtype=torch.float64,
       grad_fn=<squeezebackward3>)
</squeezebackward3></pre> </div></div>
</div>
</div>
<section id="conditional" class="level4">
<h4 class="anchored" data-anchor-id="conditional">Conditional</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb328"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb328-1"><a href="#cb328-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> with_settings(kSR, use_conditional<span class="op">=</span><span class="va">False</span>, pred_only_gap<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb328-2"><a href="#cb328-2" aria-hidden="true" tabindex="-1"></a>    pred_gap <span class="op">=</span> buffer_pred(kSR.predict(data, mask, control).mean, mask)</span>
<span id="cb328-3"><a href="#cb328-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> with_settings(kSR, use_conditional<span class="op">=</span><span class="va">True</span>, pred_only_gap<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb328-4"><a href="#cb328-4" aria-hidden="true" tabindex="-1"></a>    pred_gap_cond <span class="op">=</span> buffer_pred(kSR.predict(data, mask, control).mean, mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb329"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a>show_as_row(no_conditional <span class="op">=</span> pred_gap, conditional <span class="op">=</span> pred_gap_cond)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">no_conditional</p> <pre>tensor([[[    nan, -0.3666,  0.3765],
         [    nan, -0.0844,     nan],
         [ 0.1625,     nan,  0.3119],
         [-0.1102, -0.5474, -0.1901],
         [-0.1439, -0.4996,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,  0.4966],
         [    nan,  0.0202,     nan],
         [    nan,     nan,     nan]],

        [[    nan,     nan,     nan],
         [    nan,     nan,  0.2059],
         [    nan,     nan,     nan],
         [    nan, -0.3611,     nan],
         [ 0.1032,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan]]], dtype=torch.float64)
</pre> </div><div><p style="font-size: 1.2rem;">conditional</p> <pre>tensor([[[    nan,  0.0292,  0.6235],
         [    nan,  0.4156,     nan],
         [ 0.3672,     nan,  0.7999],
         [-0.1102, -0.5474, -0.1901],
         [-0.0686, -0.1575,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,  0.4823],
         [    nan,  0.1720,     nan],
         [    nan,     nan,     nan]],

        [[    nan,     nan,     nan],
         [    nan,     nan,  0.5191],
         [    nan,     nan,     nan],
         [    nan,  0.2014,     nan],
         [ 0.6513,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan],
         [    nan,     nan,     nan]]], dtype=torch.float64)
</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb330"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb330-1"><a href="#cb330-1" aria-hidden="true" tabindex="-1"></a>mask[gap_mask]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[ True, False, False],
        [ True, False,  True],
        [False,  True, False],
        [False, False, False],
        [False, False,  True],
        [ True,  True, False],
        [ True, False,  True],
        [ True,  True, False],
        [ True, False,  True],
        [False,  True,  True]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb332"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb332-1"><a href="#cb332-1" aria-hidden="true" tabindex="-1"></a>data[gap_mask]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[0.8775,    nan,    nan],
        [0.6706,    nan, 0.9272],
        [   nan, 0.4967,    nan],
        [   nan,    nan,    nan],
        [   nan,    nan, 0.4760],
        [0.9991, 0.1775,    nan],
        [0.6734,    nan, 0.6468],
        [0.3725, 0.2052,    nan],
        [0.5927,    nan, 0.6441],
        [   nan, 0.9132, 0.0329]], dtype=torch.float64)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb334"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a>data[gap_mask]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[0.8775,    nan,    nan],
        [0.6706,    nan, 0.9272],
        [   nan, 0.4967,    nan],
        [   nan,    nan,    nan],
        [   nan,    nan, 0.4760],
        [0.9991, 0.1775,    nan],
        [0.6734,    nan, 0.6468],
        [0.3725, 0.2052,    nan],
        [0.5927,    nan, 0.6441],
        [   nan, 0.9132, 0.0329]], dtype=torch.float64)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb336"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> is_posdef(pred_cov[<span class="dv">0</span>][<span class="dv">0</span>]).<span class="bu">all</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb337"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb337-1"><a href="#cb337-1" aria-hidden="true" tabindex="-1"></a>state <span class="op">=</span> kSR.smooth(data, mask, control)</span>
<span id="cb337-2"><a href="#cb337-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span> state.cov.isnan().<span class="bu">any</span>()</span>
<span id="cb337-3"><a href="#cb337-3" aria-hidden="true" tabindex="-1"></a>kSR.use_sr_pred <span class="op">=</span> <span class="va">False</span></span>
<span id="cb337-4"><a href="#cb337-4" aria-hidden="true" tabindex="-1"></a>pred_obs <span class="op">=</span> kSR._obs_from_state(state)</span>
<span id="cb337-5"><a href="#cb337-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span> pred_obs.cov.isnan().<span class="bu">any</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb338"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a>cov2std(pred_obs.cov).isnan().<span class="bu">any</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(False)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb340"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb340-1"><a href="#cb340-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span> kSR.predict(data, mask, control).cov.isnan().<span class="bu">any</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb341"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="kw">not</span> kSR.predict(data, mask, control, smooth<span class="op">=</span><span class="va">False</span>).cov.isnan().<span class="bu">any</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb342"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb342-1"><a href="#cb342-1" aria-hidden="true" tabindex="-1"></a>kSR._predict_filter(data, mask, control).std.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10, 3, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb344"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb344-1"><a href="#cb344-1" aria-hidden="true" tabindex="-1"></a>kSR.use_conditional <span class="op">=</span> <span class="va">False</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb345"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> kSR.predict(data, mask, control, smooth<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb346"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb346-1"><a href="#cb346-1" aria-hidden="true" tabindex="-1"></a>pred.mean.shape, pred.std.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>AttributeError: 'ListMultiNormal' object has no attribute 'std'</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb348"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb348-1"><a href="#cb348-1" aria-hidden="true" tabindex="-1"></a>filt_state, pred_state <span class="op">=</span> kSR._filter_all(data, mask, control)</span>
<span id="cb348-2"><a href="#cb348-2" aria-hidden="true" tabindex="-1"></a>mean, cov <span class="op">=</span> kSR._obs_from_state(pred_state)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb349"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a>is_posdef(cov <span class="op">@</span> cov.mT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb350"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb350-1"><a href="#cb350-1" aria-hidden="true" tabindex="-1"></a>pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="debug-nan" class="level2">
<h2 class="anchored" data-anchor-id="debug-nan">Debug nan</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb351"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="cb351-2"><a href="#cb351-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> altair <span class="im">as</span> alt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb352"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb352-1"><a href="#cb352-1" aria-hidden="true" tabindex="-1"></a>kSR.predict(<span class="op">*</span>get_test_data(<span class="dv">200</span>)).cov.isnan().<span class="bu">any</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb353"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a>data.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb354"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb354-1"><a href="#cb354-1" aria-hidden="true" tabindex="-1"></a>reset_seed()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="sr-filter" class="level3">
<h3 class="anchored" data-anchor-id="sr-filter">SR Filter</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb355"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb355-1"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a>nan <span class="op">=</span> [{<span class="st">'nan'</span>:kSR.predict(<span class="op">*</span>get_test_data(n), smooth<span class="op">=</span>smooth).cov.isnan().<span class="bu">any</span>().item(), <span class="st">'n'</span>: n, <span class="st">'rep'</span>: rep, <span class="st">'smooth'</span>: smooth}</span>
<span id="cb355-2"><a href="#cb355-2" aria-hidden="true" tabindex="-1"></a>       <span class="cf">for</span> n <span class="kw">in</span> [<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">55</span>, <span class="dv">60</span>, <span class="dv">70</span>, <span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">200</span>] <span class="cf">for</span> rep <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>) <span class="cf">for</span> smooth <span class="kw">in</span> [<span class="va">True</span>, <span class="va">False</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb356"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb356-1"><a href="#cb356-1" aria-hidden="true" tabindex="-1"></a>nan_df <span class="op">=</span> pl.DataFrame(nan).groupby([<span class="st">'nan'</span>, <span class="st">'n'</span>, <span class="st">'smooth'</span>]).count().to_pandas()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb357"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a>alt.Chart(nan_df).mark_line().encode(x<span class="op">=</span><span class="st">'n:Q'</span>, y<span class="op">=</span><span class="st">'count'</span>, color<span class="op">=</span><span class="st">'nan'</span>, column<span class="op">=</span><span class="st">'smooth'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="standard-filter" class="level3">
<h3 class="anchored" data-anchor-id="standard-filter">Standard Filter</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb358"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb358-1"><a href="#cb358-1" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> KalmanFilter.init_from(kSR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb359"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb359-1"><a href="#cb359-1" aria-hidden="true" tabindex="-1"></a>nan <span class="op">=</span> [{<span class="st">'nan'</span>:k.predict(<span class="op">*</span>get_test_data(n), smooth<span class="op">=</span>smooth).std.isnan().<span class="bu">any</span>().item(), <span class="st">'n'</span>: n, <span class="st">'rep'</span>: rep, <span class="st">'smooth'</span>: smooth}</span>
<span id="cb359-2"><a href="#cb359-2" aria-hidden="true" tabindex="-1"></a>       <span class="cf">for</span> n <span class="kw">in</span> [<span class="dv">10</span>, <span class="dv">20</span>, <span class="dv">30</span>, <span class="dv">40</span>, <span class="dv">50</span>, <span class="dv">55</span>, <span class="dv">60</span>, <span class="dv">70</span>, <span class="dv">100</span>, <span class="dv">150</span>, <span class="dv">200</span>] <span class="cf">for</span> rep <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>) <span class="cf">for</span> smooth <span class="kw">in</span> [<span class="va">True</span>, <span class="va">False</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb360"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb360-1"><a href="#cb360-1" aria-hidden="true" tabindex="-1"></a>nan_df <span class="op">=</span> pl.DataFrame(nan).groupby([<span class="st">'nan'</span>, <span class="st">'n'</span>, <span class="st">'smooth'</span>]).count().to_pandas()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb361"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a>alt.Chart(nan_df).mark_line().encode(x<span class="op">=</span><span class="st">'n:Q'</span>, y<span class="op">=</span><span class="st">'count'</span>, color<span class="op">=</span><span class="st">'nan'</span>, column<span class="op">=</span><span class="st">'smooth'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>so the standard filter is working better than the SR for the smoothing (with this parameter setting), so there is a way to make the sr smoother not that bad</p>
<p>But I just want to see how we have nan</p>
<p>So the problem is that we have a negative number on the diagonal … so is not positive definite and even the standard deviation is nan</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb362"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb362-1"><a href="#cb362-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">20</span>):</span>
<span id="cb362-2"><a href="#cb362-2" aria-hidden="true" tabindex="-1"></a>    dat <span class="op">=</span> get_test_data(<span class="dv">10</span>)</span>
<span id="cb362-3"><a href="#cb362-3" aria-hidden="true" tabindex="-1"></a>    pred <span class="op">=</span> kSR.predict(<span class="op">*</span>dat)</span>
<span id="cb362-4"><a href="#cb362-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pred.cov.isnan().<span class="bu">any</span>():</span>
<span id="cb362-5"><a href="#cb362-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(i)</span>
<span id="cb362-6"><a href="#cb362-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb363"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> KalmanFilter.init_from(kSR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb364"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb364-1"><a href="#cb364-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p1, p2 <span class="kw">in</span> <span class="bu">zip</span>(k.parameters(), kSR.parameters()):</span>
<span id="cb364-2"><a href="#cb364-2" aria-hidden="true" tabindex="-1"></a>    test_close(p1,p2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb365"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a>f_state_stand <span class="op">=</span> k.<span class="bu">filter</span>(<span class="op">*</span>dat)</span>
<span id="cb365-2"><a href="#cb365-2" aria-hidden="true" tabindex="-1"></a>s_state_stand <span class="op">=</span> k.smooth(<span class="op">*</span>dat)</span>
<span id="cb365-3"><a href="#cb365-3" aria-hidden="true" tabindex="-1"></a>pred_stand <span class="op">=</span> k.predict(<span class="op">*</span>dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb366"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb366-1"><a href="#cb366-1" aria-hidden="true" tabindex="-1"></a>pred_stand[<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>].std</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb367"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a>(f_state_stand.mean <span class="op">-</span> filt_state.mean).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb368"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb368-1"><a href="#cb368-1" aria-hidden="true" tabindex="-1"></a>filt_state <span class="op">=</span> kSR.<span class="bu">filter</span>(<span class="op">*</span>dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb369"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a>s_state <span class="op">=</span> kSR.smooth(<span class="op">*</span>dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb370"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb370-1"><a href="#cb370-1" aria-hidden="true" tabindex="-1"></a>is_posdef(s_state.cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb371"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb371-1"><a href="#cb371-1" aria-hidden="true" tabindex="-1"></a>is_posdef(s_state[<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>].cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb372"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb372-1"><a href="#cb372-1" aria-hidden="true" tabindex="-1"></a>filt_state[<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>].cov</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb373"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a>kSR.H <span class="op">@</span> s_state[<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>].cov <span class="op">@</span> kSR.H.mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb374"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb374-1"><a href="#cb374-1" aria-hidden="true" tabindex="-1"></a>kSR.use_sr_pred <span class="op">=</span> <span class="va">False</span></span>
<span id="cb374-2"><a href="#cb374-2" aria-hidden="true" tabindex="-1"></a>pred_obs <span class="op">=</span> kSR._obs_from_state(s_state)</span>
<span id="cb374-3"><a href="#cb374-3" aria-hidden="true" tabindex="-1"></a>pred_obs[<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>].cov</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb375"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a>kSR.predict(<span class="op">*</span>dat).</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb376"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb376-1"><a href="#cb376-1" aria-hidden="true" tabindex="-1"></a>pred.std[<span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="additional" class="level2">
<h2 class="anchored" data-anchor-id="additional">Additional</h2>
<section id="constructors-1" class="level3">
<h3 class="anchored" data-anchor-id="constructors-1">Constructors</h3>
<section id="simple-parameters" class="level4">
<h4 class="anchored" data-anchor-id="simple-parameters">Simple parameters</h4>
<hr>
</section>
</section>
<section id="init_simple" class="level3">
<h3 class="anchored" data-anchor-id="init_simple">init_simple’]</h3>
<p>Built-in mutable sequence.</p>
<p>If no argument is given, the constructor creates a new empty list. The argument must be an iterable if specified.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb377"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a>KalmanFilter.init_simple(<span class="dv">2</span>).state_dict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="local-slope" class="level4">
<h4 class="anchored" data-anchor-id="local-slope">Local slope</h4>
<p>Local slope models are an extentions of local level model that in the state variable keep track of also the slope</p>
<p>Given <span class="math inline">\(n\)</span> as the number of dimensions of the observations</p>
<p>The transition matrix (<code>A</code>) is:</p>
<p><span class="math display">\[A = \left[\begin{array}{cc}I &amp; I \\ 0 &amp; I\end{array}\right]\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(I \in \mathbb{R}^{n \times n}\)</span></li>
<li><span class="math inline">\(A \in \mathbb{R}^{2n \times 2n}\)</span></li>
</ul>
<p>the state <span class="math inline">\(x \in \mathbb{R}^{2N \times 1}\)</span> where the upper half keep track of the level and the lower half of the slope. <span class="math inline">\(A \in \mathbb{R}^2N \times 2N\)</span></p>
<p>the observation matrix (<code>H</code>) is:</p>
<p><span class="math display">\[H = \left[\begin{array}{cc}I &amp; 0 \end{array}\right]\]</span></p>
<p>For the multivariate case the 1 are replaced with an identiy matrix</p>
<p>assuming that the control has the same dimensions of the observations then if we are doing a local slope model we have <span class="math inline">\(B \in \mathbb{R}^{state \times contr}\)</span>: <span class="math display">\[ B = \begin{bmatrix} -I &amp; I \\ 0 &amp; 0 \end{bmatrix}\]</span></p>
<hr>
</section>
</section>
<section id="init_local_slope_pca" class="level3">
<h3 class="anchored" data-anchor-id="init_local_slope_pca">init_local_slope_pca’]</h3>
<p>Built-in mutable sequence.</p>
<p>If no argument is given, the constructor creates a new empty list. The argument must be an iterable if specified.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb378"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb378-1"><a href="#cb378-1" aria-hidden="true" tabindex="-1"></a>KalmanFilter.init_local_slope_pca(<span class="dv">2</span>,<span class="dv">2</span>,pd.DataFrame([[<span class="dv">1</span>,<span class="dv">2</span>], [<span class="dv">2</span>,<span class="dv">4</span>]])).state_dict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="export" class="level2">
<h2 class="anchored" data-anchor-id="export">Export</h2>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>