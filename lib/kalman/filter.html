<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.142">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend">

<title>meteo_imp - Kalman Filter</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="meteo_imp - Kalman Filter">
<meta property="og:description" content="Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend">
<meta property="og:site-name" content="meteo_imp">
<meta name="twitter:title" content="meteo_imp - Kalman Filter">
<meta name="twitter:description" content="Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">meteo_imp</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Kalman Filter</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">GPFA Imputation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../data_preparation.html" class="sidebar-item-text sidebar-link">Data Preparation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../results.html" class="sidebar-item-text sidebar-link">Results</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../simplegp_imputation.html" class="sidebar-item-text sidebar-link">Simple GP Imputation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gaussian.html" class="sidebar-item-text sidebar-link">Gaussian Distributions Utils</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../utils.html" class="sidebar-item-text sidebar-link">Utils</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Fluxnet</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Fluxnet/gap_finder.html" class="sidebar-item-text sidebar-link">Find Gaps in Fluxnet data</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Fluxnet/hainich.html" class="sidebar-item-text sidebar-link">Fluxnet Hainich</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">GPFA</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../GPFA/gpfa.html" class="sidebar-item-text sidebar-link">Gaussian Processes Factor Analysis</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../GPFA/learner.html" class="sidebar-item-text sidebar-link">GPFA Learner</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../GPFA/imputation.html" class="sidebar-item-text sidebar-link">Imputation time series</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">kalman</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/filter.html" class="sidebar-item-text sidebar-link active">Kalman Filter</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/test_filter_pykalman.html" class="sidebar-item-text sidebar-link">Compare PyKalman</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/filter_performance-stability.html" class="sidebar-item-text sidebar-link">Filter Perfomance and Stability</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/filter_numerical_stability.html" class="sidebar-item-text sidebar-link">Numerical stability filter</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/fastai.html" class="sidebar-item-text sidebar-link">Implement Kalman model using FastAI</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/learner.html" class="sidebar-item-text sidebar-link">Kalman Filter Models</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/imputation.html" class="sidebar-item-text sidebar-link">Imputation Kalman Model</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/old statsmodels - statespace.html" class="sidebar-item-text sidebar-link">[Not Working] StatsModels Kalman filter</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/old_01_pykalman_models.html" class="sidebar-item-text sidebar-link">[OLD] PyKalman Filter Models</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/old_02_pykalman_imputation.html" class="sidebar-item-text sidebar-link">[OLD] Imputation PyKalman Model</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#equations" id="toc-equations" class="nav-link" data-scroll-target="#equations">Equations</a></li>
  </ul></li>
  <li><a href="#kalman-filter-base" id="toc-kalman-filter-base" class="nav-link" data-scroll-target="#kalman-filter-base">Kalman Filter Base</a>
  <ul class="collapse">
  <li><a href="#utils" id="toc-utils" class="nav-link" data-scroll-target="#utils">Utils</a></li>
  <li><a href="#kalman-filter-base-1" id="toc-kalman-filter-base-1" class="nav-link" data-scroll-target="#kalman-filter-base-1">Kalman Filter Base</a>
  <ul class="collapse">
  <li><a href="#kalmanfilterbase" id="toc-kalmanfilterbase" class="nav-link" data-scroll-target="#kalmanfilterbase">KalmanFilterBase</a></li>
  <li><a href="#constructors" id="toc-constructors" class="nav-link" data-scroll-target="#constructors">Constructors</a></li>
  <li><a href="#kalmanfilter" id="toc-kalmanfilter" class="nav-link" data-scroll-target="#kalmanfilter">KalmanFilter</a></li>
  <li><a href="#kalmanfiltersr" id="toc-kalmanfiltersr" class="nav-link" data-scroll-target="#kalmanfiltersr">KalmanFilterSR</a></li>
  <li><a href="#init_from" id="toc-init_from" class="nav-link" data-scroll-target="#init_from">init_from’]</a></li>
  <li><a href="#get-info" id="toc-get-info" class="nav-link" data-scroll-target="#get-info">Get Info</a></li>
  <li><a href="#kalmanfilterbase.get_info" id="toc-kalmanfilterbase.get_info" class="nav-link" data-scroll-target="#kalmanfilterbase.get_info">KalmanFilterBase.get_info</a></li>
  <li><a href="#test-data" id="toc-test-data" class="nav-link" data-scroll-target="#test-data">Test data</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#standard-kalman-filter" id="toc-standard-kalman-filter" class="nav-link" data-scroll-target="#standard-kalman-filter">Standard Kalman Filter</a>
  <ul class="collapse">
  <li><a href="#filter" id="toc-filter" class="nav-link" data-scroll-target="#filter">Filter</a>
  <ul class="collapse">
  <li><a href="#filter-predict" id="toc-filter-predict" class="nav-link" data-scroll-target="#filter-predict">Filter predict</a></li>
  <li><a href="#unsqueeze_iter" id="toc-unsqueeze_iter" class="nav-link" data-scroll-target="#unsqueeze_iter">unsqueeze_iter</a></li>
  <li><a href="#filter-update" id="toc-filter-update" class="nav-link" data-scroll-target="#filter-update">Filter update</a></li>
  <li><a href="#filter-all" id="toc-filter-all" class="nav-link" data-scroll-target="#filter-all">Filter All</a></li>
  <li><a href="#filter-1" id="toc-filter-1" class="nav-link" data-scroll-target="#filter-1">Filter</a></li>
  <li><a href="#kalmanfilter.filter" id="toc-kalmanfilter.filter" class="nav-link" data-scroll-target="#kalmanfilter.filter">KalmanFilter.filter</a></li>
  </ul></li>
  <li><a href="#smooth" id="toc-smooth" class="nav-link" data-scroll-target="#smooth">Smooth</a>
  <ul class="collapse">
  <li><a href="#smooth-update-step" id="toc-smooth-update-step" class="nav-link" data-scroll-target="#smooth-update-step">Smooth update step</a></li>
  <li><a href="#smooth-1" id="toc-smooth-1" class="nav-link" data-scroll-target="#smooth-1">Smooth</a></li>
  <li><a href="#kalmanfilter-method" id="toc-kalmanfilter-method" class="nav-link" data-scroll-target="#kalmanfilter-method">KalmanFilter method</a></li>
  <li><a href="#kalmanfilter.smooth" id="toc-kalmanfilter.smooth" class="nav-link" data-scroll-target="#kalmanfilter.smooth">KalmanFilter.smooth</a></li>
  </ul></li>
  <li><a href="#predict-1" id="toc-predict-1" class="nav-link" data-scroll-target="#predict-1">Predict</a>
  <ul class="collapse">
  <li><a href="#kalmanfilter.predict" id="toc-kalmanfilter.predict" class="nav-link" data-scroll-target="#kalmanfilter.predict">KalmanFilter.predict</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#numerical-stable-kalman-filter-square-root-filter" id="toc-numerical-stable-kalman-filter-square-root-filter" class="nav-link" data-scroll-target="#numerical-stable-kalman-filter-square-root-filter">Numerical Stable Kalman Filter (Square Root Filter)</a>
  <ul class="collapse">
  <li><a href="#filter-2" id="toc-filter-2" class="nav-link" data-scroll-target="#filter-2">Filter</a>
  <ul class="collapse">
  <li><a href="#filter-predict-1" id="toc-filter-predict-1" class="nav-link" data-scroll-target="#filter-predict-1">Filter predict</a></li>
  <li><a href="#filter-update-1" id="toc-filter-update-1" class="nav-link" data-scroll-target="#filter-update-1">Filter Update</a></li>
  <li><a href="#filter-all-1" id="toc-filter-all-1" class="nav-link" data-scroll-target="#filter-all-1">Filter All</a></li>
  <li><a href="#filter-3" id="toc-filter-3" class="nav-link" data-scroll-target="#filter-3">Filter</a></li>
  <li><a href="#kalmanfiltersr.filter" id="toc-kalmanfiltersr.filter" class="nav-link" data-scroll-target="#kalmanfiltersr.filter">KalmanFilterSR.filter</a></li>
  <li><a href="#comparison" id="toc-comparison" class="nav-link" data-scroll-target="#comparison">Comparison</a></li>
  </ul></li>
  <li><a href="#additional" id="toc-additional" class="nav-link" data-scroll-target="#additional">Additional</a>
  <ul class="collapse">
  <li><a href="#constructors-1" id="toc-constructors-1" class="nav-link" data-scroll-target="#constructors-1">Constructors</a></li>
  <li><a href="#kalmanfilter.init_simple" id="toc-kalmanfilter.init_simple" class="nav-link" data-scroll-target="#kalmanfilter.init_simple">KalmanFilter.init_simple</a></li>
  <li><a href="#kalmanfilter.init_local_slope_pca" id="toc-kalmanfilter.init_local_slope_pca" class="nav-link" data-scroll-target="#kalmanfilter.init_local_slope_pca">KalmanFilter.init_local_slope_pca</a></li>
  </ul></li>
  <li><a href="#export" id="toc-export" class="nav-link" data-scroll-target="#export">Export</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/mone27/meteo_imp/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Kalman Filter</h1>
</div>

<div>
  <div class="description">
    Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The models uses a latent state variable <span class="math inline">\(x\)</span> that is modelled over time, to impute gaps in <span class="math inline">\(y\)</span></p>
<p>The assumption of the model is that the state variable at time <span class="math inline">\(x_t\)</span> depends only on the last state <span class="math inline">\(x_{t-1}\)</span> and not on the previous states.</p>
<section id="equations" class="level3">
<h3 class="anchored" data-anchor-id="equations">Equations</h3>
<p>The equations of the model are:</p>
<p><span class="math display">\[\begin{align} p(x_t | x_{t-1}) &amp; = \mathcal{N}(Ax_{t-1} + b, Q) \\
p(y_t | x_t) &amp; = \mathcal{N}(Hx_t + d, R) \end{align}\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(A\)</span> is the <code>A</code></li>
<li><span class="math inline">\(b\)</span> is the <code>bset</code></li>
<li><span class="math inline">\(Q\)</span> is the <code>Q</code></li>
<li><span class="math inline">\(H\)</span> is the <code>obs_trans</code></li>
<li><span class="math inline">\(d\)</span> is the <code>d</code></li>
<li><span class="math inline">\(R\)</span> is the <code>R</code></li>
</ul>
<p>in addition the model has also the parameters of the initial state that are used to initialize the filter:</p>
<ul>
<li><code>m0</code></li>
<li><code>P0</code></li>
</ul>
<p>The Kalman filter has 3 steps:</p>
<ul>
<li>filter (updating the state at time t with observations till time t-1)</li>
<li>update (update the state at time t using the observation at time t)</li>
<li>smooth (update the state using the observations at time t+1)</li>
</ul>
<p>In case of missing data the update step is skipped.</p>
<p>After smoothing the missing data at time t (<span class="math inline">\(y_t\)</span>) can be imputed from the state (<span class="math inline">\(x_t\)</span>) using this formula: <span class="math display">\[p(y_t|x_t) = \mathcal{N}(Hx_t + d, R + HP^s_tH^T)\]</span></p>
<p>The Kalman Filter is an algorithm designed to estimate <span class="math inline">\(P(x_t | y_{0:t})\)</span>. As all state transitions and obss are linear with Gaussian distributed noise, these distributions can be represented exactly as Gaussian distributions with mean <code>ms[t]</code> and covs <code>Ps[t]</code>. Similarly, the Kalman Smoother is an algorithm designed to estimate <span class="math inline">\(P(x_t | y_{0:t-1})\)</span></p>
</section>
</section>
<section id="kalman-filter-base" class="level1">
<h1>Kalman Filter Base</h1>
<section id="utils" class="level3">
<h3 class="anchored" data-anchor-id="utils">Utils</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>show_as_row(_add_batch_dim(torch.ones(<span class="dv">2</span>)), _add_batch_dim(torch.ones(<span class="dv">2</span>,<span class="dv">2</span>)), _add_batch_dim(torch.ones(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[[1.],
         [1.]]])</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[[1., 1.],
         [1., 1.]]])</pre> </div><div><p style="font-size: 1.2rem;">#2</p> <pre>tensor([[[1., 1.],
         [1., 1.]],

        [[1., 1.],
         [1., 1.]]])</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>show_as_row(_add_batch_dim(torch.ones(<span class="dv">2</span>)).shape, _add_batch_dim(torch.ones(<span class="dv">2</span>,<span class="dv">2</span>)).shape, _add_batch_dim(torch.ones(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>)).shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([1, 2, 1])</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([1, 2, 2])</pre> </div><div><p style="font-size: 1.2rem;">#2</p> <pre>torch.Size([2, 2, 2])</pre> </div></div>
</div>
</div>
</section>
<section id="kalman-filter-base-1" class="level2">
<h2 class="anchored" data-anchor-id="kalman-filter-base-1">Kalman Filter Base</h2>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L46" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="kalmanfilterbase" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilterbase">KalmanFilterBase</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilterBase (A:torch.Tensor, H:torch.Tensor, B:torch.Tensor,
                   Q:torch.Tensor, R:torch.Tensor, b:torch.Tensor,
                   d:torch.Tensor, m0:torch.Tensor, P0:torch.Tensor,
                   n_dim_state:int=None, n_dim_obs:int=None,
                   n_dim_contr:int=None,
                   var_names:Optional[Iterable[str]]=None,
                   contr_names:Optional[Iterable[str]]=None,
                   cov_checker:meteo_imp.gaussian.CheckPosDef|None=None,
                   use_conditional:bool=True, use_control:bool=True,
                   use_smooth:bool=True)</code></pre>
</blockquote>
<p>Base class for handling Kalman Filter implementation in PyTorch</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state,n_dim_state] <span class="math inline">\(A\)</span>, state transition matrix</td>
</tr>
<tr class="even">
<td>H</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_state] <span class="math inline">\(H\)</span>, observation matrix</td>
</tr>
<tr class="odd">
<td>B</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_contr] <span class="math inline">\(B\)</span> control matrix</td>
</tr>
<tr class="even">
<td>Q</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(Q\)</span>, state trans covariance matrix</td>
</tr>
<tr class="odd">
<td>R</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_obs] <span class="math inline">\(R\)</span>, observations covariance matrix</td>
</tr>
<tr class="even">
<td>b</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(b\)</span>, state transition offset</td>
</tr>
<tr class="odd">
<td>d</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs] <span class="math inline">\(d\)</span>, observations offset</td>
</tr>
<tr class="even">
<td>m0</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(m_0\)</span></td>
</tr>
<tr class="odd">
<td>P0</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(P_0\)</span></td>
</tr>
<tr class="even">
<td>n_dim_state</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for state - default infered from parameters</td>
</tr>
<tr class="odd">
<td>n_dim_obs</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for observations - default infered from parameters</td>
</tr>
<tr class="even">
<td>n_dim_contr</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for control - default infered from parameters</td>
</tr>
<tr class="odd">
<td>var_names</td>
<td>Optional</td>
<td>None</td>
<td>Names of variables for printing</td>
</tr>
<tr class="even">
<td>contr_names</td>
<td>Optional</td>
<td>None</td>
<td>Names of control variables for printing</td>
</tr>
<tr class="odd">
<td>cov_checker</td>
<td>meteo_imp.gaussian.CheckPosDef | None</td>
<td>None</td>
<td>Check covariance at every step</td>
</tr>
<tr class="even">
<td>use_conditional</td>
<td>bool</td>
<td>True</td>
<td>Use conditional distribution for gaps that don’t have all variables missing</td>
</tr>
<tr class="odd">
<td>use_control</td>
<td>bool</td>
<td>True</td>
<td>Use the control in the filter</td>
</tr>
<tr class="even">
<td>use_smooth</td>
<td>bool</td>
<td>True</td>
<td>Use smoother for predictions (otherwise is filter only)</td>
</tr>
</tbody>
</table>
</section>
<section id="constructors" class="level3">
<h3 class="anchored" data-anchor-id="constructors">Constructors</h3>
<p>Giving all the parameters manually to the <a href="https://mone27.github.io/meteo_imp/lib/kalman/filter.html#kalmanfilterbase"><code>KalmanFilterBase</code></a> init method is not convenient, hence we are having some methods that help initize the class</p>
<p>due to a bug in fastcore cannot subclass after creating class methods</p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L185" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter">KalmanFilter</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter (A:torch.Tensor, H:torch.Tensor, B:torch.Tensor,
               Q:torch.Tensor, R:torch.Tensor, b:torch.Tensor,
               d:torch.Tensor, m0:torch.Tensor, P0:torch.Tensor,
               n_dim_state:int=None, n_dim_obs:int=None,
               n_dim_contr:int=None,
               var_names:Optional[Iterable[str]]=None,
               contr_names:Optional[Iterable[str]]=None,
               cov_checker:meteo_imp.gaussian.CheckPosDef|None=None,
               use_conditional:bool=True, use_control:bool=True,
               use_smooth:bool=True)</code></pre>
</blockquote>
<p>Base class for handling Kalman Filter implementation in PyTorch</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state,n_dim_state] <span class="math inline">\(A\)</span>, state transition matrix</td>
</tr>
<tr class="even">
<td>H</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_state] <span class="math inline">\(H\)</span>, observation matrix</td>
</tr>
<tr class="odd">
<td>B</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_contr] <span class="math inline">\(B\)</span> control matrix</td>
</tr>
<tr class="even">
<td>Q</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(Q\)</span>, state trans covariance matrix</td>
</tr>
<tr class="odd">
<td>R</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_obs] <span class="math inline">\(R\)</span>, observations covariance matrix</td>
</tr>
<tr class="even">
<td>b</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(b\)</span>, state transition offset</td>
</tr>
<tr class="odd">
<td>d</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs] <span class="math inline">\(d\)</span>, observations offset</td>
</tr>
<tr class="even">
<td>m0</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(m_0\)</span></td>
</tr>
<tr class="odd">
<td>P0</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(P_0\)</span></td>
</tr>
<tr class="even">
<td>n_dim_state</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for state - default infered from parameters</td>
</tr>
<tr class="odd">
<td>n_dim_obs</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for observations - default infered from parameters</td>
</tr>
<tr class="even">
<td>n_dim_contr</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for control - default infered from parameters</td>
</tr>
<tr class="odd">
<td>var_names</td>
<td>Optional</td>
<td>None</td>
<td>Names of variables for printing</td>
</tr>
<tr class="even">
<td>contr_names</td>
<td>Optional</td>
<td>None</td>
<td>Names of control variables for printing</td>
</tr>
<tr class="odd">
<td>cov_checker</td>
<td>meteo_imp.gaussian.CheckPosDef | None</td>
<td>None</td>
<td>Check covariance at every step</td>
</tr>
<tr class="even">
<td>use_conditional</td>
<td>bool</td>
<td>True</td>
<td>Use conditional distribution for gaps that don’t have all variables missing</td>
</tr>
<tr class="odd">
<td>use_control</td>
<td>bool</td>
<td>True</td>
<td>Use the control in the filter</td>
</tr>
<tr class="even">
<td>use_smooth</td>
<td>bool</td>
<td>True</td>
<td>Use smoother for predictions (otherwise is filter only)</td>
</tr>
</tbody>
</table>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L189" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfiltersr" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfiltersr">KalmanFilterSR</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilterSR (A:torch.Tensor, H:torch.Tensor, B:torch.Tensor,
                 Q:torch.Tensor, R:torch.Tensor, b:torch.Tensor,
                 d:torch.Tensor, m0:torch.Tensor, P0:torch.Tensor,
                 n_dim_state:int=None, n_dim_obs:int=None,
                 n_dim_contr:int=None,
                 var_names:Optional[Iterable[str]]=None,
                 contr_names:Optional[Iterable[str]]=None,
                 cov_checker:meteo_imp.gaussian.CheckPosDef|None=None,
                 use_conditional:bool=True, use_control:bool=True,
                 use_smooth:bool=True)</code></pre>
</blockquote>
<p>Base class for handling Kalman Filter implementation in PyTorch</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state,n_dim_state] <span class="math inline">\(A\)</span>, state transition matrix</td>
</tr>
<tr class="even">
<td>H</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_state] <span class="math inline">\(H\)</span>, observation matrix</td>
</tr>
<tr class="odd">
<td>B</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_contr] <span class="math inline">\(B\)</span> control matrix</td>
</tr>
<tr class="even">
<td>Q</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(Q\)</span>, state trans covariance matrix</td>
</tr>
<tr class="odd">
<td>R</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_obs] <span class="math inline">\(R\)</span>, observations covariance matrix</td>
</tr>
<tr class="even">
<td>b</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(b\)</span>, state transition offset</td>
</tr>
<tr class="odd">
<td>d</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs] <span class="math inline">\(d\)</span>, observations offset</td>
</tr>
<tr class="even">
<td>m0</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(m_0\)</span></td>
</tr>
<tr class="odd">
<td>P0</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(P_0\)</span></td>
</tr>
<tr class="even">
<td>n_dim_state</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for state - default infered from parameters</td>
</tr>
<tr class="odd">
<td>n_dim_obs</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for observations - default infered from parameters</td>
</tr>
<tr class="even">
<td>n_dim_contr</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for control - default infered from parameters</td>
</tr>
<tr class="odd">
<td>var_names</td>
<td>Optional</td>
<td>None</td>
<td>Names of variables for printing</td>
</tr>
<tr class="even">
<td>contr_names</td>
<td>Optional</td>
<td>None</td>
<td>Names of control variables for printing</td>
</tr>
<tr class="odd">
<td>cov_checker</td>
<td>meteo_imp.gaussian.CheckPosDef | None</td>
<td>None</td>
<td>Check covariance at every step</td>
</tr>
<tr class="even">
<td>use_conditional</td>
<td>bool</td>
<td>True</td>
<td>Use conditional distribution for gaps that don’t have all variables missing</td>
</tr>
<tr class="odd">
<td>use_control</td>
<td>bool</td>
<td>True</td>
<td>Use the control in the filter</td>
</tr>
<tr class="even">
<td>use_smooth</td>
<td>bool</td>
<td>True</td>
<td>Use smoother for predictions (otherwise is filter only)</td>
</tr>
</tbody>
</table>
<section id="random-parameters" class="level4">
<h4 class="anchored" data-anchor-id="random-parameters">Random parameters</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>kB <span class="op">=</span> KalmanFilterBase.init_random(<span class="dv">3</span>,<span class="dv">4</span>, <span class="dv">3</span>, dtype<span class="op">=</span>torch.float64)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>kB</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Kalman Filter
        N dim obs: 3,
        N dim state: 4,
        N dim contr: 3</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>test_close(kB.Q_C <span class="op">@</span> kB.Q_C.mT, kB.Q, eps<span class="op">=</span><span class="fl">2e-5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>kB.P0 <span class="op">=</span> to_posdef(torch.rand(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>check that assigment works :)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>kB.P0 <span class="op">=</span> to_posdef(torch.rand(<span class="dv">4</span>, <span class="dv">4</span>, dtype<span class="op">=</span>torch.float64))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>kB.P0_C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Parameter containing:
tensor([[0.9340, 0.0000, 0.0000, 0.0000],
        [1.0605, 0.2445, 0.0000, 0.0000],
        [1.0207, 0.4495, 0.8036, 0.0000],
        [0.4206, 0.1265, 0.0767, 0.0983]], dtype=torch.float64,
       requires_grad=True)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>kB <span class="op">=</span> KalmanFilterBase.init_random(<span class="dv">3</span>,<span class="dv">4</span>, <span class="dv">3</span>, dtype<span class="op">=</span>torch.float64)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>kB</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Kalman Filter
        N dim obs: 3,
        N dim state: 4,
        N dim contr: 3</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(kB.named_parameters())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[('A',
  Parameter containing:
  tensor([[[0.2082, 0.1327, 0.0447, 0.6860],
           [0.1764, 0.5756, 0.4995, 0.9907],
           [0.6185, 0.2050, 0.4548, 0.4365],
           [0.7427, 0.5919, 0.4975, 0.0609]]], dtype=torch.float64,
         requires_grad=True)),
 ('H',
  Parameter containing:
  tensor([[[0.2712, 0.3454, 0.9073, 0.9889],
           [0.3629, 0.4210, 0.5668, 0.9796],
           [0.8114, 0.0584, 0.9681, 0.8442]]], dtype=torch.float64,
         requires_grad=True)),
 ('B',
  Parameter containing:
  tensor([[[0.9434, 0.6200, 0.8832],
           [0.9176, 0.5619, 0.1946],
           [0.5095, 0.0843, 0.9053],
           [0.5472, 0.8411, 0.9707]]], dtype=torch.float64, requires_grad=True)),
 ('Q_raw',
  Parameter containing:
  tensor([[[0.1125, 0.0000, 0.0000, 0.0000],
           [0.0000, 0.4965, 0.0000, 0.0000],
           [0.0000, 0.0000, 0.9714, 0.0000],
           [0.0000, 0.0000, 0.0000, 0.9973]]], dtype=torch.float64,
         requires_grad=True)),
 ('R_raw',
  Parameter containing:
  tensor([[[0.7537, 0.0000, 0.0000],
           [0.0000, 0.6649, 0.0000],
           [0.0000, 0.0000, 0.5867]]], dtype=torch.float64, requires_grad=True)),
 ('b',
  Parameter containing:
  tensor([[[0.3170],
           [0.5824],
           [0.8291],
           [0.6100]]], dtype=torch.float64, requires_grad=True)),
 ('d',
  Parameter containing:
  tensor([[[0.8146],
           [0.4824],
           [0.2898]]], dtype=torch.float64, requires_grad=True)),
 ('m0',
  Parameter containing:
  tensor([[[0.3079],
           [0.7986],
           [0.6972],
           [0.5632]]], dtype=torch.float64, requires_grad=True)),
 ('P0_raw',
  Parameter containing:
  tensor([[[ 1.1124,  0.0000,  0.0000,  0.0000],
           [ 0.4330,  0.6578,  0.0000,  0.0000],
           [ 1.3395,  0.7410,  0.6054,  0.0000],
           [ 0.8086,  0.1374, -0.2470,  0.3469]]], dtype=torch.float64,
         requires_grad=True))]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>kB.state_dict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>OrderedDict([('A',
              tensor([[[0.2082, 0.1327, 0.0447, 0.6860],
                       [0.1764, 0.5756, 0.4995, 0.9907],
                       [0.6185, 0.2050, 0.4548, 0.4365],
                       [0.7427, 0.5919, 0.4975, 0.0609]]], dtype=torch.float64)),
             ('H',
              tensor([[[0.2712, 0.3454, 0.9073, 0.9889],
                       [0.3629, 0.4210, 0.5668, 0.9796],
                       [0.8114, 0.0584, 0.9681, 0.8442]]], dtype=torch.float64)),
             ('B',
              tensor([[[0.9434, 0.6200, 0.8832],
                       [0.9176, 0.5619, 0.1946],
                       [0.5095, 0.0843, 0.9053],
                       [0.5472, 0.8411, 0.9707]]], dtype=torch.float64)),
             ('Q_raw',
              tensor([[[0.1125, 0.0000, 0.0000, 0.0000],
                       [0.0000, 0.4965, 0.0000, 0.0000],
                       [0.0000, 0.0000, 0.9714, 0.0000],
                       [0.0000, 0.0000, 0.0000, 0.9973]]], dtype=torch.float64)),
             ('R_raw',
              tensor([[[0.7537, 0.0000, 0.0000],
                       [0.0000, 0.6649, 0.0000],
                       [0.0000, 0.0000, 0.5867]]], dtype=torch.float64)),
             ('b',
              tensor([[[0.3170],
                       [0.5824],
                       [0.8291],
                       [0.6100]]], dtype=torch.float64)),
             ('d',
              tensor([[[0.8146],
                       [0.4824],
                       [0.2898]]], dtype=torch.float64)),
             ('m0',
              tensor([[[0.3079],
                       [0.7986],
                       [0.6972],
                       [0.5632]]], dtype=torch.float64)),
             ('P0_raw',
              tensor([[[ 1.1124,  0.0000,  0.0000,  0.0000],
                       [ 0.4330,  0.6578,  0.0000,  0.0000],
                       [ 1.3395,  0.7410,  0.6054,  0.0000],
                       [ 0.8086,  0.1374, -0.2470,  0.3469]]], dtype=torch.float64))])</code></pre>
</div>
</div>
</section>
<section id="from-filter" class="level4">
<h4 class="anchored" data-anchor-id="from-filter">From filter</h4>
<hr>
</section>
</section>
<section id="init_from" class="level3">
<h3 class="anchored" data-anchor-id="init_from">init_from’]</h3>
<p>Built-in mutable sequence.</p>
<p>If no argument is given, the constructor creates a new empty list. The argument must be an iterable if specified.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>k1 <span class="op">=</span> KalmanFilter.init_random(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">3</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>k2 <span class="op">=</span> KalmanFilterSR.init_from(k1)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p1, p2 <span class="kw">in</span> <span class="bu">zip</span>(k1.parameters(), k2.parameters()):</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    test_close(p1,p2, eps<span class="op">=</span><span class="fl">1e-3</span>) <span class="co">#noise added by contraints</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-info" class="level3">
<h3 class="anchored" data-anchor-id="get-info">Get Info</h3>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L225" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilterbase.get_info" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilterbase.get_info">KalmanFilterBase.get_info</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilterBase.get_info ()</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>kB</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<p style="font-size: 1.5rem; font-decoration: bold">Kalman Filter (3 obs, 4 state, 3 contr)</p><p></p><div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div> <p style="font-size: 1.3rem;">$A$</p> <style type="text/css">
</style>

<table id="T_33c10" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_33c10_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_33c10_level0_col1" class="col_heading level0 col1">x_0</th>
<th id="T_33c10_level0_col2" class="col_heading level0 col2">x_1</th>
<th id="T_33c10_level0_col3" class="col_heading level0 col3">x_2</th>
<th id="T_33c10_level0_col4" class="col_heading level0 col4">x_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_33c10_row0_col0" class="data row0 col0">x_0</td>
<td id="T_33c10_row0_col1" class="data row0 col1">0.2082</td>
<td id="T_33c10_row0_col2" class="data row0 col2">0.1327</td>
<td id="T_33c10_row0_col3" class="data row0 col3">0.0447</td>
<td id="T_33c10_row0_col4" class="data row0 col4">0.6860</td>
</tr>
<tr class="even">
<td id="T_33c10_row1_col0" class="data row1 col0">x_1</td>
<td id="T_33c10_row1_col1" class="data row1 col1">0.1764</td>
<td id="T_33c10_row1_col2" class="data row1 col2">0.5756</td>
<td id="T_33c10_row1_col3" class="data row1 col3">0.4995</td>
<td id="T_33c10_row1_col4" class="data row1 col4">0.9907</td>
</tr>
<tr class="odd">
<td id="T_33c10_row2_col0" class="data row2 col0">x_2</td>
<td id="T_33c10_row2_col1" class="data row2 col1">0.6185</td>
<td id="T_33c10_row2_col2" class="data row2 col2">0.2050</td>
<td id="T_33c10_row2_col3" class="data row2 col3">0.4548</td>
<td id="T_33c10_row2_col4" class="data row2 col4">0.4365</td>
</tr>
<tr class="even">
<td id="T_33c10_row3_col0" class="data row3 col0">x_3</td>
<td id="T_33c10_row3_col1" class="data row3 col1">0.7427</td>
<td id="T_33c10_row3_col2" class="data row3 col2">0.5919</td>
<td id="T_33c10_row3_col3" class="data row3 col3">0.4975</td>
<td id="T_33c10_row3_col4" class="data row3 col4">0.0609</td>
</tr>
</tbody>
</table>
<div>
<p>$Q$</p>
<table id="T_a2fec" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_a2fec_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_a2fec_level0_col1" class="col_heading level0 col1">x_0</th>
<th id="T_a2fec_level0_col2" class="col_heading level0 col2">x_1</th>
<th id="T_a2fec_level0_col3" class="col_heading level0 col3">x_2</th>
<th id="T_a2fec_level0_col4" class="col_heading level0 col4">x_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_a2fec_row0_col0" class="data row0 col0">x_0</td>
<td id="T_a2fec_row0_col1" class="data row0 col1">0.0127</td>
<td id="T_a2fec_row0_col2" class="data row0 col2">0.0000</td>
<td id="T_a2fec_row0_col3" class="data row0 col3">0.0000</td>
<td id="T_a2fec_row0_col4" class="data row0 col4">0.0000</td>
</tr>
<tr class="even">
<td id="T_a2fec_row1_col0" class="data row1 col0">x_1</td>
<td id="T_a2fec_row1_col1" class="data row1 col1">0.0000</td>
<td id="T_a2fec_row1_col2" class="data row1 col2">0.2465</td>
<td id="T_a2fec_row1_col3" class="data row1 col3">0.0000</td>
<td id="T_a2fec_row1_col4" class="data row1 col4">0.0000</td>
</tr>
<tr class="odd">
<td id="T_a2fec_row2_col0" class="data row2 col0">x_2</td>
<td id="T_a2fec_row2_col1" class="data row2 col1">0.0000</td>
<td id="T_a2fec_row2_col2" class="data row2 col2">0.0000</td>
<td id="T_a2fec_row2_col3" class="data row2 col3">0.9436</td>
<td id="T_a2fec_row2_col4" class="data row2 col4">0.0000</td>
</tr>
<tr class="even">
<td id="T_a2fec_row3_col0" class="data row3 col0">x_3</td>
<td id="T_a2fec_row3_col1" class="data row3 col1">0.0000</td>
<td id="T_a2fec_row3_col2" class="data row3 col2">0.0000</td>
<td id="T_a2fec_row3_col3" class="data row3 col3">0.0000</td>
<td id="T_a2fec_row3_col4" class="data row3 col4">0.9946</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>$b$</p>
<table id="T_5827d" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_5827d_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_5827d_level0_col1" class="col_heading level0 col1">offset</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_5827d_row0_col0" class="data row0 col0">x_0</td>
<td id="T_5827d_row0_col1" class="data row0 col1">0.3170</td>
</tr>
<tr class="even">
<td id="T_5827d_row1_col0" class="data row1 col0">x_1</td>
<td id="T_5827d_row1_col1" class="data row1 col1">0.5824</td>
</tr>
<tr class="odd">
<td id="T_5827d_row2_col0" class="data row2 col0">x_2</td>
<td id="T_5827d_row2_col1" class="data row2 col1">0.8291</td>
</tr>
<tr class="even">
<td id="T_5827d_row3_col0" class="data row3 col0">x_3</td>
<td id="T_5827d_row3_col1" class="data row3 col1">0.6100</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>$H$</p>
<table id="T_b9679" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_b9679_level0_col0" class="col_heading level0 col0">variable</th>
<th id="T_b9679_level0_col1" class="col_heading level0 col1">x_0</th>
<th id="T_b9679_level0_col2" class="col_heading level0 col2">x_1</th>
<th id="T_b9679_level0_col3" class="col_heading level0 col3">x_2</th>
<th id="T_b9679_level0_col4" class="col_heading level0 col4">x_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_b9679_row0_col0" class="data row0 col0">y_0</td>
<td id="T_b9679_row0_col1" class="data row0 col1">0.2712</td>
<td id="T_b9679_row0_col2" class="data row0 col2">0.3454</td>
<td id="T_b9679_row0_col3" class="data row0 col3">0.9073</td>
<td id="T_b9679_row0_col4" class="data row0 col4">0.9889</td>
</tr>
<tr class="even">
<td id="T_b9679_row1_col0" class="data row1 col0">y_1</td>
<td id="T_b9679_row1_col1" class="data row1 col1">0.3629</td>
<td id="T_b9679_row1_col2" class="data row1 col2">0.4210</td>
<td id="T_b9679_row1_col3" class="data row1 col3">0.5668</td>
<td id="T_b9679_row1_col4" class="data row1 col4">0.9796</td>
</tr>
<tr class="odd">
<td id="T_b9679_row2_col0" class="data row2 col0">y_2</td>
<td id="T_b9679_row2_col1" class="data row2 col1">0.8114</td>
<td id="T_b9679_row2_col2" class="data row2 col2">0.0584</td>
<td id="T_b9679_row2_col3" class="data row2 col3">0.9681</td>
<td id="T_b9679_row2_col4" class="data row2 col4">0.8442</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>$R$</p>
<table id="T_ff91e" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_ff91e_level0_col0" class="col_heading level0 col0">variable</th>
<th id="T_ff91e_level0_col1" class="col_heading level0 col1">y_0</th>
<th id="T_ff91e_level0_col2" class="col_heading level0 col2">y_1</th>
<th id="T_ff91e_level0_col3" class="col_heading level0 col3">y_2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_ff91e_row0_col0" class="data row0 col0">y_0</td>
<td id="T_ff91e_row0_col1" class="data row0 col1">0.5680</td>
<td id="T_ff91e_row0_col2" class="data row0 col2">0.0000</td>
<td id="T_ff91e_row0_col3" class="data row0 col3">0.0000</td>
</tr>
<tr class="even">
<td id="T_ff91e_row1_col0" class="data row1 col0">y_1</td>
<td id="T_ff91e_row1_col1" class="data row1 col1">0.0000</td>
<td id="T_ff91e_row1_col2" class="data row1 col2">0.4421</td>
<td id="T_ff91e_row1_col3" class="data row1 col3">0.0000</td>
</tr>
<tr class="odd">
<td id="T_ff91e_row2_col0" class="data row2 col0">y_2</td>
<td id="T_ff91e_row2_col1" class="data row2 col1">0.0000</td>
<td id="T_ff91e_row2_col2" class="data row2 col2">0.0000</td>
<td id="T_ff91e_row2_col3" class="data row2 col3">0.3442</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>$d$</p>
<table id="T_c781e" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_c781e_level0_col0" class="col_heading level0 col0">variable</th>
<th id="T_c781e_level0_col1" class="col_heading level0 col1">offset</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_c781e_row0_col0" class="data row0 col0">y_0</td>
<td id="T_c781e_row0_col1" class="data row0 col1">0.8146</td>
</tr>
<tr class="even">
<td id="T_c781e_row1_col0" class="data row1 col0">y_1</td>
<td id="T_c781e_row1_col1" class="data row1 col1">0.4824</td>
</tr>
<tr class="odd">
<td id="T_c781e_row2_col0" class="data row2 col0">y_2</td>
<td id="T_c781e_row2_col1" class="data row2 col1">0.2898</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>$B$</p>
<table id="T_dc006" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_dc006_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_dc006_level0_col1" class="col_heading level0 col1">c_0</th>
<th id="T_dc006_level0_col2" class="col_heading level0 col2">c_1</th>
<th id="T_dc006_level0_col3" class="col_heading level0 col3">c_2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_dc006_row0_col0" class="data row0 col0">x_0</td>
<td id="T_dc006_row0_col1" class="data row0 col1">0.9434</td>
<td id="T_dc006_row0_col2" class="data row0 col2">0.6200</td>
<td id="T_dc006_row0_col3" class="data row0 col3">0.8832</td>
</tr>
<tr class="even">
<td id="T_dc006_row1_col0" class="data row1 col0">x_1</td>
<td id="T_dc006_row1_col1" class="data row1 col1">0.9176</td>
<td id="T_dc006_row1_col2" class="data row1 col2">0.5619</td>
<td id="T_dc006_row1_col3" class="data row1 col3">0.1946</td>
</tr>
<tr class="odd">
<td id="T_dc006_row2_col0" class="data row2 col0">x_2</td>
<td id="T_dc006_row2_col1" class="data row2 col1">0.5095</td>
<td id="T_dc006_row2_col2" class="data row2 col2">0.0843</td>
<td id="T_dc006_row2_col3" class="data row2 col3">0.9053</td>
</tr>
<tr class="even">
<td id="T_dc006_row3_col0" class="data row3 col0">x_3</td>
<td id="T_dc006_row3_col1" class="data row3 col1">0.5472</td>
<td id="T_dc006_row3_col2" class="data row3 col2">0.8411</td>
<td id="T_dc006_row3_col3" class="data row3 col3">0.9707</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>$m_0$</p>
<table id="T_ceccc" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_ceccc_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_ceccc_level0_col1" class="col_heading level0 col1">mean</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_ceccc_row0_col0" class="data row0 col0">x_0</td>
<td id="T_ceccc_row0_col1" class="data row0 col1">0.3079</td>
</tr>
<tr class="even">
<td id="T_ceccc_row1_col0" class="data row1 col0">x_1</td>
<td id="T_ceccc_row1_col1" class="data row1 col1">0.7986</td>
</tr>
<tr class="odd">
<td id="T_ceccc_row2_col0" class="data row2 col0">x_2</td>
<td id="T_ceccc_row2_col1" class="data row2 col1">0.6972</td>
</tr>
<tr class="even">
<td id="T_ceccc_row3_col0" class="data row3 col0">x_3</td>
<td id="T_ceccc_row3_col1" class="data row3 col1">0.5632</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>$P_0$</p>
<table id="T_b38b5" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_b38b5_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_b38b5_level0_col1" class="col_heading level0 col1">x_0</th>
<th id="T_b38b5_level0_col2" class="col_heading level0 col2">x_1</th>
<th id="T_b38b5_level0_col3" class="col_heading level0 col3">x_2</th>
<th id="T_b38b5_level0_col4" class="col_heading level0 col4">x_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_b38b5_row0_col0" class="data row0 col0">x_0</td>
<td id="T_b38b5_row0_col1" class="data row0 col1">1.2375</td>
<td id="T_b38b5_row0_col2" class="data row0 col2">0.4817</td>
<td id="T_b38b5_row0_col3" class="data row0 col3">1.4902</td>
<td id="T_b38b5_row0_col4" class="data row0 col4">0.8995</td>
</tr>
<tr class="even">
<td id="T_b38b5_row1_col0" class="data row1 col0">x_1</td>
<td id="T_b38b5_row1_col1" class="data row1 col1">0.4817</td>
<td id="T_b38b5_row1_col2" class="data row1 col2">0.6202</td>
<td id="T_b38b5_row1_col3" class="data row1 col3">1.0675</td>
<td id="T_b38b5_row1_col4" class="data row1 col4">0.4405</td>
</tr>
<tr class="odd">
<td id="T_b38b5_row2_col0" class="data row2 col0">x_2</td>
<td id="T_b38b5_row2_col1" class="data row2 col1">1.4902</td>
<td id="T_b38b5_row2_col2" class="data row2 col2">1.0675</td>
<td id="T_b38b5_row2_col3" class="data row2 col3">2.7101</td>
<td id="T_b38b5_row2_col4" class="data row2 col4">1.0355</td>
</tr>
<tr class="even">
<td id="T_b38b5_row3_col0" class="data row3 col0">x_3</td>
<td id="T_b38b5_row3_col1" class="data row3 col1">0.8995</td>
<td id="T_b38b5_row3_col2" class="data row3 col2">0.4405</td>
<td id="T_b38b5_row3_col3" class="data row3 col3">1.0355</td>
<td id="T_b38b5_row3_col4" class="data row3 col4">0.8541</td>
</tr>
</tbody>
</table>
</div>

 </div></div>
</div>
</div>
</section>
<section id="test-data" class="level3">
<h3 class="anchored" data-anchor-id="test-data">Test data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>reset_seed()</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>data, mask, control <span class="op">=</span> get_test_data()</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>show_as_row(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">data</p> <pre>tensor([[[0.8775,    nan,    nan],
         [0.6706,    nan, 0.9272],
         [   nan, 0.4967,    nan],
         [   nan,    nan,    nan],
         [   nan,    nan, 0.4760],
         [0.7606, 0.7759, 0.5243],
         [0.3714, 0.0426, 0.2343],
         [0.9991, 0.1775,    nan],
         [0.6734,    nan, 0.6468],
         [0.5825, 0.4599, 0.7960]],

        [[0.9038, 0.9735, 0.6428],
         [0.3725, 0.2052,    nan],
         [0.4448, 0.5775, 0.7237],
         [0.5927,    nan, 0.6441],
         [   nan, 0.9132, 0.0329],
         [0.4856, 0.9927, 0.5895],
         [0.2611, 0.9413, 0.1371],
         [0.8726, 0.5590, 0.8451],
         [0.1253, 0.9434, 0.0462],
         [0.2360, 0.0239, 0.8950]]], dtype=torch.float64)</pre> </div><div><p style="font-size: 1.2rem;">mask</p> <pre>tensor([[[ True, False, False],
         [ True, False,  True],
         [False,  True, False],
         [False, False, False],
         [False, False,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True, False],
         [ True, False,  True],
         [ True,  True,  True]],

        [[ True,  True,  True],
         [ True,  True, False],
         [ True,  True,  True],
         [ True, False,  True],
         [False,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True]]])</pre> </div><div><p style="font-size: 1.2rem;">control</p> <pre>tensor([[[0.9201, 0.6883, 0.5342],
         [0.7847, 0.3137, 0.1778],
         [0.5838, 0.9799, 0.3611],
         [0.3155, 0.7475, 0.5450],
         [0.5641, 0.2493, 0.8323],
         [0.9723, 0.1883, 0.3605],
         [0.5344, 0.3443, 0.7696],
         [0.3410, 0.7553, 0.3177],
         [0.0315, 0.5209, 0.6514],
         [0.3131, 0.4510, 0.3550]],

        [[0.4790, 0.0676, 0.3606],
         [0.7299, 0.6713, 0.3134],
         [0.7460, 0.1291, 0.4653],
         [0.5693, 0.9906, 0.8288],
         [0.9039, 0.5240, 0.6277],
         [0.3574, 0.0076, 0.6530],
         [0.8667, 0.9368, 0.8667],
         [0.6749, 0.3526, 0.6618],
         [0.0837, 0.7188, 0.7247],
         [0.3211, 0.4898, 0.9030]]], dtype=torch.float64)</pre> </div></div>
</div>
</div>
</section>
</section>
</section>
<section id="standard-kalman-filter" class="level1">
<h1>Standard Kalman Filter</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> KalmanFilter.init_random(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="filter" class="level2">
<h2 class="anchored" data-anchor-id="filter">Filter</h2>
<section id="filter-predict" class="level3">
<h3 class="anchored" data-anchor-id="filter-predict">Filter predict</h3>
<p>Probability of state at time <code>t</code> given state a time <code>t-1</code></p>
<p><span class="math inline">\(p(x_t) = \mathcal{N}(x_t; m_t^-, P_t^-)\)</span> where:</p>
<ul>
<li><p>predicted state mean: <span class="math inline">\(m_t^- = Am_{t-1} + B c_t + b\)</span></p></li>
<li><p>predicted state covariance: <span class="math inline">\(P_t^- = AP_{t-1}A^T + Q\)</span></p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>A, Q, b, B, m_pr,P_pr<span class="op">=</span> (k.A, k.Q, k.b, k.B,torch.concat([k.m0]<span class="op">*</span><span class="dv">2</span>), torch.concat([k.P0]<span class="op">*</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>m_pr.shape, P_pr.shape, A.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]), torch.Size([1, 4, 4]))</code></pre>
</div>
</div>
<section id="covariance" class="level4">
<h4 class="anchored" data-anchor-id="covariance">Covariance</h4>
<p>implement <span class="math inline">\(P_t^- = AP_{t-1}A^T + Q\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>P_m <span class="op">=</span> _filter_predict_cov_stand(A, Q, P_pr)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>P_m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[4.8187, 4.4353, 4.9715, 4.9817],
         [4.4353, 5.3111, 5.1082, 5.1311],
         [4.9715, 5.1082, 5.7240, 5.7099],
         [4.9817, 5.1311, 5.7099, 6.3261]],

        [[4.8187, 4.4353, 4.9715, 4.9817],
         [4.4353, 5.3111, 5.1082, 5.1311],
         [4.9715, 5.1082, 5.7240, 5.7099],
         [4.9817, 5.1311, 5.7099, 6.3261]]], dtype=torch.float64,
       grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
</section>
<section id="mean" class="level4">
<h4 class="anchored" data-anchor-id="mean">Mean</h4>
</section>
<section id="predict" class="level4">
<h4 class="anchored" data-anchor-id="predict">Predict</h4>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L300" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="unsqueeze_iter" class="level3">
<h3 class="anchored" data-anchor-id="unsqueeze_iter">unsqueeze_iter</h3>
<blockquote class="blockquote">
<pre><code> unsqueeze_iter (*args, dim)</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>B.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([1, 4, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>control.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>B[<span class="dv">0</span>].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([4, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>B[<span class="dv">0</span>] <span class="op">@</span> control[<span class="dv">0</span>, <span class="dv">0</span>].unsqueeze(<span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[0.7217],
        [0.9572],
        [0.5742],
        [1.2138]], dtype=torch.float64, grad_fn=&lt;MmBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>m_m, P_m <span class="op">=</span> _filter_predict(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    A, Q, b, B,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    m_pr,P_pr, control[:, <span class="dv">0</span>, :].unsqueeze(<span class="op">-</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>show_as_row(m_m, P_m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">m_m</p> <pre>tensor([[[2.4986],
         [2.2429],
         [1.8833],
         [3.6164]],

        [[2.1377],
         [1.5964],
         [1.5371],
         [2.8315]]], dtype=torch.float64, grad_fn=<addbackward0>)</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">P_m</p> <pre>tensor([[[4.8187, 4.4353, 4.9715, 4.9817],
         [4.4353, 5.3111, 5.1082, 5.1311],
         [4.9715, 5.1082, 5.7240, 5.7099],
         [4.9817, 5.1311, 5.7099, 6.3261]],

        [[4.8187, 4.4353, 4.9715, 4.9817],
         [4.4353, 5.3111, 5.1082, 5.1311],
         [4.9715, 5.1082, 5.7240, 5.7099],
         [4.9817, 5.1311, 5.7099, 6.3261]]], dtype=torch.float64,
       grad_fn=<addbackward0>)</addbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>(m_m.shape, P_m.shape,)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]))</code></pre>
</div>
</div>
</section>
<section id="filter-update" class="level3">
<h3 class="anchored" data-anchor-id="filter-update">Filter update</h3>
<p>Probability of state at time <code>t</code> given the observations at time <code>t</code></p>
<p><span class="math inline">\(p(x_t|y_t) = \mathcal{N}(x_t; m_t, P_t)\)</span> where:</p>
<ul>
<li><p>predicted obs mean: <span class="math inline">\(z_t = Hm_t^- + d\)</span></p></li>
<li><p>prediced obs covariance: <span class="math inline">\(S_t = HP_t^-H^T + R\)</span></p></li>
<li><p>kalman gain<span class="math inline">\(K_t = P_t^-H^TS_t^{-1}\)</span></p></li>
<li><p>corrected state mean: <span class="math inline">\(m_t = m_t^- + K_t(y_t - z_t)\)</span></p></li>
<li><p>corrected state covariance: <span class="math inline">\(P_t = (I-K_tH)P_t^-\)</span></p></li>
</ul>
<p>if the observation are missing this step is skipped and the corrected state is equal to the predicted state</p>
<p>Need to figure out the Nans for the gradients …</p>
<section id="kalman-gain" class="level4">
<h4 class="anchored" data-anchor-id="kalman-gain">Kalman Gain</h4>
<p>Don’t compute the inverse of the matrix, but use <code>cholesky_solve</code> to invert the matrix</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>H, d, R, obs <span class="op">=</span> k.H, k.d, k.R, data[:,<span class="dv">0</span>,:].unsqueeze(<span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> _filter_update_k_gain(H, R, P_m)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>K</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 0.0307,  0.3311,  0.0291],
         [-0.2621,  0.4961,  0.0624],
         [ 0.0015,  0.4326, -0.0126],
         [ 0.2272,  0.3601, -0.0535]],

        [[ 0.0307,  0.3311,  0.0291],
         [-0.2621,  0.4961,  0.0624],
         [ 0.0015,  0.4326, -0.0126],
         [ 0.2272,  0.3601, -0.0535]]], dtype=torch.float64,
       grad_fn=&lt;TransposeBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>test_close(_filter_update_k_gain(H, R, P_m), P_m <span class="op">@</span> H.mT <span class="op">@</span> torch.inverse(H <span class="op">@</span> P_m <span class="op">@</span> H.mT <span class="op">+</span> R))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="covariance-1" class="level4">
<h4 class="anchored" data-anchor-id="covariance-1">Covariance</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>P <span class="op">=</span> _filter_update_cov(H, K, P_m)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>P</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 0.5970, -0.1075,  0.1579, -0.0676],
         [-0.1075,  0.3210, -0.0807, -0.2334],
         [ 0.1579, -0.0807,  0.2325, -0.0442],
         [-0.0676, -0.2334, -0.0442,  0.2359]],

        [[ 0.5970, -0.1075,  0.1579, -0.0676],
         [-0.1075,  0.3210, -0.0807, -0.2334],
         [ 0.1579, -0.0807,  0.2325, -0.0442],
         [-0.0676, -0.2334, -0.0442,  0.2359]]], dtype=torch.float64,
       grad_fn=&lt;UnsafeViewBackward0&gt;)</code></pre>
</div>
</div>
</section>
<section id="mean-1" class="level4">
<h4 class="anchored" data-anchor-id="mean-1">Mean</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>z <span class="op">=</span> H <span class="op">@</span> m_m <span class="op">+</span> d<span class="op">;</span> z</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>(obs <span class="op">-</span> z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[-3.3343],
         [    nan],
         [    nan]],

        [[-2.4181],
         [-5.0754],
         [-3.9145]]], dtype=torch.float64, grad_fn=&lt;SubBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> _filter_update_mean(H, d, K, m_m, obs)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>m</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[    nan],
         [    nan],
         [    nan],
         [    nan]],

        [[ 0.2687],
         [-0.5319],
         [-0.6131],
         [ 0.6636]]], dtype=torch.float64, grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>m, P <span class="op">=</span> _filter_update(H, d, R, m_m, P_m, obs)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>show_as_row(m, P)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>m.shape, P.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">m</p> <pre>tensor([[[    nan],
         [    nan],
         [    nan],
         [    nan]],

        [[ 0.2687],
         [-0.5319],
         [-0.6131],
         [ 0.6636]]], dtype=torch.float64, grad_fn=<addbackward0>)</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">P</p> <pre>tensor([[[ 0.5970, -0.1075,  0.1579, -0.0676],
         [-0.1075,  0.3210, -0.0807, -0.2334],
         [ 0.1579, -0.0807,  0.2325, -0.0442],
         [-0.0676, -0.2334, -0.0442,  0.2359]],

        [[ 0.5970, -0.1075,  0.1579, -0.0676],
         [-0.1075,  0.3210, -0.0807, -0.2334],
         [ 0.1579, -0.0807,  0.2325, -0.0442],
         [-0.0676, -0.2334, -0.0442,  0.2359]]], dtype=torch.float64,
       grad_fn=<unsafeviewbackward0>)</unsafeviewbackward0></pre> </div></div>
</div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]))</code></pre>
</div>
</div>
<p>there are <code>nan</code> in the output because there are <code>nan</code> in the observations</p>
<p>The next functions adds the support for missing obsevations by also using a mask</p>
</section>
<section id="missing-observations" class="level4">
<h4 class="anchored" data-anchor-id="missing-observations">Missing observations</h4>
<p>If all the observations at time <span class="math inline">\(t\)</span> are missing the correct step is skipped and the filtered state at time <span class="math inline">\(t\)</span> () is the same of the filtered state.</p>
<p>If only some observations are missing a variation of equation can be used.</p>
<p><span class="math inline">\(y^{ng}_t\)</span> is a vector containing the observations that are not missing at time <span class="math inline">\(t\)</span>.</p>
<p>It can be expressed as a linear transformation of <span class="math inline">\(y_t\)</span></p>
<p><span class="math display">\[ y^{ng}_t = My_t\]</span></p>
<p>where <span class="math inline">\(M\)</span> is a mask matrix that is used to select the subset of <span class="math inline">\(y_t\)</span> that is observed. <span class="math inline">\(M \in \mathbb{R}^{n_{ng} \times n}\)</span> and is made of columns which are made of all zeros but for an entry 1 at row corresponding to the non-missing observation. hence:</p>
<p><span class="math display">\[ p(y^{ng}_t) = \mathcal{N}(M\mu_{y_t},  M\Sigma_{y_t}M^T)\]</span></p>
<p>from which you can derive</p>
<p><span id="eq-filter-correct"><span class="math display">\[ p(y^{ng}_t|x_t) = p(MHx_t + Mb, MRM^T)  \tag{1}\]</span></span></p>
<p>Then the posterior <span class="math inline">\(p(x_t|y_t^{ng})\)</span> can be computed similarly of equation <span class="citation" data-cites="filter_correct">@filter_correct</span> as:</p>
<p><span id="eq-filter_correct_missing"><span class="math display">\[ p(x_t|y^{ng}_t) = \mathcal{N}(x_t; m_t, P_t)  \tag{2}\]</span></span></p>
<p>where:</p>
<ul>
<li>predicted obs mean: <span class="math inline">\(z_t = MHm_t^- + Md\)</span></li>
<li>predicted obs covariance: <span class="math inline">\(S_t = MHP_t^-(MH)^T + MRM^T\)</span></li>
<li>Kalman gain <span class="math inline">\(K_t = P_t^-(MH)^TS_t^{-1}\)</span></li>
<li>corrected state mean: <span class="math inline">\(m_t = m_t^- + K_t(My_t - z_t)\)</span></li>
<li>corrected state covariance: <span class="math inline">\(P_t = (I-K_tMH)P_t^-\)</span></li>
</ul>
<section id="details-implementation" class="level5">
<h5 class="anchored" data-anchor-id="details-implementation">Details implementation</h5>
<p>For the implementation the matrix multiplication <span class="math inline">\(MH\)</span> can be replaced with <code>H[m]</code> where <code>m</code> is the mask for the rows for <code>H</code> and <span class="math inline">\(MRM^T\)</span> with <code>R[m][:,m]</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>H, R, d,obs, mm <span class="op">=</span> k.H, k.R, k.d, data[:,<span class="dv">0</span>,:].unsqueeze(<span class="op">-</span><span class="dv">1</span>), mask[:,<span class="dv">0</span>,:].unsqueeze(<span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> torch.tensor([<span class="va">False</span>,<span class="va">True</span>,<span class="va">True</span>]) <span class="co"># mask batch</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> torch.tensor([[[<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>], <span class="co"># mask matrix</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>                  [<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>]]], dtype<span class="op">=</span>torch.float64)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>show_as_row(m, M, H, R)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">m</p> <pre>tensor([False,  True,  True])</pre> </div><div><p style="font-size: 1.2rem;">M</p> <pre>tensor([[[0., 1., 0.],
         [0., 0., 1.]]], dtype=torch.float64)</pre> </div><div><p style="font-size: 1.2rem;">H</p> <pre>Parameter containing:
tensor([[[0.1349, 0.0519, 0.1180, 0.9767],
         [0.1679, 0.8635, 0.3753, 0.9760],
         [0.2125, 0.8049, 0.2124, 0.6794]]], dtype=torch.float64,
       requires_grad=True)</pre> </div><div><p style="font-size: 1.2rem;">R</p> <pre>tensor([[[0.8976, 0.0000, 0.0000],
         [0.0000, 0.0022, 0.0000],
         [0.0000, 0.0000, 0.9592]]], dtype=torch.float64,
       grad_fn=<addbackward0>)</addbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>M <span class="op">@</span> H, H[:, m]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[[0.1679, 0.8635, 0.3753, 0.9760],
          [0.2125, 0.8049, 0.2124, 0.6794]]], dtype=torch.float64,
        grad_fn=&lt;UnsafeViewBackward0&gt;),
 tensor([[[0.1679, 0.8635, 0.3753, 0.9760],
          [0.2125, 0.8049, 0.2124, 0.6794]]], dtype=torch.float64,
        grad_fn=&lt;IndexBackward0&gt;))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>M <span class="op">@</span> R <span class="op">@</span> M.mT, R[:,m][:,:,m]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[[0.0022, 0.0000],
          [0.0000, 0.9592]]], dtype=torch.float64,
        grad_fn=&lt;UnsafeViewBackward0&gt;),
 tensor([[[0.0022, 0.0000],
          [0.0000, 0.9592]]], dtype=torch.float64, grad_fn=&lt;IndexBackward0&gt;))</code></pre>
</div>
</div>
<p>By using partially missing observations <a href="https://mone27.github.io/meteo_imp/lib/kalman/filter.html#_filter_update"><code>_filter_update</code></a> cannot be easily batched as the shape of the intermediate variables depends on the number of observed variables. So the idea is to divide the batch in blocks that share the same number of variables missing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>mask_values, indices <span class="op">=</span> torch.unique(mask[:,<span class="dv">1</span>,:], dim<span class="op">=</span><span class="dv">0</span>, return_inverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>mask_values, indices</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[ True, False,  True],
         [ True,  True, False]]),
 tensor([0, 1]))</code></pre>
</div>
</div>
</section>
<section id="update-mask" class="level5">
<h5 class="anchored" data-anchor-id="update-mask">Update mask</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>mm <span class="op">=</span> mask[<span class="dv">0</span>,<span class="dv">0</span>,:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>H[:, mm].shape, d[:, mm].shape, R[:, mm][:, :,mm].shape, obs[:, mm].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([1, 1, 4]),
 torch.Size([1, 1, 1]),
 torch.Size([1, 1, 1]),
 torch.Size([2, 1, 1]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span>_filter_update_mask(H, d, R, m_m, P_m, obs, mask[<span class="dv">0</span>, <span class="dv">0</span>, :] ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[[ 0.4966],
         [ 0.1916],
         [-0.3892],
         [ 1.1533]],

        [[ 0.6857],
         [ 0.1087],
         [-0.1110],
         [ 1.0452]]], dtype=torch.float64, grad_fn=<addbackward0>)</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[[1.0162, 0.5393, 0.6553, 0.3036],
         [0.5393, 1.3192, 0.6858, 0.3379],
         [0.6553, 0.6858, 0.8247, 0.3997],
         [0.3036, 0.3379, 0.3997, 0.5707]],

        [[1.0162, 0.5393, 0.6553, 0.3036],
         [0.5393, 1.3192, 0.6858, 0.3379],
         [0.6553, 0.6858, 0.8247, 0.3997],
         [0.3036, 0.3379, 0.3997, 0.5707]]], dtype=torch.float64,
       grad_fn=<unsafeviewbackward0>)</unsafeviewbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>m, P <span class="op">=</span> _filter_update_mask(H, d, R, m_m, P_m, obs, mask[<span class="dv">0</span>, <span class="dv">0</span>, :] )</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>m.shape, P.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]))</code></pre>
</div>
</div>
</section>
<section id="update-mask-batch" class="level5">
<h5 class="anchored" data-anchor-id="update-mask-batch">Update mask batch</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>m, P <span class="op">=</span> _filter_update_mask_batch(H, d, R, m_m, P_m, obs, mask[:,<span class="dv">0</span>,:] )</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>show_as_row(m, P)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>m.shape, P.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">m</p> <pre>tensor([[[ 0.4966],
         [ 0.1916],
         [-0.3892],
         [ 1.1533]],

        [[ 0.2687],
         [-0.5319],
         [-0.6131],
         [ 0.6636]]], dtype=torch.float64, grad_fn=<indexputbackward0>)</indexputbackward0></pre> </div><div><p style="font-size: 1.2rem;">P</p> <pre>tensor([[[ 1.0162,  0.5393,  0.6553,  0.3036],
         [ 0.5393,  1.3192,  0.6858,  0.3379],
         [ 0.6553,  0.6858,  0.8247,  0.3997],
         [ 0.3036,  0.3379,  0.3997,  0.5707]],

        [[ 0.5970, -0.1075,  0.1579, -0.0676],
         [-0.1075,  0.3210, -0.0807, -0.2334],
         [ 0.1579, -0.0807,  0.2325, -0.0442],
         [-0.0676, -0.2334, -0.0442,  0.2359]]], dtype=torch.float64,
       grad_fn=<indexputbackward0>)</indexputbackward0></pre> </div></div>
</div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>m.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>) <span class="co"># check that pytorch can compute gradients with the whole batch and gradients aren't nan</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>H.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[-1.8992e+00, -1.4530e+00,  3.0663e-01, -3.5863e+00],
         [-7.0442e-01,  9.0830e-01,  8.6987e-01, -1.0243e+00],
         [ 6.8845e-02,  4.2718e-04,  5.0290e-02, -3.1175e-02]]],
       dtype=torch.float64)</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="filter-all" class="level3">
<h3 class="anchored" data-anchor-id="filter-all">Filter All</h3>
<p>The resursive version of the kalman filter is apperently breaking pytorch gradients calculations so a workaround is needed. During the loop the states are saved in a python list and then at the end they are combined back into a tensor. The last line of the function does:</p>
<ul>
<li>convert lists to tensors</li>
<li>correct order dimensions</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>filt_state, pred_state  <span class="op">=</span> k._filter_all(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>(ms, Ps), (m_ms, P_ms) <span class="op">=</span> filt_state, pred_state</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Predictions at time <code>0</code> for both batches</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(Self.shape(), (m_ms, P_ms, ms, Ps,)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([2, 10, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([2, 10, 4, 4])</pre> </div><div><p style="font-size: 1.2rem;">#2</p> <pre>torch.Size([2, 10, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;">#3</p> <pre>torch.Size([2, 10, 4, 4])</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(<span class="kw">lambda</span> x:x[<span class="dv">0</span>][<span class="dv">0</span>], (m_ms, P_ms, ms, Ps,)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[0.6498],
        [0.3257],
        [0.8462],
        [0.7727]], dtype=torch.float64, grad_fn=<selectbackward0>)</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[1.6851, 0.7489, 0.8997, 1.8571],
        [0.7489, 0.9445, 0.8723, 1.2171],
        [0.8997, 0.8723, 0.9059, 1.2618],
        [1.8571, 1.2171, 1.2618, 2.4334]], dtype=torch.float64,
       grad_fn=<selectbackward0>)</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;">#2</p> <pre>tensor([[0.6056],
        [0.2965],
        [0.8157],
        [0.7152]], dtype=torch.float64, grad_fn=<selectbackward0>)</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;">#3</p> <pre>tensor([[0.5520, 0.0017, 0.1192, 0.3856],
        [0.0017, 0.4517, 0.3576, 0.2467],
        [0.1192, 0.3576, 0.3683, 0.2481],
        [0.3856, 0.2467, 0.2481, 0.5222]], dtype=torch.float64,
       grad_fn=<selectbackward0>)</selectbackward0></pre> </div></div>
</div>
</div>
</section>
<section id="filter-1" class="level3">
<h3 class="anchored" data-anchor-id="filter-1">Filter</h3>
<p>The filter methods wraps <code>_filter_all</code> but in addition:</p>
<ul>
<li>returns only filtered state</li>
<li>remove last dimensions from mean</li>
</ul>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L433" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter.filter" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.filter">KalmanFilter.filter</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.filter (obs:torch.Tensor, mask:torch.Tensor,
                      control:torch.Tensor)</code></pre>
</blockquote>
<p>Filter observation</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>obs</td>
<td>Tensor</td>
<td><code>([n_batches], n_obs, [self.n_dim_obs])</code> where <code>n_batches</code> and <code>n_dim_obs</code> dimensions can be omitted if 1</td>
</tr>
<tr class="even">
<td>mask</td>
<td>Tensor</td>
<td><code>([n_batches], n_obs, [self.n_dim_obs])</code> where <code>n_batches</code> and <code>n_dim_obs</code> dimensions can be omitted if 1</td>
</tr>
<tr class="odd">
<td>control</td>
<td>Tensor</td>
<td>([n_batches], n_obs, [self.n_dim_contr])</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ListMultiNormal</strong></td>
<td><strong>Filtered state (n_batches, n_obs, self.n_dim_state)</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>filt <span class="op">=</span> k.<span class="bu">filter</span>(data, mask, control)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>filt.mean.shape, filt.cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 10, 4, 1]), torch.Size([2, 10, 4, 4]))</code></pre>
</div>
</div>
</section>
</section>
<section id="smooth" class="level2">
<h2 class="anchored" data-anchor-id="smooth">Smooth</h2>
<section id="smooth-update-step" class="level3">
<h3 class="anchored" data-anchor-id="smooth-update-step">Smooth update step</h3>
<p>compute the probability of the state at time <code>t</code> given all the observations</p>
<p><span class="math inline">\(p(x_t|Y) = \mathcal{N}(x_t; m_t^s, P_t^s)\)</span> where:</p>
<ul>
<li>Kalman smoothing gain: <span class="math inline">\(G_t = P_tA^T(P_{t+1}^-)^{-1}\)</span></li>
<li>smoothed mean: <span class="math inline">\(m_t^s = m_t + G_t(m_{t+1}^s - m_{t+1}^-)\)</span></li>
<li>smoothed covariance: <span class="math inline">\(P_t^s = P_t + G_t(P_{t+1}^s - P_{t+1}^-)G_t^T\)</span></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _smooth_gain(A, filt_state, pred_state):</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>    S_C <span class="op">=</span> torch.linalg.cholesky(pred_state.cov)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.cholesky_solve(A <span class="op">@</span> filt_state.cov.mT, S_C).mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>test_close(_smooth_gain(A, filt_state, pred_state), filt_state.cov <span class="op">@</span> A.mT <span class="op">@</span> torch.inverse(pred_state.cov))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span>_smooth_update(A, filt_state[:, <span class="dv">0</span>, :], pred_state[:, <span class="dv">0</span>, :], filt_state[:, <span class="dv">0</span>, :]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[[ 0.5901],
         [ 0.2836],
         [ 0.8017],
         [ 0.6956]],

        [[ 0.1260],
         [-0.2227],
         [ 0.2902],
         [ 0.0670]]], dtype=torch.float64, grad_fn=<addbackward0>)</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[[ 0.4145, -0.1131, -0.0049,  0.2108],
         [-0.1131,  0.3559,  0.2540,  0.1008],
         [-0.0049,  0.2540,  0.2563,  0.0904],
         [ 0.2108,  0.1008,  0.0904,  0.3002]],

        [[ 0.3850, -0.1971, -0.0754,  0.1375],
         [-0.1971,  0.1340,  0.0677, -0.1096],
         [-0.0754,  0.0677,  0.0998, -0.0845],
         [ 0.1375, -0.1096, -0.0845,  0.1069]]], dtype=torch.float64,
       grad_fn=<addbackward0>)</addbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(Self.shape(), _smooth_update(A, MNormal(m_m, P_m), MNormal(m_m, P_m), MNormal(m_m, P_m))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([2, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([2, 4, 4])</pre> </div></div>
</div>
</div>
</section>
<section id="smooth-1" class="level3">
<h3 class="anchored" data-anchor-id="smooth-1">Smooth</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>smooth_state <span class="op">=</span> _smooth(k.A,  filt_state, pred_state)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smooth_state.mean[<span class="dv">0</span>][<span class="dv">0</span>], smooth_state.cov[<span class="dv">0</span>][<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[-0.6237],
        [-1.0633],
        [-0.5602],
        [-0.9697]], dtype=torch.float64, grad_fn=<selectbackward0>)</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[ 0.3228, -0.2115, -0.1058,  0.0884],
        [-0.2115,  0.2353,  0.1337, -0.0395],
        [-0.1058,  0.1337,  0.1357, -0.0513],
        [ 0.0884, -0.0395, -0.0513,  0.1312]], dtype=torch.float64,
       grad_fn=<selectbackward0>)</selectbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smooth_state.mean.shape, smooth_state.cov.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([2, 10, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([2, 10, 4, 4])</pre> </div></div>
</div>
</div>
</section>
<section id="kalmanfilter-method" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter-method">KalmanFilter method</h3>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L487" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter.smooth" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.smooth">KalmanFilter.smooth</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.smooth (obs:torch.Tensor, mask:torch.Tensor,
                      control:torch.Tensor)</code></pre>
</blockquote>
<p>Kalman Filter Smoothing</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>obs</td>
<td>Tensor</td>
<td></td>
</tr>
<tr class="even">
<td>mask</td>
<td>Tensor</td>
<td></td>
</tr>
<tr class="odd">
<td>control</td>
<td>Tensor</td>
<td></td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ListMultiNormal</strong></td>
<td><strong><code>[n_timesteps, n_dim_state]</code> smoothed state</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>smoothed_state <span class="op">=</span> k.smooth(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smoothed_state.mean.shape, smoothed_state.cov.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([2, 10, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([2, 10, 4, 4])</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>smoothed_state.mean.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>A.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[-13.6413,  -6.2732, -14.2362,   8.2959],
         [ -0.3648,   6.0936,   3.7623,  -2.9837],
         [-13.0810,  -3.2975, -13.0166,   6.8282],
         [  2.2838,  13.9427,   7.3058,  -3.1199]]], dtype=torch.float64)</code></pre>
</div>
</div>
</section>
</section>
<section id="predict-1" class="level2">
<h2 class="anchored" data-anchor-id="predict-1">Predict</h2>
<p>The prediction at time t (<span class="math inline">\(y_t\)</span>) are computed rom the state (<span class="math inline">\(x_t\)</span>) using this formula: <span class="math display">\[p(y_t|x_t) = \mathcal{N}(Hx_t + d, R + HP^s_tH^T)\]</span></p>
<p>this works both if the state was filtered or smoother</p>
<p>This add the supports for conditional predictions, which means that at the time (t) when we are making the predictions some of the variables have been actually observed. Since the model prediction is a normal distribution we can condition on the observed values and thus improve the predictions. See <code>conditional_gaussian</code></p>
<p>In order to have conditional predictions that make sense it’s not possible to return the full covariance matrix for the predictions but only the standard deviations</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>test_m <span class="op">=</span> torch.tensor(</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    [[<span class="va">True</span>, <span class="va">True</span>, <span class="va">True</span>,],</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    [<span class="va">False</span>, <span class="va">True</span>, <span class="va">True</span>],</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    [<span class="va">False</span>, <span class="va">False</span>, <span class="va">False</span>]]</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>torch.logical_xor(test_m.<span class="bu">all</span>(<span class="op">-</span><span class="dv">1</span>), test_m.<span class="bu">any</span>(<span class="op">-</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([False,  True, False])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> torch.rand(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>(A <span class="op">@</span> A).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 2, 3, 3])</code></pre>
</div>
</div>
<p>predict can be vectorized across both the batch and the timesteps, except for timesteps that require conditional predictions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>smoothed_state.mean.shape, smoothed_state.cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 10, 4, 1]), torch.Size([2, 10, 4, 4]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>(k.H <span class="op">@</span> smoothed_state.mean).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10, 3, 1])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>pred_obs0 <span class="op">=</span> k._obs_from_state(smoothed_state)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>pred_obs0.mean.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>pred_obs0.cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10, 3, 3])</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L517" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="kalmanfilter.predict" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.predict">KalmanFilter.predict</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.predict (obs, mask, control, smooth=True)</code></pre>
</blockquote>
<p>Predicted observations at all times</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> k.predict(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>pred.mean.shape, pred.std.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 10, 3]), torch.Size([2, 10, 3]))</code></pre>
</div>
</div>
<p>Gradients …</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_grad_mask(x):</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"filter gradient after sub the masks value with x"</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> data.clone()</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    d[<span class="op">~</span>mask] <span class="op">=</span> x</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>    k.predict(data, mask, control).mean.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>    grad <span class="op">=</span> k.R_raw.grad.clone()</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>    k.zero_grad() </span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>get_grad_mask(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ -4.0769,  -0.6436,  -5.1756],
         [-13.0135, -13.6321, -14.3604],
         [ -5.0067,  -0.6871,  -9.5430]]], dtype=torch.float64)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>test_close(get_grad_mask(<span class="dv">1</span>), get_grad_mask(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_times(<span class="va">self</span>: KalmanFilter, times, obs, mask<span class="op">=</span><span class="va">None</span>, smooth<span class="op">=</span><span class="va">True</span>, check_args<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Predicted observations at specific times """</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    state <span class="op">=</span> <span class="va">self</span>.smooth(obs, mask, check_args) <span class="cf">if</span> smooth <span class="cf">else</span> <span class="va">self</span>.<span class="bu">filter</span>(obs, mask, check_args)</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>    obs, mask <span class="op">=</span> <span class="va">self</span>._parse_obs(obs, mask)</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>    times <span class="op">=</span> array1d(times)</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>    n_timesteps <span class="op">=</span> obs.shape[<span class="dv">0</span>]</span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>    n_features <span class="op">=</span> obs.shape[<span class="dv">1</span>] <span class="cf">if</span> <span class="bu">len</span>(obs.shape) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> times.<span class="bu">max</span>() <span class="op">&gt;</span> n_timesteps <span class="kw">or</span> times.<span class="bu">min</span>() <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"provided times range from </span><span class="sc">{</span>times<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>times<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">, which is outside allowed range : 0 to </span><span class="sc">{</span>n_timesteps<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>    means <span class="op">=</span> torch.empty((times.shape[<span class="dv">0</span>], n_features), dtype<span class="op">=</span>obs.dtype, device<span class="op">=</span>obs.device)</span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>    stds <span class="op">=</span> torch.empty((times.shape[<span class="dv">0</span>], n_features), dtype<span class="op">=</span>obs.dtype, device<span class="op">=</span>obs.device) </span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, t <span class="kw">in</span> <span class="bu">enumerate</span>(times):</span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>        mean, std <span class="op">=</span> <span class="va">self</span>._obs_from_state(</span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>            state.mean[t],</span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a>            state.cov[t],</span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'t'</span>: t, <span class="op">**</span>check_args} <span class="cf">if</span> check_args <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a>        means[i], stds[i] <span class="op">=</span> _get_cond_pred(ListNormal(mean, std), obs[t], mask[t])</span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb113-25"><a href="#cb113-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ListNormal(means, stds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="numerical-stable-kalman-filter-square-root-filter" class="level1">
<h1>Numerical Stable Kalman Filter (Square Root Filter)</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>kSR <span class="op">=</span> KalmanFilterSR.init_random(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="filter-2" class="level2">
<h2 class="anchored" data-anchor-id="filter-2">Filter</h2>
<section id="filter-predict-1" class="level3">
<h3 class="anchored" data-anchor-id="filter-predict-1">Filter predict</h3>
<section id="covariance-2" class="level4">
<h4 class="anchored" data-anchor-id="covariance-2">Covariance</h4>
<p>Implement the numerical stable version of the covariance update</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>A, Q, b, B, m_pr,P_pr<span class="op">=</span> (k.A, k.Q, k.b, k.B,torch.concat([k.m0]<span class="op">*</span><span class="dv">2</span>), torch.concat([k.P0]<span class="op">*</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>Q_C <span class="op">=</span> kSR.Q_C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>_filter_predict_cov_stand(kSR.A, kSR.Q_C <span class="op">@</span> kSR.Q_C.mT, P_pr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[1.3994, 1.7755, 1.6101, 2.3405],
         [1.7755, 5.1566, 4.5819, 6.5831],
         [1.6101, 4.5819, 5.0435, 5.9596],
         [2.3405, 6.5831, 5.9596, 8.7927]],

        [[1.3994, 1.7755, 1.6101, 2.3405],
         [1.7755, 5.1566, 4.5819, 6.5831],
         [1.6101, 4.5819, 5.0435, 5.9596],
         [2.3405, 6.5831, 5.9596, 8.7927]]], dtype=torch.float64,
       grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>P_pr_C <span class="op">=</span> torch.linalg.cholesky(P_pr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><span class="math display">\[W = \begin{bmatrix}AC_{t-1}&amp;C_Q\end{bmatrix}\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> torch.concat([A <span class="op">@</span> P_pr_C, Q_C.expand_as(P_pr_C)], dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>W.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 4, 8])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>P_m_C <span class="op">=</span> torch.linalg.qr(W.mT).R.mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>P_m_C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[-2.2660,  0.0000,  0.0000,  0.0000],
         [-1.9573,  0.8825,  0.0000,  0.0000],
         [-2.1939,  0.9222,  0.9708,  0.0000],
         [-2.1984,  0.9382,  0.0220, -0.3203]],

        [[-2.2660,  0.0000,  0.0000,  0.0000],
         [-1.9573,  0.8825,  0.0000,  0.0000],
         [-2.1939,  0.9222,  0.9708,  0.0000],
         [-2.1984,  0.9382,  0.0220, -0.3203]]], dtype=torch.float64,
       grad_fn=&lt;TransposeBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>P_m_C <span class="op">@</span> P_m_C.mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[5.1348, 4.4353, 4.9715, 4.9817],
         [4.4353, 4.6100, 5.1082, 5.1311],
         [4.9715, 5.1082, 6.6063, 5.7099],
         [4.9817, 5.1311, 5.7099, 5.8165]],

        [[5.1348, 4.4353, 4.9715, 4.9817],
         [4.4353, 4.6100, 5.1082, 5.1311],
         [4.9715, 5.1082, 6.6063, 5.7099],
         [4.9817, 5.1311, 5.7099, 5.8165]]], dtype=torch.float64,
       grad_fn=&lt;UnsafeViewBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>P_m <span class="op">=</span> _filter_predict_cov_stand(A, Q_C <span class="op">@</span> Q_C.mT, P_pr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>test_close(P_m, P_m_C <span class="op">@</span> P_m_C.mT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>(P_m <span class="op">-</span> P_m_C <span class="op">@</span> P_m_C.mT).<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(2.6645e-15, dtype=torch.float64, grad_fn=&lt;MaxBackward1&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>test_P_m_C <span class="op">=</span> torch.linalg.cholesky(P_m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>(test_P_m_C <span class="op">@</span> test_P_m_C.mT <span class="op">-</span> P_m_C <span class="op">@</span> P_m_C.mT).<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(2.6645e-15, dtype=torch.float64, grad_fn=&lt;MaxBackward1&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>(test_P_m_C <span class="op">-</span> P_m_C).<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(4.5320, dtype=torch.float64, grad_fn=&lt;MaxBackward1&gt;)</code></pre>
</div>
</div>
<p>Cholesky decomposition is not unique! but the solution is correct</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>P_m_C <span class="op">=</span> _filter_predict_cov_SR(A, Q_C, P_pr_C)</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>test_close(P_m_C <span class="op">@</span> P_m_C.mT, _filter_predict_cov_stand(A, Q_C <span class="op">@</span> Q_C.mT, P_pr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzz_filter_predict_cov_SR(n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>        kSR <span class="op">=</span> KalmanFilterSR.init_random(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">4</span>)</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>        A, Q_C, b, B, m_pr,P_pr <span class="op">=</span> (kSR.A.unsqueeze(<span class="dv">0</span>), kSR.Q_C.unsqueeze(<span class="dv">0</span>), kSR.b.unsqueeze(<span class="op">-</span><span class="dv">1</span>),</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>                                                  kSR.B.unsqueeze(<span class="dv">0</span>),</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>                                                  torch.stack([kSR.m0]<span class="op">*</span><span class="dv">2</span>).unsqueeze(<span class="op">-</span><span class="dv">1</span>),</span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>                                                  torch.stack([kSR.P0]<span class="op">*</span><span class="dv">2</span>))</span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a>        P_pr_C <span class="op">=</span> torch.linalg.cholesky(P_pr)</span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a>        P_m_C <span class="op">=</span> _filter_predict_cov_SR(A, Q_C, P_pr_C)</span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a>        test_close(P_m_C <span class="op">@</span> P_m_C.mT, _filter_predict_cov_stand(A, Q_C <span class="op">@</span> Q_C.mT, P_pr), eps<span class="op">=</span><span class="fl">5e-13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>fuzz_filter_predict_cov_SR()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="predict-2" class="level4">
<h4 class="anchored" data-anchor-id="predict-2">Predict</h4>
</section>
</section>
<section id="filter-update-1" class="level3">
<h3 class="anchored" data-anchor-id="filter-update-1">Filter Update</h3>
<p><span class="math display">\[M = \begin{bmatrix}R^{T/2} &amp; 0 \\ (C^-)^TH^T &amp; (C^-)^T \end{bmatrix}\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>H, R, R_C, obs <span class="op">=</span> kSR.H, kSR.R, kSR.R_C, data[:,<span class="dv">0</span>,:].unsqueeze(<span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>R_C <span class="op">=</span> kSR.R_C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># P_m_C = torch.linalg.cholesky(P_m)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>P_pr_C.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 4, 4])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>P_m_C.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 4, 4])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>[[R_C.shape,<span class="dv">0</span>],</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a> [(P_m_C.mT <span class="op">@</span> H.mT).shape, P_m_C.mT.shape]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[[torch.Size([1, 3, 3]), 0], [torch.Size([2, 4, 3]), torch.Size([2, 4, 4])]]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>M_21 <span class="op">=</span> P_m_C.mT <span class="op">@</span> H.mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>M_21.mT.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 3, 4])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>M_21.shape[:<span class="op">-</span><span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>[[R_C.expand(<span class="op">*</span>M_21.shape[:<span class="op">-</span><span class="dv">2</span>], <span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>).shape, torch.zeros_like(M_21.mT).shape],</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a> [M_21.shape, P_m_C.mT.shape]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[[torch.Size([2, 3, 3]), torch.Size([2, 3, 4])],
 [torch.Size([2, 4, 3]), torch.Size([2, 4, 4])]]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>M_1 <span class="op">=</span> torch.cat([R_C.expand(<span class="op">*</span>M_21.shape[:<span class="op">-</span><span class="dv">2</span>], <span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>).mT, torch.zeros_like(M_21.mT)], dim<span class="op">=-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>M_2 <span class="op">=</span> torch.cat([M_21, P_m_C.mT], dim<span class="op">=-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>M_1.shape, M_2.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 3, 7]), torch.Size([2, 4, 7]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> torch.cat([M_1, M_2], dim<span class="op">=-</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>M[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[ 0.9094,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
        [ 0.0000,  0.9543,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
        [ 0.0000,  0.0000,  0.1604,  0.0000,  0.0000,  0.0000,  0.0000],
        [-1.7577, -3.0682, -4.6017, -2.2660, -1.9573, -2.1939, -2.1984],
        [ 0.6702,  0.9346,  1.1521,  0.0000,  0.8825,  0.9222,  0.9382],
        [ 0.3868,  0.6330,  0.3967,  0.0000,  0.0000,  0.9708,  0.0220],
        [-0.0931, -0.1038, -0.1399,  0.0000,  0.0000,  0.0000, -0.3203]],
       dtype=torch.float64, grad_fn=&lt;SelectBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>U <span class="op">=</span> torch.linalg.qr(M).R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>so <span class="math inline">\(U \in \mathbb{R}^{(n+k) \times (n+k)}\)</span> and the need to get the bottom part of size <span class="math inline">\(k \times k\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>U[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[-2.1270, -2.9497, -4.2442, -1.8726, -1.8956, -2.2802, -2.1305],
        [ 0.0000, -1.7055, -1.7253, -0.8378, -0.7263, -0.8690, -0.8122],
        [ 0.0000,  0.0000, -1.3102, -0.7895, -0.5537, -0.2800, -0.6167],
        [ 0.0000,  0.0000,  0.0000,  0.5503, -0.2911, -0.4499, -0.3183],
        [ 0.0000,  0.0000,  0.0000,  0.0000, -0.3127,  0.4201, -0.2192],
        [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000, -0.4413,  0.1756],
        [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000, -0.2399]],
       dtype=torch.float64, grad_fn=&lt;SelectBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>n_dim_state <span class="op">=</span> P_m_C.shape[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>n_dim_obs <span class="op">=</span> R_C.shape[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>P_C <span class="op">=</span> U[:, n_dim_obs:, n_dim_obs:].mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>P_C[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[ 0.5503,  0.0000,  0.0000,  0.0000],
        [-0.2911, -0.3127,  0.0000,  0.0000],
        [-0.4499,  0.4201, -0.4413,  0.0000],
        [-0.3183, -0.2192,  0.1756, -0.2399]], dtype=torch.float64,
       grad_fn=&lt;SelectBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>test_close(M.mT <span class="op">@</span> M, U.mT <span class="op">@</span> U) <span class="co"># this is just to say the the QR decomposition is correct</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check with standard implementation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>P_C <span class="op">@</span> P_C.mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 3.0279e-01, -1.6016e-01, -2.4755e-01, -1.7516e-01],
         [-1.6016e-01,  1.8248e-01, -4.1026e-04,  1.6120e-01],
         [-2.4755e-01, -4.1026e-04,  5.7354e-01, -2.6354e-02],
         [-1.7516e-01,  1.6120e-01, -2.6354e-02,  2.3776e-01]],

        [[ 3.0279e-01, -1.6016e-01, -2.4755e-01, -1.7516e-01],
         [-1.6016e-01,  1.8248e-01, -4.1026e-04,  1.6120e-01],
         [-2.4755e-01, -4.1026e-04,  5.7354e-01, -2.6354e-02],
         [-1.7516e-01,  1.6120e-01, -2.6354e-02,  2.3776e-01]]],
       dtype=torch.float64, grad_fn=&lt;UnsafeViewBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> _filter_update_k_gain(H, R_C <span class="op">@</span> R_C.mT, P_m_C <span class="op">@</span> P_m_C.mT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>_filter_update_cov(H, K, P_m_C <span class="op">@</span> P_m_C.mT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 3.0279e-01, -1.6016e-01, -2.4755e-01, -1.7516e-01],
         [-1.6016e-01,  1.8248e-01, -4.1026e-04,  1.6120e-01],
         [-2.4755e-01, -4.1026e-04,  5.7354e-01, -2.6354e-02],
         [-1.7516e-01,  1.6120e-01, -2.6354e-02,  2.3776e-01]],

        [[ 3.0279e-01, -1.6016e-01, -2.4755e-01, -1.7516e-01],
         [-1.6016e-01,  1.8248e-01, -4.1026e-04,  1.6120e-01],
         [-2.4755e-01, -4.1026e-04,  5.7354e-01, -2.6354e-02],
         [-1.7516e-01,  1.6120e-01, -2.6354e-02,  2.3776e-01]]],
       dtype=torch.float64, grad_fn=&lt;UnsafeViewBackward0&gt;)</code></pre>
</div>
</div>
<p>comparison with the <span class="math inline">\(U\)</span> matrix computed using the reference values</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>P_m.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 4, 4])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>R.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([1, 3, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>S <span class="op">=</span> H <span class="op">@</span> P_m <span class="op">@</span> H.mT <span class="op">+</span> R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>S_C <span class="op">=</span> torch.linalg.cholesky(S)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> _filter_update_k_gain(H, R, P_m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>test_close(K, P_m <span class="op">@</span> H.mT <span class="op">@</span> torch.inverse(S))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb183"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>K_til <span class="op">=</span> K <span class="op">@</span> S_C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>K_til.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 4, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>K_til</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[1.8726, 0.8378, 0.7895],
         [1.8956, 0.7264, 0.5537],
         [2.2802, 0.8690, 0.2800],
         [2.1305, 0.8122, 0.6167]],

        [[1.8726, 0.8378, 0.7895],
         [1.8956, 0.7264, 0.5537],
         [2.2802, 0.8690, 0.2800],
         [2.1305, 0.8122, 0.6167]]], dtype=torch.float64,
       grad_fn=&lt;UnsafeViewBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>P <span class="op">=</span> _filter_update_cov(H, K, P_m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>P</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 3.0280e-01, -1.6016e-01, -2.4755e-01, -1.7516e-01],
         [-1.6016e-01,  1.8249e-01, -4.0924e-04,  1.6121e-01],
         [-2.4755e-01, -4.0924e-04,  5.7354e-01, -2.6353e-02],
         [-1.7516e-01,  1.6121e-01, -2.6353e-02,  2.3776e-01]],

        [[ 3.0280e-01, -1.6016e-01, -2.4755e-01, -1.7516e-01],
         [-1.6016e-01,  1.8249e-01, -4.0924e-04,  1.6121e-01],
         [-2.4755e-01, -4.0924e-04,  5.7354e-01, -2.6353e-02],
         [-1.7516e-01,  1.6121e-01, -2.6353e-02,  2.3776e-01]]],
       dtype=torch.float64, grad_fn=&lt;UnsafeViewBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>P_C <span class="op">=</span> torch.linalg.cholesky(P)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>P_C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 0.5503,  0.0000,  0.0000,  0.0000],
         [-0.2910,  0.3127,  0.0000,  0.0000],
         [-0.4499, -0.4200,  0.4413,  0.0000],
         [-0.3183,  0.2193, -0.1755,  0.2399]],

        [[ 0.5503,  0.0000,  0.0000,  0.0000],
         [-0.2910,  0.3127,  0.0000,  0.0000],
         [-0.4499, -0.4200,  0.4413,  0.0000],
         [-0.3183,  0.2193, -0.1755,  0.2399]]], dtype=torch.float64,
       grad_fn=&lt;LinalgCholeskyExBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>S_C.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 3, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>K_til.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 4, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>U_1 <span class="op">=</span> torch.cat([S_C.mT, K_til.mT], dim<span class="op">=-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>U_1.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 3, 7])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>U_2 <span class="op">=</span> torch.cat([torch.zeros_like(K_til), P_C.mT], dim<span class="op">=-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>U_corr <span class="op">=</span> torch.cat([U_1, U_2], dim<span class="op">=-</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>(torch.tril(U_corr[<span class="dv">0</span>].mT) <span class="op">==</span> U_corr[<span class="dv">0</span>].mT).<span class="bu">all</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(True)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>U_corr.mT <span class="op">@</span> U_corr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 4.5240,  6.2739,  9.0271,  3.9830,  4.0319,  4.8499,  4.5314],
         [ 6.2739, 11.6096, 15.4616,  6.9526,  6.8304,  8.2079,  7.6694],
         [ 9.0271, 15.4616, 22.7061, 10.4276, 10.0239, 11.5435, 11.2512],
         [ 3.9830,  6.9526, 10.4276,  5.1348,  4.4353,  4.9715,  4.9817],
         [ 4.0319,  6.8304, 10.0239,  4.4353,  4.6100,  5.1082,  5.1311],
         [ 4.8499,  8.2079, 11.5435,  4.9715,  5.1082,  6.6063,  5.7099],
         [ 4.5314,  7.6694, 11.2512,  4.9817,  5.1311,  5.7099,  5.8165]],

        [[ 4.5240,  6.2739,  9.0271,  3.9830,  4.0319,  4.8499,  4.5314],
         [ 6.2739, 11.6096, 15.4616,  6.9526,  6.8304,  8.2079,  7.6694],
         [ 9.0271, 15.4616, 22.7061, 10.4276, 10.0239, 11.5435, 11.2512],
         [ 3.9830,  6.9526, 10.4276,  5.1348,  4.4353,  4.9715,  4.9817],
         [ 4.0319,  6.8304, 10.0239,  4.4353,  4.6100,  5.1082,  5.1311],
         [ 4.8499,  8.2079, 11.5435,  4.9715,  5.1082,  6.6063,  5.7099],
         [ 4.5314,  7.6694, 11.2512,  4.9817,  5.1311,  5.7099,  5.8165]]],
       dtype=torch.float64, grad_fn=&lt;UnsafeViewBackward0&gt;)</code></pre>
</div>
</div>
<p>Now we are building <span class="math inline">\(U^TU\)</span> manually and check tht is the same</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>test_close(K_til <span class="op">@</span> K_til.mT, K <span class="op">@</span> H <span class="op">@</span> P_m)</span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>K_til <span class="op">@</span> K_til.mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[4.8320, 4.5955, 5.2190, 5.1569],
         [4.5955, 4.4276, 5.1086, 4.9699],
         [5.2190, 5.1086, 6.0327, 5.7362],
         [5.1569, 4.9699, 5.7362, 5.5787]],

        [[4.8320, 4.5955, 5.2190, 5.1569],
         [4.5955, 4.4276, 5.1086, 4.9699],
         [5.2190, 5.1086, 6.0327, 5.7362],
         [5.1569, 4.9699, 5.7362, 5.5787]]], dtype=torch.float64,
       grad_fn=&lt;UnsafeViewBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>test_close(K_til <span class="op">@</span> K_til.mT <span class="op">+</span> P, P_m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>UTU <span class="op">=</span> torch.cat([torch.cat([S, H<span class="op">@</span>P_m], dim<span class="op">=-</span><span class="dv">1</span>),</span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>           torch.cat([P_m<span class="op">@</span>H.mT, K_til<span class="op">@</span>K_til.mT <span class="op">+</span> P], dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>          ], dim<span class="op">=-</span><span class="dv">2</span>)</span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a>UTU</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 4.5240,  6.2739,  9.0271,  3.9830,  4.0319,  4.8499,  4.5314],
         [ 6.2739, 11.6096, 15.4616,  6.9526,  6.8304,  8.2079,  7.6694],
         [ 9.0271, 15.4616, 22.7061, 10.4276, 10.0239, 11.5435, 11.2512],
         [ 3.9830,  6.9526, 10.4276,  5.1348,  4.4353,  4.9715,  4.9817],
         [ 4.0319,  6.8304, 10.0239,  4.4353,  4.6100,  5.1082,  5.1311],
         [ 4.8499,  8.2079, 11.5435,  4.9715,  5.1082,  6.6063,  5.7099],
         [ 4.5314,  7.6694, 11.2512,  4.9817,  5.1311,  5.7099,  5.8165]],

        [[ 4.5240,  6.2739,  9.0271,  3.9830,  4.0319,  4.8499,  4.5314],
         [ 6.2739, 11.6096, 15.4616,  6.9526,  6.8304,  8.2079,  7.6694],
         [ 9.0271, 15.4616, 22.7061, 10.4276, 10.0239, 11.5435, 11.2512],
         [ 3.9830,  6.9526, 10.4276,  5.1348,  4.4353,  4.9715,  4.9817],
         [ 4.0319,  6.8304, 10.0239,  4.4353,  4.6100,  5.1082,  5.1311],
         [ 4.8499,  8.2079, 11.5435,  4.9715,  5.1082,  6.6063,  5.7099],
         [ 4.5314,  7.6694, 11.2512,  4.9817,  5.1311,  5.7099,  5.8165]]],
       dtype=torch.float64, grad_fn=&lt;CatBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a>test_close(U_corr.mT <span class="op">@</span> U_corr, UTU)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>U_corr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 2.1270,  2.9497,  4.2441,  1.8726,  1.8956,  2.2802,  2.1305],
         [ 0.0000,  1.7055,  1.7253,  0.8378,  0.7264,  0.8690,  0.8122],
         [ 0.0000,  0.0000,  1.3102,  0.7895,  0.5537,  0.2800,  0.6167],
         [ 0.0000,  0.0000,  0.0000,  0.5503, -0.2910, -0.4499, -0.3183],
         [ 0.0000,  0.0000,  0.0000,  0.0000,  0.3127, -0.4200,  0.2193],
         [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.4413, -0.1755],
         [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.2399]],

        [[ 2.1270,  2.9497,  4.2441,  1.8726,  1.8956,  2.2802,  2.1305],
         [ 0.0000,  1.7055,  1.7253,  0.8378,  0.7264,  0.8690,  0.8122],
         [ 0.0000,  0.0000,  1.3102,  0.7895,  0.5537,  0.2800,  0.6167],
         [ 0.0000,  0.0000,  0.0000,  0.5503, -0.2910, -0.4499, -0.3183],
         [ 0.0000,  0.0000,  0.0000,  0.0000,  0.3127, -0.4200,  0.2193],
         [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.4413, -0.1755],
         [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.2399]]],
       dtype=torch.float64, grad_fn=&lt;CatBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>torch.linalg.cholesky(P).mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 0.5503, -0.2910, -0.4499, -0.3183],
         [ 0.0000,  0.3127, -0.4200,  0.2193],
         [ 0.0000,  0.0000,  0.4413, -0.1755],
         [ 0.0000,  0.0000,  0.0000,  0.2399]],

        [[ 0.5503, -0.2910, -0.4499, -0.3183],
         [ 0.0000,  0.3127, -0.4200,  0.2193],
         [ 0.0000,  0.0000,  0.4413, -0.1755],
         [ 0.0000,  0.0000,  0.0000,  0.2399]]], dtype=torch.float64,
       grad_fn=&lt;TransposeBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a>U_corr[<span class="dv">0</span>, <span class="dv">3</span>:<span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span>:<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[ 0.5503, -0.2910, -0.4499],
        [ 0.0000,  0.3127, -0.4200],
        [ 0.0000,  0.0000,  0.4413]], dtype=torch.float64,
       grad_fn=&lt;SliceBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a>U_corr[:, n_dim_obs:, n_dim_obs:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 0.5503, -0.2910, -0.4499, -0.3183],
         [ 0.0000,  0.3127, -0.4200,  0.2193],
         [ 0.0000,  0.0000,  0.4413, -0.1755],
         [ 0.0000,  0.0000,  0.0000,  0.2399]],

        [[ 0.5503, -0.2910, -0.4499, -0.3183],
         [ 0.0000,  0.3127, -0.4200,  0.2193],
         [ 0.0000,  0.0000,  0.4413, -0.1755],
         [ 0.0000,  0.0000,  0.0000,  0.2399]]], dtype=torch.float64,
       grad_fn=&lt;SliceBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a>torch.linalg.cholesky(P).mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 0.5503, -0.2910, -0.4499, -0.3183],
         [ 0.0000,  0.3127, -0.4200,  0.2193],
         [ 0.0000,  0.0000,  0.4413, -0.1755],
         [ 0.0000,  0.0000,  0.0000,  0.2399]],

        [[ 0.5503, -0.2910, -0.4499, -0.3183],
         [ 0.0000,  0.3127, -0.4200,  0.2193],
         [ 0.0000,  0.0000,  0.4413, -0.1755],
         [ 0.0000,  0.0000,  0.0000,  0.2399]]], dtype=torch.float64,
       grad_fn=&lt;TransposeBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a>test_close(U_corr[:, n_dim_obs:, n_dim_obs:], torch.linalg.cholesky(P).mT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> torch.cat([torch.cat([R_C.mT.expand(<span class="dv">2</span>,<span class="op">-</span><span class="dv">1</span>,<span class="op">-</span><span class="dv">1</span>), torch.zeros_like(H <span class="op">@</span> P_m_C)],   dim<span class="op">=-</span><span class="dv">1</span>),</span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a>               torch.cat([P_m_C.mT <span class="op">@</span> H.mT,        P_m_C.mT                   ],   dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a>              ], dim<span class="op">=-</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb225"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a>(torch.linalg.cholesky(R) <span class="op">@</span> torch.linalg.cholesky(R).mT <span class="op">-</span> R).<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(0., dtype=torch.float64, grad_fn=&lt;MaxBackward1&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a>(torch.linalg.cholesky(P_m) <span class="op">@</span> torch.linalg.cholesky(P_m).mT <span class="op">-</span> P_m).<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(8.8818e-16, dtype=torch.float64, grad_fn=&lt;MaxBackward1&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb229"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a>R_C<span class="op">@</span>R_C.mT <span class="op">+</span> H <span class="op">@</span> P_m_C <span class="op">@</span> P_m_C.mT <span class="op">@</span> H.mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 4.5240,  6.2739,  9.0271],
         [ 6.2739, 11.6096, 15.4616],
         [ 9.0271, 15.4616, 22.7061]],

        [[ 4.5240,  6.2739,  9.0271],
         [ 6.2739, 11.6096, 15.4616],
         [ 9.0271, 15.4616, 22.7061]]], dtype=torch.float64,
       grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb231"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a>R_C<span class="op">@</span>R_C.mT <span class="op">+</span> H <span class="op">@</span> torch.linalg.cholesky(P_m) <span class="op">@</span> torch.linalg.cholesky(P_m).mT <span class="op">@</span> H.mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 4.5240,  6.2739,  9.0271],
         [ 6.2739, 11.6096, 15.4616],
         [ 9.0271, 15.4616, 22.7061]],

        [[ 4.5240,  6.2739,  9.0271],
         [ 6.2739, 11.6096, 15.4616],
         [ 9.0271, 15.4616, 22.7061]]], dtype=torch.float64,
       grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb233"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a>R <span class="op">+</span> H <span class="op">@</span> P_m <span class="op">@</span> H.mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 4.5240,  6.2739,  9.0271],
         [ 6.2739, 11.6096, 15.4616],
         [ 9.0271, 15.4616, 22.7061]],

        [[ 4.5240,  6.2739,  9.0271],
         [ 6.2739, 11.6096, 15.4616],
         [ 9.0271, 15.4616, 22.7061]]], dtype=torch.float64,
       grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb235"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>test_close(M.mT<span class="op">@</span>M, UTU, eps<span class="op">=</span><span class="fl">2e-5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb236"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a>M</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 0.9094,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
         [ 0.0000,  0.9543,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
         [ 0.0000,  0.0000,  0.1604,  0.0000,  0.0000,  0.0000,  0.0000],
         [-1.7577, -3.0682, -4.6017, -2.2660, -1.9573, -2.1939, -2.1984],
         [ 0.6702,  0.9346,  1.1521,  0.0000,  0.8825,  0.9222,  0.9382],
         [ 0.3868,  0.6330,  0.3967,  0.0000,  0.0000,  0.9708,  0.0220],
         [-0.0931, -0.1038, -0.1399,  0.0000,  0.0000,  0.0000, -0.3203]],

        [[ 0.9094,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
         [ 0.0000,  0.9543,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000],
         [ 0.0000,  0.0000,  0.1604,  0.0000,  0.0000,  0.0000,  0.0000],
         [-1.7577, -3.0682, -4.6017, -2.2660, -1.9573, -2.1939, -2.1984],
         [ 0.6702,  0.9346,  1.1521,  0.0000,  0.8825,  0.9222,  0.9382],
         [ 0.3868,  0.6330,  0.3967,  0.0000,  0.0000,  0.9708,  0.0220],
         [-0.0931, -0.1038, -0.1399,  0.0000,  0.0000,  0.0000, -0.3203]]],
       dtype=torch.float64, grad_fn=&lt;CatBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb238"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>U <span class="op">=</span> torch.linalg.qr(M).R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>test_close(U.mT <span class="op">@</span> U, UTU)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb240"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a>test_close(U_corr.mT <span class="op">@</span> U_corr, U.mT <span class="op">@</span> U)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>but the decomposition is different so:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a>(U_corr <span class="op">-</span> U).<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(8.4883, dtype=torch.float64, grad_fn=&lt;MaxBackward1&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a>P_C <span class="op">=</span> U[:, <span class="dv">3</span>:, <span class="dv">3</span>:].mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb244"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>P_C</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 0.5503,  0.0000,  0.0000,  0.0000],
         [-0.2911, -0.3127,  0.0000,  0.0000],
         [-0.4499,  0.4201, -0.4413,  0.0000],
         [-0.3183, -0.2192,  0.1756, -0.2399]],

        [[ 0.5503,  0.0000,  0.0000,  0.0000],
         [-0.2911, -0.3127,  0.0000,  0.0000],
         [-0.4499,  0.4201, -0.4413,  0.0000],
         [-0.3183, -0.2192,  0.1756, -0.2399]]], dtype=torch.float64,
       grad_fn=&lt;TransposeBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>P_C <span class="op">@</span> P_C.mT</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 3.0279e-01, -1.6016e-01, -2.4755e-01, -1.7516e-01],
         [-1.6016e-01,  1.8248e-01, -4.1026e-04,  1.6120e-01],
         [-2.4755e-01, -4.1026e-04,  5.7354e-01, -2.6354e-02],
         [-1.7516e-01,  1.6120e-01, -2.6354e-02,  2.3776e-01]],

        [[ 3.0279e-01, -1.6016e-01, -2.4755e-01, -1.7516e-01],
         [-1.6016e-01,  1.8248e-01, -4.1026e-04,  1.6120e-01],
         [-2.4755e-01, -4.1026e-04,  5.7354e-01, -2.6354e-02],
         [-1.7516e-01,  1.6120e-01, -2.6354e-02,  2.3776e-01]]],
       dtype=torch.float64, grad_fn=&lt;UnsafeViewBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb248"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a>P</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[ 3.0280e-01, -1.6016e-01, -2.4755e-01, -1.7516e-01],
         [-1.6016e-01,  1.8249e-01, -4.0924e-04,  1.6121e-01],
         [-2.4755e-01, -4.0924e-04,  5.7354e-01, -2.6353e-02],
         [-1.7516e-01,  1.6121e-01, -2.6353e-02,  2.3776e-01]],

        [[ 3.0280e-01, -1.6016e-01, -2.4755e-01, -1.7516e-01],
         [-1.6016e-01,  1.8249e-01, -4.0924e-04,  1.6121e-01],
         [-2.4755e-01, -4.0924e-04,  5.7354e-01, -2.6353e-02],
         [-1.7516e-01,  1.6121e-01, -2.6353e-02,  2.3776e-01]]],
       dtype=torch.float64, grad_fn=&lt;UnsafeViewBackward0&gt;)</code></pre>
</div>
</div>
<p>I have that <span class="math inline">\(U^TU = U_{corr}^TU_{corr}\)</span> but that <span class="math inline">\(U != U_{corr}\)</span> as the cholesky decomposition of a matrix is not unique but they are both valid.</p>
<p>However in both cases the bottom left of <span class="math inline">\(U^TU\)</span> is <span class="math inline">\(KHP^- + P\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb250"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a>test_close(UTU[:, <span class="dv">3</span>:, <span class="dv">3</span>:], K <span class="op">@</span> H <span class="op">@</span> P_m <span class="op">+</span> P)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a>test_close((U.mT <span class="op">@</span> U)[:, <span class="dv">3</span>:, <span class="dv">3</span>:], K <span class="op">@</span> H <span class="op">@</span> P_m <span class="op">+</span> P)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Thefore the bottom left of <span class="math inline">\(U\)</span> needs to be a valid cholesky factor of <span class="math inline">\(P\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a>U[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[-2.1270, -2.9497, -4.2442, -1.8726, -1.8956, -2.2802, -2.1305],
        [ 0.0000, -1.7055, -1.7253, -0.8378, -0.7263, -0.8690, -0.8122],
        [ 0.0000,  0.0000, -1.3102, -0.7895, -0.5537, -0.2800, -0.6167],
        [ 0.0000,  0.0000,  0.0000,  0.5503, -0.2911, -0.4499, -0.3183],
        [ 0.0000,  0.0000,  0.0000,  0.0000, -0.3127,  0.4201, -0.2192],
        [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000, -0.4413,  0.1756],
        [ 0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000, -0.2399]],
       dtype=torch.float64, grad_fn=&lt;SelectBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>K <span class="op">@</span> H <span class="op">@</span> P_m <span class="op">+</span> P</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[5.1348, 4.4353, 4.9715, 4.9817],
         [4.4353, 4.6100, 5.1082, 5.1311],
         [4.9715, 5.1082, 6.6063, 5.7099],
         [4.9817, 5.1311, 5.7099, 5.8165]],

        [[5.1348, 4.4353, 4.9715, 4.9817],
         [4.4353, 4.6100, 5.1082, 5.1311],
         [4.9715, 5.1082, 6.6063, 5.7099],
         [4.9817, 5.1311, 5.7099, 5.8165]]], dtype=torch.float64,
       grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<p>let’s test that for each block <span class="math inline">\(U\)</span> is equivalent for <span class="math inline">\(U_{corr})\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a>test_close(U[:, :<span class="dv">3</span>, :<span class="dv">3</span>].mT <span class="op">@</span> U[:, :<span class="dv">3</span>, :<span class="dv">3</span>], S)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb257"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a>test_close(U[:, :<span class="dv">3</span>, <span class="dv">3</span>:].mT <span class="op">@</span> U[:, :<span class="dv">3</span>, <span class="dv">3</span>:], K <span class="op">@</span> H <span class="op">@</span> P_m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb258"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a>test_close(U[:, <span class="dv">3</span>:, <span class="dv">3</span>:].mT <span class="op">@</span> U[:, <span class="dv">3</span>:, <span class="dv">3</span>:], P)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="covariance-3" class="level4">
<h4 class="anchored" data-anchor-id="covariance-3">Covariance</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb259"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a>P_C, S_C <span class="op">=</span> _filter_update_cov_SR(H, R_C, P_m_C)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzz_filter_update_cov_SR(n<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a>    errs <span class="op">=</span> []</span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a>        kSR <span class="op">=</span> KalmanFilterSR.init_random(<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">4</span>)</span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a>        H, R_C, P_m <span class="op">=</span> (kSR.H, kSR.R_C, torch.cat([kSR.P0]<span class="op">*</span><span class="dv">5</span>))</span>
<span id="cb260-6"><a href="#cb260-6" aria-hidden="true" tabindex="-1"></a>        R <span class="op">=</span> R_C <span class="op">@</span> R_C.mT</span>
<span id="cb260-7"><a href="#cb260-7" aria-hidden="true" tabindex="-1"></a>        P_m_C <span class="op">=</span> torch.linalg.cholesky(P_m)</span>
<span id="cb260-8"><a href="#cb260-8" aria-hidden="true" tabindex="-1"></a>        P_C, _ <span class="op">=</span> _filter_update_cov_SR(H, R_C, P_m_C)</span>
<span id="cb260-9"><a href="#cb260-9" aria-hidden="true" tabindex="-1"></a>        K <span class="op">=</span> _filter_update_k_gain(H, R, P_m)</span>
<span id="cb260-10"><a href="#cb260-10" aria-hidden="true" tabindex="-1"></a>        std_P <span class="op">=</span> _filter_update_cov(H, K, P_m)</span>
<span id="cb260-11"><a href="#cb260-11" aria-hidden="true" tabindex="-1"></a>        errs.append((P_C <span class="op">@</span> P_C.mT <span class="op">-</span>  std_P).<span class="bu">abs</span>().<span class="bu">max</span>().item())</span>
<span id="cb260-12"><a href="#cb260-12" aria-hidden="true" tabindex="-1"></a>        test_close(P_C <span class="op">@</span> P_C.mT, std_P, eps<span class="op">=</span><span class="fl">1e-13</span>)</span>
<span id="cb260-13"><a href="#cb260-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.tensor(errs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>fuzz_filter_update_cov_SR(<span class="dv">1000</span>).median()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(8.7985e-15)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb263"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a>torch.sqrt(torch.tensor(<span class="fl">1e-5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(0.0032)</code></pre>
</div>
</div>
</section>
<section id="kalman-gain-1" class="level4">
<h4 class="anchored" data-anchor-id="kalman-gain-1">Kalman Gain</h4>
<p>Don’t compute the inverse of the matrix, but use <code>cholesky_solve</code> to invert the matrix</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb265"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a>test_close(S_C <span class="op">@</span> S_C.mT, S)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb266"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a>_filter_update_k_gain_SR(H, P_m_C, S_C)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[-1.5789e-01, -1.1835e-01,  6.0261e-01],
         [ 5.0220e-02, -1.6250e-03,  4.2261e-01],
         [ 2.3883e-01,  2.9332e-01,  2.1371e-01],
         [ 6.2363e-02,  3.9408e-05,  4.7069e-01]],

        [[-1.5789e-01, -1.1835e-01,  6.0261e-01],
         [ 5.0220e-02, -1.6250e-03,  4.2261e-01],
         [ 2.3883e-01,  2.9332e-01,  2.1371e-01],
         [ 6.2363e-02,  3.9408e-05,  4.7069e-01]]], dtype=torch.float64,
       grad_fn=&lt;TransposeBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb268"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a>test_close(_filter_update_k_gain(H, R, P_m), _filter_update_k_gain_SR(H, P_m_C, S_C))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb269"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a>obs.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 3, 1])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb271"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a>m, P_C <span class="op">=</span> _filter_update_SR(H, d, R_C, m_m, P_m_C, obs)</span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a>show_as_row(m, P_C)</span>
<span id="cb271-3"><a href="#cb271-3" aria-hidden="true" tabindex="-1"></a>m.shape, P_C.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">m</p> <pre>tensor([[[    nan],
         [    nan],
         [    nan],
         [    nan]],

        [[ 0.0088],
         [-0.2454],
         [-0.3752],
         [ 0.7701]]], dtype=torch.float64, grad_fn=<addbackward0>)</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">P_C</p> <pre>tensor([[[ 0.5503,  0.0000,  0.0000,  0.0000],
         [-0.2911, -0.3127,  0.0000,  0.0000],
         [-0.4499,  0.4201, -0.4413,  0.0000],
         [-0.3183, -0.2192,  0.1756, -0.2399]],

        [[ 0.5503,  0.0000,  0.0000,  0.0000],
         [-0.2911, -0.3127,  0.0000,  0.0000],
         [-0.4499,  0.4201, -0.4413,  0.0000],
         [-0.3183, -0.2192,  0.1756, -0.2399]]], dtype=torch.float64,
       grad_fn=<transposebackward0>)</transposebackward0></pre> </div></div>
</div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]))</code></pre>
</div>
</div>
</section>
<section id="missing-observations-1" class="level4">
<h4 class="anchored" data-anchor-id="missing-observations-1">Missing observations</h4>
<section id="update-mask-1" class="level5">
<h5 class="anchored" data-anchor-id="update-mask-1">Update mask</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb273"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span>_filter_update_mask_SR(H, d, R_C, m_m, P_m_C, obs, mask[<span class="dv">0</span>, <span class="dv">0</span>, :] ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[[1.4380],
         [1.1693],
         [0.5919],
         [2.4098]],

        [[1.4691],
         [0.9196],
         [0.7230],
         [2.0708]]], dtype=torch.float64, grad_fn=<addbackward0>)</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[[ 1.2760,  0.0000,  0.0000,  0.0000],
         [ 0.6940, -0.7314,  0.0000,  0.0000],
         [ 0.5498, -0.5526, -0.8941,  0.0000],
         [ 0.7776, -0.7559, -0.0076, -0.3186]],

        [[ 1.2760,  0.0000,  0.0000,  0.0000],
         [ 0.6940, -0.7314,  0.0000,  0.0000],
         [ 0.5498, -0.5526, -0.8941,  0.0000],
         [ 0.7776, -0.7559, -0.0076, -0.3186]]], dtype=torch.float64,
       grad_fn=<transposebackward0>)</transposebackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb274"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a>m, P_C <span class="op">=</span> _filter_update_mask_SR(H, d, R_C, m_m, P_m_C, obs, mask[<span class="dv">0</span>, <span class="dv">0</span>, :] )</span>
<span id="cb274-2"><a href="#cb274-2" aria-hidden="true" tabindex="-1"></a>m.shape, P_C.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]))</code></pre>
</div>
</div>
</section>
<section id="update-mask-batch-1" class="level5">
<h5 class="anchored" data-anchor-id="update-mask-batch-1">Update mask batch</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb276"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a>m, P_C <span class="op">=</span> _filter_update_mask_batch_SR(H, d, R_C, m_m, P_m_C, obs, mask[:,<span class="dv">0</span>,:] )</span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a>show_as_row(m, P_C)</span>
<span id="cb276-3"><a href="#cb276-3" aria-hidden="true" tabindex="-1"></a>m.shape, P_C.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">m</p> <pre>tensor([[[ 1.4380],
         [ 1.1693],
         [ 0.5919],
         [ 2.4098]],

        [[ 0.0088],
         [-0.2454],
         [-0.3752],
         [ 0.7701]]], dtype=torch.float64, grad_fn=<indexputbackward0>)</indexputbackward0></pre> </div><div><p style="font-size: 1.2rem;">P_C</p> <pre>tensor([[[ 1.2760,  0.0000,  0.0000,  0.0000],
         [ 0.6940, -0.7314,  0.0000,  0.0000],
         [ 0.5498, -0.5526, -0.8941,  0.0000],
         [ 0.7776, -0.7559, -0.0076, -0.3186]],

        [[ 0.5503,  0.0000,  0.0000,  0.0000],
         [-0.2911, -0.3127,  0.0000,  0.0000],
         [-0.4499,  0.4201, -0.4413,  0.0000],
         [-0.3183, -0.2192,  0.1756, -0.2399]]], dtype=torch.float64,
       grad_fn=<indexputbackward0>)</indexputbackward0></pre> </div></div>
</div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>m.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>) <span class="co"># check that pytorch can compute gradients with the whole batch and gradients aren't nan</span></span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a>H.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[-6.9338e+00, -5.2713e+00, -2.8998e+00, -1.0339e+01],
         [-1.9440e-03,  4.2816e-02,  6.5510e-02, -1.3323e-01],
         [ 1.5014e-01,  3.1149e-01,  4.6507e-01, -1.4330e+00]]],
       dtype=torch.float64)</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="filter-all-1" class="level3">
<h3 class="anchored" data-anchor-id="filter-all-1">Filter All</h3>
<p>The resursive version of the kalman filter is apperently breaking pytorch gradients calculations so a workaround is needed. During the loop the states are saved in a python list and then at the end they are combined back into a tensor. The last line of the function does:</p>
<ul>
<li>convert lists to tensors</li>
<li>correct order dimensions</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a>filt_stateSR, pred_stateSR  <span class="op">=</span> kSR._filter_all(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb281"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a>(ms, P_Cs), (m_ms, P_m_Cs) <span class="op">=</span> filt_stateSR, pred_stateSR</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Predictions at time <code>0</code> for both batches</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(Self.shape(), (m_ms, P_m_Cs, ms, P_Cs,)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([2, 10, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([2, 10, 4, 4])</pre> </div><div><p style="font-size: 1.2rem;">#2</p> <pre>torch.Size([2, 10, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;">#3</p> <pre>torch.Size([2, 10, 4, 4])</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb283"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(<span class="kw">lambda</span> x:x[<span class="dv">0</span>][<span class="dv">0</span>], (m_ms, P_m_Cs, ms, P_Cs,)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[0.4499],
        [0.8575],
        [0.2647],
        [0.4293]], dtype=torch.float64, grad_fn=<selectbackward0>)</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[1.1616, 0.0000, 0.0000, 0.0000],
        [0.8570, 0.9410, 0.0000, 0.0000],
        [1.5540, 0.9080, 0.0291, 0.0000],
        [0.9748, 0.6553, 0.0732, 0.3674]], dtype=torch.float64,
       grad_fn=<selectbackward0>)</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;">#2</p> <pre>tensor([[0.5779],
        [1.0114],
        [0.4934],
        [0.5826]], dtype=torch.float64, grad_fn=<selectbackward0>)</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;">#3</p> <pre>tensor([[-0.8474,  0.0000,  0.0000,  0.0000],
        [-0.2789, -0.7932,  0.0000,  0.0000],
        [-0.7989, -0.7649, -0.0291,  0.0000],
        [-0.4438, -0.5279, -0.0716,  0.3649]], dtype=torch.float64,
       grad_fn=<selectbackward0>)</selectbackward0></pre> </div></div>
</div>
</div>
</section>
<section id="filter-3" class="level3">
<h3 class="anchored" data-anchor-id="filter-3">Filter</h3>
<p>The filter methods wraps <code>_filter_all</code> but in addition:</p>
<ul>
<li>returns only filtered state</li>
<li>remove last dimensions from mean</li>
</ul>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L677" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfiltersr.filter" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfiltersr.filter">KalmanFilterSR.filter</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilterSR.filter (obs:torch.Tensor, mask:torch.Tensor,
                        control:torch.Tensor)</code></pre>
</blockquote>
<p>Filter observation</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>obs</td>
<td>Tensor</td>
<td><code>([n_batches], n_obs, [self.n_dim_obs])</code> where <code>n_batches</code> and <code>n_dim_obs</code> dimensions can be omitted if 1</td>
</tr>
<tr class="even">
<td>mask</td>
<td>Tensor</td>
<td><code>([n_batches], n_obs, [self.n_dim_obs])</code> where <code>n_batches</code> and <code>n_dim_obs</code> dimensions can be omitted if 1</td>
</tr>
<tr class="odd">
<td>control</td>
<td>Tensor</td>
<td>([n_batches], n_obs, [self.n_dim_contr])</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ListMultiNormal</strong></td>
<td><strong>Filtered state (n_batches, n_obs, self.n_dim_state)</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb285"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a>filtSR <span class="op">=</span> kSR.<span class="bu">filter</span>(data, mask, control)</span>
<span id="cb285-2"><a href="#cb285-2" aria-hidden="true" tabindex="-1"></a>filtSR.mean.shape, filtSR.cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 10, 4, 1]), torch.Size([2, 10, 4, 4]))</code></pre>
</div>
</div>
</section>
<section id="comparison" class="level3">
<h3 class="anchored" data-anchor-id="comparison">Comparison</h3>
</section>
</section>
<section id="additional" class="level2">
<h2 class="anchored" data-anchor-id="additional">Additional</h2>
<section id="constructors-1" class="level3">
<h3 class="anchored" data-anchor-id="constructors-1">Constructors</h3>
<section id="simple-parameters" class="level4">
<h4 class="anchored" data-anchor-id="simple-parameters">Simple parameters</h4>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L688" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="kalmanfilter.init_simple" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.init_simple">KalmanFilter.init_simple</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.init_simple (n_dim, dtype=torch.float64)</code></pre>
</blockquote>
<p>Simplest version of kalman filter parameters</p>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>n_dim</td>
<td></td>
<td></td>
<td>n_dim_obs and n_dim_state</td>
</tr>
<tr class="even">
<td>dtype</td>
<td>dtype</td>
<td>torch.float64</td>
<td></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb288"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a>KalmanFilter.init_simple(<span class="dv">2</span>).state_dict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>OrderedDict([('A',
              tensor([[[1., 0.],
                       [0., 1.]]], dtype=torch.float64)),
             ('H',
              tensor([[[1., 0.],
                       [0., 1.]]], dtype=torch.float64)),
             ('B',
              tensor([[[1., 0.],
                       [0., 1.]]], dtype=torch.float64)),
             ('Q_raw',
              tensor([[[1., 0.],
                       [0., 1.]]], dtype=torch.float64)),
             ('R_raw',
              tensor([[[1., 0.],
                       [0., 1.]]], dtype=torch.float64)),
             ('b',
              tensor([[[0.],
                       [0.]]], dtype=torch.float64)),
             ('d',
              tensor([[[0.],
                       [0.]]], dtype=torch.float64)),
             ('m0',
              tensor([[[0.],
                       [0.]]], dtype=torch.float64)),
             ('P0_raw',
              tensor([[[1., 0.],
                       [0., 1.]]], dtype=torch.float64))])</code></pre>
</div>
</div>
<section id="local-slope" class="level4">
<h4 class="anchored" data-anchor-id="local-slope">Local slope</h4>
<p>Local slope models are an extentions of local level model that in the state variable keep track of also the slope</p>
<p>Given <span class="math inline">\(n\)</span> as the number of dimensions of the observations</p>
<p>The transition matrix (<code>A</code>) is:</p>
<p><span class="math display">\[A = \left[\begin{array}{cc}I &amp; I \\ 0 &amp; I\end{array}\right]\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(I \in \mathbb{R}^{n \times n}\)</span></li>
<li><span class="math inline">\(A \in \mathbb{R}^{2n \times 2n}\)</span></li>
</ul>
<p>the state <span class="math inline">\(x \in \mathbb{R}^{2N \times 1}\)</span> where the upper half keep track of the level and the lower half of the slope. <span class="math inline">\(A \in \mathbb{R}^2N \times 2N\)</span></p>
<p>the observation matrix (<code>H</code>) is:</p>
<p><span class="math display">\[H = \left[\begin{array}{cc}I &amp; 0 \end{array}\right]\]</span></p>
<p>For the multivariate case the 1 are replaced with an identiy matrix</p>
<p>assuming that the control has the same dimensions of the observations then if we are doing a local slope model we have <span class="math inline">\(B \in \mathbb{R}^{state \times contr}\)</span>: <span class="math display">\[ B = \begin{bmatrix} -I &amp; I \\ 0 &amp; 0 \end{bmatrix}\]</span></p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L718" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="kalmanfilter.init_local_slope_pca" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.init_local_slope_pca">KalmanFilter.init_local_slope_pca</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.init_local_slope_pca (n_dim_obs, n_dim_state:int,
                                    df_pca:pandas.core.frame.DataFrame|Non
                                    e=None, **kwargs)</code></pre>
</blockquote>
<p>Local Slope + PCA init</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>n_dim_obs</td>
<td></td>
<td></td>
<td>n_dim_obs and n_dim_contr</td>
</tr>
<tr class="even">
<td>n_dim_state</td>
<td>int</td>
<td></td>
<td>n_dim_state</td>
</tr>
<tr class="odd">
<td>df_pca</td>
<td>pandas.core.frame.DataFrame | None</td>
<td>None</td>
<td>dataframe for PCA init, None no PCA init</td>
</tr>
<tr class="even">
<td>kwargs</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb291"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a>KalmanFilter.init_local_slope_pca(<span class="dv">2</span>,<span class="dv">2</span>,pd.DataFrame([[<span class="dv">1</span>,<span class="dv">2</span>], [<span class="dv">2</span>,<span class="dv">4</span>]])).state_dict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>OrderedDict([('A',
              tensor([[[1., 0., 1., 0.],
                       [0., 1., 0., 1.],
                       [0., 0., 1., 0.],
                       [0., 0., 0., 1.]]], dtype=torch.float64)),
             ('H',
              tensor([[[ 0.4472,  0.8944,  0.0000,  0.0000],
                       [ 0.8944, -0.4472,  0.0000,  0.0000]]], dtype=torch.float64)),
             ('B',
              tensor([[[-0.4472, -0.8944,  0.4472,  0.8944],
                       [-0.8944,  0.4472,  0.8944, -0.4472],
                       [ 0.0000,  0.0000,  0.0000,  0.0000],
                       [ 0.0000,  0.0000,  0.0000,  0.0000]]], dtype=torch.float64)),
             ('Q_raw',
              tensor([[[0.3162, 0.0000, 0.0000, 0.0000],
                       [0.0000, 0.3162, 0.0000, 0.0000],
                       [0.0000, 0.0000, 0.3162, 0.0000],
                       [0.0000, 0.0000, 0.0000, 0.3162]]], dtype=torch.float64)),
             ('R_raw',
              tensor([[[0.1000, 0.0000],
                       [0.0000, 0.1000]]], dtype=torch.float64)),
             ('b',
              tensor([[[0.],
                       [0.],
                       [0.],
                       [0.]]], dtype=torch.float64)),
             ('d',
              tensor([[[0.],
                       [0.]]], dtype=torch.float64)),
             ('m0',
              tensor([[[0.],
                       [0.],
                       [0.],
                       [0.]]], dtype=torch.float64)),
             ('P0_raw',
              tensor([[[1.7321, 0.0000, 0.0000, 0.0000],
                       [0.0000, 1.7321, 0.0000, 0.0000],
                       [0.0000, 0.0000, 1.7321, 0.0000],
                       [0.0000, 0.0000, 0.0000, 1.7321]]], dtype=torch.float64))])</code></pre>
</div>
</div>
</section>
</section>
<section id="export" class="level2">
<h2 class="anchored" data-anchor-id="export">Export</h2>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>