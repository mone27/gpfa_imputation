<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend">

<title>meteo_imp - Kalman Filter</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="meteo_imp - Kalman Filter">
<meta property="og:description" content="Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend">
<meta property="og:site-name" content="meteo_imp">
<meta name="twitter:title" content="meteo_imp - Kalman Filter">
<meta name="twitter:description" content="Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">meteo_imp</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Kalman Filter</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">GPFA Imputation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../data_preparation.html" class="sidebar-item-text sidebar-link">Data Preparation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../results.html" class="sidebar-item-text sidebar-link">Results</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../simplegp_imputation.html" class="sidebar-item-text sidebar-link">Simple GP Imputation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gaussian.html" class="sidebar-item-text sidebar-link">Gaussian Distributions Utils</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../utils.html" class="sidebar-item-text sidebar-link">Utils</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Fluxnet</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Fluxnet/gap_finder.html" class="sidebar-item-text sidebar-link">Find Gaps in Fluxnet data</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Fluxnet/hainich.html" class="sidebar-item-text sidebar-link">Fluxnet Hainich</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">GPFA</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../GPFA/gpfa.html" class="sidebar-item-text sidebar-link">Gaussian Processes Factor Analysis</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../GPFA/learner.html" class="sidebar-item-text sidebar-link">GPFA Learner</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../GPFA/imputation.html" class="sidebar-item-text sidebar-link">Imputation time series</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">kalman</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/filter.html" class="sidebar-item-text sidebar-link active">Kalman Filter</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/test_filter_pykalman.html" class="sidebar-item-text sidebar-link">Tests for Kalman Filter</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/fastai.html" class="sidebar-item-text sidebar-link">Implement Kalman model using FastAI</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/learner.html" class="sidebar-item-text sidebar-link">Kalman Filter Models</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/imputation.html" class="sidebar-item-text sidebar-link">Imputation Kalman Model</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/old statsmodels - statespace.html" class="sidebar-item-text sidebar-link">[Not Working] StatsModels Kalman filter</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/old_01_pykalman_models.html" class="sidebar-item-text sidebar-link">[OLD] PyKalman Filter Models</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/old_02_pykalman_imputation.html" class="sidebar-item-text sidebar-link">[OLD] Imputation PyKalman Model</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#equations" id="toc-equations" class="nav-link" data-scroll-target="#equations">Equations</a></li>
  </ul></li>
  <li><a href="#kalmanfilter" id="toc-kalmanfilter" class="nav-link" data-scroll-target="#kalmanfilter">KalmanFilter</a>
  <ul class="collapse">
  <li><a href="#main-class" id="toc-main-class" class="nav-link" data-scroll-target="#main-class">Main class</a></li>
  <li><a href="#kalmanfilter-1" id="toc-kalmanfilter-1" class="nav-link" data-scroll-target="#kalmanfilter-1">KalmanFilter</a></li>
  <li><a href="#constructors" id="toc-constructors" class="nav-link" data-scroll-target="#constructors">Constructors</a></li>
  <li><a href="#kalmanfilter.init_random" id="toc-kalmanfilter.init_random" class="nav-link" data-scroll-target="#kalmanfilter.init_random">KalmanFilter.init_random</a></li>
  <li><a href="#filter" id="toc-filter" class="nav-link" data-scroll-target="#filter">Filter</a></li>
  <li><a href="#kalmanfilter.filter" id="toc-kalmanfilter.filter" class="nav-link" data-scroll-target="#kalmanfilter.filter">KalmanFilter.filter</a></li>
  <li><a href="#smooth" id="toc-smooth" class="nav-link" data-scroll-target="#smooth">Smooth</a></li>
  <li><a href="#kalmanfilter.smooth" id="toc-kalmanfilter.smooth" class="nav-link" data-scroll-target="#kalmanfilter.smooth">KalmanFilter.smooth</a></li>
  <li><a href="#predict" id="toc-predict" class="nav-link" data-scroll-target="#predict">Predict</a></li>
  </ul></li>
  <li><a href="#constructor-additional" id="toc-constructor-additional" class="nav-link" data-scroll-target="#constructor-additional">Constructor Additional</a>
  <ul class="collapse">
  <li><a href="#kalmanfilter.init_simple" id="toc-kalmanfilter.init_simple" class="nav-link" data-scroll-target="#kalmanfilter.init_simple">KalmanFilter.init_simple</a></li>
  <li><a href="#kalmanfilter.init_local_slope" id="toc-kalmanfilter.init_local_slope" class="nav-link" data-scroll-target="#kalmanfilter.init_local_slope">KalmanFilter.init_local_slope</a></li>
  </ul></li>
  <li><a href="#performance" id="toc-performance" class="nav-link" data-scroll-target="#performance">Performance</a></li>
  <li><a href="#export" id="toc-export" class="nav-link" data-scroll-target="#export">Export</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/mone27/meteo_imp/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Kalman Filter</h1>
</div>

<div>
  <div class="description">
    Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The models uses a latent state variable <span class="math inline">\(x\)</span> that is modelled over time, to impute gaps in <span class="math inline">\(y\)</span></p>
<p>The assumption of the model is that the state variable at time <span class="math inline">\(x_t\)</span> depends only on the last state <span class="math inline">\(x_{t-1}\)</span> and not on the previous states.</p>
<section id="equations" class="level3">
<h3 class="anchored" data-anchor-id="equations">Equations</h3>
<p>The equations of the model are:</p>
<p><span class="math display">\[\begin{align} p(x_t | x_{t-1}) &amp; = \mathcal{N}(x_t, Ax_{t-1}, Q) \\
p(y_t | x_t) &amp; = \mathcal{N}(Hx_t, R) \end{align}\]</span></p>
<p>The Kalman filter has 3 steps:</p>
<ul>
<li>filter (updating the state at time t with observations till time t-1)</li>
<li>update (update the state at time t using the observation at time t)</li>
<li>smooth (update the state using the observations at time t+1)</li>
</ul>
<p>In case of missing data the update step is skipped.</p>
<p>After smoothing the missing data at time t (<span class="math inline">\(y_t\)</span>) can be imputed from the state (<span class="math inline">\(x_t\)</span>) using this formula: <span class="math display">\[p(y_t|x_t) = \mathcal{N}(Hx_t, R + HP^s_tH)\]</span></p>
</section>
</section>
<section id="kalmanfilter" class="level2">
<h2 class="anchored" data-anchor-id="kalmanfilter">KalmanFilter</h2>
<p>The Kalman Filter is an algorithm designed to estimate <span class="math inline">\(P(x_t | y_{0:t})\)</span>. As all state transitions and obss are linear with Gaussian distributed noise, these distributions can be represented exactly as Gaussian distributions with mean <code>filt_state_means[t]</code> and covs <code>filt_state_covs[t]</code>. Similarly, the Kalman Smoother is an algorithm designed to estimate <span class="math inline">\(P(x_t | y_{0:t-1})\)</span></p>
<section id="main-class" class="level3">
<h3 class="anchored" data-anchor-id="main-class">Main class</h3>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L21" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter-1" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter-1">KalmanFilter</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter (trans_matrix:torch.Tensor, obs_matrix:torch.Tensor,
               trans_cov:torch.Tensor, obs_cov:torch.Tensor,
               trans_off:torch.Tensor, obs_off:torch.Tensor,
               init_state_mean:torch.Tensor, init_state_cov:torch.Tensor,
               n_dim_state:int=None, n_dim_obs:int=None, cov_checker:meteo
               _imp.gaussian.CheckPosDef=&lt;meteo_imp.gaussian.CheckPosDef
               object at 0x7fb874aaa4d0&gt;)</code></pre>
</blockquote>
<p>Base class for Kalman Filter and Smoother using PyTorch</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>trans_matrix</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state,n_dim_state] <span class="math inline">\(A\)</span>, state transition matrix</td>
</tr>
<tr class="even">
<td>obs_matrix</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_state] <span class="math inline">\(H\)</span>, observation matrix</td>
</tr>
<tr class="odd">
<td>trans_cov</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(Q\)</span>, state trans covariance matrix</td>
</tr>
<tr class="even">
<td>obs_cov</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_obs] <span class="math inline">\(R\)</span>, observations covariance matrix</td>
</tr>
<tr class="odd">
<td>trans_off</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(b\)</span>, state transition offset</td>
</tr>
<tr class="even">
<td>obs_off</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs] <span class="math inline">\(d\)</span>, observations offset</td>
</tr>
<tr class="odd">
<td>init_state_mean</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(\mu_0\)</span></td>
</tr>
<tr class="even">
<td>init_state_cov</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(\Sigma_0\)</span></td>
</tr>
<tr class="odd">
<td>n_dim_state</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for state - defaults to 1 if cannot be infered from parameters</td>
</tr>
<tr class="even">
<td>n_dim_obs</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for observations - defaults to 1 if cannot be infered from parameters</td>
</tr>
<tr class="odd">
<td>cov_checker</td>
<td>CheckPosDef</td>
<td>&lt;meteo_imp.gaussian.CheckPosDef object at 0x7fb874aaa4d0&gt;</td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="constructors" class="level3">
<h3 class="anchored" data-anchor-id="constructors">Constructors</h3>
<p>Giving all the parameters manually to the <a href="https://mone27.github.io/meteo_imp/lib/kalman/filter.html#kalmanfilter"><code>KalmanFilter</code></a> init method is not convenient, hence we are having some methods that help initize the class</p>
<section id="random-parameters" class="level4">
<h4 class="anchored" data-anchor-id="random-parameters">Random parameters</h4>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L126" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="kalmanfilter.init_random" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.init_random">KalmanFilter.init_random</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.init_random (n_dim_obs, n_dim_state, dtype=torch.float32)</code></pre>
</blockquote>
<p>kalman filter with random parameters</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> KalmanFilter.init_random(<span class="dv">3</span>,<span class="dv">4</span>, dtype<span class="op">=</span>torch.float64)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>k</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Kalman Filter
        N dim obs: 3, N dim state: 4</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>k.init_state_cov</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[0.2538, 0.1536, 0.1464, 0.2398],
        [0.1536, 0.1100, 0.2001, 0.2121],
        [0.1464, 0.2001, 1.6113, 1.2695],
        [0.2398, 0.2121, 1.2695, 1.9031]], dtype=torch.float64,
       grad_fn=&lt;MmBackward0&gt;)</code></pre>
</div>
</div>
<p>check that assigment works :)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>k.init_state_cov <span class="op">=</span> to_posdef(torch.rand(<span class="dv">4</span>, <span class="dv">4</span>, dtype<span class="op">=</span>torch.float64))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>k.init_state_cov_raw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Parameter containing:
tensor([[0.1136, 0.0000, 0.0000, 0.0000],
        [0.9642, 0.7383, 0.0000, 0.0000],
        [0.2865, 0.0479, 0.4863, 0.0000],
        [0.4352, 0.6382, 0.0510, 0.0476]], dtype=torch.float64,
       requires_grad=True)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(k.named_parameters())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[('trans_matrix',
  Parameter containing:
  tensor([[0.4596, 0.9489, 0.1858, 0.8850],
          [0.4974, 0.6526, 0.1531, 0.2976],
          [0.9445, 0.8229, 0.6567, 0.2093],
          [0.8668, 0.5636, 0.8919, 0.0436]], dtype=torch.float64,
         requires_grad=True)),
 ('trans_off',
  Parameter containing:
  tensor([0.8484, 0.2449, 0.5063, 0.6818], dtype=torch.float64,
         requires_grad=True)),
 ('trans_cov_raw',
  Parameter containing:
  tensor([[0.2638, 0.0000, 0.0000, 0.0000],
          [0.6188, 0.1759, 0.0000, 0.0000],
          [0.7732, 0.9728, 0.2656, 0.0000],
          [0.4674, 0.1129, 0.5690, 0.6648]], dtype=torch.float64,
         requires_grad=True)),
 ('obs_matrix',
  Parameter containing:
  tensor([[0.2364, 0.2320, 0.1813, 0.3093],
          [0.6258, 0.2964, 0.5259, 0.6701],
          [0.7945, 0.6431, 0.3232, 0.2735]], dtype=torch.float64,
         requires_grad=True)),
 ('obs_off',
  Parameter containing:
  tensor([0.0180, 0.2455, 0.5893], dtype=torch.float64, requires_grad=True)),
 ('obs_cov_raw',
  Parameter containing:
  tensor([[0.4508, 0.0000, 0.0000],
          [0.4202, 0.4246, 0.0000],
          [0.4015, 0.2792, 0.0283]], dtype=torch.float64, requires_grad=True)),
 ('init_state_mean',
  Parameter containing:
  tensor([0.6902, 0.1689, 0.6510, 0.3037], dtype=torch.float64,
         requires_grad=True)),
 ('init_state_cov_raw',
  Parameter containing:
  tensor([[0.1136, 0.0000, 0.0000, 0.0000],
          [0.9642, 0.7383, 0.0000, 0.0000],
          [0.2865, 0.0479, 0.4863, 0.0000],
          [0.4352, 0.6382, 0.0510, 0.0476]], dtype=torch.float64,
         requires_grad=True))]</code></pre>
</div>
</div>
<section id="test-data" class="level4">
<h4 class="anchored" data-anchor-id="test-data">Test data</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_test_data(n_obs <span class="op">=</span> <span class="dv">10</span>, n_dim_obs<span class="op">=</span><span class="dv">3</span>, p_missing<span class="op">=</span><span class="fl">.3</span>, bs<span class="op">=</span><span class="dv">2</span>, dtype<span class="op">=</span>torch.float32, device<span class="op">=</span><span class="st">'cpu'</span>):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> torch.rand(bs, n_obs, n_dim_obs, dtype<span class="op">=</span>dtype, device<span class="op">=</span>device)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> torch.rand(bs, n_obs, n_dim_obs, device<span class="op">=</span>device) <span class="op">&gt;</span> p_missing</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># data[~mask] = torch.nan # ensure that the missing data cannot be used</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data, mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>reset_seed()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>data, mask <span class="op">=</span> get_test_data()</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>show_as_row(data, mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">data</p> <pre>tensor([[[0.9847, 0.0852, 0.5334],
         [0.2196, 0.2617, 0.7972],
         [0.2088, 0.4545, 0.1455],
         [0.2249, 0.7409, 0.2881],
         [0.6578, 0.9087, 0.6871],
         [0.5610, 0.9079, 0.2507],
         [0.7647, 0.7851, 0.0212],
         [0.2230, 0.6513, 0.3955],
         [0.8111, 0.2558, 0.7570],
         [0.3952, 0.8095, 0.3729]],

        [[0.3451, 0.2511, 0.4720],
         [0.6684, 0.1905, 0.1489],
         [0.6714, 0.4719, 0.5053],
         [0.4909, 0.7793, 0.3246],
         [0.1249, 0.1391, 0.5222],
         [0.8191, 0.7040, 0.3264],
         [0.0842, 0.5963, 0.4742],
         [0.9001, 0.3308, 0.7610],
         [0.3228, 0.0961, 0.3075],
         [0.0947, 0.4745, 0.8792]]])</pre> </div><div><p style="font-size: 1.2rem;">mask</p> <pre>tensor([[[ True,  True,  True],
         [False,  True,  True],
         [ True,  True,  True],
         [False, False,  True],
         [False,  True, False],
         [ True,  True,  True],
         [False,  True,  True],
         [False,  True,  True],
         [ True,  True,  True],
         [False, False, False]],

        [[False,  True,  True],
         [ True, False,  True],
         [ True,  True,  True],
         [False,  True,  True],
         [False, False, False],
         [ True,  True,  True],
         [ True, False, False],
         [False,  True,  True],
         [ True,  True,  True],
         [ True,  True, False]]])</pre> </div></div>
</div>
</div>
</section>
</section>
<section id="filter" class="level3">
<h3 class="anchored" data-anchor-id="filter">Filter</h3>
<section id="filter-predict" class="level4">
<h4 class="anchored" data-anchor-id="filter-predict">Filter predict</h4>
<p>Probability of state at time <code>t</code> given state a time <code>t-1</code></p>
<p><span class="math inline">\(p(x_t) = \mathcal{N}(x_t; m_t^-, P_t^-)\)</span> where:</p>
<ul>
<li><p>predicted state mean: <span class="math inline">\(m_t^- = Am_{t-1} + B c_t + b\)</span></p></li>
<li><p>predicted state covariance: <span class="math inline">\(P_t^- = AP_{t-1}A^T + Q\)</span></p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>trans_matrix, trans_cov, trans_off,curr_state_mean,curr_state_cov <span class="op">=</span> (k.trans_matrix, k.trans_cov, k.trans_off,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                                                  torch.stack([k.init_state_mean]<span class="op">*</span><span class="dv">2</span>).unsqueeze(<span class="op">-</span><span class="dv">1</span>),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                                                  torch.stack([k.init_state_cov]<span class="op">*</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>pred_state_mean, pred_state_cov <span class="op">=</span> _filter_predict(trans_matrix, trans_cov, trans_off,curr_state_mean,curr_state_cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>show_as_row(pred_state_mean, pred_state_cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">pred_state_mean</p> <pre>tensor([[[1.7156],
         [0.8884],
         [1.7882],
         [1.9691]],

        [[1.7156],
         [0.8884],
         [1.7882],
         [1.9691]]], dtype=torch.float64, grad_fn=<addbackward0>)</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">pred_state_cov</p> <pre>tensor([[[3.6890, 2.2488, 2.8921, 2.0905],
         [2.2488, 1.6213, 2.2177, 1.4659],
         [2.8921, 2.2177, 3.7130, 2.2235],
         [2.0905, 1.4659, 2.2235, 2.2634]],

        [[3.6890, 2.2488, 2.8921, 2.0905],
         [2.2488, 1.6213, 2.2177, 1.4659],
         [2.8921, 2.2177, 3.7130, 2.2235],
         [2.0905, 1.4659, 2.2235, 2.2634]]], dtype=torch.float64,
       grad_fn=<addbackward0>)</addbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>show_as_row(pred_state_mean.shape, pred_state_cov.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 4, 4])</pre> </div></div>
</div>
</div>
</section>
<section id="filter-correct" class="level4">
<h4 class="anchored" data-anchor-id="filter-correct">Filter correct</h4>
<p>Probability of state at time <code>t</code> given the observations at time <code>t</code></p>
<p><span class="math inline">\(p(x_t|y_t) = \mathcal{N}(x_t; m_t, P_t)\)</span> where:</p>
<ul>
<li><p>predicted obs mean: <span class="math inline">\(z_t = Hm_t^-\)</span></p></li>
<li><p>prediced obs covariance: <span class="math inline">\(S_t = HP_t^-H^T + R\)</span></p></li>
<li><p>kalman gain<span class="math inline">\(K_t = P_t^-H^TS_t^{-1}\)</span></p></li>
<li><p>corrected state mean: <span class="math inline">\(m_t = m_t^- + K_t(y_t - z_t)\)</span></p></li>
<li><p>corrected state covariance: <span class="math inline">\(P_t = (I-K_tH)P_t^-\)</span></p></li>
</ul>
<p>if the observation are missing this step is skipped and the corrected state is equal to the predicted state</p>
<p>Need to figure out the Nans for the gradients …</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>obs_matrix, obs_cov, obs_off,obs, mm <span class="op">=</span> (k.obs_matrix, k.obs_cov, k.obs_off, data[:,<span class="dv">0</span>,:], mask[:,<span class="dv">0</span>,:])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>k_gain, corr_s_mean, corr_s_cov <span class="op">=</span> _filter_correct(obs_matrix, obs_cov, obs_off, pred_state_mean, pred_state_cov, obs, mm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>show_as_row(k_gain, corr_s_mean, corr_s_cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">k_gain</p> <pre>tensor([[[-0.5179, -0.6329,  1.4622],
         [-0.1975, -0.1472,  0.6251],
         [-0.2469,  0.8113, -0.1916],
         [ 0.2169,  1.3353, -1.1003]],

        [[-0.5179, -0.6329,  1.4622],
         [-0.1975, -0.1472,  0.6251],
         [-0.2469,  0.8113, -0.1916],
         [ 0.2169,  1.3353, -1.1003]]], dtype=torch.float64,
       grad_fn=<unsafeviewbackward0>)</unsafeviewbackward0></pre> </div><div><p style="font-size: 1.2rem;">corr_s_mean</p> <pre>tensor([[[-0.1496],
         [-0.3865],
         [-0.5218],
         [ 0.2451]],

        [[ 1.7156],
         [ 0.8884],
         [ 1.7882],
         [ 1.9691]]], dtype=torch.float64, grad_fn=<indexputbackward0>)</indexputbackward0></pre> </div><div><p style="font-size: 1.2rem;">corr_s_cov</p> <pre>tensor([[[ 0.1464, -0.0547, -0.1313,  0.1339],
         [-0.0547,  0.0963,  0.1347,  0.0366],
         [-0.1313,  0.1347,  0.6103, -0.1359],
         [ 0.1339,  0.0366, -0.1359,  0.2661]],

        [[ 3.6890,  2.2488,  2.8921,  2.0905],
         [ 2.2488,  1.6213,  2.2177,  1.4659],
         [ 2.8921,  2.2177,  3.7130,  2.2235],
         [ 2.0905,  1.4659,  2.2235,  2.2634]]], dtype=torch.float64,
       grad_fn=<indexputbackward0>)</indexputbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(<span class="kw">lambda</span> x:x.shape, (k_gain, corr_s_mean, corr_s_cov,)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 4, 3])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 4, 4])</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>test_close(corr_s_mean[<span class="dv">1</span>], pred_state_mean[<span class="dv">1</span>]) <span class="co"># correctly ignoring the missing data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>corr_s_mean.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>) <span class="co"># check that pytorch can compute gradients with the whole batch</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="filter-1" class="level4">
<h4 class="anchored" data-anchor-id="filter-1">Filter</h4>
<p>The resursive version of the kalman filter is apperently breaking pytorch gradients calculations so a workaround is needed. During the loop the states are saved in a python list and then at the end they are combined back into a tensor. The last line of the function does:</p>
<ul>
<li>convert lists to tensors</li>
<li>correct order dimensions</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>obs, init_state_mean, init_state_cov <span class="op">=</span> data, k.init_state_mean, k.init_state_cov</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>pred_state_means, pred_state_covs, filt_state_means, filt_state_covs <span class="op">=</span> _filter(trans_matrix, obs_matrix, trans_cov, obs_cov, trans_off, obs_off, init_state_mean, init_state_cov, data, mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Predictions at time <code>0</code> for both batches</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(Self.shape(), (pred_state_means, pred_state_covs, filt_state_means, filt_state_covs,)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 10, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 10, 4, 4])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 10, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 10, 4, 4])</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(<span class="kw">lambda</span> x:x[<span class="dv">0</span>][<span class="dv">0</span>], (pred_state_means, pred_state_covs, filt_state_means, filt_state_covs,)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>tensor([[0.6902],
        [0.1689],
        [0.6510],
        [0.3037]], dtype=torch.float64, grad_fn=<selectbackward0>)</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>tensor([[0.0129, 0.1095, 0.0325, 0.0494],
        [0.1095, 1.4748, 0.3116, 0.8909],
        [0.0325, 0.3116, 0.3209, 0.1801],
        [0.0494, 0.8909, 0.1801, 0.6017]], dtype=torch.float64,
       grad_fn=<selectbackward0>)</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>tensor([[ 0.5457],
        [-1.2715],
        [ 0.1627],
        [-0.4438]], dtype=torch.float64, grad_fn=<selectbackward0>)</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>tensor([[ 0.0023, -0.0076,  0.0134, -0.0136],
        [-0.0076,  0.0849,  0.0198,  0.1043],
        [ 0.0134,  0.0198,  0.2067, -0.0118],
        [-0.0136,  0.1043, -0.0118,  0.1410]], dtype=torch.float64,
       grad_fn=<selectbackward0>)</selectbackward0></pre> </div></div>
</div>
</div>
</section>
<section id="kalmanfilter-method" class="level4">
<h4 class="anchored" data-anchor-id="kalmanfilter-method">KalmanFilter method</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>pred_mean, _, _, _ <span class="op">=</span> k._filter_all(obs)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>pred_mean.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>) <span class="co"># it works!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The filter methods wraps <code>_filter_all</code> but in addition:</p>
<ul>
<li>returns only filtered state</li>
<li>detach tensors</li>
</ul>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L236" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="kalmanfilter.filter" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.filter">KalmanFilter.filter</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.filter (obs:torch.Tensor, mask=None,
                      cov_checker=&lt;meteo_imp.gaussian.CheckPosDef object
                      at 0x7fb874aa8280&gt;)</code></pre>
</blockquote>
<p>Filter observation</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>obs</td>
<td>Tensor</td>
<td></td>
<td>[n_timesteps, n_dim_obs] obs for times [0…n_timesteps-1]</td>
</tr>
<tr class="even">
<td>mask</td>
<td>NoneType</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>cov_checker</td>
<td>CheckPosDef</td>
<td>&lt;meteo_imp.gaussian.CheckPosDef object at 0x7fb874aa8280&gt;</td>
<td></td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ListMultiNormal</strong></td>
<td></td>
<td><strong>Filtered state</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>filt <span class="op">=</span> k.<span class="bu">filter</span>(obs)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>filt.mean.shape, filt.cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 10, 4]), torch.Size([2, 10, 4, 4]))</code></pre>
</div>
</div>
</section>
<section id="smooth" class="level3">
<h3 class="anchored" data-anchor-id="smooth">Smooth</h3>
<section id="smooth-step" class="level4">
<h4 class="anchored" data-anchor-id="smooth-step">Smooth step</h4>
<p>compute the probability of the state at time <code>t</code> given all the observations</p>
<p><span class="math inline">\(p(x_t|Y) = \mathcal{N}(x_t; m_t^s, P_t^s)\)</span> where:</p>
<ul>
<li>Kalman smoothing gain: <span class="math inline">\(G_t = P_tA^T(P_{t+1}^-)^{-1}\)</span></li>
<li>smoothed mean: <span class="math inline">\(m_t^s = m_t + G_t(m_{t+1}^s - m_{t+1}^-)\)</span></li>
<li>smoothed covariance: <span class="math inline">\(P_t^s = P_t + G_t(P_t{t+1}^s - P_t{t+1}^-)G_t^T\)</span></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>filt_state, pred_state, next_smoothed_state <span class="op">=</span> [MNormal(pred_state_mean, pred_state_cov)] <span class="op">*</span> <span class="dv">3</span> <span class="co"># just for testing</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span>_smooth_update(trans_matrix, MNormal(pred_state_mean, pred_state_cov), MNormal(pred_state_mean, pred_state_cov), MNormal(pred_state_mean, pred_state_cov)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>tensor([[[1.7156],
         [0.8884],
         [1.7882],
         [1.9691]],

        [[1.7156],
         [0.8884],
         [1.7882],
         [1.9691]]], dtype=torch.float64, grad_fn=<addbackward0>)</addbackward0></pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>tensor([[[3.6890, 2.2488, 2.8921, 2.0905],
         [2.2488, 1.6213, 2.2177, 1.4659],
         [2.8921, 2.2177, 3.7130, 2.2235],
         [2.0905, 1.4659, 2.2235, 2.2634]],

        [[3.6890, 2.2488, 2.8921, 2.0905],
         [2.2488, 1.6213, 2.2177, 1.4659],
         [2.8921, 2.2177, 3.7130, 2.2235],
         [2.0905, 1.4659, 2.2235, 2.2634]]], dtype=torch.float64,
       grad_fn=<addbackward0>)</addbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(Self.shape(), _smooth_update(trans_matrix, MNormal(pred_state_mean, pred_state_cov), MNormal(pred_state_mean, pred_state_cov), MNormal(pred_state_mean, pred_state_cov))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 4, 4])</pre> </div></div>
</div>
</div>
</section>
<section id="smooth-1" class="level4">
<h4 class="anchored" data-anchor-id="smooth-1">Smooth</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>(pred_state_means, pred_state_covs, filt_state_means, filt_state_covs ) <span class="op">=</span> k._filter_all(data)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>filt_state, pred_state <span class="op">=</span> ListMNormal(filt_state_means, filt_state_covs), ListMNormal(pred_state_means, pred_state_covs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>smooth_state <span class="op">=</span> _smooth(k.trans_matrix,  filt_state, pred_state)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smooth_state.mean[<span class="dv">0</span>][<span class="dv">0</span>], smooth_state.cov[<span class="dv">0</span>][<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>tensor([[ 0.5047],
        [-1.0737],
        [-0.0703],
        [-0.1412]], dtype=torch.float64, grad_fn=<selectbackward0>)</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>tensor([[ 0.0017, -0.0032,  0.0111, -0.0074],
        [-0.0032,  0.0434,  0.0160,  0.0511],
        [ 0.0111,  0.0160,  0.1722, -0.0100],
        [-0.0074,  0.0511, -0.0100,  0.0716]], dtype=torch.float64,
       grad_fn=<selectbackward0>)</selectbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smooth_state.mean.shape, smooth_state.cov.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 10, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 10, 4, 4])</pre> </div></div>
</div>
</div>
</section>
<section id="kalmanfilter-method-1" class="level4">
<h4 class="anchored" data-anchor-id="kalmanfilter-method-1">KalmanFilter method</h4>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L293" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="kalmanfilter.smooth" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.smooth">KalmanFilter.smooth</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.smooth (obs:torch.Tensor, mask:torch.Tensor=None,
                      cov_checker=&lt;meteo_imp.gaussian.CheckPosDef object
                      at 0x7fb874a9e290&gt;)</code></pre>
</blockquote>
<p>Kalman Filter Smoothing</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>obs</td>
<td>Tensor</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>mask</td>
<td>Tensor</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>cov_checker</td>
<td>CheckPosDef</td>
<td>&lt;meteo_imp.gaussian.CheckPosDef object at 0x7fb874a9e290&gt;</td>
<td></td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ListMultiNormal</strong></td>
<td></td>
<td><strong><code>[n_timesteps, n_dim_state]</code> smoothed state</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>smoothed_state <span class="op">=</span> k.smooth(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smoothed_state.mean.shape, smoothed_state.cov.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 10, 4])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 10, 4, 4])</pre> </div></div>
</div>
</div>
</section>
<section id="predict" class="level3">
<h3 class="anchored" data-anchor-id="predict">Predict</h3>
<p>In order to have conditional predictions that make sense it’s not possible to return the full covariance matrix for the predictions but only the standard deviations</p>
<p>This add the supports for conditional predictions, which means that at the time (t) when we are making the predictions some of the variables have been actually observed. Since the model prediction is a normal distribution we can condition on the observed values and thus improve the predictions. See <code>conditional_gaussian</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>test_m <span class="op">=</span> torch.tensor(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    [[<span class="va">True</span>, <span class="va">True</span>, <span class="va">True</span>,],</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    [<span class="va">False</span>, <span class="va">True</span>, <span class="va">True</span>],</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    [<span class="va">False</span>, <span class="va">False</span>, <span class="va">False</span>]]</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>torch.logical_xor(test_m.<span class="bu">all</span>(<span class="op">-</span><span class="dv">1</span>), test_m.<span class="bu">any</span>(<span class="op">-</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([False,  True, False])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> torch.rand(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>(A <span class="op">@</span> A).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 2, 3, 3])</code></pre>
</div>
</div>
<p>predict can be vectorized across both the batch and the timesteps, except for timesteps that require conditional predictions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>pred_obs0 <span class="op">=</span> k._obs_from_state(smoothed_state)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>pred_obs0.mean.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>mask[:,<span class="dv">0</span>,].<span class="bu">all</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([ True, False])</code></pre>
</div>
</div>
<p>The conditional gaussian returns a distributions of 2 variables, which are the un-observed ones (you can see the <code>nan</code> in the observation vector)</p>
<p>which are correctly merged with the predictions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict(<span class="va">self</span>: KalmanFilter, obs, mask<span class="op">=</span><span class="va">None</span>, smooth<span class="op">=</span><span class="va">True</span>, cov_checker<span class="op">=</span>CheckPosDef()):</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Predicted observations at all times """</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    state <span class="op">=</span> <span class="va">self</span>.smooth(obs, mask, cov_checker) <span class="cf">if</span> smooth <span class="cf">else</span> <span class="va">self</span>.<span class="bu">filter</span>(obs, mask, cov_checker)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    obs, mask <span class="op">=</span> <span class="va">self</span>._parse_obs(obs, mask)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    pred_obs <span class="op">=</span> <span class="va">self</span>._obs_from_state(state, cov_checker)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># conditional predictions are slow, do only if some obs are missing </span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    cond_mask <span class="op">=</span> torch.logical_xor(mask.<span class="bu">all</span>(<span class="op">-</span><span class="dv">1</span>), mask.<span class="bu">any</span>(<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this cannot be batched so returns a list</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    cond_preds <span class="op">=</span> cond_gaussian_batched(</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>        pred_obs[cond_mask], obs[cond_mask], mask[cond_mask])</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    pred_mean, pred_std <span class="op">=</span> pred_obs.mean, cov2std(pred_obs.cov) <span class="co"># multiple [] still not properly implemented in ListMNormal</span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, c_pred <span class="kw">in</span> <span class="bu">enumerate</span>(cond_preds):</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> <span class="op">~</span>mask[cond_mask][i]</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>        pred_mean[cond_mask][i][m] <span class="op">=</span> c_pred.mean</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>        pred_std [cond_mask][i][m] <span class="op">=</span> cov2std(c_pred.cov)</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pred_obs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>k.predict(data).mean.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>k.obs_cov_raw.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[-67.9787,   0.0000,   0.0000],
        [-62.8064, -93.6840,   0.0000],
        [-41.3730, 319.4476,  41.3510]], dtype=torch.float64)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>k.trans_matrix.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[ -2.9769,   3.1292, -17.9998,   3.6923],
        [-13.8292,  -5.6540, -23.5754,  -3.6446],
        [  6.3412, -25.5594,   3.6237,  23.8952],
        [  4.1132, -14.1557,  -0.6216,  15.7403]], dtype=torch.float64)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>data[<span class="op">~</span>mask] <span class="op">=</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[[0.9847, 0.0852, 0.5334],
         [0.0000, 0.2617, 0.7972],
         [0.2088, 0.4545, 0.1455],
         [0.0000, 0.0000, 0.2881],
         [0.0000, 0.9087, 0.0000],
         [0.5610, 0.9079, 0.2507],
         [0.0000, 0.7851, 0.0212],
         [0.0000, 0.6513, 0.3955],
         [0.8111, 0.2558, 0.7570],
         [0.0000, 0.0000, 0.0000]],

        [[0.0000, 0.2511, 0.4720],
         [0.6684, 0.0000, 0.1489],
         [0.6714, 0.4719, 0.5053],
         [0.0000, 0.7793, 0.3246],
         [0.0000, 0.0000, 0.0000],
         [0.8191, 0.7040, 0.3264],
         [0.0842, 0.0000, 0.0000],
         [0.0000, 0.3308, 0.7610],
         [0.3228, 0.0961, 0.3075],
         [0.0947, 0.4745, 0.0000]]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>k.cpu()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Kalman Filter
        N dim obs: 3, N dim state: 4</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>k.predict(data, mask).mean.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(k.obs_cov_raw.grad)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>k.zero_grad()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tensor([[-89.1758,   0.0000,   0.0000],
        [-70.6291, -90.3979,   0.0000],
        [-82.8921, 388.4809,  47.4202]], dtype=torch.float64)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_times(<span class="va">self</span>: KalmanFilter, times, obs, mask<span class="op">=</span><span class="va">None</span>, smooth<span class="op">=</span><span class="va">True</span>, check_args<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Predicted observations at specific times """</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    state <span class="op">=</span> <span class="va">self</span>.smooth(obs, mask, check_args) <span class="cf">if</span> smooth <span class="cf">else</span> <span class="va">self</span>.<span class="bu">filter</span>(obs, mask, check_args)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    obs, mask <span class="op">=</span> <span class="va">self</span>._parse_obs(obs, mask)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    times <span class="op">=</span> array1d(times)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>    n_timesteps <span class="op">=</span> obs.shape[<span class="dv">0</span>]</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    n_features <span class="op">=</span> obs.shape[<span class="dv">1</span>] <span class="cf">if</span> <span class="bu">len</span>(obs.shape) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> times.<span class="bu">max</span>() <span class="op">&gt;</span> n_timesteps <span class="kw">or</span> times.<span class="bu">min</span>() <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"provided times range from </span><span class="sc">{</span>times<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>times<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">, which is outside allowed range : 0 to </span><span class="sc">{</span>n_timesteps<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>    means <span class="op">=</span> torch.empty((times.shape[<span class="dv">0</span>], n_features), dtype<span class="op">=</span>obs.dtype, device<span class="op">=</span>obs.device)</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>    stds <span class="op">=</span> torch.empty((times.shape[<span class="dv">0</span>], n_features), dtype<span class="op">=</span>obs.dtype, device<span class="op">=</span>obs.device) </span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, t <span class="kw">in</span> <span class="bu">enumerate</span>(times):</span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>        mean, std <span class="op">=</span> <span class="va">self</span>._obs_from_state(</span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>            state.mean[t],</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>            state.cov[t],</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'t'</span>: t, <span class="op">**</span>check_args} <span class="cf">if</span> check_args <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>        means[i], stds[i] <span class="op">=</span> _get_cond_pred(ListNormal(mean, std), obs[t], mask[t])</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ListNormal(means, stds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="constructor-additional" class="level2">
<h2 class="anchored" data-anchor-id="constructor-additional">Constructor Additional</h2>
<section id="simple-parameters" class="level4">
<h4 class="anchored" data-anchor-id="simple-parameters">Simple parameters</h4>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L350" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter.init_simple" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.init_simple">KalmanFilter.init_simple</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.init_simple (n_dim, dtype=torch.float32)</code></pre>
</blockquote>
<p>Simplest version of kalman filter parameters</p>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>n_dim</td>
<td></td>
<td></td>
<td>n_dim_obs and n_dim_state</td>
</tr>
<tr class="even">
<td>dtype</td>
<td>dtype</td>
<td>torch.float32</td>
<td></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>KalmanFilter.init_simple(<span class="dv">2</span>).state_dict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>OrderedDict([('trans_matrix',
              tensor([[1., 0.],
                      [0., 1.]])),
             ('trans_off', tensor([0., 0.])),
             ('trans_cov_raw',
              tensor([[1., 0.],
                      [0., 1.]])),
             ('obs_matrix',
              tensor([[1., 0.],
                      [0., 1.]])),
             ('obs_off', tensor([0., 0.])),
             ('obs_cov_raw',
              tensor([[1., 0.],
                      [0., 1.]])),
             ('init_state_mean', tensor([0., 0.])),
             ('init_state_cov_raw',
              tensor([[1., 0.],
                      [0., 1.]]))])</code></pre>
</div>
</div>
<section id="local-slope" class="level4">
<h4 class="anchored" data-anchor-id="local-slope">Local slope</h4>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L367" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="kalmanfilter.init_local_slope" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.init_local_slope">KalmanFilter.init_local_slope</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.init_local_slope (n_dim, dtype=torch.float32)</code></pre>
</blockquote>
<p>Simplest version of kalman filter parameters</p>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>n_dim</td>
<td></td>
<td></td>
<td>n_dim_obs and n_dim_state</td>
</tr>
<tr class="even">
<td>dtype</td>
<td>dtype</td>
<td>torch.float32</td>
<td></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>KalmanFilter.init_simple(<span class="dv">2</span>).state_dict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>OrderedDict([('trans_matrix',
              tensor([[1., 0.],
                      [0., 1.]])),
             ('trans_off', tensor([0., 0.])),
             ('trans_cov_raw',
              tensor([[1., 0.],
                      [0., 1.]])),
             ('obs_matrix',
              tensor([[1., 0.],
                      [0., 1.]])),
             ('obs_off', tensor([0., 0.])),
             ('obs_cov_raw',
              tensor([[1., 0.],
                      [0., 1.]])),
             ('init_state_mean', tensor([0., 0.])),
             ('init_state_cov_raw',
              tensor([[1., 0.],
                      [0., 1.]]))])</code></pre>
</div>
</div>
</section>
</section>
<section id="performance" class="level2">
<h2 class="anchored" data-anchor-id="performance">Performance</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>reset_seed(<span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>kf_cuda <span class="op">=</span> KalmanFilter.init_random(<span class="dv">2</span>,<span class="dv">2</span>).cuda()</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>data_cuda, mask_cuda <span class="op">=</span> get_test_data(<span class="dv">200</span>,<span class="dv">2</span>, bs<span class="op">=</span><span class="dv">200</span>, device<span class="op">=</span><span class="st">"cuda"</span> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>19.1 s ± 0 ns per loop (mean ± std. dev. of 1 run, 1 loop each)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>kf <span class="op">=</span> KalmanFilter.init_random(<span class="dv">2</span>,<span class="dv">2</span>)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>data, mask <span class="op">=</span> get_test_data(<span class="dv">100</span>,<span class="dv">2</span>, bs<span class="op">=</span><span class="dv">200</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>8.21 s ± 0 ns per loop (mean ± std. dev. of 1 run, 1 loop each)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># old method</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>17.2 s ± 0 ns per loop (mean ± std. dev. of 1 run, 1 loop each)</code></pre>
</div>
</div>
</section>
<section id="export" class="level2">
<h2 class="anchored" data-anchor-id="export">Export</h2>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>