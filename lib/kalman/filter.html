<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.280">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend">

<title>meteo_imp - Kalman Filter</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="meteo_imp - Kalman Filter">
<meta property="og:description" content="Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend">
<meta property="og:site-name" content="meteo_imp">
<meta name="twitter:title" content="meteo_imp - Kalman Filter">
<meta name="twitter:description" content="Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">meteo_imp</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Kalman Filter</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">GPFA Imputation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../data_preparation.html" class="sidebar-item-text sidebar-link">Data Preparation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../results.html" class="sidebar-item-text sidebar-link">Results</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../simplegp_imputation.html" class="sidebar-item-text sidebar-link">Simple GP Imputation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gaussian.html" class="sidebar-item-text sidebar-link">Gaussian Distributions Utilities</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../utils.html" class="sidebar-item-text sidebar-link">Utils</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Fluxnet</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Fluxnet/gap_finder.html" class="sidebar-item-text sidebar-link">Find Gaps in Fluxnet data</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Fluxnet/hainich.html" class="sidebar-item-text sidebar-link">Fluxnet Hainich</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">GPFA</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../GPFA/gpfa.html" class="sidebar-item-text sidebar-link">Gaussian Processes Factor Analysis</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../GPFA/learner.html" class="sidebar-item-text sidebar-link">GPFA Learner</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../GPFA/imputation.html" class="sidebar-item-text sidebar-link">Imputation time series</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">kalman</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/filter.html" class="sidebar-item-text sidebar-link active">Kalman Filter</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/test_filter_pykalman.html" class="sidebar-item-text sidebar-link">Testing Kalman Filter</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/fastai.html" class="sidebar-item-text sidebar-link">Implement Kalman model using FastAI</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/learner.html" class="sidebar-item-text sidebar-link">Kalman Filter Models</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/imputation.html" class="sidebar-item-text sidebar-link">Imputation Kalman Model</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/old statsmodels - statespace.html" class="sidebar-item-text sidebar-link">[Not Working] StatsModels Kalman filter</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/old_01_pykalman_models.html" class="sidebar-item-text sidebar-link">[OLD] PyKalman Filter Models</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/old_02_pykalman_imputation.html" class="sidebar-item-text sidebar-link">[OLD] Imputation PyKalman Model</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#utils" id="toc-utils" class="nav-link" data-scroll-target="#utils">Utils</a></li>
  <li><a href="#positive-definite-constraint" id="toc-positive-definite-constraint" class="nav-link" data-scroll-target="#positive-definite-constraint">Positive Definite Constraint</a></li>
  <li><a href="#is_symmetric" id="toc-is_symmetric" class="nav-link" data-scroll-target="#is_symmetric">is_symmetric</a></li>
  <li><a href="#symmetric_upto" id="toc-symmetric_upto" class="nav-link" data-scroll-target="#symmetric_upto">symmetric_upto</a></li>
  <li><a href="#is_posdef" id="toc-is_posdef" class="nav-link" data-scroll-target="#is_posdef">is_posdef</a></li>
  <li><a href="#is_posdef_eigv" id="toc-is_posdef_eigv" class="nav-link" data-scroll-target="#is_posdef_eigv">is_posdef_eigv</a></li>
  <li><a href="#posdef" id="toc-posdef" class="nav-link" data-scroll-target="#posdef">PosDef</a></li>
  <li><a href="#checkposdef" id="toc-checkposdef" class="nav-link" data-scroll-target="#checkposdef">CheckPosDef</a></li>
  </ul></li>
  <li><a href="#kalmanfilter" id="toc-kalmanfilter" class="nav-link" data-scroll-target="#kalmanfilter">KalmanFilter</a>
  <ul class="collapse">
  <li><a href="#main-class" id="toc-main-class" class="nav-link" data-scroll-target="#main-class">Main class</a></li>
  <li><a href="#kalmanfilter-1" id="toc-kalmanfilter-1" class="nav-link" data-scroll-target="#kalmanfilter-1">KalmanFilter</a></li>
  <li><a href="#constructors" id="toc-constructors" class="nav-link" data-scroll-target="#constructors">Constructors</a></li>
  <li><a href="#test-data" id="toc-test-data" class="nav-link" data-scroll-target="#test-data">Test data</a></li>
  <li><a href="#filter" id="toc-filter" class="nav-link" data-scroll-target="#filter">Filter</a></li>
  <li><a href="#smooth" id="toc-smooth" class="nav-link" data-scroll-target="#smooth">Smooth</a></li>
  <li><a href="#kalmanfilter.smooth" id="toc-kalmanfilter.smooth" class="nav-link" data-scroll-target="#kalmanfilter.smooth">KalmanFilter.smooth</a></li>
  <li><a href="#predict" id="toc-predict" class="nav-link" data-scroll-target="#predict">Predict</a></li>
  <li><a href="#kalmanfilter.predict" id="toc-kalmanfilter.predict" class="nav-link" data-scroll-target="#kalmanfilter.predict">KalmanFilter.predict</a></li>
  <li><a href="#log-likelihood" id="toc-log-likelihood" class="nav-link" data-scroll-target="#log-likelihood">Log Likelihood</a></li>
  <li><a href="#kalmanfilter.filter_loglikelihood" id="toc-kalmanfilter.filter_loglikelihood" class="nav-link" data-scroll-target="#kalmanfilter.filter_loglikelihood">KalmanFilter.filter_loglikelihood</a></li>
  <li><a href="#kalmanfilter.loglikelihood" id="toc-kalmanfilter.loglikelihood" class="nav-link" data-scroll-target="#kalmanfilter.loglikelihood">KalmanFilter.loglikelihood</a></li>
  <li><a href="#get-info" id="toc-get-info" class="nav-link" data-scroll-target="#get-info">Get Info</a></li>
  <li><a href="#kalmanfilter.get_info" id="toc-kalmanfilter.get_info" class="nav-link" data-scroll-target="#kalmanfilter.get_info">KalmanFilter.get_info</a></li>
  </ul></li>
  <li><a href="#train-parameters" id="toc-train-parameters" class="nav-link" data-scroll-target="#train-parameters">Train Parameters</a></li>
  <li><a href="#other" id="toc-other" class="nav-link" data-scroll-target="#other">Other</a>
  <ul class="collapse">
  <li><a href="#testing" id="toc-testing" class="nav-link" data-scroll-target="#testing">Testing</a></li>
  <li><a href="#fuzzing-smoother" id="toc-fuzzing-smoother" class="nav-link" data-scroll-target="#fuzzing-smoother">Fuzzing smoother</a></li>
  <li><a href="#compare-statsmodels" id="toc-compare-statsmodels" class="nav-link" data-scroll-target="#compare-statsmodels">Compare Statsmodels</a></li>
  </ul></li>
  <li><a href="#export" id="toc-export" class="nav-link" data-scroll-target="#export">Export</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/mone27/meteo_imp/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Kalman Filter</h1>
</div>

<div>
  <div class="description">
    Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The autoreload extension is already loaded. To reload it, use:
  %reload_ext autoreload</code></pre>
</div>
</div>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<section id="utils" class="level3">
<h3 class="anchored" data-anchor-id="utils">Utils</h3>
</section>
<section id="positive-definite-constraint" class="level3">
<h3 class="anchored" data-anchor-id="positive-definite-constraint">Positive Definite Constraint</h3>
<p>The covariance matrices need to be <a href="https://en.wikipedia.org/wiki/Definite_matrix">positive definite</a> Those are utilities functions to check is a matrix is positive definite and to make any matrix positive definite</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> torch.rand(<span class="dv">3</span>,<span class="dv">3</span>) <span class="co"># random matrix used for testing</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="symmetry" class="level4">
<h4 class="anchored" data-anchor-id="symmetry">Symmetry</h4>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L101" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="is_symmetric" class="level3">
<h3 class="anchored" data-anchor-id="is_symmetric">is_symmetric</h3>
<blockquote class="blockquote">
<pre><code> is_symmetric (value, atol=1e-05)</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>is_symmetric(A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>False</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L105" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="symmetric_upto" class="level3">
<h3 class="anchored" data-anchor-id="symmetric_upto">symmetric_upto</h3>
<blockquote class="blockquote">
<pre><code> symmetric_upto (value, start=-8)</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>symmetric_upto(A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>0</code></pre>
</div>
</div>
<section id="is-posdef" class="level4">
<h4 class="anchored" data-anchor-id="is-posdef">is posdef</h4>
<p>Default pytorch check (uses symmetry + cholesky decomposition)</p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L112" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="is_posdef" class="level3">
<h3 class="anchored" data-anchor-id="is_posdef">is_posdef</h3>
<blockquote class="blockquote">
<pre><code> is_posdef (cov)</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>is_posdef(A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>False</code></pre>
</div>
</div>
<p>check if it is pos definite using eigenvalues. Positive definite matrix have all positive eigenvalues</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>torch.linalg.eigvalsh(A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([-0.5442,  0.1242,  0.9816])</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L116" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="is_posdef_eigv" class="level3">
<h3 class="anchored" data-anchor-id="is_posdef_eigv">is_posdef_eigv</h3>
<blockquote class="blockquote">
<pre><code> is_posdef_eigv (cov)</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>is_posdef_eigv(A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(False, tensor([-0.5442,  0.1242,  0.9816]))</code></pre>
</div>
</div>
<p>Note that <a href="https://mone27.github.io/meteo_imp/lib/kalman/filter.html#is_posdef"><code>is_posdef</code></a> and <a href="https://mone27.github.io/meteo_imp/lib/kalman/filter.html#is_posdef_eigv"><code>is_posdef_eigv</code></a> can return different values, in general <a href="https://mone27.github.io/meteo_imp/lib/kalman/filter.html#is_posdef_eigv"><code>is_posdef_eigv</code></a> is more tollerant</p>
<p>transform any matrix <span class="math inline">\(A\)</span> into a positive definite matrix (<span class="math inline">\(PD\)</span>) using the following formula</p>
<p><span class="math inline">\(PD = CC^T\)</span> where <span class="math inline">\(C\)</span> is the lower triangular matrix of <span class="math inline">\(A\)</span></p>
<p>the inverse transformation uses cholesky decomposition</p>
<p>The API inspired by gpytorch constraints</p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L123" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="posdef" class="level3">
<h3 class="anchored" data-anchor-id="posdef">PosDef</h3>
<blockquote class="blockquote">
<pre><code> PosDef ()</code></pre>
</blockquote>
<p>Positive Definite Constraint for PyTorch parameters</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>constraint <span class="op">=</span> PosDef()</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>posdef <span class="op">=</span> constraint.transform(A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>A</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[0.3427, 0.1567, 0.1184],
        [0.3918, 0.2086, 0.9520],
        [0.1444, 0.6186, 0.0103]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>posdef</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[0.1175, 0.1343, 0.0495],
        [0.1343, 0.1970, 0.1857],
        [0.0495, 0.1857, 0.4037]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>test_eq(is_posdef(posdef), <span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>constraint.inverse_transform(posdef)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[0.3427, 0.0000, 0.0000],
        [0.3918, 0.2086, 0.0000],
        [0.1444, 0.6186, 0.0103]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>test_close(posdef, constraint.transform(constraint.inverse_transform(posdef)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>is_symmetric(posdef)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>True</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>symmetric_upto(posdef)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>-8</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>is_posdef_eigv(posdef)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(True, tensor([5.6563e-06, 1.7525e-01, 5.4292e-01]))</code></pre>
</div>
</div>
<section id="check-pos-def" class="level4">
<h4 class="anchored" data-anchor-id="check-pos-def">Check pos def</h4>
<p>This is to help finding matrices that aren’t positive definite and debug the issues. Returns a detailed dataframe row with info about the matrix and optionally logs everything to a global object</p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L144" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="checkposdef" class="level3">
<h3 class="anchored" data-anchor-id="checkposdef">CheckPosDef</h3>
<blockquote class="blockquote">
<pre><code> CheckPosDef (do_check:bool=False, use_log:bool=True, warning:bool=True)</code></pre>
</blockquote>
<p>Initialize self. See help(type(self)) for accurate signature.</p>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>do_check</td>
<td>bool</td>
<td>False</td>
<td>set to True to actually check matrix</td>
</tr>
<tr class="even">
<td>use_log</td>
<td>bool</td>
<td>True</td>
<td>keep internal log</td>
</tr>
<tr class="odd">
<td>warning</td>
<td>bool</td>
<td>True</td>
<td>show a warning if a matrix is not pos def</td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>CheckPosDef(<span class="va">True</span>).check(A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_16010/838933125.py:29: UserWarning: Matrix is not positive definite
  warn("Matrix is not positive definite")</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>is_pd_eigv</th>
      <th>is_pd_chol</th>
      <th>is_sym</th>
      <th>sym_upto</th>
      <th>eigv</th>
      <th>matrix</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>0</td>
      <td>[-0.5442282, 0.12421053, 0.9816487]</td>
      <td>[[0.34273952, 0.1567195, 0.11838853], [0.39177...</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>checker <span class="op">=</span> CheckPosDef(<span class="va">True</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>checker.check(A, my_arg<span class="op">=</span><span class="st">"my arg"</span>) <span class="co"># this will be another col in the log</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_16010/838933125.py:29: UserWarning: Matrix is not positive definite
  warn("Matrix is not positive definite")</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>is_pd_eigv</th>
      <th>is_pd_chol</th>
      <th>is_sym</th>
      <th>sym_upto</th>
      <th>eigv</th>
      <th>matrix</th>
      <th>my_arg</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>0</td>
      <td>[-0.5442282, 0.12421053, 0.9816487]</td>
      <td>[[0.34273952, 0.1567195, 0.11838853], [0.39177...</td>
      <td>my arg</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>checker.log</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>is_pd_eigv</th>
      <th>is_pd_chol</th>
      <th>is_sym</th>
      <th>sym_upto</th>
      <th>eigv</th>
      <th>matrix</th>
      <th>my_arg</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>0</td>
      <td>[-0.5442282, 0.12421053, 0.9816487]</td>
      <td>[[0.34273952, 0.1567195, 0.11838853], [0.39177...</td>
      <td>my arg</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>checker.add_args(show<span class="op">=</span><span class="st">"only once"</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>checker.check(posdef)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>checker.check(A)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>checker.log</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_16010/838933125.py:29: UserWarning: Matrix is not positive definite
  warn("Matrix is not positive definite")</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>is_pd_eigv</th>
      <th>is_pd_chol</th>
      <th>is_sym</th>
      <th>sym_upto</th>
      <th>eigv</th>
      <th>matrix</th>
      <th>my_arg</th>
      <th>show</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>0</td>
      <td>[-0.5442282, 0.12421053, 0.9816487]</td>
      <td>[[0.34273952, 0.1567195, 0.11838853], [0.39177...</td>
      <td>my arg</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>0</th>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>-8</td>
      <td>[5.6563063e-06, 0.17524819, 0.5429207]</td>
      <td>[[0.11747038, 0.13427578, 0.04950164], [0.1342...</td>
      <td>NaN</td>
      <td>only once</td>
    </tr>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>0</td>
      <td>[-0.5442282, 0.12421053, 0.9816487]</td>
      <td>[[0.34273952, 0.1567195, 0.11838853], [0.39177...</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>B <span class="op">=</span> torch.rand(<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>) <span class="co"># a batch of matrices</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>checker.check(B)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_16010/838933125.py:29: UserWarning: Matrix is not positive definite
  warn("Matrix is not positive definite")</code></pre>
</div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>is_pd_eigv</th>
      <th>is_pd_chol</th>
      <th>is_sym</th>
      <th>sym_upto</th>
      <th>eigv</th>
      <th>matrix</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>0</td>
      <td>[-0.6299121, 0.10874571, 1.2889841]</td>
      <td>[[0.27296227, 0.2163598, 0.11539459], [0.09705...</td>
    </tr>
    <tr>
      <th>0</th>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>0</td>
      <td>[0.17793366, 0.627806, 1.3450105]</td>
      <td>[[0.75479823, 0.50660074, 0.55367833], [0.4830...</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>test_close(B[<span class="dv">0</span>] <span class="op">@</span> A, (B <span class="op">@</span> A)[<span class="dv">0</span>]) <span class="co"># example batched matrix multiplication</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="kalmanfilter" class="level2">
<h2 class="anchored" data-anchor-id="kalmanfilter">KalmanFilter</h2>
<p>The Kalman Filter is an algorithm designed to estimate <span class="math inline">\(P(x_t | y_{0:t})\)</span>. As all state transitions and obss are linear with Gaussian distributed noise, these distributions can be represented exactly as Gaussian distributions with mean <code>filt_state_means[t]</code> and covs <code>filt_state_covs[t]</code>. Similarly, the Kalman Smoother is an algorithm designed to estimate <span class="math inline">\(P(x_t | y_{0:T-1})\)</span></p>
<section id="main-class" class="level3">
<h3 class="anchored" data-anchor-id="main-class">Main class</h3>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L201" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter-1" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter-1">KalmanFilter</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter (trans_matrix:torch.Tensor, obs_matrix:torch.Tensor,
               trans_cov:torch.Tensor, obs_cov:torch.Tensor,
               trans_off:torch.Tensor, obs_off:torch.Tensor,
               init_state_mean:torch.Tensor, init_state_cov:torch.Tensor,
               n_dim_state:int=None, n_dim_obs:int=None,
               cov_checker:__main__.CheckPosDef=&lt;__main__.CheckPosDef
               object at 0x7fe1e1607400&gt;)</code></pre>
</blockquote>
<p>Kalman Filter and Smoother using PyTorch</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>trans_matrix</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state,n_dim_state] <span class="math inline">\(A\)</span>, state transition matrix</td>
</tr>
<tr class="even">
<td>obs_matrix</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_state] <span class="math inline">\(H\)</span>, observation matrix</td>
</tr>
<tr class="odd">
<td>trans_cov</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(Q\)</span>, state trans covariance matrix</td>
</tr>
<tr class="even">
<td>obs_cov</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_obs] <span class="math inline">\(R\)</span>, observations covariance matrix</td>
</tr>
<tr class="odd">
<td>trans_off</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(b\)</span>, state transition offset</td>
</tr>
<tr class="even">
<td>obs_off</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs] <span class="math inline">\(d\)</span>, observations offset</td>
</tr>
<tr class="odd">
<td>init_state_mean</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(\mu_0"\)</span></td>
</tr>
<tr class="even">
<td>init_state_cov</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(\Sigma_0\)</span></td>
</tr>
<tr class="odd">
<td>n_dim_state</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for state - defaults to 1 if cannot be infered from parameters</td>
</tr>
<tr class="even">
<td>n_dim_obs</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for observations - defaults to 1 if cannot be infered from parameters</td>
</tr>
<tr class="odd">
<td>cov_checker</td>
<td>CheckPosDef</td>
<td>&lt;<strong>main</strong>.CheckPosDef object at 0x7fe1e1607400&gt;</td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="constructors" class="level3">
<h3 class="anchored" data-anchor-id="constructors">Constructors</h3>
<p>Giving all the parameters manually to the <a href="https://mone27.github.io/meteo_imp/lib/kalman/filter.html#kalmanfilter"><code>KalmanFilter</code></a> init method is not convenient, hence we are having some methods that help initize the class</p>
<section id="random-parameters" class="level4">
<h4 class="anchored" data-anchor-id="random-parameters">Random parameters</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span>(cls_method<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> init_random(cls: KalmanFilter, n_dim_obs, n_dim_state, dtype<span class="op">=</span>torch.float32):</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""kalman filter with random parameters"""</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> {</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'trans_matrix'</span>:    torch.rand(n_dim_state, n_dim_state, dtype<span class="op">=</span>dtype),</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'trans_off'</span>:       torch.rand(n_dim_state, dtype<span class="op">=</span>dtype),        </span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'trans_cov'</span>:       to_posdef(torch.rand(n_dim_state, n_dim_state, dtype<span class="op">=</span>dtype)),        </span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'obs_matrix'</span>:      torch.rand(n_dim_obs, n_dim_state, dtype<span class="op">=</span>dtype),</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'obs_off'</span>:         torch.rand(n_dim_obs, dtype<span class="op">=</span>dtype),          </span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'obs_cov'</span>:         to_posdef(torch.rand(n_dim_obs, n_dim_obs, dtype<span class="op">=</span>dtype)),            </span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'init_state_mean'</span>: torch.rand(n_dim_state, dtype<span class="op">=</span>dtype),        </span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'init_state_cov'</span>:  to_posdef(torch.rand(n_dim_state, n_dim_state, dtype<span class="op">=</span>dtype)),</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cls(<span class="op">**</span>params)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> KalmanFilter.init_random(<span class="dv">3</span>,<span class="dv">4</span>, dtype<span class="op">=</span>torch.float64)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>k</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Kalman Filter
        N dim obs: 3, N dim state: 4</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>k.init_state_cov</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[0.8016, 0.6772, 0.3551, 0.2307],
        [0.6772, 1.0154, 0.3157, 0.8042],
        [0.3551, 0.3157, 0.4873, 0.4452],
        [0.2307, 0.8042, 0.4452, 1.8951]], dtype=torch.float64,
       grad_fn=&lt;MmBackward0&gt;)</code></pre>
</div>
</div>
<p>check that assigment works :)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>k.init_state_cov <span class="op">=</span> to_posdef(torch.rand(<span class="dv">4</span>, <span class="dv">4</span>, dtype<span class="op">=</span>torch.float64))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>k.init_state_cov_raw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Parameter containing:
tensor([[0.9134, 0.0000, 0.0000, 0.0000],
        [0.1470, 0.0317, 0.0000, 0.0000],
        [0.0246, 0.7401, 0.5663, 0.0000],
        [0.8266, 0.2884, 0.4673, 0.5200]], dtype=torch.float64,
       requires_grad=True)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(k.named_parameters())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[('trans_matrix',
  Parameter containing:
  tensor([[0.2465, 0.6241, 0.0668, 0.2462],
          [0.3628, 0.9695, 0.1732, 0.8691],
          [0.7322, 0.6460, 0.8722, 0.1543],
          [0.1916, 0.7642, 0.8182, 0.6880]], dtype=torch.float64,
         requires_grad=True)),
 ('trans_off',
  Parameter containing:
  tensor([0.4932, 0.3893, 0.5000, 0.5153], dtype=torch.float64,
         requires_grad=True)),
 ('trans_cov_raw',
  Parameter containing:
  tensor([[0.5359, 0.0000, 0.0000, 0.0000],
          [0.3731, 0.5537, 0.0000, 0.0000],
          [0.8140, 0.5295, 0.8536, 0.0000],
          [0.3290, 0.3177, 0.9150, 0.2056]], dtype=torch.float64,
         requires_grad=True)),
 ('obs_matrix',
  Parameter containing:
  tensor([[0.9469, 0.4173, 0.8337, 0.0245],
          [0.5583, 0.7074, 0.2610, 0.9702],
          [0.3830, 0.6747, 0.3639, 0.4944]], dtype=torch.float64,
         requires_grad=True)),
 ('obs_off',
  Parameter containing:
  tensor([0.2422, 0.5051, 0.0628], dtype=torch.float64, requires_grad=True)),
 ('obs_cov_raw',
  Parameter containing:
  tensor([[0.2244, 0.0000, 0.0000],
          [0.5015, 0.8442, 0.0000],
          [0.8439, 0.2915, 0.3698]], dtype=torch.float64, requires_grad=True)),
 ('init_state_mean',
  Parameter containing:
  tensor([0.1409, 0.1981, 0.6858, 0.3361], dtype=torch.float64,
         requires_grad=True)),
 ('init_state_cov_raw',
  Parameter containing:
  tensor([[0.9134, 0.0000, 0.0000, 0.0000],
          [0.1470, 0.0317, 0.0000, 0.0000],
          [0.0246, 0.7401, 0.5663, 0.0000],
          [0.8266, 0.2884, 0.4673, 0.5200]], dtype=torch.float64,
         requires_grad=True))]</code></pre>
</div>
</div>
</section>
<section id="simple-parameters" class="level4">
<h4 class="anchored" data-anchor-id="simple-parameters">Simple parameters</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span>(cls_method<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> init_simple(cls: KalmanFilter,</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>                n_dim, <span class="co"># n_dim_obs and n_dim_state</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>                dtype<span class="op">=</span>torch.float32):</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Simplest version of kalman filter parameters"""</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cls(</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>        trans_matrix <span class="op">=</span>     torch.eye(n_dim, dtype<span class="op">=</span>dtype),</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>        trans_off <span class="op">=</span>        torch.zeros(n_dim, dtype<span class="op">=</span>dtype),        </span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>        trans_cov <span class="op">=</span>        torch.eye(n_dim, dtype<span class="op">=</span>dtype),        </span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>        obs_matrix <span class="op">=</span>       torch.eye(n_dim, dtype<span class="op">=</span>dtype),</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>        obs_off <span class="op">=</span>          torch.zeros(n_dim, dtype<span class="op">=</span>dtype),          </span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>        obs_cov <span class="op">=</span>          torch.eye(n_dim, dtype<span class="op">=</span>dtype),            </span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>        init_state_mean <span class="op">=</span>  torch.zeros(n_dim, dtype<span class="op">=</span>dtype),        </span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>        init_state_cov <span class="op">=</span>   torch.eye(n_dim, dtype<span class="op">=</span>dtype),</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>KalmanFilter.init_simple(<span class="dv">2</span>).state_dict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>OrderedDict([('trans_matrix',
              tensor([[1., 0.],
                      [0., 1.]])),
             ('trans_off', tensor([0., 0.])),
             ('trans_cov_raw',
              tensor([[1., 0.],
                      [0., 1.]])),
             ('obs_matrix',
              tensor([[1., 0.],
                      [0., 1.]])),
             ('obs_off', tensor([0., 0.])),
             ('obs_cov_raw',
              tensor([[1., 0.],
                      [0., 1.]])),
             ('init_state_mean', tensor([0., 0.])),
             ('init_state_cov_raw',
              tensor([[1., 0.],
                      [0., 1.]]))])</code></pre>
</div>
</div>
</section>
</section>
<section id="test-data" class="level3">
<h3 class="anchored" data-anchor-id="test-data">Test data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_test_data(n_obs <span class="op">=</span> <span class="dv">10</span>, n_dim_obs<span class="op">=</span><span class="dv">3</span>, p_missing<span class="op">=</span><span class="fl">.3</span>, bs<span class="op">=</span><span class="dv">2</span>, dtype<span class="op">=</span>torch.float32):</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> torch.rand(bs, n_obs, n_dim_obs, dtype<span class="op">=</span>dtype)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> torch.rand(bs, n_obs, n_dim_obs) <span class="op">&gt;</span> p_missing</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    data[<span class="op">~</span>mask] <span class="op">=</span> torch.nan <span class="co"># ensure that the missing data cannot be used</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data, mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>reset_seed()</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>data, mask <span class="op">=</span> get_test_data()</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>show_as_row(data, mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">data</p> <pre>tensor([[[0.9847, 0.0852, 0.5334],
         [   nan, 0.2617, 0.7972],
         [0.2088, 0.4545, 0.1455],
         [   nan,    nan, 0.2881],
         [   nan, 0.9087,    nan],
         [0.5610, 0.9079, 0.2507],
         [   nan, 0.7851, 0.0212],
         [   nan, 0.6513, 0.3955],
         [0.8111, 0.2558, 0.7570],
         [   nan,    nan,    nan]],

        [[   nan, 0.2511, 0.4720],
         [0.6684,    nan, 0.1489],
         [0.6714, 0.4719, 0.5053],
         [   nan, 0.7793, 0.3246],
         [   nan,    nan,    nan],
         [0.8191, 0.7040, 0.3264],
         [0.0842,    nan,    nan],
         [   nan, 0.3308, 0.7610],
         [0.3228, 0.0961, 0.3075],
         [0.0947, 0.4745,    nan]]])</pre> </div><div><p style="font-size: 1.2rem;">mask</p> <pre>tensor([[[ True,  True,  True],
         [False,  True,  True],
         [ True,  True,  True],
         [False, False,  True],
         [False,  True, False],
         [ True,  True,  True],
         [False,  True,  True],
         [False,  True,  True],
         [ True,  True,  True],
         [False, False, False]],

        [[False,  True,  True],
         [ True, False,  True],
         [ True,  True,  True],
         [False,  True,  True],
         [False, False, False],
         [ True,  True,  True],
         [ True, False, False],
         [False,  True,  True],
         [ True,  True,  True],
         [ True,  True, False]]])</pre> </div></div>
</div>
</div>
</section>
<section id="filter" class="level3">
<h3 class="anchored" data-anchor-id="filter">Filter</h3>
<section id="filter-predict" class="level4">
<h4 class="anchored" data-anchor-id="filter-predict">Filter predict</h4>
<p>Probability of state at time <code>t</code> given state a time <code>t-1</code></p>
<p><span class="math inline">\(p(x_t) = \mathcal{N}(x_t; m_t^-, P_t^-)\)</span> where:</p>
<ul>
<li><p>predicted state mean: <span class="math inline">\(m_t^- = Am_{t-1} + B c_t + b\)</span></p></li>
<li><p>predicted state covariance: <span class="math inline">\(P_t^- = AP_{t-1}A^T + Q\)</span></p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>trans_matrix, trans_cov, trans_off,curr_state_mean,curr_state_cov <span class="op">=</span> (k.trans_matrix, k.trans_cov, k.trans_off,</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>                                                  torch.stack([k.init_state_mean]<span class="op">*</span><span class="dv">2</span>).unsqueeze(<span class="op">-</span><span class="dv">1</span>),</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>                                                  torch.stack([k.init_state_cov]<span class="op">*</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>pred_state_mean, pred_state_cov <span class="op">=</span> _filter_predict(trans_matrix, trans_cov, trans_off,curr_state_mean,curr_state_cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>show_as_row(pred_state_mean, pred_state_cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">pred_state_mean</p> <pre>tensor([[[0.7802],
         [1.0434],
         [1.3811],
         [1.4860]],

        [[0.7802],
         [1.0434],
         [1.3811],
         [1.4860]]], dtype=torch.float64, grad_fn=<addbackward0>)</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">pred_state_cov</p> <pre>tensor([[[0.6192, 1.0170, 1.1092, 0.9157],
         [1.0170, 2.5039, 2.3017, 2.2437],
         [1.1092, 2.3017, 3.3362, 3.0781],
         [0.9157, 2.2437, 3.0781, 3.2862]],

        [[0.6192, 1.0170, 1.1092, 0.9157],
         [1.0170, 2.5039, 2.3017, 2.2437],
         [1.1092, 2.3017, 3.3362, 3.0781],
         [0.9157, 2.2437, 3.0781, 3.2862]]], dtype=torch.float64,
       grad_fn=<addbackward0>)</addbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>show_as_row(pred_state_mean.shape, pred_state_cov.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 4, 4])</pre> </div></div>
</div>
</div>
</section>
<section id="filter-correct" class="level4">
<h4 class="anchored" data-anchor-id="filter-correct">Filter correct</h4>
<p>Probability of state at time <code>t</code> given the observations at time <code>t</code></p>
<p><span class="math inline">\(p(x_t|y_t) = \mathcal{N}(x_t; m_t, P_t)\)</span> where:</p>
<ul>
<li><p>predicted obs mean: <span class="math inline">\(z_t = Hm_t^-\)</span></p></li>
<li><p>prediced obs covariance: <span class="math inline">\(S_t = HP_t^-H^T + R\)</span></p></li>
<li><p>kalman gain<span class="math inline">\(K_t = P_t^-H^TS_t^{-1}\)</span></p></li>
<li><p>corrected state mean: <span class="math inline">\(m_t = m_t^- + K_t(y_t - z_t)\)</span></p></li>
<li><p>corrected state covariance: <span class="math inline">\(P_t = (I-K_tH)P_t^-\)</span></p></li>
</ul>
<p>if the observation are missing this step is skipped and the corrected state is equal to the predicted state</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>obs_matrix, obs_cov, obs_off,obs, mm <span class="op">=</span> (k.obs_matrix, k.obs_cov, k.obs_off, data[:,<span class="dv">0</span>,:], mask[:,<span class="dv">0</span>,:])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>k_gain, corr_s_mean, corr_s_cov <span class="op">=</span> _filter_correct(obs_matrix, obs_cov, obs_offset, pred_state_mean, pred_state_cov, obs, mm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>show_as_row(k_gain, corr_s_mean, corr_s_cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">k_gain</p> <pre>tensor([[[ 0.4487, -0.0872, -0.0887],
         [ 0.3509,  0.0941,  0.0479],
         [ 0.6473,  0.1656, -0.2276],
         [ 0.1256,  0.4930, -0.1658]],

        [[ 0.4487, -0.0872, -0.0887],
         [ 0.3509,  0.0941,  0.0479],
         [ 0.6473,  0.1656, -0.2276],
         [ 0.1256,  0.4930, -0.1658]]], dtype=torch.float64,
       grad_fn=<unsafeviewbackward0>)</unsafeviewbackward0></pre> </div><div><p style="font-size: 1.2rem;">corr_s_mean</p> <pre>tensor([[[ 0.5066],
         [ 0.0707],
         [ 0.1733],
         [-0.0983]],

        [[ 0.7802],
         [ 1.0434],
         [ 1.3811],
         [ 1.4860]]], dtype=torch.float64, grad_fn=<indexputbackward0>)</indexputbackward0></pre> </div><div><p style="font-size: 1.2rem;">corr_s_cov</p> <pre>tensor([[[ 0.0941,  0.0337, -0.1245, -0.1411],
         [ 0.0337,  0.4323, -0.2066, -0.1118],
         [-0.1245, -0.2066,  0.2475,  0.2383],
         [-0.1411, -0.1118,  0.2383,  0.4888]],

        [[ 0.6192,  1.0170,  1.1092,  0.9157],
         [ 1.0170,  2.5039,  2.3017,  2.2437],
         [ 1.1092,  2.3017,  3.3362,  3.0781],
         [ 0.9157,  2.2437,  3.0781,  3.2862]]], dtype=torch.float64,
       grad_fn=<indexputbackward0>)</indexputbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(<span class="kw">lambda</span> x:x.shape, (k_gain, corr_s_mean, corr_s_cov,)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 4, 3])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 4, 4])</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>test_close(corr_s_mean[<span class="dv">1</span>], pred_state_mean[<span class="dv">1</span>]) <span class="co"># correctly ignoring the missing data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>corr_s_mean.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>) <span class="co"># check that pytorch can compute gradients with the whole batch</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="filter-1" class="level4">
<h4 class="anchored" data-anchor-id="filter-1">Filter</h4>
<p>The resursive version of the kalman filter is apperently breaking pytorch gradients calculations so a workaround is needed. During the loop the states are saved in a python list and then at the end they are combined back into a tensor. The last line of the function does:</p>
<ul>
<li>convert lists to tensors</li>
<li>correct order dimensions</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>obs, init_state_mean, init_state_cov <span class="op">=</span> data, k.init_state_mean, k.init_state_cov</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>pred_state_means, pred_state_covs, filt_state_means, filt_state_covs <span class="op">=</span> _filter(trans_matrix, obs_matrix, trans_cov, obs_cov, trans_off, obs_off, init_state_mean, init_state_cov, data, mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Predictions at time <code>0</code> for both batches</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(Self.shape(), (pred_state_means, pred_state_covs, filt_state_means, filt_state_covs,)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 10, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 10, 4, 4])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 10, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 10, 4, 4])</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(<span class="kw">lambda</span> x:x[<span class="dv">0</span>][<span class="dv">0</span>], (pred_state_means, pred_state_covs, filt_state_means, filt_state_covs,)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>tensor([[0.1409],
        [0.1981],
        [0.6858],
        [0.3361]], dtype=torch.float64, grad_fn=<selectbackward0>)</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>tensor([[0.8344, 0.1343, 0.0224, 0.7551],
        [0.1343, 0.0226, 0.0271, 0.1306],
        [0.0224, 0.0271, 0.8690, 0.4984],
        [0.7551, 0.1306, 0.4984, 1.2552]], dtype=torch.float64,
       grad_fn=<selectbackward0>)</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>tensor([[-0.1441],
        [ 0.1613],
        [ 0.8924],
        [-0.0733]], dtype=torch.float64, grad_fn=<selectbackward0>)</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>tensor([[ 0.3057,  0.0396, -0.3622,  0.0305],
        [ 0.0396,  0.0055, -0.0467,  0.0016],
        [-0.3622, -0.0467,  0.4488, -0.0138],
        [ 0.0305,  0.0016, -0.0138,  0.2507]], dtype=torch.float64,
       grad_fn=<selectbackward0>)</selectbackward0></pre> </div></div>
</div>
</div>
</section>
<section id="kalmanfilter-method" class="level4">
<h4 class="anchored" data-anchor-id="kalmanfilter-method">KalmanFilter method</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>pred_mean, _, _, _ <span class="op">=</span> k._filter_all(obs)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>pred_mean.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>) <span class="co"># it works!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The filter methods wraps <code>_filter_all</code> but in addition:</p>
<ul>
<li>returns only filtered state</li>
<li>detach tensors</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="bu">filter</span>(<span class="va">self</span>: KalmanFilter,</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>          obs: Tensor, <span class="co"># [n_timesteps, n_dim_obs] obs for times [0...n_timesteps-1]</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>          mask <span class="op">=</span> <span class="va">None</span>,</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>          cov_checker<span class="op">=</span>CheckPosDef()</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>          ) <span class="op">-&gt;</span> ListMNormal: <span class="co"># Filtered state</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Filter observation"""</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    _, _, filt_state_means, filt_state_covs <span class="op">=</span> <span class="va">self</span>._filter_all(obs, mask, cov_checker)</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ListMNormal(filt_state_means.squeeze(<span class="op">-</span><span class="dv">1</span>), filt_state_covs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>filt <span class="op">=</span> k.<span class="bu">filter</span>(obs)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>filt.mean.shape, filt.cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 10, 4]), torch.Size([2, 10, 4, 4]))</code></pre>
</div>
</div>
</section>
</section>
<section id="smooth" class="level3">
<h3 class="anchored" data-anchor-id="smooth">Smooth</h3>
<section id="smooth-step" class="level4">
<h4 class="anchored" data-anchor-id="smooth-step">Smooth step</h4>
<p>compute the probability of the state at time <code>t</code> given all the observations</p>
<p><span class="math inline">\(p(x_t|Y) = \mathcal{N}(x_t; m_t^s, P_t^s)\)</span> where:</p>
<ul>
<li>Kalman smoothing gain: <span class="math inline">\(G_t = P_tA^T(P_{t+1}^-)^{-1}\)</span></li>
<li>smoothed mean: <span class="math inline">\(m_t^s = m_t + G_t(m_{t+1}^s - m_{t+1}^-)\)</span></li>
<li>smoothed covariance: <span class="math inline">\(P_t^s = P_t + G_t(P_t{t+1}^s - P_t{t+1}^-)G_t^T\)</span></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>filt_state, pred_state, next_smoothed_state <span class="op">=</span> [MNormal(pred_state_mean, pred_state_cov)] <span class="op">*</span> <span class="dv">3</span> <span class="co"># just for testing</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span>_smooth_update(trans_matrix, MNormal(pred_state_mean, pred_state_cov), MNormal(pred_state_mean, pred_state_cov), MNormal(pred_state_mean, pred_state_cov)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>tensor([[[0.7802],
         [1.0434],
         [1.3811],
         [1.4860]],

        [[0.7802],
         [1.0434],
         [1.3811],
         [1.4860]]], dtype=torch.float64, grad_fn=<addbackward0>)</addbackward0></pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>tensor([[[0.6192, 1.0170, 1.1092, 0.9157],
         [1.0170, 2.5039, 2.3017, 2.2437],
         [1.1092, 2.3017, 3.3362, 3.0781],
         [0.9157, 2.2437, 3.0781, 3.2862]],

        [[0.6192, 1.0170, 1.1092, 0.9157],
         [1.0170, 2.5039, 2.3017, 2.2437],
         [1.1092, 2.3017, 3.3362, 3.0781],
         [0.9157, 2.2437, 3.0781, 3.2862]]], dtype=torch.float64,
       grad_fn=<addbackward0>)</addbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(Self.shape(), _smooth_update(trans_matrix, MNormal(pred_state_mean, pred_state_cov), MNormal(pred_state_mean, pred_state_cov), MNormal(pred_state_mean, pred_state_cov))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 4, 4])</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>(pred_state_means, pred_state_covs, filt_state_means, filt_state_covs ) <span class="op">=</span> k._filter_all(data)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>filt_state, pred_state <span class="op">=</span> ListMNormal(filt_state_means, filt_state_covs), ListMNormal(pred_state_means, pred_state_covs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>smooth_state <span class="op">=</span> _smooth(k.trans_matrix,  filt_state, pred_state)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smooth_state.mean[<span class="dv">0</span>][<span class="dv">0</span>], smooth_state.cov[<span class="dv">0</span>][<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>tensor([[-0.1181],
        [ 0.1661],
        [ 0.8274],
        [-0.2972]], dtype=torch.float64, grad_fn=<selectbackward0>)</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>tensor([[ 0.2884,  0.0374, -0.3408,  0.0317],
        [ 0.0374,  0.0052, -0.0439,  0.0019],
        [-0.3408, -0.0439,  0.4217, -0.0195],
        [ 0.0317,  0.0019, -0.0195,  0.2228]], dtype=torch.float64,
       grad_fn=<selectbackward0>)</selectbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smooth_state.mean.shape, smooth_state.cov.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 10, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 10, 4, 4])</pre> </div></div>
</div>
</div>
</section>
<section id="kalmanfilter-method-1" class="level4">
<h4 class="anchored" data-anchor-id="kalmanfilter-method-1">KalmanFilter method</h4>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L444" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="kalmanfilter.smooth" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.smooth">KalmanFilter.smooth</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.smooth (obs:torch.Tensor, mask:torch.Tensor=None,
                      cov_checker=&lt;__main__.CheckPosDef object at
                      0x7fe1e17c29e0&gt;)</code></pre>
</blockquote>
<p>Kalman Filter Smoothing</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>obs</td>
<td>Tensor</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>mask</td>
<td>Tensor</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>cov_checker</td>
<td>CheckPosDef</td>
<td>&lt;<strong>main</strong>.CheckPosDef object at 0x7fe1e17c29e0&gt;</td>
<td></td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ListMultiNormal</strong></td>
<td></td>
<td><strong><code>[n_timesteps, n_dim_state]</code> smoothed state</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>smoothed_state <span class="op">=</span> k.smooth(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smoothed_state.mean.shape, smoothed_state.cov.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 10, 4])</pre> </div><div><p style="font-size: 1.2rem;"></p> <pre>torch.Size([2, 10, 4, 4])</pre> </div></div>
</div>
</div>
</section>
<section id="predict" class="level3">
<h3 class="anchored" data-anchor-id="predict">Predict</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> meteo_imp.gaussian <span class="im">import</span> conditional_guassian</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In order to have conditional predictions that make sense it’s not possible to return the full covariance matrix for the predictions but only the standard deviations</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>obs <span class="op">=</span> tst.data[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> tst.mask[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>obs, mask</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([         nan,          nan, 0.1447432041]),
 tensor([False, False,  True]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>conditional_guassian</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;function meteo_imp.gaussian.conditional_guassian(μ: torch.Tensor, Σ: torch.Tensor, obs: torch.Tensor, idx: torch.Tensor) -&gt; meteo_imp.utils.ListNormal&gt;</code></pre>
</div>
</div>
<p>The conditional gaussian returns a distributions of 2 variables, which are the un-observed ones (you can see the <code>nan</code> in the observation vector)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>conditional_guassian(tst.params[<span class="st">'init_state_mean'</span>], tst.params[<span class="st">'init_state_cov'</span>], obs[mask], mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>ListNormal(mean=tensor([0.6510141492, 0.7715864182]), cov=tensor([[0.0712313056, 0.1887338310],
        [0.1887338310, 0.5375747681]]))</code></pre>
</div>
</div>
<p>which are correctly merged with the predictions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>_get_cond_pred(ListMNormal(tst.params[<span class="st">'init_state_mean'</span>], tst.params[<span class="st">'init_state_cov'</span>]), obs, mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>ListNormal(mean=tensor([0.6510141492, 0.7715864182, 0.7890297771]), cov=tensor([0.0712313056, 0.5375747681, 0.9362983704]))</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L490" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter.predict" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.predict">KalmanFilter.predict</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.predict (obs, mask=None, smooth=True, check_args=None)</code></pre>
</blockquote>
<p>Predicted observations at all times</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>k.predict(obs<span class="op">=</span>X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>ListNormal(mean=tensor([[0.9230768681],
        [1.7692307234],
        [2.3846154213]], grad_fn=&lt;CopySlices&gt;), cov=tensor([[1.3846154213],
        [1.4615384340],
        [1.6153845787]], grad_fn=&lt;CopySlices&gt;))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_times(<span class="va">self</span>: KalmanFilter, times, obs, mask<span class="op">=</span><span class="va">None</span>, smooth<span class="op">=</span><span class="va">True</span>, check_args<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Predicted observations at specific times """</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    state <span class="op">=</span> <span class="va">self</span>.smooth(obs, mask, check_args) <span class="cf">if</span> smooth <span class="cf">else</span> <span class="va">self</span>.<span class="bu">filter</span>(obs, mask, check_args)</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    obs, mask <span class="op">=</span> <span class="va">self</span>._parse_obs(obs, mask)</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>    times <span class="op">=</span> array1d(times)</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>    n_timesteps <span class="op">=</span> obs.shape[<span class="dv">0</span>]</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>    n_features <span class="op">=</span> obs.shape[<span class="dv">1</span>] <span class="cf">if</span> <span class="bu">len</span>(obs.shape) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> times.<span class="bu">max</span>() <span class="op">&gt;</span> n_timesteps <span class="kw">or</span> times.<span class="bu">min</span>() <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"provided times range from </span><span class="sc">{</span>times<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>times<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">, which is outside allowed range : 0 to </span><span class="sc">{</span>n_timesteps<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a>    means <span class="op">=</span> torch.empty((times.shape[<span class="dv">0</span>], n_features), dtype<span class="op">=</span>obs.dtype, device<span class="op">=</span>obs.device)</span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a>    stds <span class="op">=</span> torch.empty((times.shape[<span class="dv">0</span>], n_features), dtype<span class="op">=</span>obs.dtype, device<span class="op">=</span>obs.device) </span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, t <span class="kw">in</span> <span class="bu">enumerate</span>(times):</span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a>        mean, std <span class="op">=</span> <span class="va">self</span>._obs_from_state(</span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>            state.mean[t],</span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a>            state.cov[t],</span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'t'</span>: t, <span class="op">**</span>check_args} <span class="cf">if</span> check_args <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a>        means[i], stds[i] <span class="op">=</span> _get_cond_pred(ListNormal(mean, std), obs[t], mask[t])</span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ListNormal(means, stds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>pykalman doesn’t support a predict method so cannot test it</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>tst.<span class="bu">filter</span>.predict(obs <span class="op">=</span> tst.data, mask <span class="op">=</span> tst.mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>ListNormal(mean=tensor([[-0.3030261397, -0.2419726700, -0.3667301536],
        [-0.5841388106,  0.0571963340, -0.0602211729],
        [-0.4957259297, -0.1866203099, -0.3876989782],
        [-0.3683194518,  0.4738349319,  0.1002929062],
        [-0.2453254759, -0.0729204565, -0.4634614289],
        [ 0.7444251776,  0.9131455421, -0.2360927910],
        [ 0.2539923191,  0.2802425325, -0.0793784633],
        [ 1.0530376434,  0.5632419586,  0.3484775722],
        [ 0.8671647310,  0.4598079920,  1.1614903212],
        [ 6.1932973862,  2.9287741184,  0.3289620876]], grad_fn=&lt;CopySlices&gt;), cov=tensor([[5.1329714060e-01, 1.1908673048e+00, 7.2597950697e-01],
        [4.8898196220e-01, 2.7054542303e-01, 7.3858928680e-01],
        [5.2057659626e-01, 1.2010793686e+00, 7.2838747501e-01],
        [6.7297101021e-01, 8.7734472752e-01, 6.3224875927e-01],
        [6.1076289415e-01, 1.2208808661e+00, 7.5710517168e-01],
        [1.2441244125e+00, 3.4210133553e-01, 1.3619506359e+00],
        [1.1757915497e+01, 3.4084844589e-01, 3.3397865295e+00],
        [4.8872512817e+01, 1.1506040573e+01, 1.2109507561e+01],
        [2.7350158691e+00, 3.4780120850e-01, 4.8372123718e+01],
        [8.5246258545e+02, 1.8208175659e+02, 2.4330139160e-01]],
       grad_fn=&lt;CopySlices&gt;))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>mean, std <span class="op">=</span> tst.<span class="bu">filter</span>.predict_times(obs <span class="op">=</span> tst.data, times <span class="op">=</span> torch.tensor([<span class="dv">0</span>,<span class="dv">1</span>]), mask <span class="op">=</span> tst.mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>mean, std</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[-0.3030261397, -0.2419726700, -0.3667301536],
         [-0.5841388106,  0.0571963340, -0.0602211729]], grad_fn=&lt;CopySlices&gt;),
 tensor([[0.5132971406, 1.1908673048, 0.7259795070],
         [0.4889819622, 0.2705454230, 0.7385892868]], grad_fn=&lt;CopySlices&gt;))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>print_info((mean, std))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> - shape: torch.Size([2, 3]), type torch.float32, mean -0.2498154193162918
 - shape: torch.Size([2, 3]), type torch.float32, mean 0.6547101140022278</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>mean, cov <span class="op">=</span> tst64.<span class="bu">filter</span>.smooth(tst64.data, tst64.mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>tst64.<span class="bu">filter</span>._obs_from_state(mean[<span class="dv">0</span>], cov[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>ListNormal(mean=tensor([0.3859194846, 0.7281861816, 0.1397059375], dtype=torch.float64,
       grad_fn=&lt;MvBackward0&gt;), cov=tensor([[0.4320693928, 0.5322830879, 0.2673021478],
        [0.5322830879, 1.1152050124, 0.5026130264],
        [0.2673021478, 0.5026130264, 1.1322290900]], dtype=torch.float64,
       grad_fn=&lt;AddBackward0&gt;))</code></pre>
</div>
</div>
</section>
<section id="log-likelihood" class="level3">
<h3 class="anchored" data-anchor-id="log-likelihood">Log Likelihood</h3>
<p>This code is old now as the log likelihood is not computed here</p>
<p>TODO: open issue in pykalman for error in ll missing data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>pykalman.standard.KalmanFilter.loglikelihood??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> pykalman<span class="ansi-blue-fg">.</span>standard<span class="ansi-blue-fg">.</span>KalmanFilter<span class="ansi-blue-fg">.</span>loglikelihood<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> X<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Source:</span>   
    <span class="ansi-green-fg">def</span> loglikelihood<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> X<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        <span class="ansi-blue-fg">"""Calculate the log likelihood of all observations</span>
<span class="ansi-blue-fg">        Parameters</span>
<span class="ansi-blue-fg">        ----------</span>
<span class="ansi-blue-fg">        X : [n_timesteps, n_dim_obs] array</span>
<span class="ansi-blue-fg">            observations for time steps [0...n_timesteps-1]</span>
<span class="ansi-blue-fg">        Returns</span>
<span class="ansi-blue-fg">        -------</span>
<span class="ansi-blue-fg">        likelihood : float</span>
<span class="ansi-blue-fg">            likelihood of all observations</span>
<span class="ansi-blue-fg">        """</span>
        Z <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>array<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>_parse_observations<span class="ansi-blue-fg">(</span>X<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-red-fg"># initialize parameters</span>
        <span class="ansi-blue-fg">(</span>transition_matrices<span class="ansi-blue-fg">,</span> transition_offsets<span class="ansi-blue-fg">,</span>
         transition_covariance<span class="ansi-blue-fg">,</span> observation_matrices<span class="ansi-blue-fg">,</span>
         observation_offsets<span class="ansi-blue-fg">,</span> observation_covariance<span class="ansi-blue-fg">,</span>
         initial_state_mean<span class="ansi-blue-fg">,</span> initial_state_covariance<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span>
            self<span class="ansi-blue-fg">.</span>_initialize_parameters<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
        <span class="ansi-blue-fg">)</span>
        <span class="ansi-red-fg"># apply the Kalman Filter</span>
        <span class="ansi-blue-fg">(</span>predicted_state_means<span class="ansi-blue-fg">,</span> predicted_state_covariances<span class="ansi-blue-fg">,</span>
         kalman_gains<span class="ansi-blue-fg">,</span> filtered_state_means<span class="ansi-blue-fg">,</span>
         filtered_state_covariances<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span>
            _filter<span class="ansi-blue-fg">(</span>
                transition_matrices<span class="ansi-blue-fg">,</span> observation_matrices<span class="ansi-blue-fg">,</span>
                transition_covariance<span class="ansi-blue-fg">,</span> observation_covariance<span class="ansi-blue-fg">,</span>
                transition_offsets<span class="ansi-blue-fg">,</span> observation_offsets<span class="ansi-blue-fg">,</span>
                initial_state_mean<span class="ansi-blue-fg">,</span> initial_state_covariance<span class="ansi-blue-fg">,</span>
                Z
            <span class="ansi-blue-fg">)</span>
        <span class="ansi-blue-fg">)</span>
        <span class="ansi-red-fg"># get likelihoods for each time step</span>
        loglikelihoods <span class="ansi-blue-fg">=</span> _loglikelihoods<span class="ansi-blue-fg">(</span>
          observation_matrices<span class="ansi-blue-fg">,</span> observation_offsets<span class="ansi-blue-fg">,</span> observation_covariance<span class="ansi-blue-fg">,</span>
          predicted_state_means<span class="ansi-blue-fg">,</span> predicted_state_covariances<span class="ansi-blue-fg">,</span> Z
        <span class="ansi-blue-fg">)</span>
        <span class="ansi-green-fg">return</span> np<span class="ansi-blue-fg">.</span>sum<span class="ansi-blue-fg">(</span>loglikelihoods<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">File:</span>      ~/anaconda3/envs/data-science/lib/python3.10/site-packages/pykalman/standard.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>pykalman.standard._loglikelihoods??</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span>
pykalman<span class="ansi-blue-fg">.</span>standard<span class="ansi-blue-fg">.</span>_loglikelihoods<span class="ansi-blue-fg">(</span>
    observation_matrices<span class="ansi-blue-fg">,</span>
    observation_offsets<span class="ansi-blue-fg">,</span>
    observation_covariance<span class="ansi-blue-fg">,</span>
    predicted_state_means<span class="ansi-blue-fg">,</span>
    predicted_state_covariances<span class="ansi-blue-fg">,</span>
    observations<span class="ansi-blue-fg">,</span>
<span class="ansi-blue-fg">)</span>
<span class="ansi-red-fg">Source:</span>   
<span class="ansi-green-fg">def</span> _loglikelihoods<span class="ansi-blue-fg">(</span>observation_matrices<span class="ansi-blue-fg">,</span> observation_offsets<span class="ansi-blue-fg">,</span>
                    observation_covariance<span class="ansi-blue-fg">,</span> predicted_state_means<span class="ansi-blue-fg">,</span>
                    predicted_state_covariances<span class="ansi-blue-fg">,</span> observations<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
    <span class="ansi-blue-fg">"""Calculate log likelihood of all observations</span>
<span class="ansi-blue-fg">    Parameters</span>
<span class="ansi-blue-fg">    ----------</span>
<span class="ansi-blue-fg">    observation_matrices : [n_timesteps, n_dim_obs, n_dim_obs] or [n_dim_obs,</span>
<span class="ansi-blue-fg">    n_dim_state] array</span>
<span class="ansi-blue-fg">        observation matrices for t in [0...n_timesteps-1]</span>
<span class="ansi-blue-fg">    observation_offsets : [n_timesteps, n_dim_obs] or [n_dim_obs] array</span>
<span class="ansi-blue-fg">        offsets for observations for t = [0...n_timesteps-1]</span>
<span class="ansi-blue-fg">    observation_covariance : [n_dim_obs, n_dim_obs] array</span>
<span class="ansi-blue-fg">        covariance matrix for all observations</span>
<span class="ansi-blue-fg">    predicted_state_means : [n_timesteps, n_dim_state] array</span>
<span class="ansi-blue-fg">        mean of state at time t given observations from times</span>
<span class="ansi-blue-fg">        [0...t-1] for t in [0...n_timesteps-1]</span>
<span class="ansi-blue-fg">    predicted_state_covariances : [n_timesteps, n_dim_state, n_dim_state] array</span>
<span class="ansi-blue-fg">        covariance of state at time t given observations from times</span>
<span class="ansi-blue-fg">        [0...t-1] for t in [0...n_timesteps-1]</span>
<span class="ansi-blue-fg">    observations : [n_dim_obs] array</span>
<span class="ansi-blue-fg">        All observations.  If `observations[t]` is a masked array and any of</span>
<span class="ansi-blue-fg">        its values are masked, the observation will be ignored.</span>
<span class="ansi-blue-fg">    Returns</span>
<span class="ansi-blue-fg">    -------</span>
<span class="ansi-blue-fg">    loglikelihoods: [n_timesteps] array</span>
<span class="ansi-blue-fg">        `loglikelihoods[t]` is the probability density of the observation</span>
<span class="ansi-blue-fg">        generated at time step t</span>
<span class="ansi-blue-fg">    """</span>
    n_timesteps <span class="ansi-blue-fg">=</span> observations<span class="ansi-blue-fg">.</span>shape<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span>
    loglikelihoods <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>zeros<span class="ansi-blue-fg">(</span>n_timesteps<span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">for</span> t <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span>n_timesteps<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
        observation <span class="ansi-blue-fg">=</span> observations<span class="ansi-blue-fg">[</span>t<span class="ansi-blue-fg">]</span>
        <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> np<span class="ansi-blue-fg">.</span>any<span class="ansi-blue-fg">(</span>np<span class="ansi-blue-fg">.</span>ma<span class="ansi-blue-fg">.</span>getmask<span class="ansi-blue-fg">(</span>observation<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
            observation_matrix <span class="ansi-blue-fg">=</span> _last_dims<span class="ansi-blue-fg">(</span>observation_matrices<span class="ansi-blue-fg">,</span> t<span class="ansi-blue-fg">)</span>
            observation_offset <span class="ansi-blue-fg">=</span> _last_dims<span class="ansi-blue-fg">(</span>observation_offsets<span class="ansi-blue-fg">,</span> t<span class="ansi-blue-fg">,</span> ndims<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span>
            predicted_state_mean <span class="ansi-blue-fg">=</span> _last_dims<span class="ansi-blue-fg">(</span>
                predicted_state_means<span class="ansi-blue-fg">,</span> t<span class="ansi-blue-fg">,</span> ndims<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span>
            <span class="ansi-blue-fg">)</span>
            predicted_state_covariance <span class="ansi-blue-fg">=</span> _last_dims<span class="ansi-blue-fg">(</span>
                predicted_state_covariances<span class="ansi-blue-fg">,</span> t
            <span class="ansi-blue-fg">)</span>
            predicted_observation_mean <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span>
                np<span class="ansi-blue-fg">.</span>dot<span class="ansi-blue-fg">(</span>observation_matrix<span class="ansi-blue-fg">,</span>
                       predicted_state_mean<span class="ansi-blue-fg">)</span>
                <span class="ansi-blue-fg">+</span> observation_offset
            <span class="ansi-blue-fg">)</span>
            predicted_observation_covariance <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">(</span>
                np<span class="ansi-blue-fg">.</span>dot<span class="ansi-blue-fg">(</span>observation_matrix<span class="ansi-blue-fg">,</span>
                       np<span class="ansi-blue-fg">.</span>dot<span class="ansi-blue-fg">(</span>predicted_state_covariance<span class="ansi-blue-fg">,</span>
                              observation_matrix<span class="ansi-blue-fg">.</span>T<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
                <span class="ansi-blue-fg">+</span> observation_covariance
            <span class="ansi-blue-fg">)</span>
            loglikelihoods<span class="ansi-blue-fg">[</span>t<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> log_multivariate_normal_density<span class="ansi-blue-fg">(</span>
                observation<span class="ansi-blue-fg">[</span>np<span class="ansi-blue-fg">.</span>newaxis<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>
                predicted_observation_mean<span class="ansi-blue-fg">[</span>np<span class="ansi-blue-fg">.</span>newaxis<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>
                predicted_observation_covariance<span class="ansi-blue-fg">[</span>np<span class="ansi-blue-fg">.</span>newaxis<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">]</span>
            <span class="ansi-blue-fg">)</span>
    <span class="ansi-green-fg">return</span> loglikelihoods
<span class="ansi-red-fg">File:</span>      ~/anaconda3/envs/data-science/lib/python3.10/site-packages/pykalman/standard.py
<span class="ansi-red-fg">Type:</span>      function
</pre>
</div>
</div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L511" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter.filter_loglikelihood" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.filter_loglikelihood">KalmanFilter.filter_loglikelihood</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.filter_loglikelihood (obs, mask=None)</code></pre>
</blockquote>
<p>Compute log likelihood using only filter step</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>k.filter_loglikelihood(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(-5.2315979004, grad_fn=&lt;SumBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>test_close(k.filter_loglikelihood(X), pyk.loglikelihood(nX))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>pred_state, pred_state_cov, _, _ <span class="op">=</span> <span class="bu">tuple</span>(<span class="bu">map</span>(_stack_detach, tst.<span class="bu">filter</span>._filter_all(tst.data, tst.mask)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>tst <span class="op">=</span> KalmanFilterTester(nan_mask <span class="op">=</span> <span class="va">False</span>, p_missing<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>pykalman.standard._loglikelihoods(</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>    tst.params_pyk[<span class="st">'observation_matrices'</span>],</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    tst.params_pyk[<span class="st">'observation_offsets'</span>],</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    tst.params_pyk[<span class="st">'observation_covariance'</span>],</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    pred_state.numpy(),</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    pred_state_cov.numpy(),</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    np.array(tst.data_pyk)</span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>array([-5.64984703, -8.634758  , -3.505826  , -3.89075327, -4.01303673,
       -3.75743556, -4.12671423, -4.10942173, -6.93878555, -6.93154287])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>test_close(</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>    tst.<span class="bu">filter</span>.filter_loglikelihood(tst.data, tst.mask),</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>    tst.filter_pyk.loglikelihood(tst.data_pyk)) <span class="co"># need to increase the resolution</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>AssertionError: close:
-35.311344146728516
-42.055377029134384</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>tst64 <span class="op">=</span> KalmanFilterTester(p_missing<span class="op">=</span><span class="dv">0</span>, dtype<span class="op">=</span>torch.float64)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>(tst64.<span class="bu">filter</span>.filter_loglikelihood(tst64.data, tst64.mask),</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>tst64.filter_pyk.loglikelihood(tst64.data_pyk))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor(-30.2942523956, grad_fn=&lt;SumBackward0&gt;), -36.23070604799459)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>k2.filter_loglikelihood(X2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(-181.6866760254, grad_fn=&lt;SumBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>test_close(k2.filter_loglikelihood(X2), pyk2.loglikelihood(nX2), eps<span class="op">=</span><span class="fl">1e-4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>since the goal is to fill gaps we want the log likelihood for the whole gap and only for it</p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L530" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter.loglikelihood" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.loglikelihood">KalmanFilter.loglikelihood</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.loglikelihood (obs_train:torch.Tensor, times:torch.Tensor,
                             obs_test:torch.Tensor,
                             mask:torch.Tensor=None)</code></pre>
</blockquote>
<p>Log likelihood only for the <code>obs_test</code> at giben times</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>obs_train</td>
<td>Tensor</td>
<td></td>
<td>[n_timesteps, n_dim_obs] Observations use for the filter (can containt missing data)</td>
</tr>
<tr class="even">
<td>times</td>
<td>Tensor</td>
<td></td>
<td>[n_pred_timesteps] time at which to calculate the log likelihood</td>
</tr>
<tr class="odd">
<td>obs_test</td>
<td>Tensor</td>
<td></td>
<td>[n_pred_timesteps, n_dim_obs] observed data to compute log likelihood</td>
</tr>
<tr class="even">
<td>mask</td>
<td>Tensor</td>
<td>None</td>
<td>[n_timesteps, n_dim_obs]</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>Tensor</strong></td>
<td></td>
<td><strong>scalar that is sum of log likelihoods for all <code>times</code></strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>torch.diag(std[<span class="dv">0</span>]).dtype</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.float32</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>tst.<span class="bu">filter</span>.loglikelihood(tst.data, tst.mask, tst.data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(-47.5645027161, grad_fn=&lt;SumBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>X2.dtype</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.float32</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>k.loglikelihood(X, [<span class="dv">1</span>,<span class="dv">2</span>], X[[<span class="dv">1</span>,<span class="dv">2</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(-3.1273550987, grad_fn=&lt;SumBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>k2.loglikelihood(X2, [<span class="dv">1</span>,<span class="dv">2</span>], X2[[<span class="dv">1</span>,<span class="dv">2</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(-84.5747680664, grad_fn=&lt;SumBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>k2.loglikelihood(X2m, [<span class="dv">1</span>,<span class="dv">2</span>], X2[[<span class="dv">1</span>,<span class="dv">2</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor(-86.9698638916, grad_fn=&lt;SumBackward0&gt;)</code></pre>
</div>
</div>
</section>
<section id="get-info" class="level3">
<h3 class="anchored" data-anchor-id="get-info">Get Info</h3>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L546" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter.get_info" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.get_info">KalmanFilter.get_info</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.get_info (var_names=None)</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>display_as_row(k.get_info())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<p style="font-size: 1.5rem; font-decoration: bold"></p><p></p><div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div> <p style="font-size: 1.3rem;">A</p> <style type="text/css">
</style>
<table id="T_5631d">
  <thead>
    <tr>
      <th id="T_5631d_level0_col0" class="col_heading level0 col0">latent</th>
      <th id="T_5631d_level0_col1" class="col_heading level0 col1">z_0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_5631d_row0_col0" class="data row0 col0">z_0</td>
      <td id="T_5631d_row0_col1" class="data row0 col1">1.0000</td>
    </tr>
  </tbody>
</table>
 </div><div> <p style="font-size: 1.3rem;">H</p> <style type="text/css">
</style>
<table id="T_acae0">
  <thead>
    <tr>
      <th id="T_acae0_level0_col0" class="col_heading level0 col0">z_0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_acae0_row0_col0" class="data row0 col0">1.0000</td>
    </tr>
  </tbody>
</table>
 </div><div> <p style="font-size: 1.3rem;">R</p> <style type="text/css">
</style>
<table id="T_e0b79">
  <thead>
    <tr>
      <th id="T_e0b79_level0_col0" class="col_heading level0 col0">0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_e0b79_row0_col0" class="data row0 col0">1.0000</td>
    </tr>
  </tbody>
</table>
 </div><div> <p style="font-size: 1.3rem;">Q</p> <style type="text/css">
</style>
<table id="T_1134d">
  <thead>
    <tr>
      <th id="T_1134d_level0_col0" class="col_heading level0 col0">latent</th>
      <th id="T_1134d_level0_col1" class="col_heading level0 col1">z_0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_1134d_row0_col0" class="data row0 col0">z_0</td>
      <td id="T_1134d_row0_col1" class="data row0 col1">1.0000</td>
    </tr>
  </tbody>
</table>
 </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>display_as_row(k2.get_info())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<p style="font-size: 1.5rem; font-decoration: bold"></p><p></p><div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div> <p style="font-size: 1.3rem;">A</p> <style type="text/css">
</style>
<table id="T_493bf">
  <thead>
    <tr>
      <th id="T_493bf_level0_col0" class="col_heading level0 col0">latent</th>
      <th id="T_493bf_level0_col1" class="col_heading level0 col1">z_0</th>
      <th id="T_493bf_level0_col2" class="col_heading level0 col2">z_1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_493bf_row0_col0" class="data row0 col0">z_0</td>
      <td id="T_493bf_row0_col1" class="data row0 col1">1.0000</td>
      <td id="T_493bf_row0_col2" class="data row0 col2">0.0000</td>
    </tr>
    <tr>
      <td id="T_493bf_row1_col0" class="data row1 col0">z_1</td>
      <td id="T_493bf_row1_col1" class="data row1 col1">0.0000</td>
      <td id="T_493bf_row1_col2" class="data row1 col2">1.0000</td>
    </tr>
  </tbody>
</table>
 </div><div> <p style="font-size: 1.3rem;">H</p> <style type="text/css">
</style>
<table id="T_61988">
  <thead>
    <tr>
      <th id="T_61988_level0_col0" class="col_heading level0 col0">z_0</th>
      <th id="T_61988_level0_col1" class="col_heading level0 col1">z_1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_61988_row0_col0" class="data row0 col0">1.0000</td>
      <td id="T_61988_row0_col1" class="data row0 col1">0.0000</td>
    </tr>
    <tr>
      <td id="T_61988_row1_col0" class="data row1 col0">0.0000</td>
      <td id="T_61988_row1_col1" class="data row1 col1">1.0000</td>
    </tr>
  </tbody>
</table>
 </div><div> <p style="font-size: 1.3rem;">R</p> <style type="text/css">
</style>
<table id="T_d152c">
  <thead>
    <tr>
      <th id="T_d152c_level0_col0" class="col_heading level0 col0">0</th>
      <th id="T_d152c_level0_col1" class="col_heading level0 col1">1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_d152c_row0_col0" class="data row0 col0">1.0000</td>
      <td id="T_d152c_row0_col1" class="data row0 col1">0.0000</td>
    </tr>
    <tr>
      <td id="T_d152c_row1_col0" class="data row1 col0">0.0000</td>
      <td id="T_d152c_row1_col1" class="data row1 col1">1.0000</td>
    </tr>
  </tbody>
</table>
 </div><div> <p style="font-size: 1.3rem;">Q</p> <style type="text/css">
</style>
<table id="T_1fa9c">
  <thead>
    <tr>
      <th id="T_1fa9c_level0_col0" class="col_heading level0 col0">latent</th>
      <th id="T_1fa9c_level0_col1" class="col_heading level0 col1">z_0</th>
      <th id="T_1fa9c_level0_col2" class="col_heading level0 col2">z_1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_1fa9c_row0_col0" class="data row0 col0">z_0</td>
      <td id="T_1fa9c_row0_col1" class="data row0 col1">1.0000</td>
      <td id="T_1fa9c_row0_col2" class="data row0 col2">0.0000</td>
    </tr>
    <tr>
      <td id="T_1fa9c_row1_col0" class="data row1 col0">z_1</td>
      <td id="T_1fa9c_row1_col1" class="data row1 col1">0.0000</td>
      <td id="T_1fa9c_row1_col2" class="data row1 col2">1.0000</td>
    </tr>
  </tbody>
</table>
 </div></div>
</div>
</div>
</section>
</section>
<section id="train-parameters" class="level2">
<h2 class="anchored" data-anchor-id="train-parameters">Train Parameters</h2>
<p>This implementation of <a href="https://mone27.github.io/meteo_imp/lib/kalman/filter.html#kalmanfilter"><code>KalmanFilter</code></a> allows to find the optimal parameters by maximising the log-likelihood using gradient descend</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>training_iter <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> KalmanFilter()</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>k.train()</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(k.parameters(), lr<span class="op">=</span><span class="fl">0.005</span>) </span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a>losses <span class="op">=</span> []</span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(training_iter):</span>
<span id="cb150-9"><a href="#cb150-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Zero gradients from previous iteration</span></span>
<span id="cb150-10"><a href="#cb150-10" aria-hidden="true" tabindex="-1"></a>    optimizer.zero_grad()</span>
<span id="cb150-11"><a href="#cb150-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Output from model</span></span>
<span id="cb150-12"><a href="#cb150-12" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> <span class="op">-</span> k.loglikelihood(X, <span class="bu">range</span>(<span class="bu">len</span>(X)), X)</span>
<span id="cb150-13"><a href="#cb150-13" aria-hidden="true" tabindex="-1"></a>    losses.append(loss.item())</span>
<span id="cb150-14"><a href="#cb150-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># backpropagate gradients</span></span>
<span id="cb150-15"><a href="#cb150-15" aria-hidden="true" tabindex="-1"></a>    loss.backward()</span>
<span id="cb150-16"><a href="#cb150-16" aria-hidden="true" tabindex="-1"></a>    optimizer.step()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>plt.plot(losses)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="00_filter_files/figure-html/cell-111-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(k.parameters())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[Parameter containing:
 tensor([[1.3400094509]], requires_grad=True),
 Parameter containing:
 tensor([0.4287530482], requires_grad=True),
 Parameter containing:
 tensor([[0.1470584720]], requires_grad=True),
 Parameter containing:
 tensor([[0.1455851793]], requires_grad=True),
 Parameter containing:
 tensor([-0.4134024680], requires_grad=True),
 Parameter containing:
 tensor([[0.0268113427]], requires_grad=True),
 Parameter containing:
 tensor([0.4979022741], requires_grad=True),
 Parameter containing:
 tensor([[0.1377424598]], requires_grad=True)]</code></pre>
</div>
</div>
</section>
<section id="other" class="level2">
<h2 class="anchored" data-anchor-id="other">Other</h2>
<section id="testing" class="level3">
<h3 class="anchored" data-anchor-id="testing">Testing</h3>
</section>
<section id="fuzzing-smoother" class="level3">
<h3 class="anchored" data-anchor-id="fuzzing-smoother">Fuzzing smoother</h3>
<p>trying to run the filter many times to see if some of the matrix are not symmetric</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch._C <span class="im">import</span> _LinAlgError</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzz_symmetric(n_iter<span class="op">=</span><span class="dv">10</span>, n_obs<span class="op">=</span><span class="dv">100</span>, <span class="op">**</span>kwargs):</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>    tst <span class="op">=</span> KalmanFilterTester(n_obs<span class="op">=</span>n_obs, <span class="op">**</span>kwargs)</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>    _, sm_covs <span class="op">=</span> tst.<span class="bu">filter</span>.smooth(tst.data, tst.mask)</span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>    i_posdef <span class="op">=</span> []</span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t, cov <span class="kw">in</span> <span class="bu">enumerate</span>(sm_covs):</span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>        i_posdef.append(check_posdef(cov))</span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.concat(i_posdef)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzz_smooth(n_obs<span class="op">=</span><span class="dv">100</span>, <span class="op">**</span>kwargs):</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>    tst <span class="op">=</span> KalmanFilterTester(n_obs<span class="op">=</span>n_obs, <span class="op">**</span>kwargs)</span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>    _, sm_covs <span class="op">=</span> tst.<span class="bu">filter</span>.smooth(tst.data, tst.mask, check_args<span class="op">=</span> {})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_max_obs(start<span class="op">=</span><span class="dv">100_000</span>, end<span class="op">=</span><span class="dv">100</span>, steps<span class="op">=</span><span class="dv">10</span>, <span class="op">**</span>kwargs):</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> n <span class="kw">in</span> torch.logspace(torch.log10(start), torch.log10(end), <span class="dv">10</span>):</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(n, <span class="st">"working"</span>)</span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> _LinAlgError:</span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(n, <span class="st">"not working"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>posdef_log <span class="op">=</span> pd.DataFrame()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>total_warn <span class="op">=</span> []</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">200</span>):</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> warnings.catch_warnings(record<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> w:</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>            fuzz_smooth(n_obs<span class="op">=</span>n)</span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> _LinAlgError:</span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(n)</span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">finally</span>:</span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>            total_warn.append((n, <span class="bu">len</span>(w)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>27</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>posdef_log</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>is_pd_eigv</th>
      <th>is_pd_chol</th>
      <th>is_sym</th>
      <th>sym_upto</th>
      <th>eigv</th>
      <th>matrix</th>
      <th>name</th>
      <th>t</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>-8</td>
      <td>[0.0044204406, 0.51171917, 1.1058657]</td>
      <td>[[0.07919369, 0.21216275, 0.08634329], [0.2121...</td>
      <td>filter_correct</td>
      <td>0</td>
    </tr>
    <tr>
      <th>0</th>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>-8</td>
      <td>[0.14680785, 0.6775383, 5.3274283]</td>
      <td>[[2.041435, 1.3869133, 1.601786], [1.3869132, ...</td>
      <td>filter_predict</td>
      <td>1</td>
    </tr>
    <tr>
      <th>0</th>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>-8</td>
      <td>[0.14680785, 0.6775383, 5.3274283]</td>
      <td>[[2.041435, 1.3869133, 1.601786], [1.3869132, ...</td>
      <td>filter_correct</td>
      <td>1</td>
    </tr>
    <tr>
      <th>0</th>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>-8</td>
      <td>[[0.0044204514, 0.5117193, 1.1058657], [0.0959...</td>
      <td>[[[0.07919369, 0.21216275, 0.08634329], [0.212...</td>
      <td>filter_correct</td>
      <td>0</td>
    </tr>
    <tr>
      <th>0</th>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>-8</td>
      <td>[0.0044204406, 0.51171917, 1.1058657]</td>
      <td>[[0.07919369, 0.21216275, 0.08634329], [0.2121...</td>
      <td>filter_correct</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>0</th>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>-8</td>
      <td>[0.3388391, 0.69478154, 18449.22]</td>
      <td>[[7131.8594, 6422.1284, 6281.904], [6422.1284,...</td>
      <td>filter_correct</td>
      <td>9</td>
    </tr>
    <tr>
      <th>0</th>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>-8</td>
      <td>[0.33459213, 0.6852231, 77041.47]</td>
      <td>[[29782.723, 26819.559, 26233.049], [26819.559...</td>
      <td>filter_predict</td>
      <td>10</td>
    </tr>
    <tr>
      <th>0</th>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>-8</td>
      <td>[0.33459213, 0.6852231, 77041.47]</td>
      <td>[[29782.723, 26819.559, 26233.049], [26819.559...</td>
      <td>filter_correct</td>
      <td>10</td>
    </tr>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>2</td>
      <td>[-797.5366, -56.76306, 29.798246]</td>
      <td>[[-327.70764, -295.44025, -289.2465], [-348.85...</td>
      <td>filter_predict</td>
      <td>11</td>
    </tr>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>2</td>
      <td>[-797.5366, -56.76306, 29.798246]</td>
      <td>[[-327.70764, -295.44025, -289.2465], [-348.85...</td>
      <td>filter_correct</td>
      <td>11</td>
    </tr>
  </tbody>
</table>
<p>198 rows × 8 columns</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> altair <span class="im">as</span> alt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>alt.Chart(pd.DataFrame(total_warn, columns<span class="op">=</span>[<span class="st">"n_obs"</span>, <span class="st">"n_not_posdef"</span>])).mark_line().encode(alt.X(<span class="st">"n_obs"</span>), alt.Y(<span class="st">"n_not_posdef"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/simone/.local/lib/python3.10/site-packages/altair/utils/core.py:317: FutureWarning: iteritems is deprecated and will be removed in a future version. Use .items instead.
  for col_name, dtype in df.dtypes.iteritems():</code></pre>
</div>
<div class="cell-output cell-output-display">

<div id="altair-viz-2f67a1f1cfb14583a13a477928af86c3"></div>
<script type="text/javascript">
  var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG;
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-2f67a1f1cfb14583a13a477928af86c3") {
      outputDiv = document.getElementById("altair-viz-2f67a1f1cfb14583a13a477928af86c3");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@4.17.0?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function maybeLoadScript(lib, version) {
      var key = `${lib.replace("-", "")}_version`;
      return (VEGA_DEBUG[key] == version) ?
        Promise.resolve(paths[lib]) :
        new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          document.getElementsByTagName("head")[0].appendChild(s);
          s.async = true;
          s.onload = () => {
            VEGA_DEBUG[key] = version;
            return resolve(paths[lib]);
          };
          s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
          s.src = paths[lib];
        });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else {
      maybeLoadScript("vega", "5")
        .then(() => maybeLoadScript("vega-lite", "4.17.0"))
        .then(() => maybeLoadScript("vega-embed", "6"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "data": {"name": "data-b10bc7f46a07a942ba21433b332eb9de"}, "mark": "line", "encoding": {"x": {"field": "n_obs", "type": "quantitative"}, "y": {"field": "n_not_posdef", "type": "quantitative"}}, "$schema": "https://vega.github.io/schema/vega-lite/v4.17.0.json", "datasets": {"data-b10bc7f46a07a942ba21433b332eb9de": [{"n_obs": 2, "n_not_posdef": 0}, {"n_obs": 3, "n_not_posdef": 0}, {"n_obs": 4, "n_not_posdef": 0}, {"n_obs": 5, "n_not_posdef": 0}, {"n_obs": 6, "n_not_posdef": 0}, {"n_obs": 7, "n_not_posdef": 0}, {"n_obs": 8, "n_not_posdef": 0}, {"n_obs": 9, "n_not_posdef": 0}, {"n_obs": 10, "n_not_posdef": 0}, {"n_obs": 11, "n_not_posdef": 0}, {"n_obs": 12, "n_not_posdef": 2}]}}, {"mode": "vega-lite"});
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>alt.data_transformers.enable(<span class="st">'data_server'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>DataTransformerRegistry.enable('data_server')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>alt.Chart(posdef_log).mark_line().encode(alt.X(<span class="st">"t"</span>), alt.Y(<span class="st">"average(sym_upto)"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div id="altair-viz-627c2ce957f74a4bbfe8256d64b29023"></div>
<script type="text/javascript">
  var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG;
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-627c2ce957f74a4bbfe8256d64b29023") {
      outputDiv = document.getElementById("altair-viz-627c2ce957f74a4bbfe8256d64b29023");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@4.17.0?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function maybeLoadScript(lib, version) {
      var key = `${lib.replace("-", "")}_version`;
      return (VEGA_DEBUG[key] == version) ?
        Promise.resolve(paths[lib]) :
        new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          document.getElementsByTagName("head")[0].appendChild(s);
          s.async = true;
          s.onload = () => {
            VEGA_DEBUG[key] = version;
            return resolve(paths[lib]);
          };
          s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
          s.src = paths[lib];
        });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else {
      maybeLoadScript("vega", "5")
        .then(() => maybeLoadScript("vega-lite", "4.17.0"))
        .then(() => maybeLoadScript("vega-embed", "6"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "data": {"url": "http://localhost:33689/18996f52761ab3221e555812a344dbfe.json"}, "mark": "line", "encoding": {"x": {"field": "t", "type": "quantitative"}, "y": {"aggregate": "average", "field": "sym_upto", "type": "quantitative"}}, "$schema": "https://vega.github.io/schema/vega-lite/v4.17.0.json"}, {"mode": "vega-lite"});
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>alt.Chart(posdef_log).mark_point().encode(alt.X(<span class="st">"t"</span>), alt.Y(<span class="st">"count(is_sym)"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div id="altair-viz-1ace05bb9bc1483cb22cbfbe34eb7f78"></div>
<script type="text/javascript">
  var VEGA_DEBUG = (typeof VEGA_DEBUG == "undefined") ? {} : VEGA_DEBUG;
  (function(spec, embedOpt){
    let outputDiv = document.currentScript.previousElementSibling;
    if (outputDiv.id !== "altair-viz-1ace05bb9bc1483cb22cbfbe34eb7f78") {
      outputDiv = document.getElementById("altair-viz-1ace05bb9bc1483cb22cbfbe34eb7f78");
    }
    const paths = {
      "vega": "https://cdn.jsdelivr.net/npm//vega@5?noext",
      "vega-lib": "https://cdn.jsdelivr.net/npm//vega-lib?noext",
      "vega-lite": "https://cdn.jsdelivr.net/npm//vega-lite@4.17.0?noext",
      "vega-embed": "https://cdn.jsdelivr.net/npm//vega-embed@6?noext",
    };

    function maybeLoadScript(lib, version) {
      var key = `${lib.replace("-", "")}_version`;
      return (VEGA_DEBUG[key] == version) ?
        Promise.resolve(paths[lib]) :
        new Promise(function(resolve, reject) {
          var s = document.createElement('script');
          document.getElementsByTagName("head")[0].appendChild(s);
          s.async = true;
          s.onload = () => {
            VEGA_DEBUG[key] = version;
            return resolve(paths[lib]);
          };
          s.onerror = () => reject(`Error loading script: ${paths[lib]}`);
          s.src = paths[lib];
        });
    }

    function showError(err) {
      outputDiv.innerHTML = `<div class="error" style="color:red;">${err}</div>`;
      throw err;
    }

    function displayChart(vegaEmbed) {
      vegaEmbed(outputDiv, spec, embedOpt)
        .catch(err => showError(`Javascript Error: ${err.message}<br>This usually means there's a typo in your chart specification. See the javascript console for the full traceback.`));
    }

    if(typeof define === "function" && define.amd) {
      requirejs.config({paths});
      require(["vega-embed"], displayChart, err => showError(`Error loading script: ${err.message}`));
    } else {
      maybeLoadScript("vega", "5")
        .then(() => maybeLoadScript("vega-lite", "4.17.0"))
        .then(() => maybeLoadScript("vega-embed", "6"))
        .catch(showError)
        .then(() => displayChart(vegaEmbed));
    }
  })({"config": {"view": {"continuousWidth": 400, "continuousHeight": 300}}, "data": {"url": "http://localhost:33689/18996f52761ab3221e555812a344dbfe.json"}, "mark": "point", "encoding": {"x": {"field": "t", "type": "quantitative"}, "y": {"aggregate": "count", "field": "is_sym", "type": "nominal"}}, "$schema": "https://vega.github.io/schema/vega-lite/v4.17.0.json"}, {"mode": "vega-lite"});
</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>posdef_log[[<span class="st">"t"</span>, <span class="st">"name"</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>t</th>
      <th>name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>filter_correct</td>
    </tr>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>filter_predict</td>
    </tr>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>filter_correct</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>filter_correct</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>filter_correct</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>0</th>
      <td>9</td>
      <td>filter_correct</td>
    </tr>
    <tr>
      <th>0</th>
      <td>10</td>
      <td>filter_predict</td>
    </tr>
    <tr>
      <th>0</th>
      <td>10</td>
      <td>filter_correct</td>
    </tr>
    <tr>
      <th>0</th>
      <td>11</td>
      <td>filter_predict</td>
    </tr>
    <tr>
      <th>0</th>
      <td>11</td>
      <td>filter_correct</td>
    </tr>
  </tbody>
</table>
<p>198 rows × 2 columns</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>plt.scatter(posdef_log.reset_index().index, posdef_log.sym_upto)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;matplotlib.collections.PathCollection&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="00_filter_files/figure-html/cell-127-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 2 µs, sys: 0 ns, total: 2 µs
Wall time: 3.58 µs
CPU times: user 2 µs, sys: 0 ns, total: 2 µs
Wall time: 2.86 µs
CPU times: user 2 µs, sys: 0 ns, total: 2 µs
Wall time: 2.86 µs</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="co"># find_max_obs(dtype=torch.float64)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The function takes 5 min to run so this is the output saved</p>
<p>with <code>float64</code> there is no problem with positive definite matrices even with 100k observations <code>CPU times: user 30min 43s, sys: 28.6 s, total: 31min 11s Wall time: 5min 26s tensor(100000.) working</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>tst <span class="op">=</span> KalmanFilterTester(n_obs<span class="op">=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>is_posdef(tst.params[<span class="st">'obs_cov'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>True</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>is_posdef(tst.params[<span class="st">'trans_cov'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>True</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>is_posdef(tst.params[<span class="st">'init_state_cov'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>True</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>tst.<span class="bu">filter</span>.smooth(tst.data, tst.mask)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>_LinAlgError: linalg.cholesky: The factorization could not be completed because the input is not positive-definite (the leading minor of order 1 is not positive-definite).</code></pre>
</div>
</div>
<section id="random-testing" class="level4">
<h4 class="anchored" data-anchor-id="random-testing">Random Testing</h4>
<p>The goal is to generate random set of data and parameters and check that <code>meteo_imp</code> implementation is the same of <code>pykalman</code> implementation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>n_dim_state <span class="op">=</span> <span class="dv">3</span> </span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>n_dim_obs <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>n_obs <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>p_missing <span class="op">=</span> <span class="fl">.3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>to_posdef <span class="op">=</span> PosDef().transform</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> torch.rand(n_obs, n_dim_obs)</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> torch.rand(n_obs, n_dim_obs) <span class="op">&gt;</span> p_missing</span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> mask.<span class="bu">all</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>mask[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>mask[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> {</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'trans_matrices'</span>: torch.rand(n_dim_state, n_dim_state),</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'trans_offsets'</span>:  torch.rand(n_dim_state),        </span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'trans_cov'</span>:      to_posdef(torch.rand(n_dim_state, n_dim_state)),        </span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'obs_matrices'</span>:        torch.rand(n_dim_obs, n_dim_state),</span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'obs_offsets'</span>:         torch.rand(n_dim_obs),          </span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'obs_cov'</span>:             to_posdef(torch.rand(n_dim_obs, n_dim_obs)),            </span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'init_state_mean'</span>:  torch.rand(n_dim_state),        </span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'init_state_cov'</span>:   to_posdef(torch.rand(n_dim_state, n_dim_state)),</span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>params2pyk <span class="op">=</span> {</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'trans_matrices'</span>: <span class="st">'trans_matrices'</span>,</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'trans_offsets'</span>:  <span class="st">'trans_offsets'</span>,        </span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'trans_cov'</span>:      <span class="st">'trans_covariance'</span>,        </span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'obs_matrices'</span>:        <span class="st">'observation_matrices'</span>,</span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'obs_offsets'</span>:         <span class="st">'observation_offsets'</span>,          </span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'obs_cov'</span>:             <span class="st">'observation_covariance'</span>,            </span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'init_state_mean'</span>:  <span class="st">'init_state_mean'</span>,        </span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'init_state_cov'</span>:   <span class="st">'init_state_covariance'</span>,</span>
<span id="cb192-10"><a href="#cb192-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>params</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> KalmanFilter(<span class="op">**</span>params)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> k.smooth(data, mask)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>make a <code>pykalman</code> model using the same parameters</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>data_pyk <span class="op">=</span> np.ma.masked_array(data.numpy(), mask <span class="op">=</span> mask.numpy())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>pyk_k <span class="op">=</span> pykalman.standard.KalmanFilter(</span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a>    trans_matrices<span class="op">=</span>k.trans_matrices.detach().numpy(),</span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a>    trans_offsets<span class="op">=</span>k.trans_offsets.detach().numpy(),</span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a>    trans_covariance<span class="op">=</span>k.trans_cov.detach().numpy(),</span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a>    observation_matrices<span class="op">=</span>k.obs_matrices.detach().numpy(),</span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a>    observation_offsets<span class="op">=</span>k.obs_offsets.detach().numpy(),</span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a>    observation_covariance<span class="op">=</span>k.obs_cov.detach().numpy(),</span>
<span id="cb197-9"><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a>    init_state_mean<span class="op">=</span>k.init_state_mean.detach().numpy(),</span>
<span id="cb197-10"><a href="#cb197-10" aria-hidden="true" tabindex="-1"></a>    init_state_covariance<span class="op">=</span>k.init_state_cov.detach().numpy()</span>
<span id="cb197-11"><a href="#cb197-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>pred_pyk <span class="op">=</span> pyk_k.smooth(data_pyk)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> params.keys():</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(p, <span class="bu">getattr</span>(k, p))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> params.keys():</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(p, <span class="bu">getattr</span>(pyk_k, params2pyk[p]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="compare-statsmodels" class="level3">
<h3 class="anchored" data-anchor-id="compare-statsmodels">Compare Statsmodels</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sm_kf = statsmodels.tsa.statespace.kalman_filter.KalmanFilter(</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a><span class="co">#     k_endog = 3,</span></span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a><span class="co">#     k_states = 3,</span></span>
<span id="cb202-4"><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a><span class="co">#     initization = 'known',</span></span>
<span id="cb202-5"><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     init_state = pyk_ncov.init_state_mean,</span></span>
<span id="cb202-6"><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a><span class="co">#     init_state_cov = pyk_ncov.init_state_covariance,</span></span>
<span id="cb202-7"><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     design = pyk_ncov.observation_matrices,</span></span>
<span id="cb202-8"><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     obs_cov = pyk_ncov.observation_covariance,</span></span>
<span id="cb202-9"><a href="#cb202-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     trans = pyk_ncov.trans_matrices,</span></span>
<span id="cb202-10"><a href="#cb202-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     state_cov = pyk_ncov.trans_covariance)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sm_kf.bind(X_ncov.detach().numpy())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sm_pred = sm_kf.filter()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sm_pred.predicted_state.shape</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sm_pred.predicted_state_cov.shape</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mean = MultivariateNormal(torch.tensor(sm_pred.predicted_state[:, 0]), torch.tensor(sm_pred.predicted_state_cov[:, :, 0]))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sm_kf.loglikeobs()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="export" class="level2">
<h2 class="anchored" data-anchor-id="export">Export</h2>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>