<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.119">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend">

<title>meteo_imp - Kalman Filter</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="meteo_imp - Kalman Filter">
<meta property="og:description" content="Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend">
<meta property="og:site-name" content="meteo_imp">
<meta name="twitter:title" content="meteo_imp - Kalman Filter">
<meta name="twitter:description" content="Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">meteo_imp</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Kalman Filter</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">GPFA Imputation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../data_preparation.html" class="sidebar-item-text sidebar-link">Data Preparation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../results.html" class="sidebar-item-text sidebar-link">Results</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../simplegp_imputation.html" class="sidebar-item-text sidebar-link">Simple GP Imputation</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gaussian.html" class="sidebar-item-text sidebar-link">Gaussian Distributions Utils</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../utils.html" class="sidebar-item-text sidebar-link">Utils</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Fluxnet</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Fluxnet/gap_finder.html" class="sidebar-item-text sidebar-link">Find Gaps in Fluxnet data</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../Fluxnet/hainich.html" class="sidebar-item-text sidebar-link">Fluxnet Hainich</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">GPFA</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../GPFA/gpfa.html" class="sidebar-item-text sidebar-link">Gaussian Processes Factor Analysis</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../GPFA/learner.html" class="sidebar-item-text sidebar-link">GPFA Learner</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../GPFA/imputation.html" class="sidebar-item-text sidebar-link">Imputation time series</a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">kalman</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/filter.html" class="sidebar-item-text sidebar-link active">Kalman Filter</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/test_filter_pykalman.html" class="sidebar-item-text sidebar-link">Compare PyKalman</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/filter_numerical_stability.html" class="sidebar-item-text sidebar-link">Numerical stability filter</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/fastai.html" class="sidebar-item-text sidebar-link">Implement Kalman model using FastAI</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/learner.html" class="sidebar-item-text sidebar-link">Kalman Filter Models</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/imputation.html" class="sidebar-item-text sidebar-link">Imputation Kalman Model</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/old statsmodels - statespace.html" class="sidebar-item-text sidebar-link">[Not Working] StatsModels Kalman filter</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/old_01_pykalman_models.html" class="sidebar-item-text sidebar-link">[OLD] PyKalman Filter Models</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../kalman/old_02_pykalman_imputation.html" class="sidebar-item-text sidebar-link">[OLD] Imputation PyKalman Model</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#equations" id="toc-equations" class="nav-link" data-scroll-target="#equations">Equations</a></li>
  </ul></li>
  <li><a href="#main-class" id="toc-main-class" class="nav-link" data-scroll-target="#main-class">Main class</a>
  <ul class="collapse">
  <li><a href="#kalmanfilter" id="toc-kalmanfilter" class="nav-link" data-scroll-target="#kalmanfilter">KalmanFilter</a></li>
  </ul></li>
  <li><a href="#constructors" id="toc-constructors" class="nav-link" data-scroll-target="#constructors">Constructors</a>
  <ul class="collapse">
  <li><a href="#random-parameters" id="toc-random-parameters" class="nav-link" data-scroll-target="#random-parameters">Random parameters</a></li>
  <li><a href="#kalmanfilter.init_random" id="toc-kalmanfilter.init_random" class="nav-link" data-scroll-target="#kalmanfilter.init_random">KalmanFilter.init_random</a></li>
  <li><a href="#test-data" id="toc-test-data" class="nav-link" data-scroll-target="#test-data">Test data</a></li>
  </ul></li>
  <li><a href="#filter" id="toc-filter" class="nav-link" data-scroll-target="#filter">Filter</a>
  <ul class="collapse">
  <li><a href="#filter-predict" id="toc-filter-predict" class="nav-link" data-scroll-target="#filter-predict">Filter predict</a></li>
  <li><a href="#unsqueeze_iter" id="toc-unsqueeze_iter" class="nav-link" data-scroll-target="#unsqueeze_iter">unsqueeze_iter</a></li>
  <li><a href="#filter-predict-ud" id="toc-filter-predict-ud" class="nav-link" data-scroll-target="#filter-predict-ud">Filter Predict UD</a></li>
  <li><a href="#filter-correct" id="toc-filter-correct" class="nav-link" data-scroll-target="#filter-correct">Filter correct</a></li>
  <li><a href="#filter-1" id="toc-filter-1" class="nav-link" data-scroll-target="#filter-1">Filter</a></li>
  <li><a href="#kalmanfilter-method" id="toc-kalmanfilter-method" class="nav-link" data-scroll-target="#kalmanfilter-method">KalmanFilter method</a></li>
  <li><a href="#kalmanfilter.filter" id="toc-kalmanfilter.filter" class="nav-link" data-scroll-target="#kalmanfilter.filter">KalmanFilter.filter</a></li>
  </ul></li>
  <li><a href="#smooth" id="toc-smooth" class="nav-link" data-scroll-target="#smooth">Smooth</a>
  <ul class="collapse">
  <li><a href="#smooth-step" id="toc-smooth-step" class="nav-link" data-scroll-target="#smooth-step">Smooth step</a></li>
  <li><a href="#smooth-1" id="toc-smooth-1" class="nav-link" data-scroll-target="#smooth-1">Smooth</a></li>
  <li><a href="#kalmanfilter-method-1" id="toc-kalmanfilter-method-1" class="nav-link" data-scroll-target="#kalmanfilter-method-1">KalmanFilter method</a></li>
  <li><a href="#kalmanfilter.smooth" id="toc-kalmanfilter.smooth" class="nav-link" data-scroll-target="#kalmanfilter.smooth">KalmanFilter.smooth</a></li>
  </ul></li>
  <li><a href="#predict" id="toc-predict" class="nav-link" data-scroll-target="#predict">Predict</a>
  <ul class="collapse">
  <li><a href="#kalmanfilter.predict" id="toc-kalmanfilter.predict" class="nav-link" data-scroll-target="#kalmanfilter.predict">KalmanFilter.predict</a></li>
  </ul></li>
  <li><a href="#additional" id="toc-additional" class="nav-link" data-scroll-target="#additional">Additional</a>
  <ul class="collapse">
  <li><a href="#get-info" id="toc-get-info" class="nav-link" data-scroll-target="#get-info">Get Info</a></li>
  <li><a href="#kalmanfilter.get_info" id="toc-kalmanfilter.get_info" class="nav-link" data-scroll-target="#kalmanfilter.get_info">KalmanFilter.get_info</a></li>
  <li><a href="#constructors-1" id="toc-constructors-1" class="nav-link" data-scroll-target="#constructors-1">Constructors</a></li>
  <li><a href="#kalmanfilter.init_simple" id="toc-kalmanfilter.init_simple" class="nav-link" data-scroll-target="#kalmanfilter.init_simple">KalmanFilter.init_simple</a></li>
  <li><a href="#kalmanfilter.init_local_slope_pca" id="toc-kalmanfilter.init_local_slope_pca" class="nav-link" data-scroll-target="#kalmanfilter.init_local_slope_pca">KalmanFilter.init_local_slope_pca</a></li>
  </ul></li>
  <li><a href="#export" id="toc-export" class="nav-link" data-scroll-target="#export">Export</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/mone27/meteo_imp/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Kalman Filter</h1>
</div>

<div>
  <div class="description">
    Implementation of Kalman filters using pytorch and parameter optimizations with gradient descend
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The models uses a latent state variable <span class="math inline">\(x\)</span> that is modelled over time, to impute gaps in <span class="math inline">\(y\)</span></p>
<p>The assumption of the model is that the state variable at time <span class="math inline">\(x_t\)</span> depends only on the last state <span class="math inline">\(x_{t-1}\)</span> and not on the previous states.</p>
<section id="equations" class="level3">
<h3 class="anchored" data-anchor-id="equations">Equations</h3>
<p>The equations of the model are:</p>
<p><span class="math display">\[\begin{align} p(x_t | x_{t-1}) &amp; = \mathcal{N}(Ax_{t-1} + b, Q) \\
p(y_t | x_t) &amp; = \mathcal{N}(Hx_t + d, R) \end{align}\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(A\)</span> is the <code>trans_matrix</code></li>
<li><span class="math inline">\(b\)</span> is the <code>trans_offset</code></li>
<li><span class="math inline">\(Q\)</span> is the <code>trans_cov</code></li>
<li><span class="math inline">\(H\)</span> is the <code>obs_trans</code></li>
<li><span class="math inline">\(d\)</span> is the <code>obs_off</code></li>
<li><span class="math inline">\(R\)</span> is the <code>obs_cov</code></li>
</ul>
<p>in addition the model has also the parameters of the initial state that are used to initialize the filter:</p>
<ul>
<li><code>init_state_mean</code></li>
<li><code>init_state_cov</code></li>
</ul>
<p>The Kalman filter has 3 steps:</p>
<ul>
<li>filter (updating the state at time t with observations till time t-1)</li>
<li>update (update the state at time t using the observation at time t)</li>
<li>smooth (update the state using the observations at time t+1)</li>
</ul>
<p>In case of missing data the update step is skipped.</p>
<p>After smoothing the missing data at time t (<span class="math inline">\(y_t\)</span>) can be imputed from the state (<span class="math inline">\(x_t\)</span>) using this formula: <span class="math display">\[p(y_t|x_t) = \mathcal{N}(Hx_t + d, R + HP^s_tH^T)\]</span></p>
<p>The Kalman Filter is an algorithm designed to estimate <span class="math inline">\(P(x_t | y_{0:t})\)</span>. As all state transitions and obss are linear with Gaussian distributed noise, these distributions can be represented exactly as Gaussian distributions with mean <code>filt_state_means[t]</code> and covs <code>filt_state_covs[t]</code>. Similarly, the Kalman Smoother is an algorithm designed to estimate <span class="math inline">\(P(x_t | y_{0:t-1})\)</span></p>
</section>
</section>
<section id="main-class" class="level2">
<h2 class="anchored" data-anchor-id="main-class">Main class</h2>
<p>TODO: fill nans with 0 for all data</p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L22" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="kalmanfilter" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter">KalmanFilter</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter (trans_matrix:torch.Tensor, obs_matrix:torch.Tensor,
               contr_matrix:torch.Tensor, trans_cov:torch.Tensor,
               obs_cov:torch.Tensor, trans_off:torch.Tensor,
               obs_off:torch.Tensor, init_state_mean:torch.Tensor,
               init_state_cov:torch.Tensor, n_dim_state:int=None,
               n_dim_obs:int=None, var_names:Optional[Iterable[str]]=None,
               contr_names:Optional[Iterable[str]]=None, cov_checker:meteo
               _imp.gaussian.CheckPosDef=&lt;meteo_imp.gaussian.CheckPosDef
               object at 0x7f6b10f1d6c0&gt;, use_conditional:bool=True,
               use_control:bool=True, use_smooth:bool=True)</code></pre>
</blockquote>
<p>Base class for Kalman Filter and Smoother using PyTorch</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>trans_matrix</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state,n_dim_state] <span class="math inline">\(A\)</span>, state transition matrix</td>
</tr>
<tr class="even">
<td>obs_matrix</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_state] <span class="math inline">\(H\)</span>, observation matrix</td>
</tr>
<tr class="odd">
<td>contr_matrix</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_contr] <span class="math inline">\(B\)</span> control matrix</td>
</tr>
<tr class="even">
<td>trans_cov</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(Q\)</span>, state trans covariance matrix</td>
</tr>
<tr class="odd">
<td>obs_cov</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs, n_dim_obs] <span class="math inline">\(R\)</span>, observations covariance matrix</td>
</tr>
<tr class="even">
<td>trans_off</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(b\)</span>, state transition offset</td>
</tr>
<tr class="odd">
<td>obs_off</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_obs] <span class="math inline">\(d\)</span>, observations offset</td>
</tr>
<tr class="even">
<td>init_state_mean</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state] <span class="math inline">\(\mu_0\)</span></td>
</tr>
<tr class="odd">
<td>init_state_cov</td>
<td>Tensor</td>
<td></td>
<td>[n_dim_state, n_dim_state] <span class="math inline">\(\Sigma_0\)</span></td>
</tr>
<tr class="even">
<td>n_dim_state</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for state - defaults to 1 if cannot be infered from parameters</td>
</tr>
<tr class="odd">
<td>n_dim_obs</td>
<td>int</td>
<td>None</td>
<td>Number of dimensions for observations - defaults to 1 if cannot be infered from parameters</td>
</tr>
<tr class="even">
<td>var_names</td>
<td>Optional</td>
<td>None</td>
<td>Names of variables for printing</td>
</tr>
<tr class="odd">
<td>contr_names</td>
<td>Optional</td>
<td>None</td>
<td>Names of control variables for printing</td>
</tr>
<tr class="even">
<td>cov_checker</td>
<td>CheckPosDef</td>
<td>&lt;meteo_imp.gaussian.CheckPosDef object at 0x7f6b10f1d6c0&gt;</td>
<td>Check covariance at every step</td>
</tr>
<tr class="odd">
<td>use_conditional</td>
<td>bool</td>
<td>True</td>
<td>Use conditional distribution for gaps that don’t have all variables missing</td>
</tr>
<tr class="even">
<td>use_control</td>
<td>bool</td>
<td>True</td>
<td>Use the control in the filter</td>
</tr>
<tr class="odd">
<td>use_smooth</td>
<td>bool</td>
<td>True</td>
<td>Use smoother for predictions (otherwise is filter only)</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="constructors" class="level2">
<h2 class="anchored" data-anchor-id="constructors">Constructors</h2>
<p>Giving all the parameters manually to the <a href="https://mone27.github.io/meteo_imp/lib/kalman/filter.html#kalmanfilter"><code>KalmanFilter</code></a> init method is not convenient, hence we are having some methods that help initize the class</p>
<section id="random-parameters" class="level3">
<h3 class="anchored" data-anchor-id="random-parameters">Random parameters</h3>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L139" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter.init_random" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.init_random">KalmanFilter.init_random</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.init_random (n_dim_obs, n_dim_state, n_dim_contr,
                           dtype=torch.float32, **kwargs)</code></pre>
</blockquote>
<p>kalman filter with random parameters</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> KalmanFilter.init_random(<span class="dv">3</span>,<span class="dv">4</span>, <span class="dv">3</span>, dtype<span class="op">=</span>torch.float64)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>k</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Kalman Filter
        N dim obs: 3, N dim state: 4, N dim contr: 3</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>k.init_state_cov</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[1.6851, 0.7489, 0.8997, 1.8571],
        [0.7489, 0.9445, 0.8723, 1.2171],
        [0.8997, 0.8723, 0.9059, 1.2618],
        [1.8571, 1.2171, 1.2618, 2.4334]], dtype=torch.float64,
       grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
<p>check that assigment works :)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>k.init_state_cov <span class="op">=</span> to_posdef(torch.rand(<span class="dv">4</span>, <span class="dv">4</span>, dtype<span class="op">=</span>torch.float64))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>k.init_state_cov_raw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Parameter containing:
tensor([[ 1.4412,  0.0000,  0.0000,  0.0000],
        [ 0.8133,  0.6769,  0.0000,  0.0000],
        [ 0.7504, -0.0333,  0.2076,  0.0000],
        [ 0.3364,  0.0307, -0.2374,  0.1300]], dtype=torch.float64,
       requires_grad=True)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(k.named_parameters())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[('trans_matrix',
  Parameter containing:
  tensor([[0.0358, 0.1662, 0.7741, 0.7937],
          [0.7183, 0.5141, 0.4918, 0.2773],
          [0.6901, 0.8565, 0.3723, 0.3410],
          [0.4035, 0.0591, 0.6836, 0.8306]], dtype=torch.float64,
         requires_grad=True)),
 ('trans_off',
  Parameter containing:
  tensor([0.4312, 0.0210, 0.0032, 0.9010], dtype=torch.float64,
         requires_grad=True)),
 ('trans_cov_raw',
  Parameter containing:
  tensor([[ 1.0125,  0.0000,  0.0000,  0.0000],
          [ 1.0871,  0.8975,  0.0000,  0.0000],
          [ 0.7836, -0.1072,  0.5750,  0.0000],
          [ 1.4338,  0.5792,  0.2001,  0.1476]], dtype=torch.float64,
         requires_grad=True)),
 ('contr_matrix',
  Parameter containing:
  tensor([[0.5282, 0.1294, 0.2746],
          [0.5556, 0.6463, 0.0023],
          [0.1761, 0.3391, 0.3346],
          [0.4655, 0.8172, 0.4176]], dtype=torch.float64, requires_grad=True)),
 ('obs_matrix',
  Parameter containing:
  tensor([[0.1349, 0.0519, 0.1180, 0.9767],
          [0.1679, 0.8635, 0.3753, 0.9760],
          [0.2125, 0.8049, 0.2124, 0.6794]], dtype=torch.float64,
         requires_grad=True)),
 ('obs_off',
  Parameter containing:
  tensor([0.0037, 0.9711, 0.5679], dtype=torch.float64, requires_grad=True)),
 ('obs_cov_raw',
  Parameter containing:
  tensor([ 0.7147, -0.2276,  0.5474], dtype=torch.float64, requires_grad=True)),
 ('init_state_mean',
  Parameter containing:
  tensor([0.6498, 0.3257, 0.8462, 0.7727], dtype=torch.float64,
         requires_grad=True)),
 ('init_state_cov_raw',
  Parameter containing:
  tensor([[ 1.4412,  0.0000,  0.0000,  0.0000],
          [ 0.8133,  0.6769,  0.0000,  0.0000],
          [ 0.7504, -0.0333,  0.2076,  0.0000],
          [ 0.3364,  0.0307, -0.2374,  0.1300]], dtype=torch.float64,
         requires_grad=True))]</code></pre>
</div>
</div>
</section>
<section id="test-data" class="level3">
<h3 class="anchored" data-anchor-id="test-data">Test data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>reset_seed()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>data, mask, control <span class="op">=</span> get_test_data(dtype<span class="op">=</span>torch.float64)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>show_as_row(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">data</p> <pre>tensor([[[0.8775,    nan,    nan],
         [0.6706,    nan, 0.9272],
         [   nan, 0.4967,    nan],
         [   nan,    nan,    nan],
         [   nan,    nan, 0.4760],
         [0.7606, 0.7759, 0.5243],
         [0.3714, 0.0426, 0.2343],
         [0.9991, 0.1775,    nan],
         [0.6734,    nan, 0.6468],
         [0.5825, 0.4599, 0.7960]],

        [[0.9038, 0.9735, 0.6428],
         [0.3725, 0.2052,    nan],
         [0.4448, 0.5775, 0.7237],
         [0.5927,    nan, 0.6441],
         [   nan, 0.9132, 0.0329],
         [0.4856, 0.9927, 0.5895],
         [0.2611, 0.9413, 0.1371],
         [0.8726, 0.5590, 0.8451],
         [0.1253, 0.9434, 0.0462],
         [0.2360, 0.0239, 0.8950]]], dtype=torch.float64)</pre> </div><div><p style="font-size: 1.2rem;">mask</p> <pre>tensor([[[ True, False, False],
         [ True, False,  True],
         [False,  True, False],
         [False, False, False],
         [False, False,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True, False],
         [ True, False,  True],
         [ True,  True,  True]],

        [[ True,  True,  True],
         [ True,  True, False],
         [ True,  True,  True],
         [ True, False,  True],
         [False,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True],
         [ True,  True,  True]]])</pre> </div><div><p style="font-size: 1.2rem;">control</p> <pre>tensor([[[0.9201, 0.6883, 0.5342],
         [0.7847, 0.3137, 0.1778],
         [0.5838, 0.9799, 0.3611],
         [0.3155, 0.7475, 0.5450],
         [0.5641, 0.2493, 0.8323],
         [0.9723, 0.1883, 0.3605],
         [0.5344, 0.3443, 0.7696],
         [0.3410, 0.7553, 0.3177],
         [0.0315, 0.5209, 0.6514],
         [0.3131, 0.4510, 0.3550]],

        [[0.4790, 0.0676, 0.3606],
         [0.7299, 0.6713, 0.3134],
         [0.7460, 0.1291, 0.4653],
         [0.5693, 0.9906, 0.8288],
         [0.9039, 0.5240, 0.6277],
         [0.3574, 0.0076, 0.6530],
         [0.8667, 0.9368, 0.8667],
         [0.6749, 0.3526, 0.6618],
         [0.0837, 0.7188, 0.7247],
         [0.3211, 0.4898, 0.9030]]], dtype=torch.float64)</pre> </div></div>
</div>
</div>
</section>
</section>
<section id="filter" class="level2">
<h2 class="anchored" data-anchor-id="filter">Filter</h2>
<section id="filter-predict" class="level3">
<h3 class="anchored" data-anchor-id="filter-predict">Filter predict</h3>
<p>Probability of state at time <code>t</code> given state a time <code>t-1</code></p>
<p><span class="math inline">\(p(x_t) = \mathcal{N}(x_t; m_t^-, P_t^-)\)</span> where:</p>
<ul>
<li><p>predicted state mean: <span class="math inline">\(m_t^- = Am_{t-1} + B c_t + b\)</span></p></li>
<li><p>predicted state covariance: <span class="math inline">\(P_t^- = AP_{t-1}A^T + Q\)</span></p></li>
</ul>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L164" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="unsqueeze_iter" class="level3">
<h3 class="anchored" data-anchor-id="unsqueeze_iter">unsqueeze_iter</h3>
<blockquote class="blockquote">
<pre><code> unsqueeze_iter (*args, dim)</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>trans_matrix, trans_cov, trans_off, contr_matrix, curr_state_mean,curr_state_cov <span class="op">=</span> (k.trans_matrix, k.trans_cov, k.trans_off,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                                                  k.contr_matrix,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                                                  torch.stack([k.init_state_mean]<span class="op">*</span><span class="dv">2</span>).unsqueeze(<span class="op">-</span><span class="dv">1</span>),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>                                                  torch.stack([k.init_state_cov]<span class="op">*</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>pred_state_mean, pred_state_cov <span class="op">=</span> _filter_predict(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    trans_matrix, trans_cov, trans_off, contr_matrix,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    curr_state_mean,curr_state_cov, control[:,<span class="dv">0</span>,:])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>show_as_row(pred_state_mean, pred_state_cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">pred_state_mean</p> <pre>tensor([[[2.4986],
         [2.2429],
         [1.8833],
         [3.6164]],

        [[2.1377],
         [1.5964],
         [1.5371],
         [2.8315]]], dtype=torch.float64, grad_fn=<addbackward0>)</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">pred_state_cov</p> <pre>tensor([[[2.1193, 3.1231, 3.0197, 2.9402],
         [3.1231, 5.7751, 4.9480, 4.8186],
         [3.0197, 4.9480, 5.6400, 4.1710],
         [2.9402, 4.8186, 4.1710, 4.4912]],

        [[2.1193, 3.1231, 3.0197, 2.9402],
         [3.1231, 5.7751, 4.9480, 4.8186],
         [3.0197, 4.9480, 5.6400, 4.1710],
         [2.9402, 4.8186, 4.1710, 4.4912]]], dtype=torch.float64,
       grad_fn=<addbackward0>)</addbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>show_as_row((pred_state_mean.shape, pred_state_cov.shape,))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]))</pre> </div></div>
</div>
</div>
</section>
<section id="filter-predict-ud" class="level3">
<h3 class="anchored" data-anchor-id="filter-predict-ud">Filter Predict UD</h3>
<section id="udu-decomposition" class="level4">
<h4 class="anchored" data-anchor-id="udu-decomposition">UDU Decomposition</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>Lc <span class="op">=</span> torch.linalg.cholesky(trans_cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>Lc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[ 1.0125,  0.0000,  0.0000,  0.0000],
        [ 1.0871,  0.8976,  0.0000,  0.0000],
        [ 0.7836, -0.1072,  0.5750,  0.0000],
        [ 1.4338,  0.5792,  0.2001,  0.1477]], dtype=torch.float64,
       grad_fn=&lt;LinalgCholeskyExBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>D0 <span class="op">=</span> torch.diag(Lc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>D0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([1.0125, 0.8976, 0.5750, 0.1477], dtype=torch.float64,
       grad_fn=&lt;DiagBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>D0.unsqueeze(<span class="dv">0</span>).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([1, 4])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>L <span class="op">=</span> Lc <span class="op">/</span> D0.unsqueeze(<span class="dv">0</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>L</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[ 1.0000,  0.0000,  0.0000,  0.0000],
        [ 1.0737,  1.0000,  0.0000,  0.0000],
        [ 0.7740, -0.1194,  1.0000,  0.0000],
        [ 1.4161,  0.6454,  0.3479,  1.0000]], dtype=torch.float64,
       grad_fn=&lt;DivBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>D <span class="op">=</span> D0.<span class="bu">pow</span>(<span class="dv">2</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>D</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([1.0251, 0.8056, 0.3306, 0.0218], dtype=torch.float64,
       grad_fn=&lt;PowBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>L <span class="op">@</span> torch.diag(D) <span class="op">@</span> L.T <span class="op">-</span> trans_cov</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[-2.2204e-16,  0.0000e+00, -2.2204e-16,  0.0000e+00],
        [ 0.0000e+00,  0.0000e+00,  0.0000e+00,  0.0000e+00],
        [-2.2204e-16, -1.1102e-16, -3.3307e-16, -2.2204e-16],
        [ 0.0000e+00,  0.0000e+00, -2.2204e-16,  4.4409e-16]],
       dtype=torch.float64, grad_fn=&lt;SubBackward0&gt;)</code></pre>
</div>
</div>
<p>can compute gradients</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>L.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Cannot used PyTorch LDL function, because it doesn’t compute gradients, and in any case we don’t need it! We can use just use the cholesky decomposition. Actually we may just use cholesky directly and <span class="math inline">\(I\)</span> for the diagonal …</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> to_posdef(torch.rand(<span class="dv">2</span>, <span class="dv">3</span>,<span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>torch.diagonal(A, dim1<span class="op">=-</span><span class="dv">2</span>, dim2<span class="op">=-</span><span class="dv">1</span>).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> udu_decomposition(A):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    L <span class="op">=</span> torch.linalg.cholesky(A)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    D0 <span class="op">=</span> torch.diagonal(L, dim1<span class="op">=-</span><span class="dv">2</span>, dim2<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    U <span class="op">=</span> L <span class="op">/</span> D0.unsqueeze(<span class="op">-</span><span class="dv">2</span>)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    D <span class="op">=</span> D0.<span class="bu">pow</span>(<span class="dv">2</span>)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> U, D</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>U, D <span class="op">=</span> udu_decomposition(A)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>torch.diag_embed(D), D</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[[1.3610, 0.0000, 0.0000],
          [0.0000, 0.1577, 0.0000],
          [0.0000, 0.0000, 0.0253]],
 
         [[1.6047, 0.0000, 0.0000],
          [0.0000, 0.0966, 0.0000],
          [0.0000, 0.0000, 0.0751]]]),
 tensor([[1.3610, 0.1577, 0.0253],
         [1.6047, 0.0966, 0.0751]]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    A <span class="op">=</span> to_posdef(torch.rand(<span class="dv">5</span>, <span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    U,D <span class="op">=</span> udu_decomposition(A)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    test_close(A, U <span class="op">@</span> torch.diag_embed(D) <span class="op">@</span> U.mT)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>torch.diag(trans_cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([1.0251, 1.9873, 0.9562, 2.4531], dtype=torch.float64,
       grad_fn=&lt;DiagBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>udu_decomposition(torch.diag(torch.diag(trans_cov)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[1., 0., 0., 0.],
         [0., 1., 0., 0.],
         [0., 0., 1., 0.],
         [0., 0., 0., 1.]], dtype=torch.float64, grad_fn=&lt;DivBackward0&gt;),
 tensor([1.0251, 1.9873, 0.9562, 2.4531], dtype=torch.float64,
        grad_fn=&lt;PowBackward0&gt;))</code></pre>
</div>
</div>
<p>The first step is to decompose the trans_covariance matrix Q <span class="math display">\[    Q = GD_QG^T \]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>G, D_Q <span class="op">=</span> udu_decomposition(trans_cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><span class="math display">\[W = \begin{bmatrix}AU_{t-1}&amp;G\end{bmatrix}\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>U_curr, D_curr <span class="op">=</span> udu_decomposition(curr_state_cov[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> torch.hstack([trans_matrix <span class="op">@</span> U_curr, G])</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>W</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[ 0.7179,  0.1642, -0.1333,  0.7937,  1.0000,  0.0000,  0.0000,  0.0000],
        [ 1.3292,  0.5025,  0.1748,  0.2773,  1.0737,  1.0000,  0.0000,  0.0000],
        [ 1.4469,  0.8537, -0.0175,  0.3410,  0.7740, -0.1194,  1.0000,  0.0000],
        [ 0.9866,  0.0631, -0.2660,  0.8306,  1.4161,  0.6454,  0.3479,  1.0000]],
       dtype=torch.float64, grad_fn=&lt;CatBackward0&gt;)</code></pre>
</div>
</div>
<p><span class="math display">\[ D_w = \begin{bmatrix}D_{t-1} &amp; 0 \\ 0&amp; D_Q \end{bmatrix}\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>Dw <span class="op">=</span> torch.diag(torch.hstack([D_curr, D_Q]))</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>Dw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[2.0770, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
        [0.0000, 0.4582, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
        [0.0000, 0.0000, 0.0431, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
        [0.0000, 0.0000, 0.0000, 0.0169, 0.0000, 0.0000, 0.0000, 0.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 1.0251, 0.0000, 0.0000, 0.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.8056, 0.0000, 0.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.3306, 0.0000],
        [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0218]],
       dtype=torch.float64, grad_fn=&lt;DiagBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>W.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([4, 8])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>C_dw <span class="op">=</span> Dw.sqrt()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>C_dw.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([8, 8])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>Q, R <span class="op">=</span> torch.linalg.qr((W <span class="op">@</span> C_dw).mT)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>Q, R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[-0.7107, -0.3610,  0.4193, -0.2126],
         [-0.0763, -0.1629,  0.3247, -0.2840],
         [ 0.0190, -0.0712,  0.0029, -0.1181],
         [-0.0710,  0.1072, -0.0504,  0.0055],
         [-0.6955,  0.3739, -0.4589,  0.2447],
         [-0.0000, -0.8287, -0.4603,  0.2697],
         [-0.0000, -0.0000,  0.5419,  0.7722],
         [-0.0000, -0.0000,  0.0000,  0.3623]], dtype=torch.float64,
        grad_fn=&lt;LinalgQrBackward0&gt;),
 tensor([[-1.4558, -2.1453, -2.0742, -2.0196],
         [ 0.0000, -1.0830, -0.4600, -0.4487],
         [ 0.0000,  0.0000,  1.0611, -0.2117],
         [ 0.0000,  0.0000,  0.0000,  0.4077]], dtype=torch.float64,
        grad_fn=&lt;LinalgQrBackward0&gt;))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>Q.T <span class="op">@</span> Q</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[ 1.0000e+00, -4.4235e-17,  5.8981e-17,  6.9389e-18],
        [-4.4235e-17,  1.0000e+00, -1.1102e-16,  8.3267e-17],
        [ 5.8981e-17, -1.1102e-16,  1.0000e+00, -8.3267e-17],
        [ 6.9389e-18,  8.3267e-17, -8.3267e-17,  1.0000e+00]],
       dtype=torch.float64, grad_fn=&lt;MmBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>U_pred <span class="op">=</span> R.mT</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>V <span class="op">=</span> Q.T <span class="op">@</span> torch.inverse(C_dw)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>U_pred.shape, V.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([4, 4]), torch.Size([4, 8]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>D_pred <span class="op">=</span> V <span class="op">@</span> Dw <span class="op">@</span> V.T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>D_pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[ 1.0000e+00,  4.7705e-17, -6.2450e-17,  7.6328e-17],
        [-1.1276e-17,  1.0000e+00, -1.6653e-16,  1.3878e-16],
        [-5.8981e-17, -1.1102e-16,  1.0000e+00, -8.3267e-17],
        [ 3.8164e-17,  1.3878e-16, -5.5511e-17,  1.0000e+00]],
       dtype=torch.float64, grad_fn=&lt;MmBackward0&gt;)</code></pre>
</div>
</div>
<p>so the math works and D_pred is a diagonal matrix, actually and identity matrix</p>
<p>Actually this all derivations are probably not needed, as the original idea of the algorightm is to not scalar square roots in PyTorch … but since we have to use cholesky decomposition anyway, we can just use cholesky factors and make the life easier</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>U_pred <span class="op">@</span> D_pred <span class="op">@</span> U_pred.T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([[2.1193, 3.1231, 3.0197, 2.9402],
        [3.1231, 5.7751, 4.9480, 4.8186],
        [3.0197, 4.9480, 5.6400, 4.1710],
        [2.9402, 4.8186, 4.1710, 4.4912]], dtype=torch.float64,
       grad_fn=&lt;MmBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>test_close(pred_state_cov[<span class="dv">0</span>], U_pred <span class="op">@</span> D_pred <span class="op">@</span> U_pred.T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="filter-correct" class="level3">
<h3 class="anchored" data-anchor-id="filter-correct">Filter correct</h3>
<p>Probability of state at time <code>t</code> given the observations at time <code>t</code></p>
<p><span class="math inline">\(p(x_t|y_t) = \mathcal{N}(x_t; m_t, P_t)\)</span> where:</p>
<ul>
<li><p>predicted obs mean: <span class="math inline">\(z_t = Hm_t^- + d\)</span></p></li>
<li><p>prediced obs covariance: <span class="math inline">\(S_t = HP_t^-H^T + R\)</span></p></li>
<li><p>kalman gain<span class="math inline">\(K_t = P_t^-H^TS_t^{-1}\)</span></p></li>
<li><p>corrected state mean: <span class="math inline">\(m_t = m_t^- + K_t(y_t - z_t)\)</span></p></li>
<li><p>corrected state covariance: <span class="math inline">\(P_t = (I-K_tH)P_t^-\)</span></p></li>
</ul>
<p>if the observation are missing this step is skipped and the corrected state is equal to the predicted state</p>
<p>Need to figure out the Nans for the gradients …</p>
<section id="missing-observations" class="level4">
<h4 class="anchored" data-anchor-id="missing-observations">Missing observations</h4>
<p>If all the observations at time <span class="math inline">\(t\)</span> are missing the correct step is skipped and the filtered state at time <span class="math inline">\(t\)</span> () is the same of the filtered state.</p>
<p>If only some observations are missing a variation of equation can be used.</p>
<p><span class="math inline">\(y^{ng}_t\)</span> is a vector containing the observations that are not missing at time <span class="math inline">\(t\)</span>.</p>
<p>It can be expressed as a linear transformation of <span class="math inline">\(y_t\)</span></p>
<p><span class="math display">\[ y^{ng}_t = My_t\]</span></p>
<p>where <span class="math inline">\(M\)</span> is a mask matrix that is used to select the subset of <span class="math inline">\(y_t\)</span> that is observed. <span class="math inline">\(M \in \mathbb{R}^{n_{ng} \times n}\)</span> and is made of columns which are made of all zeros but for an entry 1 at row corresponding to the non-missing observation. hence:</p>
<p><span class="math display">\[ p(y^{ng}_t) = \mathcal{N}(M\mu_{y_t},  M\Sigma_{y_t}M^T)\]</span></p>
<p>from which you can derive</p>
<p><span id="eq-filter-correct"><span class="math display">\[ p(y^{ng}_t|x_t) = p(MHx_t + Mb, MRM^T)  \tag{1}\]</span></span></p>
<p>Then the posterior <span class="math inline">\(p(x_t|y_t^{ng})\)</span> can be computed similarly of equation <span class="citation" data-cites="filter_correct">@filter_correct</span> as:</p>
<p><span id="eq-filter_correct_missing"><span class="math display">\[ p(x_t|y^{ng}_t) = \mathcal{N}(x_t; m_t, P_t)  \tag{2}\]</span></span></p>
<p>where:</p>
<ul>
<li>predicted obs mean: <span class="math inline">\(z_t = MHm_t^- + Md\)</span></li>
<li>predicted obs covariance: <span class="math inline">\(S_t = MHP_t^-(MH)^T + MRM^T\)</span></li>
<li>Kalman gain <span class="math inline">\(K_t = P_t^-(MH)^TS_t^{-1}\)</span></li>
<li>corrected state mean: <span class="math inline">\(m_t = m_t^- + K_t(My_t - z_t)\)</span></li>
<li>corrected state covariance: <span class="math inline">\(P_t = (I-K_tMH)P_t^-\)</span></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>k.obs_off.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([3])</code></pre>
</div>
</div>
<section id="details-implementation" class="level5">
<h5 class="anchored" data-anchor-id="details-implementation">Details implementation</h5>
<p>For the implementation the matrix multiplication <span class="math inline">\(MH\)</span> can be replaced with <code>H[m]</code> where <code>m</code> is the mask for the rows for <code>H</code> and <span class="math inline">\(MRM^T\)</span> with <code>R[m][:,m]</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>obs_matrix, obs_cov, obs_off,obs, mm <span class="op">=</span> (k.obs_matrix, k.obs_cov, k.obs_off, data[:,<span class="dv">0</span>,:], mask[:,<span class="dv">0</span>,:])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> torch.tensor([<span class="va">False</span>,<span class="va">True</span>,<span class="va">True</span>]) <span class="co"># mask batch</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> torch.tensor([[<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>], <span class="co"># mask matrix</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>                  [<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>]], dtype<span class="op">=</span>torch.float64)</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>show_as_row(m, M, obs_matrix, obs_cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">m</p> <pre>tensor([False,  True,  True])</pre> </div><div><p style="font-size: 1.2rem;">M</p> <pre>tensor([[0., 1., 0.],
        [0., 0., 1.]], dtype=torch.float64)</pre> </div><div><p style="font-size: 1.2rem;">obs_matrix</p> <pre>Parameter containing:
tensor([[0.6627, 0.2116, 0.6291, 0.3670],
        [0.2237, 0.0553, 0.2241, 0.4903],
        [0.4756, 0.3574, 0.5449, 0.4099]], dtype=torch.float64,
       requires_grad=True)</pre> </div><div><p style="font-size: 1.2rem;">obs_cov</p> <pre>tensor([[1.5641, 0.0000, 0.0000],
        [0.0000, 1.1859, 0.0000],
        [0.0000, 0.0000, 0.6930]], dtype=torch.float64,
       grad_fn=<diagbackward0>)</diagbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>M <span class="op">@</span> obs_matrix, obs_matrix[m]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[0.2237, 0.0553, 0.2241, 0.4903],
         [0.4756, 0.3574, 0.5449, 0.4099]], dtype=torch.float64,
        grad_fn=&lt;MmBackward0&gt;),
 tensor([[0.2237, 0.0553, 0.2241, 0.4903],
         [0.4756, 0.3574, 0.5449, 0.4099]], dtype=torch.float64,
        grad_fn=&lt;IndexBackward0&gt;))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>M <span class="op">@</span> obs_cov <span class="op">@</span> M.T, obs_cov[m][:,m]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[1.1859, 0.0000],
         [0.0000, 0.6930]], dtype=torch.float64, grad_fn=&lt;MmBackward0&gt;),
 tensor([[1.1859, 0.0000],
         [0.0000, 0.6930]], dtype=torch.float64, grad_fn=&lt;IndexBackward0&gt;))</code></pre>
</div>
</div>
<p>By using partially missing observations <a href="https://mone27.github.io/meteo_imp/lib/kalman/filter.html#_filter_correct"><code>_filter_correct</code></a> cannot be easily batched as the shape of the intermediate variables depends on the number of observed variables. So the idea is to divide the batch in batches where there is the same number of variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>mask_values, indices <span class="op">=</span> torch.unique(mask[:,<span class="dv">1</span>,:], dim<span class="op">=</span><span class="dv">0</span>, return_inverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>mask_values, indices</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(tensor([[ True, False,  True],
         [ True,  True, False]]),
 tensor([0, 1]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>obs_matrix, obs_cov, obs_off,obs, mm <span class="op">=</span> (k.obs_matrix, k.obs_cov, k.obs_off, data[:,<span class="dv">0</span>,:], mask[:,<span class="dv">0</span>,:])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>corr_s_mean,corr_s_cov <span class="op">=</span> _filter_correct_batch(obs_matrix, obs_cov, obs_off, pred_state_mean[<span class="dv">0</span>:<span class="dv">1</span>], pred_state_cov[<span class="dv">0</span>:<span class="dv">1</span>], obs[<span class="dv">0</span>:<span class="dv">1</span>], mm[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>corr_s_mean.shape, corr_s_cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([1, 4, 1]), torch.Size([1, 4, 4]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>obs_matrix, obs_cov, obs_off,obs, mm <span class="op">=</span> (k.obs_matrix, k.obs_cov, k.obs_off, data[:,<span class="dv">0</span>,:], mask[:,<span class="dv">0</span>,:])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>corr_s_mean, corr_s_cov <span class="op">=</span> _filter_correct(obs_matrix, obs_cov, obs_off, pred_state_mean, pred_state_cov, obs, mm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>show_as_row(corr_s_mean, corr_s_cov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">corr_s_mean</p> <pre>tensor([[[ 0.1665],
         [ 1.3408],
         [ 0.5831],
         [ 0.1386]],

        [[ 0.1831],
         [ 0.8667],
         [ 0.3231],
         [-0.0661]]], dtype=torch.float64, grad_fn=<indexputbackward0>)</indexputbackward0></pre> </div><div><p style="font-size: 1.2rem;">corr_s_cov</p> <pre>tensor([[[ 5.9730e-01,  5.4209e-01,  2.9660e-01,  2.7770e-01],
         [ 5.4209e-01,  1.1098e+00,  6.4993e-02,  2.8594e-01],
         [ 2.9660e-01,  6.4993e-02,  6.4509e-01,  2.9308e-01],
         [ 2.7770e-01,  2.8594e-01,  2.9308e-01,  1.0954e+00]],

        [[ 3.1335e-01,  2.4103e-01,  5.4056e-02, -5.5656e-02],
         [ 2.4103e-01,  7.8848e-01, -1.9029e-01, -5.7119e-02],
         [ 5.4056e-02, -1.9029e-01,  4.3623e-01, -9.3618e-04],
         [-5.5656e-02, -5.7119e-02, -9.3618e-04,  6.5286e-01]]],
       dtype=torch.float64, grad_fn=<indexputbackward0>)</indexputbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>corr_s_mean.shape, corr_s_cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 4, 1]), torch.Size([2, 4, 4]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>corr_s_mean.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>) <span class="co"># check that pytorch can compute gradients with the whole batch</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="filter-1" class="level3">
<h3 class="anchored" data-anchor-id="filter-1">Filter</h3>
<p>The resursive version of the kalman filter is apperently breaking pytorch gradients calculations so a workaround is needed. During the loop the states are saved in a python list and then at the end they are combined back into a tensor. The last line of the function does:</p>
<ul>
<li>convert lists to tensors</li>
<li>correct order dimensions</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>obs, init_state_mean, init_state_cov <span class="op">=</span> data, k.init_state_mean, k.init_state_cov</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>pred_state_means, pred_state_covs, filt_state_means, filt_state_covs <span class="op">=</span> _filter(</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    trans_matrix, obs_matrix, contr_matrix,</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    trans_cov, obs_cov,</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    trans_off, obs_off,</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    init_state_mean, init_state_cov,</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Predictions at time <code>0</code> for both batches</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="bu">list</span>(<span class="bu">map</span>(Self.shape(), (pred_state_means, pred_state_covs, filt_state_means, filt_state_covs,))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>[torch.Size([2, 10, 4, 1]), torch.Size([2, 10, 4, 4]), torch.Size([2, 10, 4, 1]), torch.Size([2, 10, 4, 4])]</pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="bu">list</span>(<span class="bu">map</span>(<span class="kw">lambda</span> x:x[<span class="dv">0</span>][<span class="dv">0</span>], (pred_state_means, pred_state_covs, filt_state_means, filt_state_covs,))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>[tensor([[0.3830],
        [0.4214],
        [0.5458],
        [0.5241]], dtype=torch.float64, grad_fn=<selectbackward0>), tensor([[1.3892, 0.7181, 1.6393, 1.3942],
        [0.7181, 0.8852, 0.9592, 0.8515],
        [1.6393, 0.9592, 2.1083, 1.6580],
        [1.3942, 0.8515, 1.6580, 1.4405]], dtype=torch.float64,
       grad_fn=<selectbackward0>), tensor([[0.2232],
        [0.3249],
        [0.3488],
        [0.3607]], dtype=torch.float64, grad_fn=<selectbackward0>), tensor([[0.3592, 0.0962, 0.3697, 0.3405],
        [0.0962, 0.5098, 0.1927, 0.2153],
        [0.3697, 0.1927, 0.5432, 0.3591],
        [0.3405, 0.2153, 0.3591, 0.3625]], dtype=torch.float64,
       grad_fn=<selectbackward0>)]</selectbackward0></selectbackward0></selectbackward0></selectbackward0></pre> </div></div>
</div>
</div>
</section>
<section id="kalmanfilter-method" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter-method">KalmanFilter method</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>pred_mean, _, _, _ <span class="op">=</span> k._filter_all(obs, mask, control)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(k._filter_all(obs, mask, control))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>list</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>pred_mean.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>) <span class="co"># it works!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The filter methods wraps <code>_filter_all</code> but in addition:</p>
<ul>
<li>returns only filtered state</li>
<li>detach tensors</li>
</ul>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L296" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter.filter" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.filter">KalmanFilter.filter</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.filter (obs:torch.Tensor, mask:torch.Tensor,
                      control:torch.Tensor)</code></pre>
</blockquote>
<p>Filter observation</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>obs</td>
<td>Tensor</td>
<td>[n_timesteps, n_dim_obs] obs for times [0…n_timesteps-1]</td>
</tr>
<tr class="even">
<td>mask</td>
<td>Tensor</td>
<td>[n_timesteps, n_dim_obs] obs for times [0…n_timesteps-1]</td>
</tr>
<tr class="odd">
<td>control</td>
<td>Tensor</td>
<td>[n_timesteps, n_dim_contr] control for times [1…n_timesteps-1]</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ListMultiNormal</strong></td>
<td><strong>Filtered state</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>filt <span class="op">=</span> k.<span class="bu">filter</span>(obs, mask, control)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>filt.mean.shape, filt.cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 10, 4]), torch.Size([2, 10, 4, 4]))</code></pre>
</div>
</div>
</section>
</section>
<section id="smooth" class="level2">
<h2 class="anchored" data-anchor-id="smooth">Smooth</h2>
<section id="smooth-step" class="level3">
<h3 class="anchored" data-anchor-id="smooth-step">Smooth step</h3>
<p>compute the probability of the state at time <code>t</code> given all the observations</p>
<p><span class="math inline">\(p(x_t|Y) = \mathcal{N}(x_t; m_t^s, P_t^s)\)</span> where:</p>
<ul>
<li>Kalman smoothing gain: <span class="math inline">\(G_t = P_tA^T(P_{t+1}^-)^{-1}\)</span></li>
<li>smoothed mean: <span class="math inline">\(m_t^s = m_t + G_t(m_{t+1}^s - m_{t+1}^-)\)</span></li>
<li>smoothed covariance: <span class="math inline">\(P_t^s = P_t + G_t(P_{t+1}^s - P_{t+1}^-)G_t^T\)</span></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>filt_state, pred_state, next_smoothed_state <span class="op">=</span> [MNormal(pred_state_mean, pred_state_cov)] <span class="op">*</span> <span class="dv">3</span> <span class="co"># just for testing</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span>_smooth_update(trans_matrix, MNormal(pred_state_mean, pred_state_cov), MNormal(pred_state_mean, pred_state_cov), MNormal(pred_state_mean, pred_state_cov)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[[2.4637],
         [3.4680],
         [2.6637],
         [2.5277]],

        [[1.8814],
         [2.4901],
         [1.8271],
         [1.5799]]], dtype=torch.float64, grad_fn=<addbackward0>)</addbackward0></pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[[6.0158, 5.5596, 5.2040, 5.9127],
         [5.5596, 5.7559, 4.6093, 5.5039],
         [5.2040, 4.6093, 5.0897, 5.3966],
         [5.9127, 5.5039, 5.3966, 6.9555]],

        [[6.0158, 5.5596, 5.2040, 5.9127],
         [5.5596, 5.7559, 4.6093, 5.5039],
         [5.2040, 4.6093, 5.0897, 5.3966],
         [5.9127, 5.5039, 5.3966, 6.9555]]], dtype=torch.float64,
       grad_fn=<addbackward0>)</addbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>show_as_row(<span class="op">*</span><span class="bu">map</span>(Self.shape(), _smooth_update(trans_matrix, MNormal(pred_state_mean, pred_state_cov), MNormal(pred_state_mean, pred_state_cov), MNormal(pred_state_mean, pred_state_cov))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([2, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([2, 4, 4])</pre> </div></div>
</div>
</div>
</section>
<section id="smooth-1" class="level3">
<h3 class="anchored" data-anchor-id="smooth-1">Smooth</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>(pred_state_means, pred_state_covs, filt_state_means, filt_state_covs ) <span class="op">=</span> k._filter_all(data, mask, control)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>filt_state, pred_state <span class="op">=</span> ListMNormal(filt_state_means, filt_state_covs), ListMNormal(pred_state_means, pred_state_covs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>smooth_state <span class="op">=</span> _smooth(k.trans_matrix,  filt_state, pred_state)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smooth_state.mean[<span class="dv">0</span>][<span class="dv">0</span>], smooth_state.cov[<span class="dv">0</span>][<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>tensor([[-0.3253],
        [-0.1535],
        [-0.3464],
        [-0.2399]], dtype=torch.float64, grad_fn=<selectbackward0>)</selectbackward0></pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>tensor([[ 0.2329, -0.0111,  0.2100,  0.2030],
        [-0.0111,  0.4152,  0.0549,  0.0978],
        [ 0.2100,  0.0549,  0.3402,  0.1849],
        [ 0.2030,  0.0978,  0.1849,  0.2127]], dtype=torch.float64,
       grad_fn=<selectbackward0>)</selectbackward0></pre> </div></div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smooth_state.mean.shape, smooth_state.cov.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([2, 10, 4, 1])</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([2, 10, 4, 4])</pre> </div></div>
</div>
</div>
</section>
<section id="kalmanfilter-method-1" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter-method-1">KalmanFilter method</h3>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L353" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter.smooth" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.smooth">KalmanFilter.smooth</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.smooth (obs:torch.Tensor, mask:torch.Tensor,
                      control:torch.Tensor)</code></pre>
</blockquote>
<p>Kalman Filter Smoothing</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>obs</td>
<td>Tensor</td>
<td></td>
</tr>
<tr class="even">
<td>mask</td>
<td>Tensor</td>
<td></td>
</tr>
<tr class="odd">
<td>control</td>
<td>Tensor</td>
<td></td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>ListMultiNormal</strong></td>
<td><strong><code>[n_timesteps, n_dim_state]</code> smoothed state</strong></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>smoothed_state <span class="op">=</span> k.smooth(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>show_as_row(smoothed_state.mean.shape, smoothed_state.cov.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<div style="display: flex; column-gap: 20px; flex-wrap: wrap;" class="table table-striped table-sm"> <div><p style="font-size: 1.2rem;">#0</p> <pre>torch.Size([2, 10, 4])</pre> </div><div><p style="font-size: 1.2rem;">#1</p> <pre>torch.Size([2, 10, 4, 4])</pre> </div></div>
</div>
</div>
</section>
</section>
<section id="predict" class="level2">
<h2 class="anchored" data-anchor-id="predict">Predict</h2>
<p>The prediction at time t (<span class="math inline">\(y_t\)</span>) are computed rom the state (<span class="math inline">\(x_t\)</span>) using this formula: <span class="math display">\[p(y_t|x_t) = \mathcal{N}(Hx_t + d, R + HP^s_tH^T)\]</span></p>
<p>this works both if the state was filtered or smoother</p>
<p>This add the supports for conditional predictions, which means that at the time (t) when we are making the predictions some of the variables have been actually observed. Since the model prediction is a normal distribution we can condition on the observed values and thus improve the predictions. See <code>conditional_gaussian</code></p>
<p>In order to have conditional predictions that make sense it’s not possible to return the full covariance matrix for the predictions but only the standard deviations</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>test_m <span class="op">=</span> torch.tensor(</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>    [[<span class="va">True</span>, <span class="va">True</span>, <span class="va">True</span>,],</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    [<span class="va">False</span>, <span class="va">True</span>, <span class="va">True</span>],</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    [<span class="va">False</span>, <span class="va">False</span>, <span class="va">False</span>]]</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>torch.logical_xor(test_m.<span class="bu">all</span>(<span class="op">-</span><span class="dv">1</span>), test_m.<span class="bu">any</span>(<span class="op">-</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([False,  True, False])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>A <span class="op">=</span> torch.rand(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>(A <span class="op">@</span> A).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 2, 3, 3])</code></pre>
</div>
</div>
<p>predict can be vectorized across both the batch and the timesteps, except for timesteps that require conditional predictions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>smoothed_state.mean.shape, smoothed_state.cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 10, 4]), torch.Size([2, 10, 4, 4]))</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>(k.obs_matrix <span class="op">@</span> smoothed_state.mean.unsqueeze(<span class="op">-</span><span class="dv">1</span>)).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10, 3, 1])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>pred_obs0 <span class="op">=</span> k._obs_from_state(smoothed_state)</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>pred_obs0.mean.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10, 3])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>pred_obs0.cov.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([2, 10, 3, 3])</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L383" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="kalmanfilter.predict" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.predict">KalmanFilter.predict</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.predict (obs, mask, control, smooth=True)</code></pre>
</blockquote>
<p>Predicted observations at all times</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>pred <span class="op">=</span> k.predict(data, mask, control)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>pred.mean.shape, pred.std.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(torch.Size([2, 10, 3]), torch.Size([2, 10, 3]))</code></pre>
</div>
</div>
<p>Gradients …</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_grad_mask(x):</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"filter gradient after sub the masks value with x"</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> data.clone()</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>    d[<span class="op">~</span>mask] <span class="op">=</span> x</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    k.predict(data, mask, control).mean.<span class="bu">sum</span>().backward(retain_graph<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>    grad <span class="op">=</span> k.obs_cov_raw.grad.clone()</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>    k.zero_grad() </span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>get_grad_mask(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>tensor([-1.9622,  2.6291,  6.2310], dtype=torch.float64)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>test_close(get_grad_mask(<span class="dv">1</span>), get_grad_mask(<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_times(<span class="va">self</span>: KalmanFilter, times, obs, mask<span class="op">=</span><span class="va">None</span>, smooth<span class="op">=</span><span class="va">True</span>, check_args<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Predicted observations at specific times """</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>    state <span class="op">=</span> <span class="va">self</span>.smooth(obs, mask, check_args) <span class="cf">if</span> smooth <span class="cf">else</span> <span class="va">self</span>.<span class="bu">filter</span>(obs, mask, check_args)</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>    obs, mask <span class="op">=</span> <span class="va">self</span>._parse_obs(obs, mask)</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>    times <span class="op">=</span> array1d(times)</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>    n_timesteps <span class="op">=</span> obs.shape[<span class="dv">0</span>]</span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>    n_features <span class="op">=</span> obs.shape[<span class="dv">1</span>] <span class="cf">if</span> <span class="bu">len</span>(obs.shape) <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> times.<span class="bu">max</span>() <span class="op">&gt;</span> n_timesteps <span class="kw">or</span> times.<span class="bu">min</span>() <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"provided times range from </span><span class="sc">{</span>times<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>times<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">, which is outside allowed range : 0 to </span><span class="sc">{</span>n_timesteps<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a>    means <span class="op">=</span> torch.empty((times.shape[<span class="dv">0</span>], n_features), dtype<span class="op">=</span>obs.dtype, device<span class="op">=</span>obs.device)</span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a>    stds <span class="op">=</span> torch.empty((times.shape[<span class="dv">0</span>], n_features), dtype<span class="op">=</span>obs.dtype, device<span class="op">=</span>obs.device) </span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, t <span class="kw">in</span> <span class="bu">enumerate</span>(times):</span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a>        mean, std <span class="op">=</span> <span class="va">self</span>._obs_from_state(</span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a>            state.mean[t],</span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a>            state.cov[t],</span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'t'</span>: t, <span class="op">**</span>check_args} <span class="cf">if</span> check_args <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb131-23"><a href="#cb131-23" aria-hidden="true" tabindex="-1"></a>        means[i], stds[i] <span class="op">=</span> _get_cond_pred(ListNormal(mean, std), obs[t], mask[t])</span>
<span id="cb131-24"><a href="#cb131-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-25"><a href="#cb131-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ListNormal(means, stds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="additional" class="level2">
<h2 class="anchored" data-anchor-id="additional">Additional</h2>
<section id="get-info" class="level3">
<h3 class="anchored" data-anchor-id="get-info">Get Info</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>k.obs_matrix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Parameter containing:
tensor([[0.6627, 0.2116, 0.6291, 0.3670],
        [0.2237, 0.0553, 0.2241, 0.4903],
        [0.4756, 0.3574, 0.5449, 0.4099]], dtype=torch.float64,
       requires_grad=True)</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L408" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="kalmanfilter.get_info" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.get_info">KalmanFilter.get_info</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.get_info ()</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>k.contr_matrix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Parameter containing:
tensor([[0.3640, 0.6339, 0.1636],
        [0.7750, 0.8999, 0.4475],
        [0.2087, 0.9819, 0.7791],
        [0.4139, 0.9798, 0.9052]], dtype=torch.float64, requires_grad=True)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>display_as_row(k.get_info())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table id="T_923bd" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_923bd_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_923bd_level0_col1" class="col_heading level0 col1">x_0</th>
<th id="T_923bd_level0_col2" class="col_heading level0 col2">x_1</th>
<th id="T_923bd_level0_col3" class="col_heading level0 col3">x_2</th>
<th id="T_923bd_level0_col4" class="col_heading level0 col4">x_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_923bd_row0_col0" class="data row0 col0">x_0</td>
<td id="T_923bd_row0_col1" class="data row0 col1">0.3923</td>
<td id="T_923bd_row0_col2" class="data row0 col2">0.7703</td>
<td id="T_923bd_row0_col3" class="data row0 col3">0.7068</td>
<td id="T_923bd_row0_col4" class="data row0 col4">0.1368</td>
</tr>
<tr class="even">
<td id="T_923bd_row1_col0" class="data row1 col0">x_1</td>
<td id="T_923bd_row1_col1" class="data row1 col1">0.6002</td>
<td id="T_923bd_row1_col2" class="data row1 col2">0.4108</td>
<td id="T_923bd_row1_col3" class="data row1 col3">0.3458</td>
<td id="T_923bd_row1_col4" class="data row1 col4">0.6117</td>
</tr>
<tr class="odd">
<td id="T_923bd_row2_col0" class="data row2 col0">x_2</td>
<td id="T_923bd_row2_col1" class="data row2 col1">0.7857</td>
<td id="T_923bd_row2_col2" class="data row2 col2">0.1670</td>
<td id="T_923bd_row2_col3" class="data row2 col3">0.0884</td>
<td id="T_923bd_row2_col4" class="data row2 col4">0.5066</td>
</tr>
<tr class="even">
<td id="T_923bd_row3_col0" class="data row3 col0">x_3</td>
<td id="T_923bd_row3_col1" class="data row3 col1">0.1431</td>
<td id="T_923bd_row3_col2" class="data row3 col2">0.5090</td>
<td id="T_923bd_row3_col3" class="data row3 col3">0.9645</td>
<td id="T_923bd_row3_col4" class="data row3 col4">0.2983</td>
</tr>
</tbody>
</table>
<div>
<p>trans cov (Q)</p>
<table id="T_f0fea" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_f0fea_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_f0fea_level0_col1" class="col_heading level0 col1">x_0</th>
<th id="T_f0fea_level0_col2" class="col_heading level0 col2">x_1</th>
<th id="T_f0fea_level0_col3" class="col_heading level0 col3">x_2</th>
<th id="T_f0fea_level0_col4" class="col_heading level0 col4">x_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_f0fea_row0_col0" class="data row0 col0">x_0</td>
<td id="T_f0fea_row0_col1" class="data row0 col1">1.1591</td>
<td id="T_f0fea_row0_col2" class="data row0 col2">0.7234</td>
<td id="T_f0fea_row0_col3" class="data row0 col3">1.4105</td>
<td id="T_f0fea_row0_col4" class="data row0 col4">0.9115</td>
</tr>
<tr class="even">
<td id="T_f0fea_row1_col0" class="data row1 col0">x_1</td>
<td id="T_f0fea_row1_col1" class="data row1 col1">0.7234</td>
<td id="T_f0fea_row1_col2" class="data row1 col2">0.8544</td>
<td id="T_f0fea_row1_col3" class="data row1 col3">0.7177</td>
<td id="T_f0fea_row1_col4" class="data row1 col4">0.5024</td>
</tr>
<tr class="odd">
<td id="T_f0fea_row2_col0" class="data row2 col0">x_2</td>
<td id="T_f0fea_row2_col1" class="data row2 col1">1.4105</td>
<td id="T_f0fea_row2_col2" class="data row2 col2">0.7177</td>
<td id="T_f0fea_row2_col3" class="data row2 col3">1.9741</td>
<td id="T_f0fea_row2_col4" class="data row2 col4">1.4590</td>
</tr>
<tr class="even">
<td id="T_f0fea_row3_col0" class="data row3 col0">x_3</td>
<td id="T_f0fea_row3_col1" class="data row3 col1">0.9115</td>
<td id="T_f0fea_row3_col2" class="data row3 col2">0.5024</td>
<td id="T_f0fea_row3_col3" class="data row3 col3">1.4590</td>
<td id="T_f0fea_row3_col4" class="data row3 col4">1.7778</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>trans off</p>
<table id="T_bfff6" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_bfff6_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_bfff6_level0_col1" class="col_heading level0 col1">offset</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_bfff6_row0_col0" class="data row0 col0">x_0</td>
<td id="T_bfff6_row0_col1" class="data row0 col1">0.6728</td>
</tr>
<tr class="even">
<td id="T_bfff6_row1_col0" class="data row1 col0">x_1</td>
<td id="T_bfff6_row1_col1" class="data row1 col1">0.9842</td>
</tr>
<tr class="odd">
<td id="T_bfff6_row2_col0" class="data row2 col0">x_2</td>
<td id="T_bfff6_row2_col1" class="data row2 col1">0.6946</td>
</tr>
<tr class="even">
<td id="T_bfff6_row3_col0" class="data row3 col0">x_3</td>
<td id="T_bfff6_row3_col1" class="data row3 col1">0.0369</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>obs matrix (H)</p>
<table id="T_80933" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_80933_level0_col0" class="col_heading level0 col0">variable</th>
<th id="T_80933_level0_col1" class="col_heading level0 col1">x_0</th>
<th id="T_80933_level0_col2" class="col_heading level0 col2">x_1</th>
<th id="T_80933_level0_col3" class="col_heading level0 col3">x_2</th>
<th id="T_80933_level0_col4" class="col_heading level0 col4">x_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_80933_row0_col0" class="data row0 col0">y_0</td>
<td id="T_80933_row0_col1" class="data row0 col1">0.6627</td>
<td id="T_80933_row0_col2" class="data row0 col2">0.2116</td>
<td id="T_80933_row0_col3" class="data row0 col3">0.6291</td>
<td id="T_80933_row0_col4" class="data row0 col4">0.3670</td>
</tr>
<tr class="even">
<td id="T_80933_row1_col0" class="data row1 col0">y_1</td>
<td id="T_80933_row1_col1" class="data row1 col1">0.2237</td>
<td id="T_80933_row1_col2" class="data row1 col2">0.0553</td>
<td id="T_80933_row1_col3" class="data row1 col3">0.2241</td>
<td id="T_80933_row1_col4" class="data row1 col4">0.4903</td>
</tr>
<tr class="odd">
<td id="T_80933_row2_col0" class="data row2 col0">y_2</td>
<td id="T_80933_row2_col1" class="data row2 col1">0.4756</td>
<td id="T_80933_row2_col2" class="data row2 col2">0.3574</td>
<td id="T_80933_row2_col3" class="data row2 col3">0.5449</td>
<td id="T_80933_row2_col4" class="data row2 col4">0.4099</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>obs cov (R)</p>
<table id="T_26e3c" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_26e3c_level0_col0" class="col_heading level0 col0">variable</th>
<th id="T_26e3c_level0_col1" class="col_heading level0 col1">y_0</th>
<th id="T_26e3c_level0_col2" class="col_heading level0 col2">y_1</th>
<th id="T_26e3c_level0_col3" class="col_heading level0 col3">y_2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_26e3c_row0_col0" class="data row0 col0">y_0</td>
<td id="T_26e3c_row0_col1" class="data row0 col1">1.5641</td>
<td id="T_26e3c_row0_col2" class="data row0 col2">0.0000</td>
<td id="T_26e3c_row0_col3" class="data row0 col3">0.0000</td>
</tr>
<tr class="even">
<td id="T_26e3c_row1_col0" class="data row1 col0">y_1</td>
<td id="T_26e3c_row1_col1" class="data row1 col1">0.0000</td>
<td id="T_26e3c_row1_col2" class="data row1 col2">1.1859</td>
<td id="T_26e3c_row1_col3" class="data row1 col3">0.0000</td>
</tr>
<tr class="odd">
<td id="T_26e3c_row2_col0" class="data row2 col0">y_2</td>
<td id="T_26e3c_row2_col1" class="data row2 col1">0.0000</td>
<td id="T_26e3c_row2_col2" class="data row2 col2">0.0000</td>
<td id="T_26e3c_row2_col3" class="data row2 col3">0.6930</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>obs off</p>
<table id="T_0c2bc" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_0c2bc_level0_col0" class="col_heading level0 col0">variable</th>
<th id="T_0c2bc_level0_col1" class="col_heading level0 col1">offset</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_0c2bc_row0_col0" class="data row0 col0">y_0</td>
<td id="T_0c2bc_row0_col1" class="data row0 col1">0.4045</td>
</tr>
<tr class="even">
<td id="T_0c2bc_row1_col0" class="data row1 col0">y_1</td>
<td id="T_0c2bc_row1_col1" class="data row1 col1">0.2622</td>
</tr>
<tr class="odd">
<td id="T_0c2bc_row2_col0" class="data row2 col0">y_2</td>
<td id="T_0c2bc_row2_col1" class="data row2 col1">0.4132</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>contr matrix (B)</p>
<table id="T_1a1f6" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_1a1f6_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_1a1f6_level0_col1" class="col_heading level0 col1">c_0</th>
<th id="T_1a1f6_level0_col2" class="col_heading level0 col2">c_1</th>
<th id="T_1a1f6_level0_col3" class="col_heading level0 col3">c_2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_1a1f6_row0_col0" class="data row0 col0">x_0</td>
<td id="T_1a1f6_row0_col1" class="data row0 col1">0.3640</td>
<td id="T_1a1f6_row0_col2" class="data row0 col2">0.6339</td>
<td id="T_1a1f6_row0_col3" class="data row0 col3">0.1636</td>
</tr>
<tr class="even">
<td id="T_1a1f6_row1_col0" class="data row1 col0">x_1</td>
<td id="T_1a1f6_row1_col1" class="data row1 col1">0.7750</td>
<td id="T_1a1f6_row1_col2" class="data row1 col2">0.8999</td>
<td id="T_1a1f6_row1_col3" class="data row1 col3">0.4475</td>
</tr>
<tr class="odd">
<td id="T_1a1f6_row2_col0" class="data row2 col0">x_2</td>
<td id="T_1a1f6_row2_col1" class="data row2 col1">0.2087</td>
<td id="T_1a1f6_row2_col2" class="data row2 col2">0.9819</td>
<td id="T_1a1f6_row2_col3" class="data row2 col3">0.7791</td>
</tr>
<tr class="even">
<td id="T_1a1f6_row3_col0" class="data row3 col0">x_3</td>
<td id="T_1a1f6_row3_col1" class="data row3 col1">0.4139</td>
<td id="T_1a1f6_row3_col2" class="data row3 col2">0.9798</td>
<td id="T_1a1f6_row3_col3" class="data row3 col3">0.9052</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>init state mean</p>
<table id="T_31972" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_31972_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_31972_level0_col1" class="col_heading level0 col1">mean</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_31972_row0_col0" class="data row0 col0">x_0</td>
<td id="T_31972_row0_col1" class="data row0 col1">0.3830</td>
</tr>
<tr class="even">
<td id="T_31972_row1_col0" class="data row1 col0">x_1</td>
<td id="T_31972_row1_col1" class="data row1 col1">0.4214</td>
</tr>
<tr class="odd">
<td id="T_31972_row2_col0" class="data row2 col0">x_2</td>
<td id="T_31972_row2_col1" class="data row2 col1">0.5458</td>
</tr>
<tr class="even">
<td id="T_31972_row3_col0" class="data row3 col0">x_3</td>
<td id="T_31972_row3_col1" class="data row3 col1">0.5241</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>init state cov</p>
<table id="T_45a51" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_45a51_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_45a51_level0_col1" class="col_heading level0 col1">x_0</th>
<th id="T_45a51_level0_col2" class="col_heading level0 col2">x_1</th>
<th id="T_45a51_level0_col3" class="col_heading level0 col3">x_2</th>
<th id="T_45a51_level0_col4" class="col_heading level0 col4">x_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_45a51_row0_col0" class="data row0 col0">x_0</td>
<td id="T_45a51_row0_col1" class="data row0 col1">1.3892</td>
<td id="T_45a51_row0_col2" class="data row0 col2">0.7181</td>
<td id="T_45a51_row0_col3" class="data row0 col3">1.6393</td>
<td id="T_45a51_row0_col4" class="data row0 col4">1.3942</td>
</tr>
<tr class="even">
<td id="T_45a51_row1_col0" class="data row1 col0">x_1</td>
<td id="T_45a51_row1_col1" class="data row1 col1">0.7181</td>
<td id="T_45a51_row1_col2" class="data row1 col2">0.8852</td>
<td id="T_45a51_row1_col3" class="data row1 col3">0.9592</td>
<td id="T_45a51_row1_col4" class="data row1 col4">0.8515</td>
</tr>
<tr class="odd">
<td id="T_45a51_row2_col0" class="data row2 col0">x_2</td>
<td id="T_45a51_row2_col1" class="data row2 col1">1.6393</td>
<td id="T_45a51_row2_col2" class="data row2 col2">0.9592</td>
<td id="T_45a51_row2_col3" class="data row2 col3">2.1083</td>
<td id="T_45a51_row2_col4" class="data row2 col4">1.6580</td>
</tr>
<tr class="even">
<td id="T_45a51_row3_col0" class="data row3 col0">x_3</td>
<td id="T_45a51_row3_col1" class="data row3 col1">1.3942</td>
<td id="T_45a51_row3_col2" class="data row3 col2">0.8515</td>
<td id="T_45a51_row3_col3" class="data row3 col3">1.6580</td>
<td id="T_45a51_row3_col4" class="data row3 col4">1.4405</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>k</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table id="T_2909d" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_2909d_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_2909d_level0_col1" class="col_heading level0 col1">x_0</th>
<th id="T_2909d_level0_col2" class="col_heading level0 col2">x_1</th>
<th id="T_2909d_level0_col3" class="col_heading level0 col3">x_2</th>
<th id="T_2909d_level0_col4" class="col_heading level0 col4">x_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_2909d_row0_col0" class="data row0 col0">x_0</td>
<td id="T_2909d_row0_col1" class="data row0 col1">0.3923</td>
<td id="T_2909d_row0_col2" class="data row0 col2">0.7703</td>
<td id="T_2909d_row0_col3" class="data row0 col3">0.7068</td>
<td id="T_2909d_row0_col4" class="data row0 col4">0.1368</td>
</tr>
<tr class="even">
<td id="T_2909d_row1_col0" class="data row1 col0">x_1</td>
<td id="T_2909d_row1_col1" class="data row1 col1">0.6002</td>
<td id="T_2909d_row1_col2" class="data row1 col2">0.4108</td>
<td id="T_2909d_row1_col3" class="data row1 col3">0.3458</td>
<td id="T_2909d_row1_col4" class="data row1 col4">0.6117</td>
</tr>
<tr class="odd">
<td id="T_2909d_row2_col0" class="data row2 col0">x_2</td>
<td id="T_2909d_row2_col1" class="data row2 col1">0.7857</td>
<td id="T_2909d_row2_col2" class="data row2 col2">0.1670</td>
<td id="T_2909d_row2_col3" class="data row2 col3">0.0884</td>
<td id="T_2909d_row2_col4" class="data row2 col4">0.5066</td>
</tr>
<tr class="even">
<td id="T_2909d_row3_col0" class="data row3 col0">x_3</td>
<td id="T_2909d_row3_col1" class="data row3 col1">0.1431</td>
<td id="T_2909d_row3_col2" class="data row3 col2">0.5090</td>
<td id="T_2909d_row3_col3" class="data row3 col3">0.9645</td>
<td id="T_2909d_row3_col4" class="data row3 col4">0.2983</td>
</tr>
</tbody>
</table>
<div>
<p>trans cov (Q)</p>
<table id="T_af0ed" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_af0ed_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_af0ed_level0_col1" class="col_heading level0 col1">x_0</th>
<th id="T_af0ed_level0_col2" class="col_heading level0 col2">x_1</th>
<th id="T_af0ed_level0_col3" class="col_heading level0 col3">x_2</th>
<th id="T_af0ed_level0_col4" class="col_heading level0 col4">x_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_af0ed_row0_col0" class="data row0 col0">x_0</td>
<td id="T_af0ed_row0_col1" class="data row0 col1">1.1591</td>
<td id="T_af0ed_row0_col2" class="data row0 col2">0.7234</td>
<td id="T_af0ed_row0_col3" class="data row0 col3">1.4105</td>
<td id="T_af0ed_row0_col4" class="data row0 col4">0.9115</td>
</tr>
<tr class="even">
<td id="T_af0ed_row1_col0" class="data row1 col0">x_1</td>
<td id="T_af0ed_row1_col1" class="data row1 col1">0.7234</td>
<td id="T_af0ed_row1_col2" class="data row1 col2">0.8544</td>
<td id="T_af0ed_row1_col3" class="data row1 col3">0.7177</td>
<td id="T_af0ed_row1_col4" class="data row1 col4">0.5024</td>
</tr>
<tr class="odd">
<td id="T_af0ed_row2_col0" class="data row2 col0">x_2</td>
<td id="T_af0ed_row2_col1" class="data row2 col1">1.4105</td>
<td id="T_af0ed_row2_col2" class="data row2 col2">0.7177</td>
<td id="T_af0ed_row2_col3" class="data row2 col3">1.9741</td>
<td id="T_af0ed_row2_col4" class="data row2 col4">1.4590</td>
</tr>
<tr class="even">
<td id="T_af0ed_row3_col0" class="data row3 col0">x_3</td>
<td id="T_af0ed_row3_col1" class="data row3 col1">0.9115</td>
<td id="T_af0ed_row3_col2" class="data row3 col2">0.5024</td>
<td id="T_af0ed_row3_col3" class="data row3 col3">1.4590</td>
<td id="T_af0ed_row3_col4" class="data row3 col4">1.7778</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>trans off</p>
<table id="T_8d4e5" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_8d4e5_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_8d4e5_level0_col1" class="col_heading level0 col1">offset</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_8d4e5_row0_col0" class="data row0 col0">x_0</td>
<td id="T_8d4e5_row0_col1" class="data row0 col1">0.6728</td>
</tr>
<tr class="even">
<td id="T_8d4e5_row1_col0" class="data row1 col0">x_1</td>
<td id="T_8d4e5_row1_col1" class="data row1 col1">0.9842</td>
</tr>
<tr class="odd">
<td id="T_8d4e5_row2_col0" class="data row2 col0">x_2</td>
<td id="T_8d4e5_row2_col1" class="data row2 col1">0.6946</td>
</tr>
<tr class="even">
<td id="T_8d4e5_row3_col0" class="data row3 col0">x_3</td>
<td id="T_8d4e5_row3_col1" class="data row3 col1">0.0369</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>obs matrix (H)</p>
<table id="T_a28ed" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_a28ed_level0_col0" class="col_heading level0 col0">variable</th>
<th id="T_a28ed_level0_col1" class="col_heading level0 col1">x_0</th>
<th id="T_a28ed_level0_col2" class="col_heading level0 col2">x_1</th>
<th id="T_a28ed_level0_col3" class="col_heading level0 col3">x_2</th>
<th id="T_a28ed_level0_col4" class="col_heading level0 col4">x_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_a28ed_row0_col0" class="data row0 col0">y_0</td>
<td id="T_a28ed_row0_col1" class="data row0 col1">0.6627</td>
<td id="T_a28ed_row0_col2" class="data row0 col2">0.2116</td>
<td id="T_a28ed_row0_col3" class="data row0 col3">0.6291</td>
<td id="T_a28ed_row0_col4" class="data row0 col4">0.3670</td>
</tr>
<tr class="even">
<td id="T_a28ed_row1_col0" class="data row1 col0">y_1</td>
<td id="T_a28ed_row1_col1" class="data row1 col1">0.2237</td>
<td id="T_a28ed_row1_col2" class="data row1 col2">0.0553</td>
<td id="T_a28ed_row1_col3" class="data row1 col3">0.2241</td>
<td id="T_a28ed_row1_col4" class="data row1 col4">0.4903</td>
</tr>
<tr class="odd">
<td id="T_a28ed_row2_col0" class="data row2 col0">y_2</td>
<td id="T_a28ed_row2_col1" class="data row2 col1">0.4756</td>
<td id="T_a28ed_row2_col2" class="data row2 col2">0.3574</td>
<td id="T_a28ed_row2_col3" class="data row2 col3">0.5449</td>
<td id="T_a28ed_row2_col4" class="data row2 col4">0.4099</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>obs cov (R)</p>
<table id="T_031c0" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_031c0_level0_col0" class="col_heading level0 col0">variable</th>
<th id="T_031c0_level0_col1" class="col_heading level0 col1">y_0</th>
<th id="T_031c0_level0_col2" class="col_heading level0 col2">y_1</th>
<th id="T_031c0_level0_col3" class="col_heading level0 col3">y_2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_031c0_row0_col0" class="data row0 col0">y_0</td>
<td id="T_031c0_row0_col1" class="data row0 col1">1.5641</td>
<td id="T_031c0_row0_col2" class="data row0 col2">0.0000</td>
<td id="T_031c0_row0_col3" class="data row0 col3">0.0000</td>
</tr>
<tr class="even">
<td id="T_031c0_row1_col0" class="data row1 col0">y_1</td>
<td id="T_031c0_row1_col1" class="data row1 col1">0.0000</td>
<td id="T_031c0_row1_col2" class="data row1 col2">1.1859</td>
<td id="T_031c0_row1_col3" class="data row1 col3">0.0000</td>
</tr>
<tr class="odd">
<td id="T_031c0_row2_col0" class="data row2 col0">y_2</td>
<td id="T_031c0_row2_col1" class="data row2 col1">0.0000</td>
<td id="T_031c0_row2_col2" class="data row2 col2">0.0000</td>
<td id="T_031c0_row2_col3" class="data row2 col3">0.6930</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>obs off</p>
<table id="T_bebcf" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_bebcf_level0_col0" class="col_heading level0 col0">variable</th>
<th id="T_bebcf_level0_col1" class="col_heading level0 col1">offset</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_bebcf_row0_col0" class="data row0 col0">y_0</td>
<td id="T_bebcf_row0_col1" class="data row0 col1">0.4045</td>
</tr>
<tr class="even">
<td id="T_bebcf_row1_col0" class="data row1 col0">y_1</td>
<td id="T_bebcf_row1_col1" class="data row1 col1">0.2622</td>
</tr>
<tr class="odd">
<td id="T_bebcf_row2_col0" class="data row2 col0">y_2</td>
<td id="T_bebcf_row2_col1" class="data row2 col1">0.4132</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>contr matrix (B)</p>
<table id="T_d5c02" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_d5c02_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_d5c02_level0_col1" class="col_heading level0 col1">c_0</th>
<th id="T_d5c02_level0_col2" class="col_heading level0 col2">c_1</th>
<th id="T_d5c02_level0_col3" class="col_heading level0 col3">c_2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_d5c02_row0_col0" class="data row0 col0">x_0</td>
<td id="T_d5c02_row0_col1" class="data row0 col1">0.3640</td>
<td id="T_d5c02_row0_col2" class="data row0 col2">0.6339</td>
<td id="T_d5c02_row0_col3" class="data row0 col3">0.1636</td>
</tr>
<tr class="even">
<td id="T_d5c02_row1_col0" class="data row1 col0">x_1</td>
<td id="T_d5c02_row1_col1" class="data row1 col1">0.7750</td>
<td id="T_d5c02_row1_col2" class="data row1 col2">0.8999</td>
<td id="T_d5c02_row1_col3" class="data row1 col3">0.4475</td>
</tr>
<tr class="odd">
<td id="T_d5c02_row2_col0" class="data row2 col0">x_2</td>
<td id="T_d5c02_row2_col1" class="data row2 col1">0.2087</td>
<td id="T_d5c02_row2_col2" class="data row2 col2">0.9819</td>
<td id="T_d5c02_row2_col3" class="data row2 col3">0.7791</td>
</tr>
<tr class="even">
<td id="T_d5c02_row3_col0" class="data row3 col0">x_3</td>
<td id="T_d5c02_row3_col1" class="data row3 col1">0.4139</td>
<td id="T_d5c02_row3_col2" class="data row3 col2">0.9798</td>
<td id="T_d5c02_row3_col3" class="data row3 col3">0.9052</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>init state mean</p>
<table id="T_bee5f" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_bee5f_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_bee5f_level0_col1" class="col_heading level0 col1">mean</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_bee5f_row0_col0" class="data row0 col0">x_0</td>
<td id="T_bee5f_row0_col1" class="data row0 col1">0.3830</td>
</tr>
<tr class="even">
<td id="T_bee5f_row1_col0" class="data row1 col0">x_1</td>
<td id="T_bee5f_row1_col1" class="data row1 col1">0.4214</td>
</tr>
<tr class="odd">
<td id="T_bee5f_row2_col0" class="data row2 col0">x_2</td>
<td id="T_bee5f_row2_col1" class="data row2 col1">0.5458</td>
</tr>
<tr class="even">
<td id="T_bee5f_row3_col0" class="data row3 col0">x_3</td>
<td id="T_bee5f_row3_col1" class="data row3 col1">0.5241</td>
</tr>
</tbody>
</table>
</div>
<div>
<p>init state cov</p>
<table id="T_42887" class="table table-sm table-striped">
<thead>
<tr class="header">
<th id="T_42887_level0_col0" class="col_heading level0 col0">state</th>
<th id="T_42887_level0_col1" class="col_heading level0 col1">x_0</th>
<th id="T_42887_level0_col2" class="col_heading level0 col2">x_1</th>
<th id="T_42887_level0_col3" class="col_heading level0 col3">x_2</th>
<th id="T_42887_level0_col4" class="col_heading level0 col4">x_3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_42887_row0_col0" class="data row0 col0">x_0</td>
<td id="T_42887_row0_col1" class="data row0 col1">1.3892</td>
<td id="T_42887_row0_col2" class="data row0 col2">0.7181</td>
<td id="T_42887_row0_col3" class="data row0 col3">1.6393</td>
<td id="T_42887_row0_col4" class="data row0 col4">1.3942</td>
</tr>
<tr class="even">
<td id="T_42887_row1_col0" class="data row1 col0">x_1</td>
<td id="T_42887_row1_col1" class="data row1 col1">0.7181</td>
<td id="T_42887_row1_col2" class="data row1 col2">0.8852</td>
<td id="T_42887_row1_col3" class="data row1 col3">0.9592</td>
<td id="T_42887_row1_col4" class="data row1 col4">0.8515</td>
</tr>
<tr class="odd">
<td id="T_42887_row2_col0" class="data row2 col0">x_2</td>
<td id="T_42887_row2_col1" class="data row2 col1">1.6393</td>
<td id="T_42887_row2_col2" class="data row2 col2">0.9592</td>
<td id="T_42887_row2_col3" class="data row2 col3">2.1083</td>
<td id="T_42887_row2_col4" class="data row2 col4">1.6580</td>
</tr>
<tr class="even">
<td id="T_42887_row3_col0" class="data row3 col0">x_3</td>
<td id="T_42887_row3_col1" class="data row3 col1">1.3942</td>
<td id="T_42887_row3_col2" class="data row3 col2">0.8515</td>
<td id="T_42887_row3_col3" class="data row3 col3">1.6580</td>
<td id="T_42887_row3_col4" class="data row3 col4">1.4405</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="constructors-1" class="level3">
<h3 class="anchored" data-anchor-id="constructors-1">Constructors</h3>
<section id="simple-parameters" class="level4">
<h4 class="anchored" data-anchor-id="simple-parameters">Simple parameters</h4>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L433" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="kalmanfilter.init_simple" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.init_simple">KalmanFilter.init_simple</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.init_simple (n_dim, dtype=torch.float64)</code></pre>
</blockquote>
<p>Simplest version of kalman filter parameters</p>
<table class="table">
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>n_dim</td>
<td></td>
<td></td>
<td>n_dim_obs and n_dim_state</td>
</tr>
<tr class="even">
<td>dtype</td>
<td>dtype</td>
<td>torch.float64</td>
<td></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>KalmanFilter.init_simple(<span class="dv">2</span>).state_dict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>OrderedDict([('trans_matrix',
              tensor([[1., 0.],
                      [0., 1.]], dtype=torch.float64)),
             ('trans_off', tensor([0., 0.], dtype=torch.float64)),
             ('trans_cov_raw',
              tensor([[1., 0.],
                      [0., 1.]], dtype=torch.float64)),
             ('contr_matrix',
              tensor([[1., 0.],
                      [0., 1.]], dtype=torch.float64)),
             ('obs_matrix',
              tensor([[1., 0.],
                      [0., 1.]], dtype=torch.float64)),
             ('obs_off', tensor([0., 0.], dtype=torch.float64)),
             ('obs_cov_raw', tensor([0., 0.], dtype=torch.float64)),
             ('init_state_mean', tensor([0., 0.], dtype=torch.float64)),
             ('init_state_cov_raw',
              tensor([[1., 0.],
                      [0., 1.]], dtype=torch.float64))])</code></pre>
</div>
</div>
<section id="local-slope" class="level4">
<h4 class="anchored" data-anchor-id="local-slope">Local slope</h4>
<p>Local slope models are an extentions of local level model that in the state variable keep track of also the slope</p>
<p>Given <span class="math inline">\(n\)</span> as the number of dimensions of the observations</p>
<p>The transition matrix (<code>A</code>) is:</p>
<p><span class="math display">\[A = \left[\begin{array}{cc}I &amp; I \\ 0 &amp; I\end{array}\right]\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(I \in \mathbb{R}^{n \times n}\)</span></li>
<li><span class="math inline">\(A \in \mathbb{R}^{2n \times 2n}\)</span></li>
</ul>
<p>the state <span class="math inline">\(x \in \mathbb{R}^{2N \times 1}\)</span> where the upper half keep track of the level and the lower half of the slope. <span class="math inline">\(A \in \mathbb{R}^2N \times 2N\)</span></p>
<p>the observation matrix (<code>H</code>) is:</p>
<p><span class="math display">\[H = \left[\begin{array}{cc}I &amp; 0 \end{array}\right]\]</span></p>
<p>For the multivariate case the 1 are replaced with an identiy matrix</p>
<p>assuming that the control has the same dimensions of the observations then if we are doing a local slope model we have <span class="math inline">\(B \in \mathbb{R}^{state \times contr}\)</span>: <span class="math display">\[ B = \begin{bmatrix} -I &amp; I \\ 0 &amp; 0 \end{bmatrix}\]</span></p>
<hr>
<p><a href="https://github.com/mone27/meteo_imp/blob/master/meteo_imp/kalman/filter.py#L463" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
</section>
<section id="kalmanfilter.init_local_slope_pca" class="level3">
<h3 class="anchored" data-anchor-id="kalmanfilter.init_local_slope_pca">KalmanFilter.init_local_slope_pca</h3>
<blockquote class="blockquote">
<pre><code> KalmanFilter.init_local_slope_pca (n_dim_obs, n_dim_state:int,
                                    df_pca:pandas.core.frame.DataFrame|Non
                                    e=None, **kwargs)</code></pre>
</blockquote>
<p>Local Slope + PCA init</p>
<table class="table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>n_dim_obs</td>
<td></td>
<td></td>
<td>n_dim_obs and n_dim_contr</td>
</tr>
<tr class="even">
<td>n_dim_state</td>
<td>int</td>
<td></td>
<td>n_dim_state</td>
</tr>
<tr class="odd">
<td>df_pca</td>
<td>pandas.core.frame.DataFrame | None</td>
<td>None</td>
<td>dataframe for PCA init, None no PCA init</td>
</tr>
<tr class="even">
<td>kwargs</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>KalmanFilter.init_local_slope_pca(<span class="dv">2</span>,<span class="dv">2</span>,pd.DataFrame([[<span class="dv">1</span>,<span class="dv">2</span>], [<span class="dv">2</span>,<span class="dv">4</span>]])).state_dict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>OrderedDict([('trans_matrix',
              tensor([[1., 0., 1., 0.],
                      [0., 1., 0., 1.],
                      [0., 0., 1., 0.],
                      [0., 0., 0., 1.]], dtype=torch.float64)),
             ('trans_off', tensor([0., 0., 0., 0.], dtype=torch.float64)),
             ('trans_cov_raw',
              tensor([[0.3162, 0.0000, 0.0000, 0.0000],
                      [0.0000, 0.3162, 0.0000, 0.0000],
                      [0.0000, 0.0000, 0.3162, 0.0000],
                      [0.0000, 0.0000, 0.0000, 0.3162]], dtype=torch.float64)),
             ('contr_matrix',
              tensor([[-0.4472, -0.8944,  0.4472,  0.8944],
                      [-0.8944,  0.4472,  0.8944, -0.4472],
                      [ 0.0000,  0.0000,  0.0000,  0.0000],
                      [ 0.0000,  0.0000,  0.0000,  0.0000]], dtype=torch.float64)),
             ('obs_matrix',
              tensor([[ 0.4472,  0.8944,  0.0000,  0.0000],
                      [ 0.8944, -0.4472,  0.0000,  0.0000]], dtype=torch.float64)),
             ('obs_off', tensor([0., 0.], dtype=torch.float64)),
             ('obs_cov_raw', tensor([-4.6052, -4.6052], dtype=torch.float64)),
             ('init_state_mean',
              tensor([0., 0., 0., 0.], dtype=torch.float64)),
             ('init_state_cov_raw',
              tensor([[1.7321, 0.0000, 0.0000, 0.0000],
                      [0.0000, 1.7321, 0.0000, 0.0000],
                      [0.0000, 0.0000, 1.7321, 0.0000],
                      [0.0000, 0.0000, 0.0000, 1.7321]], dtype=torch.float64))])</code></pre>
</div>
</div>
</section>
</section>
<section id="export" class="level2">
<h2 class="anchored" data-anchor-id="export">Export</h2>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>