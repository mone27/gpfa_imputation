<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.4">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Plotting for results – Meteo Imp Analsyis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-c9f28ac3654e8145e3f329489cfce6b3.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-b639d1ae7fba4b2406dd7e01c700a741.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<meta property="og:title" content="Plotting for results – Meteo Imp Analsyis">
<meta property="og:description" content="Meteo Imputation">
<meta property="og:image" content="https://mone27.github.io/meteo_imp/results/result_plots_files/figure-html/cell-14-output-1.png">
<meta property="og:site_name" content="Meteo Imp Analsyis">
<meta property="og:image:height" content="733">
<meta property="og:image:width" content="974">
<meta name="twitter:title" content="Plotting for results – Meteo Imp Analsyis">
<meta name="twitter:description" content="Meteo Imputation">
<meta name="twitter:image" content="https://mone27.github.io/meteo_imp/results/result_plots_files/figure-html/cell-14-output-1.png">
<meta name="twitter:image-height" content="733">
<meta name="twitter:image-width" content="974">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Meteo Imp Analsyis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../lib"> 
<span class="menu-text">Library Docs</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#correlation" id="toc-correlation" class="nav-link active" data-scroll-target="#correlation">Correlation</a></li>
  <li><a href="#comparison-imputation-methods" id="toc-comparison-imputation-methods" class="nav-link" data-scroll-target="#comparison-imputation-methods">Comparison Imputation methods</a>
  <ul class="collapse">
  <li><a href="#state-of-the-art" id="toc-state-of-the-art" class="nav-link" data-scroll-target="#state-of-the-art">State of the art</a></li>
  <li><a href="#percentage-improvement" id="toc-percentage-improvement" class="nav-link" data-scroll-target="#percentage-improvement">Percentage improvement</a></li>
  <li><a href="#main-plot" id="toc-main-plot" class="nav-link" data-scroll-target="#main-plot">Main plot</a></li>
  <li><a href="#table" id="toc-table" class="nav-link" data-scroll-target="#table">Table</a></li>
  <li><a href="#timeseries" id="toc-timeseries" class="nav-link" data-scroll-target="#timeseries">Timeseries</a></li>
  </ul></li>
  <li><a href="#kalman-filter-analysis" id="toc-kalman-filter-analysis" class="nav-link" data-scroll-target="#kalman-filter-analysis">Kalman Filter analysis</a>
  <ul class="collapse">
  <li><a href="#gap-len" id="toc-gap-len" class="nav-link" data-scroll-target="#gap-len">Gap len</a></li>
  <li><a href="#control" id="toc-control" class="nav-link" data-scroll-target="#control">Control</a></li>
  <li><a href="#gap-in-other-variables" id="toc-gap-in-other-variables" class="nav-link" data-scroll-target="#gap-in-other-variables">Gap in Other variables</a></li>
  <li><a href="#generic-vs-specialized" id="toc-generic-vs-specialized" class="nav-link" data-scroll-target="#generic-vs-specialized">Generic vs Specialized</a></li>
  <li><a href="#training" id="toc-training" class="nav-link" data-scroll-target="#training">Training</a></li>
  </ul></li>
  <li><a href="#extra-results" id="toc-extra-results" class="nav-link" data-scroll-target="#extra-results">Extra results</a>
  <ul class="collapse">
  <li><a href="#standard-deviations" id="toc-standard-deviations" class="nav-link" data-scroll-target="#standard-deviations">Standard deviations</a></li>
  <li><a href="#gap-distribution" id="toc-gap-distribution" class="nav-link" data-scroll-target="#gap-distribution">Gap distribution</a></li>
  <li><a href="#square-root-filter" id="toc-square-root-filter" class="nav-link" data-scroll-target="#square-root-filter">Square Root Filter</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Plotting for results</h1>
</div>



<div class="quarto-title-meta column-page-left">

    
  
    
  </div>
  


</header>


<p>This notebook produces all results plots. It generates some gap in the data, fill with a method (filter, MDS …), compute metrics and then makes all relevant plots</p>
<div id="8f5d0618-2625-43ff-84f2-59b3e946bd99" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>load_ext autoreload</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>autoreload <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6f195049-d6ed-47fc-9628-74e6c2d2aa80" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> altair <span class="im">as</span> alt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="97717125-2e40-474e-a9a6-2ae949d96757" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> meteo_imp.kalman.results <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> meteo_imp.data <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> meteo_imp.utils <span class="im">import</span> <span class="op">*</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyprojroot <span class="im">import</span> here</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> SVG, Image</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> meteo_imp.kalman.results <span class="im">import</span> _plot_timeseries, _get_labels</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> contextlib <span class="im">import</span> redirect_stderr</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> io</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> polars <span class="im">as</span> pl</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.data <span class="im">import</span> get_grid</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cairosvg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>the generation of a proper pdf is complex as <code>altair_render</code> doesn’t support <code>XOffset</code>, so plotsare first renderder to svg using <code>vl-convert</code> and then to pdf using <code>cairosvg</code>. However this last methods doesn’t support negative numbers …</p>
<p>Due to the high number of samples also cannot use the browser render in the notebook so using <code>vl-convert</code> to a png for the visualization in the notebook</p>
<div id="01c42271-bc8d-40df-8030-b086e33ceb90" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> vl_convert <span class="im">as</span> vlc</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyprojroot <span class="im">import</span> here</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>base_path_img <span class="op">=</span> here(<span class="st">"manuscript/Master Thesis - Evaluation of Kalman filter for meteorological time series imputation for Eddy Covariance applications - Simone Massaro/images/"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>base_path_tbl <span class="op">=</span> here(<span class="st">"manuscript/Master Thesis - Evaluation of Kalman filter for meteorological time series imputation for Eddy Covariance applications - Simone Massaro/tables/"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>base_path_img.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>), base_path_tbl.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> save_show_plot(plot,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                   path,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                   altair_render<span class="op">=</span><span class="va">False</span> <span class="co"># use altair render for pdf?</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                  ):</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    plt_json <span class="op">=</span> plot.to_json()</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> altair_render:</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        svg_data <span class="op">=</span> vlc.vegalite_to_svg(vl_spec<span class="op">=</span>plt_json)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(base_path_img <span class="op">/</span> (path <span class="op">+</span> <span class="st">".svg"</span>), <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>            f.write(svg_data)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        cairosvg.svg2pdf(file_obj<span class="op">=</span><span class="bu">open</span>(base_path_img <span class="op">/</span> (path <span class="op">+</span> <span class="st">".svg"</span>)), write_to<span class="op">=</span><span class="bu">str</span>(base_path_img <span class="op">/</span> (path <span class="op">+</span> <span class="st">".pdf"</span>)))</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">#save svg version anyway</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        svg_data <span class="op">=</span> vlc.vegalite_to_svg(vl_spec<span class="op">=</span>plt_json)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(base_path_img <span class="op">/</span> (path <span class="op">+</span> <span class="st">".svg"</span>), <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>            f.write(svg_data)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">#convert to pdf using altair</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> redirect_stderr(io.StringIO()):</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>            plot.save(base_path_img <span class="op">/</span> (path <span class="op">+</span> <span class="st">".pdf"</span>))</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># render to image for displaying in notebook</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    png_data <span class="op">=</span> vlc.vegalite_to_png(vl_spec<span class="op">=</span>plot.to_json(), scale<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> Image(png_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1daee753-a9dc-4aa7-b72b-cdb83ab44ee5" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>reset_seed()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>n_rep <span class="op">=</span> <span class="dv">500</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="17ea6bc9-8ada-48a1-89fb-fcf0f5a1206e" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>hai <span class="op">=</span> pd.read_parquet(hai_big_path).reindex(columns<span class="op">=</span>var_type.categories)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>hai_era <span class="op">=</span> pd.read_parquet(hai_era_big_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="14812163-c5a3-4fca-ab12-209e79e9e5c6" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>alt.data_transformers.disable_max_rows() <span class="co"># it is safe to do so as the plots are rendered using vl-convert and then showed as images</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>DataTransformerRegistry.enable('default')</code></pre>
</div>
</div>
<section id="correlation" class="level2">
<h2 class="anchored" data-anchor-id="correlation">Correlation</h2>
<div id="169ed21b-07a5-46c1-ad54-1cb6c60f55f5" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="e4759b4c-b1ff-4b20-9d75-de80a4f04359" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="e7d833d5-c0f8-48f3-8b45-7985e39aed67" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> auto_corr_df(data, nlags<span class="op">=</span><span class="dv">96</span>):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    autocorr <span class="op">=</span> {}</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> data.columns:</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        autocorr[col] <span class="op">=</span> sm.tsa.acf(data[col], nlags<span class="op">=</span>nlags)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(autocorr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d808c4ae-8701-4f03-ba24-11650e2c4942" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>auto_corr <span class="op">=</span> auto_corr_df(hai).reset_index(names<span class="op">=</span><span class="st">"gap_len"</span>).melt(id_vars<span class="op">=</span><span class="st">"gap_len"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>auto_corr.gap_len <span class="op">=</span> auto_corr.gap_len <span class="op">/</span> <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="00298220-255c-4eb3-ac62-8a7fb1c26478" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>auto_corr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">gap_len</th>
<th data-quarto-table-cell-role="th">variable</th>
<th data-quarto-table-cell-role="th">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.0</td>
<td>TA</td>
<td>1.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.5</td>
<td>TA</td>
<td>0.998595</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1.0</td>
<td>TA</td>
<td>0.995814</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1.5</td>
<td>TA</td>
<td>0.992141</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2.0</td>
<td>TA</td>
<td>0.987630</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">868</td>
<td>46.0</td>
<td>TS</td>
<td>0.959680</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">869</td>
<td>46.5</td>
<td>TS</td>
<td>0.961116</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">870</td>
<td>47.0</td>
<td>TS</td>
<td>0.962085</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">871</td>
<td>47.5</td>
<td>TS</td>
<td>0.962551</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">872</td>
<td>48.0</td>
<td>TS</td>
<td>0.962480</td>
</tr>
</tbody>
</table>

<p>873 rows × 3 columns</p>
</div>
</div>
</div>
<div id="72a0760c-99d0-40d6-b8b4-eb6636901450" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> (alt.Chart(auto_corr).mark_line().encode(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> alt.X(<span class="st">'gap_len'</span>, title<span class="op">=</span><span class="st">"Gap length [h]"</span>, axis <span class="op">=</span> alt.Axis(values<span class="op">=</span> [<span class="dv">12</span>, <span class="dv">24</span>, <span class="dv">36</span>, <span class="dv">48</span>])),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> alt.Y(<span class="st">"value"</span>, title<span class="op">=</span><span class="st">"correlation"</span>),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span>alt.Color(<span class="st">"variable"</span>, scale<span class="op">=</span>meteo_scale, title<span class="op">=</span><span class="st">"Variable"</span>),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    facet <span class="op">=</span>alt.Facet(<span class="st">'variable'</span>, columns<span class="op">=</span><span class="dv">3</span>, sort <span class="op">=</span> meteo_scale.domain, title<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                     header <span class="op">=</span> alt.Header(labelFontWeight<span class="op">=</span><span class="st">"bold"</span>, labelFontSize<span class="op">=</span><span class="dv">20</span>))</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    .properties(height<span class="op">=</span><span class="dv">120</span>, width<span class="op">=</span><span class="dv">250</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    .resolve_scale(y<span class="op">=</span><span class="st">'independent'</span>, x <span class="op">=</span> <span class="st">'independent'</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    .pipe(plot_formatter))</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>save_show_plot(p, <span class="st">"temporal_autocorrelation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="result_plots_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="21f6a40a-e089-482c-a10e-7469942c9a6d" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> get_grid(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">8</span>))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>sns.<span class="bu">set</span>(font_scale<span class="op">=</span><span class="fl">1.25</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>sns.heatmap(hai.corr(), annot<span class="op">=</span><span class="va">True</span>,     vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>, center<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span>sns.diverging_palette(<span class="dv">20</span>, <span class="dv">220</span>, n<span class="op">=</span><span class="dv">200</span>), ax<span class="op">=</span>axes[<span class="dv">0</span>], square<span class="op">=</span><span class="va">True</span>, cbar<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># axes[0].set(xlabel="Variable", ylabel="Variable", title="Inter-variable Correlation");</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># size_old = plt.rcParams["axes.labelsize"]</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># w_old = plt.rcParams["axes.labelweight"]</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.rcParams["axes.labelsize"] = 30</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.rcParams["axes.labelweight"] = 'bold'</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>plt.xticks(weight <span class="op">=</span> <span class="st">'bold'</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>plt.yticks(weight <span class="op">=</span> <span class="st">'bold'</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> matplotlib.rc_context({<span class="st">"axes.labelsize"</span>: <span class="dv">30</span>}):</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    plt.savefig(base_path_img <span class="op">/</span> <span class="st">"correlation.pdf"</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.rcParams["axes.labelsize"] = size_old</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.rcParams["axes.labelweight"] = w_old</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="result_plots_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="comparison-imputation-methods" class="level2">
<h2 class="anchored" data-anchor-id="comparison-imputation-methods">Comparison Imputation methods</h2>
<div id="23c020cf-9f43-4bba-911a-56ab02eb1fd8" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>base_path <span class="op">=</span> here(<span class="st">"analysis/results/trained_models"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f81cbb90-5b73-453d-9399-948e347d97fb" class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> l_model(x, base_path<span class="op">=</span>base_path): <span class="cf">return</span> torch.load(base_path <span class="op">/</span> x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="920200e1-d0e7-4f08-a81c-f9e5758e0a98" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>models_var <span class="op">=</span> pd.DataFrame.from_records([</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'var'</span>: <span class="st">'TA'</span>,    <span class="st">'model'</span>: l_model(<span class="st">"TA_specialized_gap_6-336_v3_0.pickle"</span>,base_path)},</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'var'</span>: <span class="st">'SW_IN'</span>, <span class="st">'model'</span>: l_model(<span class="st">"SW_IN_specialized_gap_6-336_v2_0.pickle"</span>,base_path)},</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'var'</span>: <span class="st">'LW_IN'</span>, <span class="st">'model'</span>: l_model(<span class="st">"LW_IN_specialized_gap_6-336_v1.pickle"</span>,base_path)},</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'var'</span>: <span class="st">'VPD'</span>,   <span class="st">'model'</span>: l_model(<span class="st">"VPD_specialized_gap_6-336_v2_0.pickle"</span>,base_path)},</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'var'</span>: <span class="st">'WS'</span>,    <span class="st">'model'</span>: l_model(<span class="st">"WS_specialized_gap_6-336_v1.pickle"</span>,base_path)},</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'var'</span>: <span class="st">'PA'</span>,    <span class="st">'model'</span>: l_model(<span class="st">"PA_specialized_gap_6-336_v3_0.pickle"</span>,base_path)},</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'var'</span>: <span class="st">'P'</span>,     <span class="st">'model'</span>: l_model(<span class="st">"1_gap_varying_6-336_v3.pickle"</span>,base_path)},</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'var'</span>: <span class="st">'TS'</span>,    <span class="st">'model'</span>: l_model(<span class="st">"TS_specialized_gap_6-336_v2_0.pickle"</span>,base_path)},</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'var'</span>: <span class="st">'SWC'</span>,   <span class="st">'model'</span>: l_model(<span class="st">"SWC_specialized_gap_6-336_v2_1.pickle"</span>,base_path)},</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="67787142-2082-4fea-a508-9df332733ed4" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="at">@cache_disk</span>(cache_dir <span class="op">/</span> <span class="st">"the_results"</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_the_results(n_rep<span class="op">=</span><span class="dv">20</span>):</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    reset_seed()</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    comp_Av <span class="op">=</span> ImpComparison(models <span class="op">=</span> models_var, df <span class="op">=</span> hai, control <span class="op">=</span> hai_era, block_len <span class="op">=</span> <span class="dv">446</span>, time_series<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    results_Av <span class="op">=</span> comp_Av.compare(gap_len <span class="op">=</span> [<span class="dv">12</span>,<span class="dv">24</span>, <span class="dv">48</span>, <span class="dv">336</span>], var<span class="op">=</span><span class="bu">list</span>(hai.columns), n_rep<span class="op">=</span>n_rep) </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_Av</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>results_Av <span class="op">=</span> get_the_results(n_rep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="state-of-the-art" class="level3">
<h3 class="anchored" data-anchor-id="state-of-the-art">State of the art</h3>
<p>the first plot is a time series using only state-of-the-art methods</p>
<div id="40fd8e27-1119-45e7-90a0-51f2562a2b48" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>reset_seed()</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>comp_ts <span class="op">=</span> ImpComparison(models <span class="op">=</span> models_var, df <span class="op">=</span> hai, control <span class="op">=</span> hai_era, block_len <span class="op">=</span> <span class="dv">48</span><span class="op">+</span><span class="dv">100</span>, time_series<span class="op">=</span><span class="va">True</span>, rmse<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>results_ts <span class="op">=</span> comp_ts.compare(gap_len <span class="op">=</span> [<span class="dv">48</span>], var<span class="op">=</span><span class="bu">list</span>(hai.columns), n_rep<span class="op">=</span><span class="dv">1</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"6eda331d01274e269e4d141261eba226","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div id="1a6d201d-74b9-4683-9ae2-d892e2236184" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>res_ts <span class="op">=</span> results_ts.query(<span class="st">"method != 'Kalman Filter'"</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>res_ts_plot <span class="op">=</span> pd.concat([unnest_predictions(row, ctx_len<span class="op">=</span><span class="dv">72</span>) <span class="cf">for</span> _,row <span class="kw">in</span> res_ts.iterrows()])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cf6f0b95-2b82-41a9-bb96-9a00fa229bfd" class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>scale_sota <span class="op">=</span> alt.Scale(domain<span class="op">=</span>[<span class="st">"ERA-I"</span>, <span class="st">"MDS"</span>], <span class="bu">range</span><span class="op">=</span><span class="bu">list</span>(sns.color_palette(<span class="st">'Dark2'</span>, <span class="dv">3</span>).as_hex())[<span class="dv">1</span>:])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="8269dd8c-f51f-4039-8fb2-268beecd3291" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> (facet_wrap(res_ts_plot, partial(_plot_timeseries, scale_color<span class="op">=</span>scale_sota, err_band <span class="op">=</span> <span class="va">False</span>), col<span class="op">=</span><span class="st">"var"</span>,</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                y_labels <span class="op">=</span> _get_labels(res_ts_plot, <span class="st">'mean'</span>, <span class="va">None</span>),</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>               )</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>            .pipe(plot_formatter)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>save_show_plot(p, <span class="st">"timeseries_sota"</span>, altair_render<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="result_plots_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="percentage-improvement" class="level3">
<h3 class="anchored" data-anchor-id="percentage-improvement">Percentage improvement</h3>
<div id="16567f9c-6192-48d9-ba25-2319a7b78a15" class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>results_Av.method.unique()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['Kalman Filter', 'ERA-I', 'MDS']
Categories (3, object): ['Kalman Filter' &lt; 'ERA-I' &lt; 'MDS']</code></pre>
</div>
</div>
<div id="9057734c-2b07-4a1d-931c-7c5b80760375" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>all_res <span class="op">=</span> results_Av.query(<span class="st">'var != "P"'</span>).groupby([<span class="st">'method'</span>]).agg({<span class="st">'rmse_stand'</span>: <span class="st">'mean'</span>}).T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="5736d5ed-99d4-4081-8961-71599ea0a71b" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>all_res</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">method</th>
<th data-quarto-table-cell-role="th">Kalman Filter</th>
<th data-quarto-table-cell-role="th">ERA-I</th>
<th data-quarto-table-cell-role="th">MDS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">rmse_stand</td>
<td>0.204628</td>
<td>0.307361</td>
<td>0.482837</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>percentage of improvement across all variables</p>
<div id="23b3aa36-9858-47c3-adeb-c89e757b1bf6" class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>(all_res[<span class="st">"ERA-I"</span>] <span class="op">-</span> all_res[<span class="st">"Kalman Filter"</span>]) <span class="op">/</span> all_res[<span class="st">"ERA-I"</span>] <span class="op">*</span> <span class="dv">100</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>rmse_stand    33.42398
dtype: float64</code></pre>
</div>
</div>
<div id="84a4700d-94ca-451c-9b1b-dc4f05fa1ce3" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>(all_res[<span class="st">"MDS"</span>] <span class="op">-</span> all_res[<span class="st">"Kalman Filter"</span>]) <span class="op">/</span> all_res[<span class="st">"MDS"</span>] <span class="op">*</span> <span class="dv">100</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>rmse_stand    57.619542
dtype: float64</code></pre>
</div>
</div>
<div id="56c7d661-0b5f-4e2e-a72a-5c2e9d64272c" class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>res_var <span class="op">=</span> results_Av.groupby([<span class="st">'method'</span>, <span class="st">'var'</span>]).agg({<span class="st">'rmse_stand'</span>: <span class="st">'mean'</span>}) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="263c34e7-3e24-45cd-95c1-457bbde62acd" class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>res_var <span class="op">=</span> res_var.reset_index().pivot(columns<span class="op">=</span><span class="st">'method'</span>, values<span class="op">=</span><span class="st">'rmse_stand'</span>, index<span class="op">=</span><span class="st">'var'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="5ea7a661-e605-4e10-9cd6-ad96382d20f4" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame({<span class="st">'ERA'</span>: (res_var[<span class="st">"ERA-I"</span>] <span class="op">-</span> res_var[<span class="st">"Kalman Filter"</span>]) <span class="op">/</span> res_var[<span class="st">"ERA-I"</span>] <span class="op">*</span> <span class="dv">100</span>, <span class="st">'MDS'</span>: (res_var[<span class="st">"MDS"</span>] <span class="op">-</span> res_var[<span class="st">"Kalman Filter"</span>]) <span class="op">/</span> res_var[<span class="st">"MDS"</span>] <span class="op">*</span> <span class="dv">100</span> })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ERA</th>
<th data-quarto-table-cell-role="th">MDS</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">var</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">TA</td>
<td>54.540802</td>
<td>77.713711</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">SW_IN</td>
<td>12.004508</td>
<td>35.516142</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">LW_IN</td>
<td>5.166063</td>
<td>52.289627</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">VPD</td>
<td>44.402821</td>
<td>65.407769</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">WS</td>
<td>21.064305</td>
<td>40.321732</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">PA</td>
<td>28.784191</td>
<td>90.751559</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">P</td>
<td>-18.544370</td>
<td>-22.084360</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">SWC</td>
<td>NaN</td>
<td>41.543006</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">TS</td>
<td>NaN</td>
<td>25.772326</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="944b2dea-e64b-40d8-b03f-efede94e6dce" class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>res_var2 <span class="op">=</span> results_Av.groupby([<span class="st">'method'</span>, <span class="st">'var'</span>, <span class="st">'gap_len'</span>]).agg({<span class="st">'rmse_stand'</span>: <span class="st">'mean'</span>}) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="868e8136-ff81-4f98-a2c8-bcfdb01dc6c3" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>res_var2 <span class="op">=</span> res_var2.reset_index().pivot(columns<span class="op">=</span><span class="st">'method'</span>, values<span class="op">=</span><span class="st">'rmse_stand'</span>, index<span class="op">=</span>[<span class="st">'var'</span>, <span class="st">'gap_len'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a57b84f8-df19-4d12-881f-bab424c28c36" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame({<span class="st">'ERA'</span>: (res_var2[<span class="st">"ERA-I"</span>] <span class="op">-</span> res_var2[<span class="st">"Kalman Filter"</span>]) <span class="op">/</span> res_var2[<span class="st">"ERA-I"</span>] <span class="op">*</span> <span class="dv">100</span>, <span class="st">'MDS'</span>: (res_var2[<span class="st">"MDS"</span>] <span class="op">-</span> res_var2[<span class="st">"Kalman Filter"</span>]) <span class="op">/</span> res_var2[<span class="st">"MDS"</span>] <span class="op">*</span> <span class="dv">100</span> })</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ERA</th>
<th data-quarto-table-cell-role="th">MDS</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">var</th>
<th data-quarto-table-cell-role="th">gap_len</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">TA</td>
<td data-quarto-table-cell-role="th">6</td>
<td>69.897582</td>
<td>85.052698</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>58.766166</td>
<td>79.376385</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>51.538443</td>
<td>75.395970</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">168</td>
<td>41.823614</td>
<td>73.000401</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">SW_IN</td>
<td data-quarto-table-cell-role="th">6</td>
<td>9.519984</td>
<td>29.746651</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>11.165399</td>
<td>30.639223</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>14.232051</td>
<td>34.811941</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">168</td>
<td>12.305658</td>
<td>42.651906</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">LW_IN</td>
<td data-quarto-table-cell-role="th">6</td>
<td>21.023524</td>
<td>59.136518</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>9.110040</td>
<td>52.211404</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>-3.553292</td>
<td>50.720632</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">168</td>
<td>-4.260023</td>
<td>48.223005</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">VPD</td>
<td data-quarto-table-cell-role="th">6</td>
<td>66.980942</td>
<td>79.449579</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>47.785633</td>
<td>69.081018</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>33.663749</td>
<td>56.728120</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">168</td>
<td>32.272332</td>
<td>57.702579</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">WS</td>
<td data-quarto-table-cell-role="th">6</td>
<td>32.402977</td>
<td>45.724043</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>25.209162</td>
<td>43.275430</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>15.543672</td>
<td>37.142502</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">168</td>
<td>12.735569</td>
<td>36.436106</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">PA</td>
<td data-quarto-table-cell-role="th">6</td>
<td>39.823585</td>
<td>91.511486</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>30.995845</td>
<td>90.532461</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>24.727301</td>
<td>89.319180</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">168</td>
<td>20.691181</td>
<td>91.421434</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">P</td>
<td data-quarto-table-cell-role="th">6</td>
<td>-18.485009</td>
<td>-13.917879</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>-28.935358</td>
<td>-37.127331</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>-24.423076</td>
<td>-29.998707</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">168</td>
<td>-7.725322</td>
<td>-11.587796</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">SWC</td>
<td data-quarto-table-cell-role="th">6</td>
<td>NaN</td>
<td>61.302664</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>NaN</td>
<td>47.976950</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>NaN</td>
<td>42.535719</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">168</td>
<td>NaN</td>
<td>23.301469</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">TS</td>
<td data-quarto-table-cell-role="th">6</td>
<td>NaN</td>
<td>64.264901</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>NaN</td>
<td>46.699870</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">24</td>
<td>NaN</td>
<td>27.050291</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">168</td>
<td>NaN</td>
<td>-15.268479</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="main-plot" class="level3">
<h3 class="anchored" data-anchor-id="main-plot">Main plot</h3>
<div id="1121a833-5d71-4ec6-a914-4514fb6fb6c0" class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> product</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> altair <span class="im">as</span> alt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ed796888-cb28-4260-b4b7-419a6b9806d5" class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> the_plot(results_Av)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>save_show_plot(p, <span class="st">"the_plot"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="result_plots_files/figure-html/cell-37-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="c78a9ea6-5348-4f5d-ae7e-b5edae12b5a6" class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> the_plot_stand(results_Av)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>save_show_plot(p, <span class="st">"the_plot_stand"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="result_plots_files/figure-html/cell-38-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="table" class="level3">
<h3 class="anchored" data-anchor-id="table">Table</h3>
<div id="9916df10-d3d4-43d6-bf82-da9e8083f8a3" class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> the_table(results_Av)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>the_table_latex(t, base_path_tbl <span class="op">/</span> <span class="st">"the_table.tex"</span>, label<span class="op">=</span><span class="st">"tbl:the_table"</span>,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>                caption<span class="op">=</span><span class="st">"</span><span class="ch">\\</span><span class="st">CapTheTable"</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">Kalman Filter</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">ERA-I</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">MDS</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">RMSE</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
</tr>
<tr class="header">
<th data-quarto-table-cell-role="th">Variable</th>
<th data-quarto-table-cell-role="th">Gap</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">TA</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>0.405453</td>
<td>0.258301</td>
<td>1.346910</td>
<td>0.997843</td>
<td>2.712546</td>
<td>1.896914</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>0.606836</td>
<td>0.400849</td>
<td>1.471695</td>
<td>0.900611</td>
<td>2.942435</td>
<td>1.748131</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>0.741275</td>
<td>0.368468</td>
<td>1.529614</td>
<td>0.800256</td>
<td>3.012819</td>
<td>1.611311</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>1.020608</td>
<td>0.444591</td>
<td>1.754334</td>
<td>0.643160</td>
<td>3.780087</td>
<td>1.315472</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">SW_IN</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>44.636609</td>
<td>40.464629</td>
<td>49.333113</td>
<td>66.241975</td>
<td>63.536627</td>
<td>85.401585</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>48.155186</td>
<td>33.868178</td>
<td>54.207691</td>
<td>49.769296</td>
<td>69.427115</td>
<td>68.936352</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>56.564277</td>
<td>30.042752</td>
<td>65.950367</td>
<td>40.930505</td>
<td>86.770917</td>
<td>59.603564</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>61.582820</td>
<td>25.740161</td>
<td>70.224393</td>
<td>34.883199</td>
<td>107.384249</td>
<td>53.606111</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">LW_IN</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>10.902409</td>
<td>7.736087</td>
<td>13.804628</td>
<td>12.987987</td>
<td>26.680077</td>
<td>15.022366</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>13.421656</td>
<td>7.734502</td>
<td>14.766929</td>
<td>12.584725</td>
<td>28.085478</td>
<td>13.457335</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>14.593819</td>
<td>7.840046</td>
<td>14.093052</td>
<td>12.227900</td>
<td>29.614461</td>
<td>12.416763</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>17.062880</td>
<td>6.425136</td>
<td>16.365697</td>
<td>11.129569</td>
<td>32.954558</td>
<td>8.833972</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">VPD</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>0.428187</td>
<td>0.363168</td>
<td>1.296787</td>
<td>1.547397</td>
<td>2.083592</td>
<td>2.149288</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>0.660623</td>
<td>0.504761</td>
<td>1.265213</td>
<td>1.288794</td>
<td>2.136626</td>
<td>2.095549</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>0.827563</td>
<td>0.501975</td>
<td>1.247527</td>
<td>1.032319</td>
<td>1.912472</td>
<td>1.605013</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>1.125680</td>
<td>0.633392</td>
<td>1.662069</td>
<td>1.127314</td>
<td>2.661345</td>
<td>1.965431</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">WS</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>0.616774</td>
<td>0.316972</td>
<td>0.912428</td>
<td>0.508295</td>
<td>1.136367</td>
<td>0.783146</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>0.715412</td>
<td>0.350974</td>
<td>0.956550</td>
<td>0.524247</td>
<td>1.261203</td>
<td>0.796744</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>0.801851</td>
<td>0.343378</td>
<td>0.949427</td>
<td>0.446912</td>
<td>1.275665</td>
<td>0.608630</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>0.950211</td>
<td>0.363124</td>
<td>1.088887</td>
<td>0.348541</td>
<td>1.494891</td>
<td>0.615371</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">PA</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>0.045046</td>
<td>0.034294</td>
<td>0.074856</td>
<td>0.061726</td>
<td>0.530665</td>
<td>0.441476</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>0.053359</td>
<td>0.041613</td>
<td>0.077328</td>
<td>0.058476</td>
<td>0.563603</td>
<td>0.427426</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>0.059481</td>
<td>0.038666</td>
<td>0.079021</td>
<td>0.051491</td>
<td>0.556899</td>
<td>0.404451</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>0.066325</td>
<td>0.047544</td>
<td>0.083628</td>
<td>0.053654</td>
<td>0.773143</td>
<td>0.384029</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">P</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>0.134093</td>
<td>0.274033</td>
<td>0.113173</td>
<td>0.315504</td>
<td>0.117710</td>
<td>0.305539</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>0.178871</td>
<td>0.295419</td>
<td>0.138729</td>
<td>0.297227</td>
<td>0.130442</td>
<td>0.281377</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>0.206231</td>
<td>0.253588</td>
<td>0.165750</td>
<td>0.288432</td>
<td>0.158641</td>
<td>0.265257</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>0.239885</td>
<td>0.173820</td>
<td>0.222682</td>
<td>0.201782</td>
<td>0.214975</td>
<td>0.197499</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">SWC</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>0.508379</td>
<td>0.487342</td>
<td>NaN</td>
<td>NaN</td>
<td>1.313730</td>
<td>1.556829</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>0.664855</td>
<td>0.471849</td>
<td>NaN</td>
<td>NaN</td>
<td>1.278001</td>
<td>1.323011</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>0.779066</td>
<td>0.640996</td>
<td>NaN</td>
<td>NaN</td>
<td>1.355740</td>
<td>1.472185</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>1.493784</td>
<td>0.947799</td>
<td>NaN</td>
<td>NaN</td>
<td>1.947605</td>
<td>1.488284</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">TS</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>0.341080</td>
<td>0.431992</td>
<td>NaN</td>
<td>NaN</td>
<td>0.954469</td>
<td>0.889126</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>0.534363</td>
<td>0.783787</td>
<td>NaN</td>
<td>NaN</td>
<td>1.002555</td>
<td>0.876784</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>0.786670</td>
<td>0.851931</td>
<td>NaN</td>
<td>NaN</td>
<td>1.078373</td>
<td>0.856964</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>1.659875</td>
<td>1.077782</td>
<td>NaN</td>
<td>NaN</td>
<td>1.440008</td>
<td>0.764040</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="1bce37cd-0884-49a1-9b40-31411cccf1de" class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> the_table(results_Av, <span class="st">'rmse_stand'</span>, y_name<span class="op">=</span><span class="st">"Stand. RMSE"</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>the_table_latex(t, base_path_tbl <span class="op">/</span> <span class="st">"the_table_stand.tex"</span>, stand <span class="op">=</span> <span class="va">True</span>, label<span class="op">=</span><span class="st">"tbl:the_table_stand"</span>, </span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                caption <span class="op">=</span> <span class="st">"</span><span class="ch">\\</span><span class="st">CapTheTableStand"</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">Kalman Filter</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">ERA-I</th>
<th colspan="2" data-quarto-table-cell-role="th" data-halign="left">MDS</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Stand. RMSE</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
</tr>
<tr class="header">
<th data-quarto-table-cell-role="th">Variable</th>
<th data-quarto-table-cell-role="th">Gap</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">TA</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>0.051164</td>
<td>0.032595</td>
<td>0.169965</td>
<td>0.125917</td>
<td>0.342294</td>
<td>0.239370</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>0.076576</td>
<td>0.050583</td>
<td>0.185712</td>
<td>0.113647</td>
<td>0.371303</td>
<td>0.220595</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>0.093541</td>
<td>0.046497</td>
<td>0.193021</td>
<td>0.100984</td>
<td>0.380185</td>
<td>0.203330</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>0.128790</td>
<td>0.056103</td>
<td>0.221378</td>
<td>0.081160</td>
<td>0.477006</td>
<td>0.165998</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">SW_IN</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>0.218804</td>
<td>0.198354</td>
<td>0.241826</td>
<td>0.324711</td>
<td>0.311450</td>
<td>0.418630</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>0.236052</td>
<td>0.166018</td>
<td>0.265721</td>
<td>0.243964</td>
<td>0.340325</td>
<td>0.337919</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>0.277272</td>
<td>0.147267</td>
<td>0.323282</td>
<td>0.200637</td>
<td>0.425342</td>
<td>0.292171</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>0.301873</td>
<td>0.126176</td>
<td>0.344233</td>
<td>0.170994</td>
<td>0.526387</td>
<td>0.262772</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">LW_IN</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>0.259855</td>
<td>0.184387</td>
<td>0.329028</td>
<td>0.309564</td>
<td>0.635910</td>
<td>0.358053</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>0.319900</td>
<td>0.184349</td>
<td>0.351964</td>
<td>0.299952</td>
<td>0.669407</td>
<td>0.320751</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>0.347838</td>
<td>0.186865</td>
<td>0.335903</td>
<td>0.291448</td>
<td>0.705850</td>
<td>0.295949</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>0.406688</td>
<td>0.153141</td>
<td>0.390071</td>
<td>0.265269</td>
<td>0.785460</td>
<td>0.210555</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">VPD</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>0.098019</td>
<td>0.083135</td>
<td>0.296855</td>
<td>0.354224</td>
<td>0.476967</td>
<td>0.492006</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>0.151227</td>
<td>0.115548</td>
<td>0.289627</td>
<td>0.295025</td>
<td>0.489108</td>
<td>0.479704</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>0.189442</td>
<td>0.114910</td>
<td>0.285579</td>
<td>0.236314</td>
<td>0.437795</td>
<td>0.367413</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>0.257686</td>
<td>0.144994</td>
<td>0.380474</td>
<td>0.258060</td>
<td>0.609224</td>
<td>0.449918</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">WS</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>0.379454</td>
<td>0.195008</td>
<td>0.561347</td>
<td>0.312715</td>
<td>0.699120</td>
<td>0.481810</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>0.440138</td>
<td>0.215927</td>
<td>0.588492</td>
<td>0.322529</td>
<td>0.775922</td>
<td>0.490176</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>0.493318</td>
<td>0.211254</td>
<td>0.584110</td>
<td>0.274951</td>
<td>0.784819</td>
<td>0.374443</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>0.584592</td>
<td>0.223403</td>
<td>0.669909</td>
<td>0.214431</td>
<td>0.919692</td>
<td>0.378591</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">PA</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>0.052675</td>
<td>0.040103</td>
<td>0.087534</td>
<td>0.072180</td>
<td>0.620545</td>
<td>0.516250</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>0.062397</td>
<td>0.048661</td>
<td>0.090425</td>
<td>0.068381</td>
<td>0.659061</td>
<td>0.499820</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>0.069556</td>
<td>0.045215</td>
<td>0.092405</td>
<td>0.060212</td>
<td>0.651223</td>
<td>0.472953</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>0.077558</td>
<td>0.055597</td>
<td>0.097793</td>
<td>0.062741</td>
<td>0.904092</td>
<td>0.449073</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">P</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>0.478431</td>
<td>0.977725</td>
<td>0.403790</td>
<td>1.125691</td>
<td>0.419979</td>
<td>1.090136</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>0.638197</td>
<td>1.054031</td>
<td>0.494974</td>
<td>1.060481</td>
<td>0.465404</td>
<td>1.003928</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>0.735816</td>
<td>0.904779</td>
<td>0.591382</td>
<td>1.029100</td>
<td>0.566018</td>
<td>0.946414</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>0.855891</td>
<td>0.620173</td>
<td>0.794512</td>
<td>0.719941</td>
<td>0.767011</td>
<td>0.704660</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">SWC</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>0.057037</td>
<td>0.054677</td>
<td>NaN</td>
<td>NaN</td>
<td>0.147393</td>
<td>0.174667</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>0.074593</td>
<td>0.052939</td>
<td>NaN</td>
<td>NaN</td>
<td>0.143384</td>
<td>0.148434</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>0.087407</td>
<td>0.071916</td>
<td>NaN</td>
<td>NaN</td>
<td>0.152106</td>
<td>0.165171</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>0.167594</td>
<td>0.106338</td>
<td>NaN</td>
<td>NaN</td>
<td>0.218510</td>
<td>0.166977</td>
</tr>
<tr class="odd">
<td rowspan="4" data-quarto-table-cell-role="th" data-valign="top">TS</td>
<td data-quarto-table-cell-role="th">6 h</td>
<td>0.060276</td>
<td>0.076342</td>
<td>NaN</td>
<td>NaN</td>
<td>0.168674</td>
<td>0.157127</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12 h</td>
<td>0.094433</td>
<td>0.138512</td>
<td>NaN</td>
<td>NaN</td>
<td>0.177172</td>
<td>0.154946</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1 day (24 h)</td>
<td>0.139021</td>
<td>0.150554</td>
<td>NaN</td>
<td>NaN</td>
<td>0.190571</td>
<td>0.151443</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1 week (168 h)</td>
<td>0.293335</td>
<td>0.190466</td>
<td>NaN</td>
<td>NaN</td>
<td>0.254479</td>
<td>0.135022</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="timeseries" class="level3">
<h3 class="anchored" data-anchor-id="timeseries">Timeseries</h3>
<div id="64571a34-6e5d-4fd9-aa39-523ce11a37ad" class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="at">@cache_disk</span>(cache_dir <span class="op">/</span> <span class="st">"the_results_ts"</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_the_results_ts():</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    reset_seed()</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    comp_Av <span class="op">=</span> ImpComparison(models <span class="op">=</span> models_var, df <span class="op">=</span> hai, control <span class="op">=</span> hai_era, block_len <span class="op">=</span> <span class="dv">446</span>, time_series<span class="op">=</span><span class="va">True</span>, rmse<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    results_Av <span class="op">=</span> comp_Av.compare(gap_len <span class="op">=</span> [<span class="dv">12</span>,<span class="dv">24</span>, <span class="dv">336</span>], var<span class="op">=</span><span class="bu">list</span>(hai.columns), n_rep<span class="op">=</span><span class="dv">4</span>) </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_Av</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>results_ts <span class="op">=</span> get_the_results_ts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="63bb0e8f-8766-42ee-9c61-a5984e05220f" class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>ts <span class="op">=</span> plot_timeseries(results_ts.query(<span class="st">"var in ['TA', 'SW_IN', 'LW_IN', 'VPD', 'WS']"</span>), idx_rep<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>save_show_plot(ts, <span class="st">"timeseries_1"</span>, altair_render<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="result_plots_files/figure-html/cell-42-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="e057820b-1321-40a9-a078-b6a0c114ac8a" class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time ts <span class="op">=</span> plot_timeseries(results_ts.query(<span class="st">"var in ['PA', 'P', 'TS', 'SWC']"</span>), idx_rep<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time save_show_plot(ts, <span class="st">"timeseries_2"</span>, altair_render<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 2.82 s, sys: 765 µs, total: 2.82 s
Wall time: 2.84 s
CPU times: user 9.53 s, sys: 127 ms, total: 9.66 s
Wall time: 12.8 s</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="result_plots_files/figure-html/cell-43-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="27c02102-1f65-4e0e-bab1-c65435391096" class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.auto <span class="im">import</span> tqdm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9d5f993c-4c8d-4850-a1f1-bc10916b39f8" class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># @cache_disk(cache_dir / "ts_plot", rm_cache=True)</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_additional_ts():</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx <span class="kw">in</span> tqdm(results_ts.idx_rep.unique()):</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> idx <span class="op">==</span> <span class="dv">0</span>: <span class="cf">continue</span> <span class="co"># skip first plot as is done above</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>        ts1 <span class="op">=</span> plot_timeseries(results_ts.query(<span class="st">"var in ['TA', 'SW_IN', 'LW_IN', 'VPD', 'WS']"</span>), idx_rep<span class="op">=</span>idx)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>        save_show_plot(ts1, <span class="ss">f"timeseries_1_</span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">"</span>, altair_render<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>        ts2 <span class="op">=</span> plot_timeseries(results_ts.query(<span class="st">"var in ['PA', 'P', 'TS', 'SWC']"</span>), idx_rep<span class="op">=</span>idx)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>        save_show_plot(ts2, <span class="ss">f"timeseries_2_</span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">"</span>, altair_render<span class="op">=</span><span class="va">True</span>)        </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c76bd137-8ba6-4ac2-b25e-9a22befa7695" class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>plot_additional_ts()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bb11ce82f4e449538695d2d6672893d7","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
</section>
</section>
<section id="kalman-filter-analysis" class="level2">
<h2 class="anchored" data-anchor-id="kalman-filter-analysis">Kalman Filter analysis</h2>
<section id="gap-len" class="level3">
<h3 class="anchored" data-anchor-id="gap-len">Gap len</h3>
<div id="83d3f8d8-54ae-45be-b755-66929a78c1f8" class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="at">@cache_disk</span>(cache_dir <span class="op">/</span> <span class="st">"gap_len"</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_g_len(n_rep<span class="op">=</span>n_rep):</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>    reset_seed()</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> KalmanImpComparison(models_var, hai, hai_era, block_len<span class="op">=</span><span class="dv">48</span><span class="op">*</span><span class="dv">7</span><span class="op">+</span><span class="dv">100</span>).compare(gap_len <span class="op">=</span> [<span class="dv">2</span>,<span class="dv">6</span>,<span class="dv">12</span>,<span class="dv">24</span>,<span class="dv">48</span>,<span class="dv">48</span><span class="op">*</span><span class="dv">2</span>, <span class="dv">48</span><span class="op">*</span><span class="dv">3</span>, <span class="dv">48</span><span class="op">*</span><span class="dv">7</span>], var<span class="op">=</span><span class="bu">list</span>(hai.columns), n_rep<span class="op">=</span>n_rep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="7f972e3d-64fe-4b8d-acd8-2b1c28d4c9c6" class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>gap_len <span class="op">=</span> get_g_len(n_rep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"19c1ea5e9c3c44f0a7c41f35e71a0063","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
Input <span class="ansi-green-fg">In [46]</span>, in <span class="ansi-cyan-fg">&lt;cell line: 1&gt;</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-fg">----&gt; 1</span> gap_len <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">get_g_len</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">n_rep</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/Documents/uni/Thesis/meteo_imp/meteo_imp/utils.py:44</span>, in <span class="ansi-cyan-fg">cache_disk.&lt;locals&gt;.decorator.&lt;locals&gt;.new_func</span><span class="ansi-blue-fg">(*args)</span>
<span class="ansi-green-fg ansi-bold">     42</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">new_func</span>(<span style="color:rgb(98,98,98)">*</span>args):
<span class="ansi-green-fg ansi-bold">     43</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">tuple</span>(args) <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> cache:
<span class="ansi-green-fg">---&gt; 44</span>         cache[<span style="color:rgb(0,135,0)">tuple</span>(args)] <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">original_func</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     45</span>         save_data()
<span class="ansi-green-fg ansi-bold">     46</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> cache[args]

Input <span class="ansi-green-fg">In [45]</span>, in <span class="ansi-cyan-fg">get_g_len</span><span class="ansi-blue-fg">(n_rep)</span>
<span class="ansi-green-fg ansi-bold">      1</span> <span style="color:rgb(175,0,255)">@cache_disk</span>(cache_dir <span style="color:rgb(98,98,98)">/</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">gap_len</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">      2</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">get_g_len</span>(n_rep<span style="color:rgb(98,98,98)">=</span>n_rep):
<span class="ansi-green-fg ansi-bold">      3</span>     reset_seed()
<span class="ansi-green-fg">----&gt; 4</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">KalmanImpComparison</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">models_var</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">hai</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">hai_era</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">block_len</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">48</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">7</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">+</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">100</span><span class="ansi-yellow-bg">)</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">compare</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">gap_len</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">[</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">2</span><span class="ansi-yellow-bg">,</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">6</span><span class="ansi-yellow-bg">,</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">12</span><span class="ansi-yellow-bg">,</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">24</span><span class="ansi-yellow-bg">,</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">48</span><span class="ansi-yellow-bg">,</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">48</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">2</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">48</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">3</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">48</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">7</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">var</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">list</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">hai</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">columns</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">n_rep</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">n_rep</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/Documents/uni/Thesis/meteo_imp/meteo_imp/kalman/results.py:458</span>, in <span class="ansi-cyan-fg">KalmanImpComparison.compare</span><span class="ansi-blue-fg">(self, n_rep, gap_len, var)</span>
<span class="ansi-green-fg ansi-bold">    456</span> out <span style="color:rgb(98,98,98)">=</span> []
<span class="ansi-green-fg ansi-bold">    457</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> arg_set <span style="font-weight:bold;color:rgb(175,0,255)">in</span> tqdm(arg_sets):
<span class="ansi-green-fg">--&gt; 458</span>     out<span style="color:rgb(98,98,98)">.</span>append(<span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_compare_single</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">arg_set</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">n_rep</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">n_rep</span><span class="ansi-yellow-bg">)</span>)
<span class="ansi-green-fg ansi-bold">    459</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> prep_df(pd<span style="color:rgb(98,98,98)">.</span>concat(out))

File <span class="ansi-green-fg">~/Documents/uni/Thesis/meteo_imp/meteo_imp/kalman/results.py:439</span>, in <span class="ansi-cyan-fg">KalmanImpComparison._compare_single</span><span class="ansi-blue-fg">(self, n_rep, gap_len, var)</span>
<span class="ansi-green-fg ansi-bold">    437</span> pred, targ, metric <span style="color:rgb(98,98,98)">=</span> imp<span style="color:rgb(98,98,98)">.</span>imp<span style="color:rgb(98,98,98)">.</span>preds_all_metrics(items <span style="color:rgb(98,98,98)">=</span> [items[i]], dls<span style="color:rgb(98,98,98)">=</span>dls, metrics<span style="color:rgb(98,98,98)">=</span>metrics_fn)
<span class="ansi-green-fg ansi-bold">    438</span> pred, targ <span style="color:rgb(98,98,98)">=</span> pred[<span style="color:rgb(98,98,98)">0</span>], targ[<span style="color:rgb(98,98,98)">0</span>]
<span class="ansi-green-fg">--&gt; 439</span> pred <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">pred</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">mean</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">iloc</span>[:, [var_idx]]
<span class="ansi-green-fg ansi-bold">    440</span> targ <span style="color:rgb(98,98,98)">=</span> MeteoImpDf(targ<span style="color:rgb(98,98,98)">.</span>data<span style="color:rgb(98,98,98)">.</span>iloc[:, [var_idx]], targ<span style="color:rgb(98,98,98)">.</span>mask<span style="color:rgb(98,98,98)">.</span>iloc[:, [var_idx]], targ<span style="color:rgb(98,98,98)">.</span>control<span style="color:rgb(98,98,98)">.</span>iloc[:, [var_idx]])
<span class="ansi-green-fg ansi-bold">    441</span> out <span style="color:rgb(98,98,98)">=</span> {
<span class="ansi-green-fg ansi-bold">    442</span>     <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">var</span><span style="color:rgb(175,0,0)">'</span>: var,
<span class="ansi-green-fg ansi-bold">    443</span>     <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">loss</span><span style="color:rgb(175,0,0)">'</span>: metric[<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">loss</span><span style="color:rgb(175,0,0)">'</span>][<span style="color:rgb(98,98,98)">0</span>]<span style="color:rgb(98,98,98)">.</span>item(),
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    446</span>     <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">idx_rep</span><span style="color:rgb(175,0,0)">'</span>: i,
<span class="ansi-green-fg ansi-bold">    447</span> } <span style="color:rgb(98,98,98)">|</span> imp<span style="color:rgb(98,98,98)">.</span>drop(index<span style="color:rgb(98,98,98)">=</span>[<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">model</span><span style="color:rgb(175,0,0)">"</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">imp</span><span style="color:rgb(175,0,0)">"</span>])<span style="color:rgb(98,98,98)">.</span>to_dict()

File <span class="ansi-green-fg">~/.local/lib/python3.10/site-packages/pandas/core/indexing.py:140</span>, in <span class="ansi-cyan-fg">IndexingMixin.iloc</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    135</span> <span style="font-weight:bold;color:rgb(0,135,0)">class</span> <span style="font-weight:bold;color:rgb(0,0,255)">IndexingMixin</span>:
<span class="ansi-green-fg ansi-bold">    136</span>     <span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg ansi-bold">    137</span> <span style="font-style:italic;color:rgb(175,0,0)">    Mixin for adding .loc/.iloc/.at/.iat to Dataframes and Series.</span>
<span class="ansi-green-fg ansi-bold">    138</span> <span style="font-style:italic;color:rgb(175,0,0)">    """</span>
<span class="ansi-green-fg">--&gt; 140</span>     <span style="color:rgb(175,0,255)">@property</span>
<span class="ansi-green-fg ansi-bold">    141</span>     <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">iloc</span>(<span style="color:rgb(0,135,0)">self</span>) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> _iLocIndexer:
<span class="ansi-green-fg ansi-bold">    142</span>         <span style="font-style:italic;color:rgb(175,0,0)">"""</span>
<span class="ansi-green-fg ansi-bold">    143</span> <span style="font-style:italic;color:rgb(175,0,0)">        Purely integer-location based indexing for selection by position.</span>
<span class="ansi-green-fg ansi-bold">    144</span> 
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    275</span> <span style="font-style:italic;color:rgb(175,0,0)">        2  1000  3000</span>
<span class="ansi-green-fg ansi-bold">    276</span> <span style="font-style:italic;color:rgb(175,0,0)">        """</span>
<span class="ansi-green-fg ansi-bold">    277</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> _iLocIndexer(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">iloc</span><span style="color:rgb(175,0,0)">"</span>, <span style="color:rgb(0,135,0)">self</span>)

<span class="ansi-red-fg">KeyboardInterrupt</span>: </pre>
</div>
</div>
</div>
<div id="98820596-cedf-40a5-bd4e-b2ac25700351" class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> plot_gap_len(gap_len, hai, hai_era)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>save_show_plot(p, <span class="st">"gap_len"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1637ad8a-20ab-4c74-a8b7-9660602f3c08" class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> table_gap_len(gap_len)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>table_gap_len_latex(t, base_path_tbl <span class="op">/</span> <span class="st">"gap_len.tex"</span>, label<span class="op">=</span><span class="st">"gap_len"</span>,</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>                caption<span class="op">=</span><span class="st">"</span><span class="ch">\\</span><span class="st">CapGapLen"</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d0d85b51-bcbf-4484-80ee-961385c3c4eb" class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>g_len_agg <span class="op">=</span> gap_len.groupby(<span class="st">'gap_len'</span>).agg({<span class="st">'rmse_stand'</span>: <span class="st">'mean'</span>})</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>(g_len_agg.iloc[<span class="dv">0</span>])<span class="op">/</span>g_len_agg.iloc[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f3c0a8a6-b7cc-4d67-871f-50c4c5a8f7c9" class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>g_len_agg <span class="op">=</span> gap_len.groupby([<span class="st">'gap_len'</span>, <span class="st">'var'</span>]).agg({<span class="st">'rmse_stand'</span>: <span class="st">'mean'</span>})</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>(g_len_agg.loc[<span class="fl">1.</span>])<span class="op">/</span>g_len_agg.loc[<span class="fl">168.</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="931f0d21-cc62-42c0-b251-7385a2e13856" class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>g_len_agg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1013abdb-d9ad-4e41-943c-8fa974cb9d8e" class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>g_len_agg_std <span class="op">=</span> gap_len.groupby(<span class="st">'gap_len'</span>).agg({<span class="st">'rmse_stand'</span>: <span class="st">'std'</span>})</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>(g_len_agg_std.iloc[<span class="dv">0</span>])<span class="op">/</span>g_len_agg_std.iloc[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ee210669-895e-4071-96aa-5db324600ddd" class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>(gap_len.groupby([<span class="st">'gap_len'</span>, <span class="st">'var'</span>]).agg({<span class="st">'rmse_stand'</span>: <span class="st">'std'</span>})</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    .unstack(<span class="st">"var"</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    .droplevel(<span class="dv">0</span>, <span class="dv">1</span>) </span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    .plot(subplots<span class="op">=</span><span class="va">True</span>, layout<span class="op">=</span>(<span class="dv">3</span>,<span class="dv">3</span>), figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="0531aba9-217f-409e-a401-e5d2c1f0aa3f" class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># with open(base_path_tbl / "gap_len.tex") as f:</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(f.readlines())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="control" class="level3">
<h3 class="anchored" data-anchor-id="control">Control</h3>
<div id="720d4c18-35a5-4c34-b779-5d18d5c33fc1" class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>models_nc <span class="op">=</span> pd.DataFrame({<span class="st">'model'</span>: [ l_model(<span class="st">"1_gap_varying_336_no_control_v1.pickle"</span>), l_model(<span class="st">"1_gap_varying_6-336_v3.pickle"</span>)],</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>                          <span class="st">'type'</span>:   [ <span class="st">'No Control'</span>,                                       <span class="st">'Use Control'</span>                         ]})                                        </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4e57f5ba-203b-4854-8585-08e84828be34" class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="at">@cache_disk</span>(cache_dir <span class="op">/</span> <span class="st">"use_control"</span>)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_control(n_rep<span class="op">=</span>n_rep):</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    reset_seed()</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    kcomp_control <span class="op">=</span> KalmanImpComparison(models_nc, hai, hai_era, block_len<span class="op">=</span><span class="dv">100</span><span class="op">+</span><span class="dv">48</span><span class="op">*</span><span class="dv">7</span>)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    k_results_control <span class="op">=</span> kcomp_control.compare(n_rep <span class="op">=</span>n_rep, gap_len <span class="op">=</span> [<span class="dv">12</span>, <span class="dv">24</span>, <span class="dv">48</span>, <span class="dv">48</span><span class="op">*</span><span class="dv">7</span>], var <span class="op">=</span> <span class="bu">list</span>(hai.columns))</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> k_results_control</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d112df90-f6bf-4417-8aaf-19762f57a150" class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> sleep</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3aa1f654-c763-48b0-b29c-c4761513e9fe" class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>k_results_control <span class="op">=</span> get_control(n_rep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="2d9d436f-d053-4c3e-a92e-008e74503bf7" class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>k_results_control</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="318c8ade-732d-4735-92a5-7760ee0c4f49" class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> plot_compare(k_results_control, <span class="st">'type'</span>, y <span class="op">=</span> <span class="st">'rmse'</span>, scale_domain<span class="op">=</span>[<span class="st">"Use Control"</span>, <span class="st">"No Control"</span>])</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>save_show_plot(p, <span class="st">"use_control"</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6cf80b36-e10d-4cc8-b9e5-ace3bf26c2fc" class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ea3c7efa-188d-4e27-95c5-9868cc84f9b7" class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> table_compare(k_results_control, <span class="st">'type'</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>table_compare_latex(t, base_path_tbl <span class="op">/</span> <span class="st">"control.tex"</span>, label<span class="op">=</span><span class="st">"tbl:control"</span>,</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>                caption<span class="op">=</span><span class="st">"</span><span class="ch">\\</span><span class="st">CapControl"</span>)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="gap-in-other-variables" class="level3">
<h3 class="anchored" data-anchor-id="gap-in-other-variables">Gap in Other variables</h3>
<div id="8023d9c6-e8ac-48cc-a23f-720d1254235d" class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>models_gap_single <span class="op">=</span> pd.DataFrame.from_records([</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'Gap'</span>:  <span class="st">'All variables'</span>, <span class="st">'gap_single_var'</span>: <span class="va">False</span>, <span class="st">'model'</span>: l_model(<span class="st">"all_varying_gap_varying_len_6-30_v3.pickle"</span>)},</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'Gap'</span>:  <span class="st">'Only one var'</span>,  <span class="st">'gap_single_var'</span>: <span class="va">True</span>,  <span class="st">'model'</span>: l_model(<span class="st">"all_varying_gap_varying_len_6-30_v3.pickle"</span>)},</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="985f5eab-c744-431c-a4ec-fe11cd839e53" class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="at">@cache_disk</span>(cache_dir <span class="op">/</span> <span class="st">"gap_single"</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_gap_single(n_rep):</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    kcomp_single <span class="op">=</span> KalmanImpComparison(models_gap_single, hai, hai_era, block_len<span class="op">=</span><span class="dv">130</span>)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> kcomp_single.compare(n_rep <span class="op">=</span>n_rep, gap_len <span class="op">=</span> [<span class="dv">6</span>, <span class="dv">12</span>, <span class="dv">24</span>, <span class="dv">30</span>], var <span class="op">=</span> <span class="bu">list</span>(hai.columns))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="8bc62c78-5727-4975-9844-fe316b74d363" class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>res_single <span class="op">=</span> get_gap_single(n_rep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="5b6d26b1-fef2-420b-9fed-a5fb974df443" class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> plot_compare(res_single, <span class="st">"Gap"</span>, y <span class="op">=</span> <span class="st">'rmse'</span>, scale_domain<span class="op">=</span>[<span class="st">"Only one var"</span>, <span class="st">"All variables"</span>])</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>save_show_plot(p, <span class="st">"gap_single_var"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="827c2902-5cff-4fd5-9477-9688429cbe57" class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> table_compare(res_single, <span class="st">'Gap'</span>)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>table_compare_latex(t, base_path_tbl <span class="op">/</span> <span class="st">"gap_single_var.tex"</span>, caption<span class="op">=</span><span class="st">"</span><span class="ch">\\</span><span class="st">CapGapSingle"</span>, label<span class="op">=</span><span class="st">"tbl:gap_single_var"</span>)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9a097d8a-a68f-4b5c-a469-ee217993facb" class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>res_singl_perc <span class="op">=</span> res_single.groupby([<span class="st">'Gap'</span>, <span class="st">'var'</span>, <span class="st">'gap_len'</span>]).agg({<span class="st">'rmse_stand'</span>: <span class="st">'mean'</span>}).reset_index().pivot(columns <span class="op">=</span> <span class="st">'Gap'</span>, values<span class="op">=</span><span class="st">'rmse_stand'</span>, index<span class="op">=</span>[<span class="st">'var'</span>, <span class="st">'gap_len'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="49b0bf1e-fb07-4931-98b1-b32033627123" class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame({<span class="st">'Only one var'</span>: (res_singl_perc[<span class="st">"All variables"</span>] <span class="op">-</span> res_singl_perc[<span class="st">"Only one var"</span>]) <span class="op">/</span> res_singl_perc[<span class="st">"All variables"</span>] <span class="op">*</span> <span class="dv">100</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="454f9adf-63d7-4d7b-af19-587ad23935a3" class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>res_singl_perc <span class="op">=</span> res_single.groupby([<span class="st">'Gap'</span>, <span class="st">'var'</span>]).agg({<span class="st">'rmse_stand'</span>: <span class="st">'mean'</span>}).reset_index().pivot(columns <span class="op">=</span> <span class="st">'Gap'</span>, values<span class="op">=</span><span class="st">'rmse_stand'</span>, index<span class="op">=</span>[<span class="st">'var'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="5cb5a0bd-5c38-4585-adca-d20fce278557" class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame({<span class="st">'Only one var'</span>: (res_singl_perc[<span class="st">"All variables"</span>] <span class="op">-</span> res_singl_perc[<span class="st">"Only one var"</span>]) <span class="op">/</span> res_singl_perc[<span class="st">"All variables"</span>] <span class="op">*</span> <span class="dv">100</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="generic-vs-specialized" class="level3">
<h3 class="anchored" data-anchor-id="generic-vs-specialized">Generic vs Specialized</h3>
<div id="5340f94d-d601-438d-8648-1d15a3ef0b50" class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>models_generic <span class="op">=</span> models_var.copy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="7fb66af5-2b64-44d0-aa09-70d59345c4aa" class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>models_generic.model <span class="op">=</span> l_model(<span class="st">"1_gap_varying_6-336_v3.pickle"</span>) </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>models_generic[<span class="st">'type'</span>] <span class="op">=</span> <span class="st">'Generic'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4c53d933-d68c-4905-a6ba-e0d4e555c3a7" class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>models_generic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="7252fb9f-7a94-494f-bcc1-4abd95a7ee54" class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>models_var[<span class="st">'type'</span>] <span class="op">=</span> <span class="st">'Fine-tuned one var'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="832af682-b202-482c-8996-e106061c032c" class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>models_gen_vs_spec <span class="op">=</span> pd.concat([models_generic, models_var])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="256981d8-5000-44fb-b9aa-133eeace76bd" class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>models_gen_vs_spec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="82255c8d-7903-4d0c-a231-c01d3b10031c" class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="at">@cache_disk</span>(cache_dir <span class="op">/</span> <span class="st">"generic"</span>)</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_generic(n_rep<span class="op">=</span>n_rep):</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    reset_seed()</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    comp_generic <span class="op">=</span> KalmanImpComparison(models_gen_vs_spec, hai, hai_era, block_len<span class="op">=</span><span class="dv">100</span><span class="op">+</span><span class="dv">48</span><span class="op">*</span><span class="dv">7</span>)</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> comp_generic.compare(n_rep <span class="op">=</span>n_rep, gap_len <span class="op">=</span> [<span class="dv">12</span>, <span class="dv">24</span>, <span class="dv">48</span>, <span class="dv">48</span><span class="op">*</span><span class="dv">7</span>], var <span class="op">=</span> <span class="bu">list</span>(hai.columns))</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>k_results_generic <span class="op">=</span> get_generic(n_rep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fc250543-d4e5-437c-b92d-12d00d002bc9" class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>plot_formatter.legend_symbol_size <span class="op">=</span> <span class="dv">300</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="82943e19-5bdd-4278-9647-da1055456766" class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> plot_compare(k_results_generic, <span class="st">'type'</span>, y <span class="op">=</span> <span class="st">'rmse'</span>, scale_domain<span class="op">=</span>[<span class="st">"Fine-tuned one var"</span>, <span class="st">"Generic"</span>])</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>save_show_plot(p, <span class="st">"generic"</span>)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="705be3a4-9176-45b8-9276-f94524db3eb9" class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> table_compare(k_results_generic, <span class="st">'type'</span>)</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>table_compare_latex(t, base_path_tbl <span class="op">/</span> <span class="st">"generic.tex"</span>, label<span class="op">=</span><span class="st">'tbl:generic'</span>, caption<span class="op">=</span><span class="st">"</span><span class="ch">\\</span><span class="st">CapGeneric"</span>)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b900c498-264d-4f4f-be72-62aeb55e48d0" class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>res_singl_perc <span class="op">=</span> k_results_generic.groupby([<span class="st">'type'</span>, <span class="st">'var'</span>]).agg({<span class="st">'rmse_stand'</span>: <span class="st">'mean'</span>}).reset_index().pivot(columns <span class="op">=</span> <span class="st">'type'</span>, values<span class="op">=</span><span class="st">'rmse_stand'</span>, index<span class="op">=</span>[<span class="st">'var'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3b1c245d-c0e4-45b7-9ac1-c3faf31471d1" class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>(res_singl_perc[<span class="st">"Generic"</span>] <span class="op">-</span> res_singl_perc[<span class="st">"Fine-tuned one var"</span>]) <span class="op">/</span> res_singl_perc[<span class="st">"Generic"</span>] <span class="op">*</span> <span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="training" class="level3">
<h3 class="anchored" data-anchor-id="training">Training</h3>
<div id="907dde25-1790-4c4a-a71d-aeab0111bfa2" class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>models_train <span class="op">=</span> pd.DataFrame.from_records([</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># {'Train':  'All variables',  'model': l_model("All_gap_all_30_v1.pickle")  },</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'Train'</span>:  <span class="st">'Only one var'</span>,   <span class="st">'model'</span>: l_model(<span class="st">"1_gap_varying_6-336_v3.pickle"</span>)  },</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'Train'</span>:  <span class="st">'Multi vars'</span>,     <span class="st">'model'</span>: l_model(<span class="st">"all_varying_gap_varying_len_6-30_v3.pickle"</span>)  },</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'Train'</span>:  <span class="st">'Random params'</span>,  <span class="st">'model'</span>: l_model(<span class="st">"rand_all_varying_gap_varying_len_6-30_v4.pickle"</span>)  }</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="6bdeba9a-9646-4cd0-9a3d-681cc45b1e63" class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>models_train</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b2361971-a85a-4c21-8b42-748a88eeaa09" class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="at">@cache_disk</span>(cache_dir <span class="op">/</span> <span class="st">"train"</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_train(n_rep):</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    reset_seed()</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    kcomp <span class="op">=</span> KalmanImpComparison(models_train, hai, hai_era, block_len<span class="op">=</span><span class="dv">130</span>)</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> kcomp.compare(n_rep <span class="op">=</span>n_rep, gap_len <span class="op">=</span> [<span class="dv">6</span>, <span class="dv">12</span>, <span class="dv">24</span>, <span class="dv">30</span>], var <span class="op">=</span> <span class="bu">list</span>(hai.columns))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="e5da6966-7909-4a7e-9903-2dfcab88aaca" class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>res_train <span class="op">=</span> get_train(n_rep)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ad5d3a6a-c46a-4ead-8f6f-f02d9cb827a5" class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>res_train_agg <span class="op">=</span> res_train.groupby([<span class="st">'Train'</span>, <span class="st">'gap_len'</span>]).agg({<span class="st">'rmse_stand'</span>: <span class="st">'mean'</span>}).reset_index()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3c3fc7b9-2c3e-4f38-b1d5-7fa7715cf3ae" class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>res_train_agg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="60766fdd-0767-4acd-825f-4262def4c193" class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> plot_compare(res_train, <span class="st">"Train"</span>, y<span class="op">=</span><span class="st">'rmse'</span>, scale_domain<span class="op">=</span>[<span class="st">"Multi vars"</span>, <span class="st">"Only one var"</span>, <span class="st">"Random params"</span>])</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>save_show_plot(p, <span class="st">"train_compare"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="eef738f9-9807-4d3b-b98f-71594aa06bbb" class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> table_compare3(res_train, <span class="st">'Train'</span>)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>table_compare3_latex(t, base_path_tbl <span class="op">/</span> <span class="st">"train.tex"</span>, label<span class="op">=</span><span class="st">"tbl:train_compare"</span>, caption<span class="op">=</span><span class="st">"</span><span class="ch">\\</span><span class="st">CapTrain"</span>)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="extra-results" class="level2">
<h2 class="anchored" data-anchor-id="extra-results">Extra results</h2>
<section id="standard-deviations" class="level3">
<h3 class="anchored" data-anchor-id="standard-deviations">Standard deviations</h3>
<div id="3208491d-9860-4130-ba68-807ffd5b649c" class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>hai_std <span class="op">=</span> hai.std().to_frame(name<span class="op">=</span><span class="st">'std'</span>)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>hai_std.index.name <span class="op">=</span> <span class="st">"Variable"</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>hai_std <span class="op">=</span> hai_std.reset_index().assign(unit<span class="op">=</span>[<span class="ss">f"</span><span class="ch">\\</span><span class="ss">si</span><span class="ch">{{</span><span class="sc">{</span>unit<span class="sc">}</span><span class="ch">}}</span><span class="ss">"</span> <span class="cf">for</span> unit <span class="kw">in</span> units_big.values()])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="c7f0bc7b-f5e1-4e01-b858-4e3f7cb929c8" class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>hai_std</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9dd4359b-60e6-4423-8301-80f07b43bbba" class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>latex <span class="op">=</span> hai_std.style.hide(axis<span class="op">=</span><span class="st">"index"</span>).<span class="bu">format</span>(precision<span class="op">=</span><span class="dv">3</span>).to_latex(hrules<span class="op">=</span><span class="va">True</span>, caption<span class="op">=</span><span class="st">"</span><span class="ch">\\</span><span class="st">CapStd"</span>, label<span class="op">=</span><span class="st">"tbl:hai_std"</span>, position_float<span class="op">=</span><span class="st">"centering"</span>)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(base_path_tbl <span class="op">/</span> <span class="st">"hai_std.tex"</span>, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    f.write(latex)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="gap-distribution" class="level3">
<h3 class="anchored" data-anchor-id="gap-distribution">Gap distribution</h3>
<div id="5183a92b-9f9f-400b-a63a-96235cdbef2c" class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>out_dir <span class="op">=</span> here(<span class="st">"../fluxnet/gap_stat"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="ce4082ac-d395-4143-b326-3f0e199cd595" class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>site_info <span class="op">=</span> pl.read_parquet(out_dir <span class="op">/</span> <span class="st">"../site_info.parquet"</span>).select([</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"start"</span>).cast(pl.Utf8).<span class="bu">str</span>.strptime(pl.Datetime, <span class="st">"%Y%m</span><span class="sc">%d</span><span class="st">%H%M"</span>),</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"end"</span>).cast(pl.Utf8).<span class="bu">str</span>.strptime(pl.Datetime, <span class="st">"%Y%m</span><span class="sc">%d</span><span class="st">%H%M"</span>),</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"site"</span>).cast(pl.Categorical).sort()</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="e124c9f1-39fe-465b-8911-287f3bbf7a34" class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> duration_n_obs(duration):</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"converts a duration into a n of fluxnet observations"</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">abs</span>(<span class="bu">int</span>(duration.total_seconds() <span class="op">/</span> (<span class="dv">30</span> <span class="op">*</span> <span class="dv">60</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4349f71f-2fd4-41f9-93c8-a71e6af9b223" class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> out_dir.ls()</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>files.sort() <span class="co"># need to sort to match the site_info</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>sites <span class="op">=</span> []</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, path <span class="kw">in</span> <span class="bu">enumerate</span>(files):</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>    sites.append(pl.scan_parquet(path).with_columns([</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>        pl.lit(site_info[i, <span class="st">"site"</span>]).alias(<span class="st">"site"</span>),</span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>        pl.lit(duration_n_obs(site_info[i, <span class="st">"start"</span>] <span class="op">-</span>  site_info[i, <span class="st">"end"</span>])).alias(<span class="st">"total_obs"</span>),</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>        pl.col(<span class="st">"TIMESTAMP_END"</span>).cast(pl.Utf8).<span class="bu">str</span>.strptime(pl.Datetime, <span class="st">"%Y%m</span><span class="sc">%d</span><span class="st">%H%M"</span>).alias(<span class="st">"end"</span>),</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>    ]).drop(<span class="st">"TIMESTAMP_END"</span>))</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>gap_stat <span class="op">=</span> pl.concat(sites)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4d843ec6-ec8f-4ab7-a59d-ae1f12755e83" class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>pl.read_parquet(files[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="9a63d5aa-6f7a-40e1-a7f9-9e9adfe76e23" class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>gap_stat.head().collect()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="8306c005-a1ca-4195-ab61-db2b6b11a8fe" class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_var_dist(var, small<span class="op">=</span><span class="va">False</span>, ax<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ax <span class="kw">is</span> <span class="va">None</span>: ax <span class="op">=</span> get_grid(<span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>    ta_gaps <span class="op">=</span> gap_stat.<span class="bu">filter</span>(</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>        (pl.col(<span class="st">"variable"</span>) <span class="op">==</span> var)</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">filter</span>(</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>        pl.col(<span class="st">"gap_len"</span>) <span class="op">&lt;</span> <span class="dv">200</span> <span class="cf">if</span> small <span class="cf">else</span> <span class="va">True</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>    ).with_column(pl.col(<span class="st">"gap_len"</span>) <span class="op">/</span> (<span class="dv">24</span> <span class="op">*</span><span class="dv">2</span> <span class="op">*</span> <span class="dv">7</span>)).collect().to_pandas().hist(<span class="st">"gap_len"</span>, bins<span class="op">=</span><span class="dv">50</span>, ax<span class="op">=</span>ax)</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"</span><span class="sc">{</span>var<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span> <span class="st">'gaps &lt; 200'</span> <span class="cf">if</span> small <span class="cf">else</span> <span class="st">'all gaps'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> small: ax.set_yscale(<span class="st">'log'</span>)</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">"gap length (weeks)"</span>)</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Log'</span> <span class="cf">if</span> <span class="kw">not</span> small <span class="cf">else</span> <span class="st">''</span><span class="sc">}</span><span class="ss"> n gaps"</span>)</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plt.xscale('log') </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="5151ce36-b5d3-4f66-8442-5e5738703f89" class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>plot_var_dist(<span class="st">'TA_F_QC'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="2cc83c14-5c96-4bf4-9c39-a795c98b4268" class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>color_map <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(scale_meteo.domain, <span class="bu">list</span>(sns.color_palette(<span class="st">'Set2'</span>, n_colors<span class="op">=</span><span class="bu">len</span>(hai.columns)).as_hex())))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="8a2139c7-8d43-4762-b2e5-db37d3583fe9" class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>qc_map <span class="op">=</span> {</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'TA'</span>: <span class="st">'TA_F_QC'</span>,</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SW_IN'</span>: <span class="st">'SW_IN_F_QC'</span>,</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'LW_IN'</span>: <span class="st">'LW_IN_F_QC'</span>,</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VPD'</span>: <span class="st">'VPD_F_QC'</span>,</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'WS'</span>: <span class="st">'WS_F_QC'</span>,</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PA'</span>: <span class="st">'PA_F_QC'</span>,</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'P'</span>: <span class="st">'P_F_QC'</span>,</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'TS'</span>: <span class="st">'TS_F_MDS_1_QC'</span>,</span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SWC'</span>: <span class="st">'SWC_F_MDS_1_QC'</span>,</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="4766cd78-a07d-487d-8b14-e04bd62b01c6" class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pl_in(col, values):</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>    expr <span class="op">=</span> <span class="va">False</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> val <span class="kw">in</span> values:</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>        expr <span class="op">|=</span> pl.col(col) <span class="op">==</span> val</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> expr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f58bbc5d-35d0-454e-8f22-2644efc72de2" class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>gap_stat.<span class="bu">filter</span>(pl_in(<span class="st">'variable'</span>, qc_map.values())</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>               ).with_columns([</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    pl.when(pl.col(<span class="st">"gap_len"</span>) <span class="op">&lt;</span> <span class="dv">48</span><span class="op">*</span><span class="dv">7</span>).then(<span class="va">True</span>).otherwise(<span class="va">False</span>).alias(<span class="st">"short"</span>),</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    pl.count().alias(<span class="st">"total"</span>),</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    pl.count().alias(<span class="st">"total len"</span>),</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>]).groupby(<span class="st">"short"</span>).agg([</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>    (pl.col(<span class="st">"gap_len"</span>).count() <span class="op">/</span> pl.col(<span class="st">"total"</span>)).alias(<span class="st">"frac_num"</span>),</span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>    (pl.col(<span class="st">"gap_len"</span>).<span class="bu">sum</span>() <span class="op">/</span> pl.col(<span class="st">"total len"</span>)).alias(<span class="st">"frac_len"</span>)</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>]).collect()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="87ec5de0-243c-4382-98b0-7a9075b98001" class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>gap_stat.<span class="bu">filter</span>(pl_in(<span class="st">'variable'</span>, qc_map.values())</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>               ).with_columns([</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>    pl.when(pl.col(<span class="st">"gap_len"</span>) <span class="op">&lt;</span> <span class="dv">48</span><span class="op">*</span><span class="dv">7</span>).then(<span class="va">True</span>).otherwise(<span class="va">False</span>).alias(<span class="st">"short"</span>),</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    pl.count().alias(<span class="st">"total"</span>),</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>    pl.count().alias(<span class="st">"total len"</span>),</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>]).groupby(<span class="st">"short"</span>).agg([</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>    (pl.col(<span class="st">"gap_len"</span>).count() <span class="op">/</span> pl.col(<span class="st">"total"</span>)).alias(<span class="st">"frac_num"</span>),</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>    (pl.col(<span class="st">"gap_len"</span>).<span class="bu">sum</span>() <span class="op">/</span> pl.col(<span class="st">"total len"</span>)).alias(<span class="st">"frac_len"</span>)</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>]).collect()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="03950e63-1c2c-400d-8918-8b3e1a9c4d67" class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>frac_miss <span class="op">=</span> gap_stat.<span class="bu">filter</span>(</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>    pl_in(<span class="st">'variable'</span>, qc_map.values())</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>).groupby([<span class="st">"site"</span>, <span class="st">"variable"</span>]).agg([</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"gap_len"</span>).mean().alias(<span class="st">"mean"</span>),</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>    (pl.col(<span class="st">"gap_len"</span>).<span class="bu">sum</span>() <span class="op">/</span> pl.col(<span class="st">"total_obs"</span>).first()).alias(<span class="st">"frac_gap"</span>)</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="94004145-cc6c-46b6-8e40-d96855a54af6" class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>frac_miss.groupby(<span class="st">'variable'</span>).agg([</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"frac_gap"</span>).<span class="bu">max</span>().alias(<span class="st">"max"</span>),</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"frac_gap"</span>).<span class="bu">min</span>().alias(<span class="st">"min"</span>),</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"frac_gap"</span>).std().alias(<span class="st">"std"</span>),</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>    pl.col(<span class="st">"frac_gap"</span>).mean().alias(<span class="st">"mean"</span>),</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>]).collect()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="44b9c4fb-2fb8-47a4-ac47-29f239b75ce1" class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>frac_miss.sort(<span class="st">"frac_gap"</span>, reverse<span class="op">=</span><span class="va">True</span>).collect()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="439adf16-e254-432c-86cb-79c50375f132" class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>site_info.<span class="bu">filter</span>((pl.col(<span class="st">"site"</span>) <span class="op">==</span> <span class="st">"US-LWW"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cc1f4f53-3fdc-407e-8f23-2249acf444ca" class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>gap_stat.<span class="bu">filter</span>((pl.col(<span class="st">"site"</span>) <span class="op">==</span> <span class="st">"US-LWW"</span>) <span class="op">&amp;</span> (pl.col(<span class="st">"variable"</span>) <span class="op">==</span> <span class="st">"LW_IN_F_QC"</span> )).collect()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="22042ad0-1fb5-4844-aabf-23802f1572e2" class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="21ffe2c7-77ae-47c5-b856-36ce5b1fc6fb" class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>matplotlib.rcParams.update({<span class="st">'font.size'</span>: <span class="dv">22</span>})</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="336e6897-d0af-43af-a6fd-283746d8e9ec" class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_var_dist(var, ax<span class="op">=</span><span class="va">None</span>, small<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ax <span class="kw">is</span> <span class="va">None</span>: ax <span class="op">=</span> get_grid(<span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    color <span class="op">=</span> color_map[var]</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>    var_qc <span class="op">=</span> qc_map[var]</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    ta_gaps <span class="op">=</span> gap_stat.<span class="bu">filter</span>(</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>        (pl.col(<span class="st">"variable"</span>) <span class="op">==</span> var_qc)</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">filter</span>(</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>        pl.col(<span class="st">"gap_len"</span>) <span class="op">&lt;</span> (<span class="dv">24</span> <span class="op">*</span> <span class="dv">2</span> <span class="op">*</span><span class="dv">7</span>) <span class="cf">if</span> small <span class="cf">else</span> <span class="va">True</span> </span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>    ).with_column(pl.col(<span class="st">"gap_len"</span>) <span class="op">/</span> (<span class="dv">2</span> <span class="cf">if</span> small <span class="cf">else</span> <span class="dv">48</span> <span class="op">*</span> <span class="dv">7</span>)</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>                 ).collect().to_pandas().hist(<span class="st">"gap_len"</span>, bins<span class="op">=</span><span class="dv">50</span>, ax<span class="op">=</span>ax, edgecolor<span class="op">=</span><span class="st">"white"</span>, color<span class="op">=</span>color)</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"</span><span class="sc">{</span>var<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span> <span class="st">'gap length &lt;  1 week'</span> <span class="cf">if</span> small <span class="cf">else</span> <span class="st">'all gaps'</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="ss">f"Gap length (</span><span class="sc">{</span> <span class="st">'hour'</span> <span class="cf">if</span> small <span class="cf">else</span> <span class="st">'week'</span><span class="sc">}</span><span class="ss">)"</span>)</span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="ss">f"Log n gaps"</span>)</span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>    ax.set_yscale(<span class="st">'log'</span>) </span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="0c525c83-10e6-4005-a7be-799701680136" class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="bu">vars</span> <span class="op">=</span> gap_stat.select(pl.col(<span class="st">"variable"</span>).unique()).collect()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="479e9671-1226-49c3-910a-bc3dd0277430" class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="bu">vars</span>.<span class="bu">filter</span>(pl.col(<span class="st">"variable"</span>).<span class="bu">str</span>.contains(<span class="st">"TA"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="10486e73-722d-4b8c-964c-59c0d5d84adb" class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, var <span class="kw">in</span> <span class="bu">zip</span>(get_grid(<span class="dv">9</span>,<span class="dv">3</span>,<span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>,<span class="dv">12</span>), sharey<span class="op">=</span><span class="va">False</span>), <span class="bu">list</span>(var_type.categories)):</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>    plot_var_dist(var, ax<span class="op">=</span>ax)</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>plt.savefig(base_path_img <span class="op">/</span> <span class="st">"gap_len_dist_small.pdf"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d2750729-3ef6-42a4-a424-6118e7db5c91" class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, var <span class="kw">in</span> <span class="bu">zip</span>(get_grid(<span class="dv">9</span>,<span class="dv">3</span>,<span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>,<span class="dv">12</span>), sharey<span class="op">=</span><span class="va">False</span>), <span class="bu">list</span>(var_type.categories)):</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>    plot_var_dist(var, ax<span class="op">=</span>ax, small<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>plt.savefig(base_path_img <span class="op">/</span> <span class="st">"gap_len_dist.pdf"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="square-root-filter" class="level3">
<h3 class="anchored" data-anchor-id="square-root-filter">Square Root Filter</h3>
<section id="numerical-stability" class="level4">
<h4 class="anchored" data-anchor-id="numerical-stability">Numerical Stability</h4>
<div id="676c68d5-8752-417f-9dce-6e131116a35c" class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> meteo_imp.kalman.performance <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="1d38080d-30a4-429f-b1a2-900abc32afa6" class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>err <span class="op">=</span> cache_disk(cache_dir <span class="op">/</span> <span class="st">"fuzz_sr"</span>)(fuzz_filter_SR)(<span class="dv">100</span>, <span class="dv">110</span>) <span class="co"># this is already handling the random seed</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3488c66e-280d-4d14-8e54-8f0bd6c3df46" class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> plot_err_sr_filter(err)</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>save_show_plot(p, <span class="st">"numerical_stability"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="performance" class="level4">
<h4 class="anchored" data-anchor-id="performance">Performance</h4>
<div id="4717692b-843e-439f-abd4-22545c526f89" class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="at">@cache_disk</span>(cache_dir <span class="op">/</span> <span class="st">"perf_sr"</span>)</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_perf_sr():</span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>    reset_seed()</span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> perf_comb_params(<span class="st">'filter'</span>, use_sr_filter<span class="op">=</span>[<span class="va">True</span>, <span class="va">False</span>], rep<span class="op">=</span><span class="bu">range</span>(<span class="dv">100</span>),</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>                           n_obs <span class="op">=</span> <span class="dv">100</span>,</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>                           n_dim_obs<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>                           n_dim_state<span class="op">=</span><span class="dv">18</span>,</span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>                           n_dim_contr<span class="op">=</span><span class="dv">14</span>,</span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>                           p_missing<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>                           bs<span class="op">=</span><span class="dv">20</span> ,</span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>                           init_method <span class="op">=</span> <span class="st">'local_slope'</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>                           ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fc30fc0b-162e-473a-8824-78d148fc9d01" class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>perf1 <span class="op">=</span> (get_perf_sr()</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'use_sr_filter'</span>)</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    .agg(pl.col(<span class="st">"time"</span>).mean())</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>    .with_column(</span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>        pl.when(pl.col(<span class="st">"use_sr_filter"</span>))</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>        .then(pl.lit(<span class="st">"Square Root Filter"</span>))</span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>        .otherwise(pl.lit(<span class="st">"Standard Filter"</span>))</span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>        .alias(<span class="st">"Filter type"</span>)</span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>    ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d87f45fa-77ad-4fe1-b358-cb69cd1f4537" class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>perf1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="b232bb84-1b69-449e-a52c-914542a2ca91" class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>(perf1[<span class="dv">0</span>, <span class="st">'time'</span>] <span class="op">-</span> perf1[<span class="dv">1</span>, <span class="st">'time'</span>]) <span class="op">/</span> perf1[<span class="dv">1</span>, <span class="st">'time'</span>] <span class="op">*</span> <span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="5ec603fd-466a-48f2-b071-89905d231656" class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>plot_perf_sr <span class="op">=</span> alt.Chart(perf1.to_pandas()).mark_bar(size <span class="op">=</span> <span class="dv">50</span>).encode(</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span>alt.X(<span class="st">'Filter type'</span>, axis<span class="op">=</span>alt.Axis(labelAngle<span class="op">=</span><span class="dv">0</span>)),</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span>alt.Y(<span class="st">'time'</span>, scale<span class="op">=</span>alt.Scale(zero<span class="op">=</span><span class="va">False</span>), title<span class="op">=</span><span class="st">"time [s]"</span>),</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span>alt.Color(<span class="st">'Filter type'</span>,</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>                    scale <span class="op">=</span> alt.Scale(scheme <span class="op">=</span> <span class="st">'accent'</span>))</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>).properties(width<span class="op">=</span><span class="dv">300</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="790b10e8-3b26-42d5-9f17-f2ea68b1eb48" class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>save_show_plot(plot_perf_sr, <span class="st">"perf_sr"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script type="application/vnd.jupyter.widget-state+json">
{"state":{},"version_major":2,"version_minor":0}
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/mone27\.github\.io\/meteo_imp");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>